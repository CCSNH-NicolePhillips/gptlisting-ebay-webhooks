// Tests for pricing formula

import { applyPricingFormula, PricingResult } from "../../src/lib/price-formula.js";

describe("Price Formula", () => {
  describe("applyPricingFormula", () => {
    test("returns null for null input", () => {
      expect(applyPricingFormula(null)).toBeNull();
    });

    test("returns null for undefined input", () => {
      expect(applyPricingFormula(undefined)).toBeNull();
    });

    test("returns null for zero or negative values", () => {
      expect(applyPricingFormula(0)).toBeNull();
      expect(applyPricingFormula(-10)).toBeNull();
    });

    test("applies 10% discount for values under $30", () => {
      const result = applyPricingFormula(20);
      expect(result).not.toBeNull();
      expect(result!.base).toBe(20);
      // 20 * 0.9 = 18 -> rounds to 18.45
      expect(result!.ebay).toBe(18.45);
    });

    test("applies $5 flat discount for values over $30", () => {
      const result = applyPricingFormula(50);
      expect(result).not.toBeNull();
      expect(result!.base).toBe(50);
      // 50 - 5 = 45 -> rounds to 45.45
      expect(result!.ebay).toBe(45.45);
    });

    test("rounds to .45 when cents < 0.5", () => {
      const result = applyPricingFormula(100);
      // 100 - 5 = 95 -> rounds to 95.45
      expect(result!.ebay).toBe(95.45);
    });

    test("rounds to .95 when cents >= 0.5", () => {
      const result = applyPricingFormula(34);
      // 34 - 5 = 29 -> rounds to 29.95
      expect(result!.ebay).toBe(29.95);
    });

    test("sets auto-reduction to 80% of eBay price", () => {
      const result = applyPricingFormula(50);
      expect(result).not.toBeNull();
      expect(result!.auto.minPrice).toBe((45.45 * 0.8).toFixed(2));
    });

    test("sets auto-reduction schedule to $1 every 3 days", () => {
      const result = applyPricingFormula(50);
      expect(result).not.toBeNull();
      expect(result!.auto.reduceBy).toBe(1);
      expect(result!.auto.everyDays).toBe(3);
    });

    test("handles edge case at $30 boundary", () => {
      const result = applyPricingFormula(30);
      // 30 is not > 30, so 10% discount
      expect(result!.ebay).toBe(27.95);
    });

    test("handles edge case just above $30", () => {
      const result = applyPricingFormula(30.01);
      // 30.01 - 5 = 25.01 -> rounds to 25.45
      expect(result!.ebay).toBe(25.45);
    });

    test("handles very small values", () => {
      const result = applyPricingFormula(1);
      // 1 * 0.9 = 0.9 -> rounds to 0.95
      expect(result!.ebay).toBe(0.95);
      expect(result!.auto.minPrice).toBe((0.95 * 0.8).toFixed(2));
    });

    test("handles very large values", () => {
      const result = applyPricingFormula(1000);
      // 1000 - 5 = 995 -> rounds to 995.45
      expect(result!.ebay).toBe(995.45);
      expect(result!.auto.minPrice).toBe((995.45 * 0.8).toFixed(2));
    });

    test("base price is fixed to 2 decimals", () => {
      const result = applyPricingFormula(19.999);
      expect(result!.base).toBe(20.0);
    });

    test("eBay price is fixed to 2 decimals", () => {
      const result = applyPricingFormula(50);
      expect(result!.ebay).toBe(45.45);
      expect(typeof result!.ebay).toBe("number");
    });

    test("returns complete PricingResult structure", () => {
      const result = applyPricingFormula(25);
      expect(result).toHaveProperty("base");
      expect(result).toHaveProperty("ebay");
      expect(result).toHaveProperty("auto");
      expect(result!.auto).toHaveProperty("reduceBy");
      expect(result!.auto).toHaveProperty("everyDays");
      expect(result!.auto).toHaveProperty("minPrice");
    });

    test("works with decimal input values", () => {
      const result = applyPricingFormula(19.99);
      expect(result).not.toBeNull();
      // 19.99 * 0.9 = 17.991 -> rounds to 18.45
      expect(result!.base).toBe(19.99);
      expect(result!.ebay).toBe(18.45);
    });
  });
});
