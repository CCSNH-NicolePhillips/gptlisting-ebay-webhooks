# Production Configuration for Pairing System

# =============================================================================
# CANDIDATE & AUTO-PAIR THRESHOLDS
# =============================================================================

# Minimum preScore to consider a back as candidate for a front
# Lower = more candidates, higher recall but slower
# Higher = fewer candidates, faster but may miss edge cases
PAIR_MIN_PRESCORE=1.5

# General auto-pair thresholds (supplements/food with strong brand+product match)
PAIR_AUTO_SCORE=3.0      # Minimum preScore for auto-pairing
PAIR_AUTO_GAP=1.0        # Minimum gap to runner-up candidate

# Hair/cosmetics auto-pair thresholds (INCI-based backs with weaker text signals)
PAIR_AUTO_HAIR_SCORE=2.4
PAIR_AUTO_HAIR_GAP=0.8

# =============================================================================
# PACKAGING BOOSTS
# =============================================================================

# Distinctive packaging types get higher boosts
PAIR_PKG_DROPPER=2.0     # Dropper bottles (rare, distinctive)
PAIR_PKG_POUCH=1.5       # Pouches (common in supplements)
PAIR_PKG_BOTTLE=1.0      # Regular bottles

# =============================================================================
# EXTRAS (MULTI-IMAGE PRODUCTS)
# =============================================================================

# Maximum side/detail images to attach per product
PAIR_EXTRAS_MAX=4

# Minimum score to attach an extra (brand+packaging+category signals)
PAIR_EXTRAS_MIN_SCORE=2

# =============================================================================
# SAFETY VALVES
# =============================================================================

# Maximum time allowed for candidate building (milliseconds)
PAIR_MAX_BUILD_MS=30000

# Maximum fronts a back can appear under before warning
PAIR_MAX_BACK_FRONT_RATIO=3

# Maximum images per batch chunk (rate limiting)
PAIR_BATCH_MAX_CHUNK=200

# Maximum wall time per batch (milliseconds)
PAIR_BATCH_MAX_WALL_MS=30000

# =============================================================================
# COST GUARDRAILS
# =============================================================================

# Disable GPT tie-breaking entirely (autopair-only mode)
# Set to "1" for backfill runs or when API key not available
PAIR_DISABLE_TIEBREAK=0

# Maximum retries on model timeout before disabling GPT
PAIR_MAX_MODEL_RETRIES=3

# Maximum characters per image's textExtracted field (token diet)
PAIR_MAX_TEXT_CHARS=1500

# =============================================================================
# OPENAI CONFIGURATION
# =============================================================================

# OpenAI API key (only needed for tie-break scenarios)
# Leave unset if running autopair-only mode
# OPENAI_API_KEY=sk-...

# Model to use for tie-breaking (gpt-4o-mini recommended for cost)
PAIR_MODEL=gpt-4o-mini

# Temperature for model calls (0 for deterministic)
PAIR_TEMPERATURE=0

# =============================================================================
# MONITORING & TELEMETRY
# =============================================================================

# Enable metrics JSON output
PAIR_METRICS_ENABLED=1

# Metrics output path (relative to working directory)
PAIR_METRICS_PATH=./pairing-metrics.json

# Enable console logging
PAIR_LOG_ENABLED=1

# Log level (DEBUG, INFO, WARN, ERROR)
PAIR_LOG_LEVEL=INFO

# =============================================================================
# CATEGORY-SPECIFIC TUNING (optional)
# =============================================================================

# Lower thresholds for hair/cosmetics (INCI-heavy categories)
# PAIR_CATEGORY_HAIR_AUTO_SCORE=2.2

# Higher thresholds for supplements (strong text signals)
# PAIR_CATEGORY_SUPPLEMENT_AUTO_SCORE=3.2

# =============================================================================
# VERSIONING
# =============================================================================

# Engine version (update on breaking changes)
PAIR_ENGINE_VERSION=1.0.0

# =============================================================================
# SLO TARGETS (for monitoring/alerting)
# =============================================================================

# Target pair rate (%) - alert if below this
PAIR_SLO_PAIR_RATE=98

# Max acceptable singleton rate (%)
PAIR_SLO_MAX_SINGLETON_RATE=2

# Max GPT usage rate (% of batches)
PAIR_SLO_MAX_GPT_RATE=2

# Target runtime (ms per 100 images)
PAIR_SLO_TARGET_RUNTIME_MS=75

# =============================================================================
# NOTES
# =============================================================================
# 
# Production rollout checklist:
# 1. Copy this file to .env (not committed)
# 2. Set OPENAI_API_KEY if tie-breaking needed
# 3. Adjust thresholds based on category mix
# 4. Run npm run verify:golden to confirm no regressions
# 5. Test on small live batch before full rollout
# 6. Monitor pairing-metrics.json for anomalies
#
# Rollback procedure:
# 1. Revert threshold changes in .env
# 2. Restart services
# 3. Re-run failed batches
# 4. Update golden dataset if needed
