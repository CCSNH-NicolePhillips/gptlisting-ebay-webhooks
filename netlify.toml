
[build]
  command = "npm run build"
  publish = "public"
  functions = "netlify/functions"

[functions]
  node_bundler = "esbuild"
  directory = "netlify/functions"
  external_node_modules = [
    "openai",
    "@aws-sdk/client-s3",
    "@aws-sdk/s3-request-presigner",
    "@netlify/blobs",
    "@anthropic-ai/sdk",
    "@google/generative-ai",
    "sharp",
    "dotenv",
    "jose",
    "cheerio"
  ]

# Increase timeout for functions that call external APIs (ChatGPT, eBay)
[functions."smartdrafts-create-drafts"]
  timeout = 26  # Max for Pro tier, helps with ChatGPT API calls

# Allow larger payloads for local upload (base64 images)
[functions."ingest-local-upload"]
  timeout = 26
  included_files = []  # Don't bundle extra files

# Background scan function needs extended timeout for image processing
[functions."smartdrafts-scan-background"]
  timeout = 26  # Max for Pro tier, handles vision API calls and analysis

# Pairing function needs extended timeout for GPT tiebreaker calls
[functions."smartdrafts-pairing"]
  timeout = 26  # Max for Pro tier, handles GPT API calls for ambiguous pairs

# Reduce false positives in Netlify Secrets Scanning by managing omit lists outside repo.
[build.environment]
  USE_NEW_SORTER = "false"

## Make a stable self-hosted ESM path that rewrites to the SDK proxy
[[redirects]]
  from = "/vendor/auth0-spa.esm.js"
  to = "/.netlify/functions/cdn-auth0-spa?esm=1&v=2.1.0"
  status = 200
  force = true

## Do not force a single Content-Type for all functions; individual functions set appropriate headers.

[[scheduled_function]]
  name = "price-tick"
  schedule = "0 */6 * * *"
