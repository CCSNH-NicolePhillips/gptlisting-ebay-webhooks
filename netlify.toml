
[build]
  command = "npm run build"
  publish = "public"
  functions = "netlify/functions"
  # Redeploy to pick up new API keys

[functions]
  node_bundler = "esbuild"
  directory = "netlify/functions"
  external_node_modules = [
    "openai",
    "@aws-sdk/client-s3",
    "@aws-sdk/s3-request-presigner",
    "@netlify/blobs",
    "@anthropic-ai/sdk",
    "@google/generative-ai",
    "sharp",
    "dotenv",
    "jose",
    "cheerio"
  ]

# Increase timeout for functions that call external APIs (ChatGPT, eBay)
[functions."smartdrafts-create-drafts"]
  timeout = 26  # Max for Pro tier, helps with ChatGPT API calls

# Allow larger payloads for local upload (base64 images)
[functions."ingest-local-upload"]
  timeout = 26
  included_files = []  # Don't bundle extra files

# Background scan function needs extended timeout for image processing
[functions."smartdrafts-scan-background"]
  timeout = 26  # Max for Pro tier, handles vision API calls and analysis

# Pairing function needs extended timeout for GPT tiebreaker calls
[functions."smartdrafts-pairing"]
  timeout = 26  # Max for Pro tier, handles GPT API calls for ambiguous pairs

# Pairing V2 processor runs as background function with 10-minute timeout
[functions."pairing-v2-processor-background"]
  timeout = 600  # 10 minutes for background function

# eBay list offers may need extended timeout for multiple API retry attempts
[functions."ebay-list-offers"]
  timeout = 26  # Max for Pro tier, handles multiple eBay API calls with retries

# Reduce false positives in Netlify Secrets Scanning by omitting documentation/examples
[build.environment]
  USE_NEW_SORTER = "false"
  VISION_CONCURRENCY = "1"
  # Omit non-sensitive default values from secrets scanning - these are config defaults, not actual secrets
  SECRETS_SCAN_OMIT_KEYS = "PUBLISH_MODE,DEFAULT_MARKETPLACE_ID,DEFAULT_CATEGORY_ID,EBAY_ENV,APP_URL,DROPBOX_LOCALE,EBAY_RUNAME,EBAY_ENDPOINT_URL,DROPBOX_REDIRECT_URI,PROMOTED_CAMPAIGN_ID,OCR_PROVIDER,SHIP_NAME,SHIP_ADDRESS1,SHIP_CITY,SHIP_STATE,SHIP_POSTAL,SHIP_COUNTRY,EBAY_MERCHANT_LOCATION_KEY,EBAY_RU_NAME"
  # Omit docs, examples, build output, and test files from secrets scanning
  SECRETS_SCAN_OMIT_PATHS = "**/*.md,**/*.example,configs/**,scripts/**,tests/**,tmp/**,testDropbox/**,public/**,dist/**,functions/**,*.json,*.csv,*.mjs,*.toml"

## Make a stable self-hosted ESM path that rewrites to the SDK proxy
[[redirects]]
  from = "/vendor/auth0-spa.esm.js"
  to = "/.netlify/functions/cdn-auth0-spa?esm=1&v=2.1.0"
  status = 200
  force = true

## Do not force a single Content-Type for all functions; individual functions set appropriate headers.

[[scheduled_function]]
  name = "price-tick"
  schedule = "0 */6 * * *"
