<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Quick List</title>
  <style>
    :root {
      --bg: #0b1020;
      --panel: #141a33;
      --line: #2a335c;
      --text: #f4f6fb;
      --muted: #a2a9c8;
      --primary: #4f7cff;
      --primary-600: #3e66d6;
      --success: #22c55e;
      --warning: #f59e0b;
    }
    * { box-sizing: border-box; }
    body {
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      margin: 0;
      background: var(--bg);
      color: var(--text);
      padding: 2rem 1rem;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
    }
    h1 {
      font-size: 2rem;
      margin: 0 0 0.5rem;
    }
    .subtitle {
      color: var(--muted);
      margin-bottom: 2rem;
    }
    .card {
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
    }
    .step {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 1rem;
      background: rgba(255,255,255,0.02);
      border-radius: 8px;
      margin-bottom: 0.75rem;
      border: 1px solid transparent;
    }
    .step.active {
      border-color: var(--primary);
      background: rgba(79, 124, 255, 0.1);
    }
    .step.complete {
      border-color: var(--success);
      background: rgba(34, 197, 94, 0.1);
    }
    .step-num {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: var(--line);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      flex-shrink: 0;
    }
    .step.active .step-num {
      background: var(--primary);
    }
    .step.complete .step-num {
      background: var(--success);
    }
    .step-content {
      flex: 1;
    }
    .step-title {
      font-weight: 600;
      margin-bottom: 0.25rem;
    }
    .step-desc {
      font-size: 0.9rem;
      color: var(--muted);
    }
    .step-status {
      font-size: 0.85rem;
      color: var(--muted);
    }
    .step.complete .step-status {
      color: var(--success);
    }
    .btn {
      background: var(--primary);
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 0.75rem 1.5rem;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      width: 100%;
      transition: background 0.2s;
    }
    .btn:hover:not(:disabled) {
      background: var(--primary-600);
    }
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .btn.secondary {
      background: transparent;
      border: 1px solid var(--line);
      color: var(--text);
    }
    .spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255,255,255,0.3);
      border-top-color: #fff;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-right: 0.5rem;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .progress {
      background: rgba(255,255,255,0.05);
      border-radius: 4px;
      height: 8px;
      overflow: hidden;
      margin-top: 1rem;
    }
    .progress-bar {
      height: 100%;
      background: var(--primary);
      transition: width 0.3s;
    }
    .results {
      display: none;
      margin-top: 1.5rem;
    }
    .results.show {
      display: block;
    }
    .result-summary {
      display: flex;
      justify-content: space-between;
      padding: 1rem;
      background: rgba(34, 197, 94, 0.1);
      border: 1px solid var(--success);
      border-radius: 8px;
      margin-bottom: 1rem;
    }
    .result-stat {
      text-align: center;
    }
    .result-num {
      font-size: 2rem;
      font-weight: 700;
      color: var(--success);
    }
    .result-label {
      font-size: 0.85rem;
      color: var(--muted);
    }
    .actions {
      display: flex;
      gap: 0.75rem;
      margin-top: 1rem;
    }
    select {
      width: 100%;
      padding: 0.75rem;
      background: var(--bg);
      color: var(--text);
      border: 1px solid var(--line);
      border-radius: 8px;
      font-size: 1rem;
    }
    h3 {
      color: var(--text);
      margin-bottom: 0.75rem;
    }
  </style>
</head>
<body>
  <script src="/auth-client.js"></script>
  
  <div class="container">
    <h1>Quick List</h1>
    <p class="subtitle">Scan, analyze, and create eBay drafts in one click</p>
    
    <div class="card">
      <h3 style="margin-top: 0;">Select Dropbox Folder</h3>
      <select id="folderSelect" class="btn secondary" style="margin-bottom: 1.5rem;">
        <option value="">Loading folders...</option>
      </select>
    </div>
    
    <div class="card">
      <div class="step" id="step1">
        <div class="step-num">1</div>
        <div class="step-content">
          <div class="step-title">Scan Images</div>
          <div class="step-desc">Analyze product photos and extract details</div>
        </div>
        <div class="step-status" id="status1">Pending</div>
      </div>
      
      <div class="step" id="step2">
        <div class="step-num">2</div>
        <div class="step-content">
          <div class="step-title">Match Products</div>
          <div class="step-desc">Pair front/back images and identify products</div>
        </div>
        <div class="step-status" id="status2">Pending</div>
      </div>
      
      <div class="step" id="step3">
        <div class="step-num">3</div>
        <div class="step-content">
          <div class="step-title">Generate Listings</div>
          <div class="step-desc">Create titles, descriptions, and pricing with AI</div>
        </div>
        <div class="step-status" id="status3">Pending</div>
      </div>
      
      <div class="step" id="step4">
        <div class="step-num">4</div>
        <div class="step-content">
          <div class="step-title">Send to eBay Drafts</div>
          <div class="step-desc">Create unpublished listings ready to review</div>
        </div>
        <div class="step-status" id="status4">Pending</div>
      </div>
      
      <div class="progress">
        <div class="progress-bar" id="progressBar" style="width: 0%"></div>
      </div>
    </div>
    
    <button class="btn" id="btnStart" onclick="startPipeline()" disabled>
      Start Quick List
    </button>
    
    <div class="results" id="results">
      <div class="result-summary">
        <div class="result-stat">
          <div class="result-num" id="totalDrafts">0</div>
          <div class="result-label">Drafts Created</div>
        </div>
        <div class="result-stat">
          <div class="result-num" id="totalImages">0</div>
          <div class="result-label">Images Processed</div>
        </div>
        <div class="result-stat">
          <div class="result-num" id="totalPaired">0</div>
          <div class="result-label">Products Matched</div>
        </div>
      </div>
      
      <div class="actions">
        <a href="/drafts.html" class="btn">View Drafts</a>
        <button class="btn secondary" onclick="resetPipeline()">Run Again</button>
      </div>
    </div>
  </div>
  
  <script>
    const $ = (id) => document.getElementById(id);
    const exec = window.authClient?.authFetch || fetch;
    
    let currentJobId = null;
    let selectedFolder = null;
    
    async function fetchJSON(url, opts = {}) {
      const r = await exec(url, opts);
      const data = await r.json();
      if (!r.ok) throw new Error(data.error || `HTTP ${r.status}`);
      return data;
    }
    
    async function loadFolders() {
      try {
        const data = await fetchJSON('/.netlify/functions/dropbox-list-folders');
        const select = $('folderSelect');
        
        if (!data.folders || data.folders.length === 0) {
          select.innerHTML = '<option value="">No folders found</option>';
          return;
        }
        
        select.innerHTML = '<option value="">-- Select a folder --</option>';
        data.folders.forEach(folder => {
          const opt = document.createElement('option');
          opt.value = folder.path_lower;
          opt.textContent = folder.name;
          select.appendChild(opt);
        });
        
        select.addEventListener('change', (e) => {
          selectedFolder = e.target.value;
          $('btnStart').disabled = !selectedFolder;
        });
        
      } catch (err) {
        console.error('Failed to load folders:', err);
        $('folderSelect').innerHTML = '<option value="">Error loading folders</option>';
      }
    }
    
    function updateStep(num, status) {
      const step = $(`step${num}`);
      const statusEl = $(`status${num}`);
      
      step.classList.remove('active', 'complete');
      if (status === 'active') {
        step.classList.add('active');
        statusEl.innerHTML = '<span class="spinner"></span>Running...';
      } else if (status === 'complete') {
        step.classList.add('complete');
        statusEl.textContent = 'âœ“ Complete';
      }
      
      // Update progress bar
      const progress = (num / 4) * 100;
      $('progressBar').style.width = `${progress}%`;
    }
    
    async function startPipeline() {
      if (!selectedFolder) {
        alert('Please select a Dropbox folder first');
        return;
      }
      
      const btn = $('btnStart');
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner"></span>Running...';
      $('results').classList.remove('show');
      
      try {
        // Step 1: Scan/Analyze (enqueue background job)
        updateStep(1, 'active');
        const scanRes = await fetchJSON('/.netlify/functions/smartdrafts-scan-bg', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            path: selectedFolder,
            force: false
          })
        });
        
        if (!scanRes.ok || !scanRes.jobId) {
          throw new Error(scanRes.error || 'Scan failed to start');
        }
        
        currentJobId = scanRes.jobId;
        console.log('[Quick List] Scan job started:', currentJobId);
        
        // Poll for scan completion
        let scanComplete = false;
        let attempts = 0;
        const maxAttempts = 80; // 2 minutes max (1.5s intervals)
        
        while (!scanComplete && attempts < maxAttempts) {
          await new Promise(resolve => setTimeout(resolve, 1500));
          attempts++;
          
          const statusRes = await fetchJSON(`/.netlify/functions/smartdrafts-scan-status?jobId=${currentJobId}`);
          
          if (statusRes.state === 'complete') {
            scanComplete = true;
            updateStep(1, 'complete');
            $('totalImages').textContent = (statusRes.groups || []).length || 0;
            console.log('[Quick List] Scan complete:', statusRes.groups?.length, 'groups');
          } else if (statusRes.state === 'error') {
            throw new Error(statusRes.error || 'Scan failed');
          } else {
            $('status1').innerHTML = `<span class="spinner"></span>Analyzing... (${attempts * 1.5}s)`;
          }
        }
        
        if (!scanComplete) {
          throw new Error('Scan timeout after 2 minutes');
        }
        
        // Step 2: Pair
        updateStep(2, 'active');
        const pairRes = await fetchJSON('/.netlify/functions/smartdrafts-pairing', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ jobId: currentJobId })
        });
        
        if (!pairRes.ok) {
          throw new Error(pairRes.error || 'Pairing failed');
        }
        
        updateStep(2, 'complete');
        const products = pairRes.pairing?.products || [];
        $('totalPaired').textContent = products.length;
        
        if (products.length === 0) {
          throw new Error('No products were paired. Please check your images.');
        }
        
        console.log('[Quick List] Paired', products.length, 'products');
        
        // Step 3: Create Drafts (send all products at once)
        updateStep(3, 'active');
        const draftRes = await fetchJSON('/.netlify/functions/smartdrafts-create-drafts', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ products })
        });
        
        if (!draftRes.ok) {
          throw new Error(draftRes.error || 'Draft creation failed');
        }
        
        updateStep(3, 'complete');
        const drafts = draftRes.drafts || [];
        $('totalDrafts').textContent = drafts.length;
        
        console.log('[Quick List] Created', drafts.length, 'drafts');
        
        // Step 4: Publish to eBay Drafts
        updateStep(4, 'active');
        
        // Note: create-ebay-draft-user needs the groups with drafts
        // We need to merge the pairing products with draft content
        const groupsWithDrafts = products.map((product, idx) => {
          const draft = drafts[idx];
          return {
            ...product,
            title: draft?.title,
            description: draft?.description,
            aspects: draft?.aspects,
            price: draft?.price,
            condition: draft?.condition,
            category: draft?.category
          };
        });
        
        const pubRes = await fetchJSON('/.netlify/functions/create-ebay-draft-user', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            jobId: currentJobId,
            groups: groupsWithDrafts
          })
        });
        
        if (!pubRes.ok) {
          throw new Error(pubRes.error || 'Publishing to eBay failed');
        }
        
        updateStep(4, 'complete');
        const published = pubRes.created || 0;
        console.log('[Quick List] Published', published, 'drafts to eBay');
        
        // Show results
        $('progressBar').style.width = '100%';
        $('results').classList.add('show');
        btn.textContent = 'Complete!';
        
      } catch (err) {
        console.error('Pipeline error:', err);
        alert(`Error: ${err.message}`);
        btn.disabled = false;
        btn.textContent = 'Retry';
      }
    }
    
    function resetPipeline() {
      // Reset all steps
      for (let i = 1; i <= 4; i++) {
        const step = $(`step${i}`);
        const status = $(`status${i}`);
        step.classList.remove('active', 'complete');
        status.textContent = 'Pending';
      }
      
      $('progressBar').style.width = '0%';
      $('results').classList.remove('show');
      $('btnStart').disabled = false;
      $('btnStart').textContent = 'Start Quick List';
      currentJobId = null;
    }
    
    async function bootstrap() {
      try {
        const ok = await authClient.requireAuth();
        if (!ok) return;
        
        // Load Dropbox folders
        await loadFolders();
      } catch (e) {
        console.error('Auth check failed', e);
      }
    }
    
    bootstrap();
  </script>
</body>
</html>
