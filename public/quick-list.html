<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Quick List ‚Äì DraftPilot</title>
  <link rel="stylesheet" href="/draftpilot.css">
  <style>
    /* Quick List specific styles */
    
    /* Responsive feature highlights */
    .feature-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 2rem;
      align-items: center;
    }
    
    @media (max-width: 1024px) {
      .feature-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 1.5rem;
      }
    }
    
    @media (max-width: 640px) {
      .feature-grid {
        grid-template-columns: 1fr;
        gap: 1rem;
      }
    }
    
    /* Make upload area text visible */
    .upload-area strong,
    .upload-area span,
    .upload-hint {
      color: var(--text-primary) !important;
    }
    
    .upload-icon {
      font-size: 3rem;
      margin-bottom: 1rem;
      opacity: 0.8;
    }
    
    .step {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 1rem;
      background: rgba(255,255,255,0.02);
      border-radius: 8px;
      margin-bottom: 0.75rem;
      border: 1px solid transparent;
    }
    .step.active {
      border-color: var(--primary);
      background: rgba(79, 124, 255, 0.1);
    }
    .step.complete {
      border-color: var(--success);
      background: rgba(34, 197, 94, 0.1);
    }
    .step.warning {
      border-color: rgb(251, 191, 36);
      background: rgba(251, 191, 36, 0.1);
    }
    .step-num {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: var(--line);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      flex-shrink: 0;
    }
    .step.active .step-num {
      background: var(--primary);
    }
    .step.complete .step-num {
      background: var(--success);
    }
    .step.warning .step-num {
      background: rgb(251, 191, 36);
    }
    .step-content {
      flex: 1;
    }
    .step-title {
      font-weight: 600;
      margin-bottom: 0.25rem;
    }
    .step-desc {
      font-size: 0.9rem;
      color: var(--muted);
    }
    .step-status {
      font-size: 0.85rem;
      color: var(--muted);
    }
    .step.complete .step-status {
      color: var(--success);
    }
    
    .btn {
      background: var(--primary);
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 0.75rem 1.5rem;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      width: 100%;
      transition: background 0.2s;
    }
    .btn:hover:not(:disabled) {
      background: var(--primary-600);
    }
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .btn.secondary {
      background: transparent;
      border: 1px solid var(--line);
      color: var(--text);
    }
    
    .spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255,255,255,0.3);
      border-top-color: #fff;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-right: 0.5rem;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .progress {
      background: rgba(255,255,255,0.05);
      border-radius: 4px;
      height: 8px;
      overflow: hidden;
      margin-top: 1rem;
    }
    .progress-bar {
      height: 100%;
      background: var(--primary);
      transition: width 0.3s;
    }
    
    .results {
      display: none;
      margin-top: 1.5rem;
    }
    .results.show {
      display: block;
    }
    .result-summary {
      display: flex;
      justify-content: space-between;
      padding: 1rem;
      background: rgba(34, 197, 94, 0.1);
      border: 1px solid var(--success);
      border-radius: 8px;
      margin-bottom: 1rem;
    }
    .result-stat {
      text-align: center;
    }
    .result-num {
      font-size: 2rem;
      font-weight: 700;
      color: var(--success);
    }
    .result-label {
      font-size: 0.85rem;
      color: var(--muted);
    }
    .actions {
      display: flex;
      gap: 0.75rem;
      margin-top: 1rem;
    }
    .actions .btn {
      flex: 1;
      text-align: center;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    .actions .btn:not(.secondary) {
      background: var(--success);
    }
    .actions .btn:not(.secondary):hover {
      background: #16a34a;
    }
    .actions .btn.secondary {
      background: transparent;
      border: 1px solid var(--line);
      color: var(--text);
    }
    .actions .btn.secondary:hover {
      background: rgba(255, 255, 255, 0.05);
      border-color: var(--primary);
    }
    
    select {
      width: 100%;
      padding: 0.75rem;
      background: var(--bg);
      color: var(--text);
      border: 1px solid var(--line);
      border-radius: 8px;
      font-size: 1rem;
    }
    
    .upload-tab {
      padding: 0.75rem 1.5rem;
      background: transparent;
      border: none;
      border-bottom: 2px solid transparent;
      color: var(--text-muted);
      cursor: pointer;
      font-size: 0.95rem;
      font-weight: 600;
      transition: all 0.2s;
    }
    .upload-tab:hover {
      color: var(--text-primary);
    }
    .upload-tab.active {
      color: var(--accent);
      border-bottom-color: var(--accent);
    }
    .upload-panel {
      animation: fadeIn 0.3s;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .upload-area {
      border: 2px dashed var(--border-medium);
      border-radius: 12px;
      padding: 3rem 2rem;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
      background: rgba(255,255,255,0.02);
    }
    .upload-area:hover {
      border-color: var(--accent);
      background: var(--accent-soft);
    }
    .upload-area.drag-over {
      border-color: var(--accent);
      background: var(--accent-soft);
      border-style: solid;
    }
    .upload-icon {
      font-size: 3rem;
      margin-bottom: 1rem;
    }
    .upload-text {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
      font-size: 1.05rem;
      margin-bottom: 0.5rem;
      color: var(--text-primary);
    }
    .upload-text strong {
      font-weight: 600;
      color: var(--text-primary);
    }
    .upload-text span {
      font-size: 0.9rem;
      color: var(--text-secondary);
    }
    .upload-hint {
      font-size: 0.85rem;
      color: var(--text-muted);
    }
    .file-list {
      display: grid;
      gap: 0.5rem;
      max-height: 300px;
      overflow-y: auto;
    }
    .file-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem;
      background: rgba(255,255,255,0.02);
      border: 1px solid var(--line);
      border-radius: 8px;
    }
    .file-thumbnail {
      width: 50px;
      height: 50px;
      border-radius: 6px;
      object-fit: cover;
      flex-shrink: 0;
    }
    .file-info {
      flex: 1;
      min-width: 0;
    }
    .file-name {
      font-size: 0.9rem;
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .file-size {
      font-size: 0.8rem;
      color: var(--muted);
    }
    .file-remove {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.3);
      color: rgb(239, 68, 68);
      padding: 0.4rem 0.8rem;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.85rem;
      transition: all 0.2s;
    }
    .file-remove:hover {
      background: rgba(239, 68, 68, 0.2);
    }
    h3 {
      color: var(--text);
      margin-bottom: 0.75rem;
    }
    
    /* Promotion option styles */
    .promo-option {
      display: flex;
      align-items: flex-start;
      gap: 0.75rem;
      cursor: pointer;
      padding: 0.875rem;
      background: var(--bg-secondary);
      border-radius: 8px;
      border: 1px solid var(--line);
      transition: all 0.2s;
    }
    .promo-option:hover {
      border-color: var(--primary);
      background: rgba(91, 124, 255, 0.05);
    }
    .promo-option input[type="radio"] {
      margin-top: 0.125rem;
      width: 18px;
      height: 18px;
      cursor: pointer;
      flex-shrink: 0;
      accent-color: var(--primary);
    }
    .promo-content {
      flex: 1;
    }
    .promo-title {
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 0.25rem;
      font-size: 0.9375rem;
    }
    .promo-desc {
      font-size: 0.875rem;
      color: var(--text-muted);
      line-height: 1.4;
    }
    .promo-option:has(input:checked) {
      border-color: var(--primary);
      background: rgba(91, 124, 255, 0.1);
    }
  </style>
</head>
<body>
  <script src="/auth-client.js"></script>
  
  <div class="dp-shell">
    <!-- Sidebar -->
    <aside class="dp-sidebar">
      <!-- Brand Area -->
      <div class="dp-sidebar__brand">
        <img src="logo/LogoWhiteText_NoBg.png" alt="DraftPilot - AI Listing Studio" class="dp-brand-logo" />
      </div>
      
      <!-- Navigation -->
      <nav class="dp-sidebar__nav">
        <!-- Primary Navigation Group -->
        <div class="dp-nav-group">
          <div class="dp-nav-group__label">APP</div>
          <div class="dp-nav-group__items">
            <a href="/index.html" class="dp-nav-item">
              <svg class="dp-nav-item__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                <polyline points="9 22 9 12 15 12 15 22"></polyline>
              </svg>
              <span class="dp-nav-item__label">Overview</span>
            </a>
            <a href="/quick-list.html" class="dp-nav-item dp-nav-item--active">
              <svg class="dp-nav-item__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon>
              </svg>
              <span class="dp-nav-item__label">Create Listings</span>
            </a>
            <a href="/drafts.html" class="dp-nav-item">
              <svg class="dp-nav-item__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                <polyline points="14 2 14 8 20 8"></polyline>
              </svg>
              <span class="dp-nav-item__label">Drafts</span>
            </a>
            <a href="/active-listings.html" class="dp-nav-item">
              <svg class="dp-nav-item__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect>
                <path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path>
              </svg>
              <span class="dp-nav-item__label">Active Listings</span>
            </a>
          </div>
        </div>
        
        <!-- Account Navigation Group -->
        <div class="dp-nav-group">
          <div class="dp-nav-group__label">ACCOUNT</div>
          <div class="dp-nav-group__items">
            <a href="/policies-manage.html" class="dp-nav-item">
              <svg class="dp-nav-item__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                <polyline points="14 2 14 8 20 8"></polyline>
                <line x1="16" y1="13" x2="8" y2="13"></line>
                <line x1="16" y1="17" x2="8" y2="17"></line>
                <polyline points="10 9 9 9 8 9"></polyline>
              </svg>
              <span class="dp-nav-item__label">eBay Policies</span>
            </a>
            <a href="/location.html" class="dp-nav-item">
              <svg class="dp-nav-item__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                <circle cx="12" cy="10" r="3"></circle>
              </svg>
              <span class="dp-nav-item__label">Inventory Locations</span>
            </a>
            <a href="/settings.html" class="dp-nav-item">
              <svg class="dp-nav-item__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="3"></circle>
                <path d="M12 1v6m0 6v6m5.196-15.196l-4.243 4.243m0 5.656l-4.242 4.243m15.195-5.196l-4.242-4.243m-5.657 0l-4.243-4.243"></path>
              </svg>
              <span class="dp-nav-item__label">Settings</span>
            </a>
            <a href="/faq.html" class="dp-nav-item">
              <svg class="dp-nav-item__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"></circle>
                <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                <line x1="12" y1="17" x2="12.01" y2="17"></line>
              </svg>
              <span class="dp-nav-item__label">FAQ</span>
            </a>
            <a href="/support.html" class="dp-nav-item">
              <svg class="dp-nav-item__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"></circle>
                <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                <line x1="12" y1="17" x2="12.01" y2="17"></line>
              </svg>
              <span class="dp-nav-item__label">Support</span>
            </a>
          </div>
        </div>
      </nav>
      
      <!-- Spacer -->
      <div class="dp-sidebar__spacer"></div>
      
      <!-- User Footer -->
      <div class="dp-sidebar__footer">
        <div class="dp-user-card" id="userCard">
          <div class="dp-user-card__avatar" id="userAvatar">U</div>
          <div class="dp-user-card__info">
            <div class="dp-user-card__name" id="userName">Loading...</div>
            <div class="dp-user-card__status" id="userEmail">Signed in</div>
          </div>
        </div>
        <div class="dp-user-menu" id="userMenu" style="display: none;">
          <a href="/logout.html" class="dp-user-menu__item">
            <svg class="dp-user-menu__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
              <polyline points="16 17 21 12 16 7"></polyline>
              <line x1="21" y1="12" x2="9" y2="12"></line>
            </svg>
            <span>Sign out</span>
          </a>
        </div>
      </div>
    </aside>
    
    <div class="dp-mobile-backdrop" id="mobileBackdrop"></div>
    
    <!-- Main Content Wrapper -->
    <div class="dp-main-wrapper">
      <!-- Top Bar -->
      <header class="dp-topbar">
        <!-- Left: Mobile menu + Page Title & Subtitle -->
        <div class="dp-topbar-left">
          <!-- Mobile-only hamburger -->
          <button
            class="dp-topbar-icon dp-topbar-icon--menu"
            id="mobileMenuButton"
            aria-label="Open navigation"
            aria-expanded="false"
            type="button"
          >
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="4" y1="6" x2="20" y2="6"></line>
              <line x1="4" y1="12" x2="20" y2="12"></line>
              <line x1="4" y1="18" x2="20" y2="18"></line>
            </svg>
          </button>

          <div class="dp-topbar-heading">
            <h1 class="dp-topbar__title">‚ö° Quick List</h1>
            <p class="dp-topbar__subtitle">
              AI-powered listing creation from your product photos
            </p>
          </div>
        </div>
        
        <!-- Center: Search -->
        <div class="dp-topbar-center">
          <div class="dp-search">
            <svg class="dp-search__icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="11" cy="11" r="8"></circle>
              <path d="m21 21-4.35-4.35"></path>
            </svg>
            <input type="text" class="dp-search__input" placeholder="Search drafts, SKUs, or notes‚Ä¶" />
          </div>
        </div>
        
        <!-- Right: Icon Cluster -->
        <div class="dp-topbar-right" style="display: flex !important; gap: 0.75rem;">
          <a href="/index.html" class="dp-btn dp-btn-secondary" style="padding: 0.5rem 1rem; font-size: 0.875rem;">‚Üê Back to Dashboard</a>
        </div>
      </header>
      
      <!-- Main Content Area -->
      <main class="dp-main">
    <!-- Feature highlights -->
    <div class="dp-card dp-card--full" style="background: linear-gradient(135deg, rgba(56, 189, 248, 0.15) 0%, rgba(56, 189, 248, 0.05) 100%); border-color: rgba(56, 189, 248, 0.3);">
      <div class="feature-grid">
        <div style="display: flex; align-items: center; gap: 0.75rem; justify-content: center;">
          <div style="font-size: 1.5rem;">ü§ñ</div>
          <div>
            <div style="font-weight: 600; font-size: 0.95rem; color: var(--text-primary);">GPT-4 Vision</div>
            <div style="font-size: 0.8rem; color: var(--text-muted);">Image analysis</div>
          </div>
        </div>
        <div style="display: flex; align-items: center; gap: 0.75rem; justify-content: center;">
          <div style="font-size: 1.5rem;">üí∞</div>
          <div>
            <div style="font-weight: 600; font-size: 0.95rem; color: var(--text-primary);">Smart Pricing</div>
            <div style="font-size: 0.8rem; color: var(--text-muted);">Amazon/Walmart research</div>
          </div>
        </div>
        <div style="display: flex; align-items: center; gap: 0.75rem; justify-content: center;">
          <div style="font-size: 1.5rem;">üéØ</div>
          <div>
            <div style="font-weight: 600; font-size: 0.95rem; color: var(--text-primary);">Auto Categories</div>
            <div style="font-size: 0.8rem; color: var(--text-muted);">eBay taxonomy matching</div>
          </div>
        </div>
        <div style="display: flex; align-items: center; gap: 0.75rem; justify-content: center;">
          <div style="font-size: 1.5rem;">‚ú®</div>
          <div>
            <div style="font-weight: 600; font-size: 0.95rem; color: var(--text-primary);">Full Automation</div>
            <div style="font-size: 0.8rem; color: var(--text-muted);">Zero manual input</div>
          </div>
        </div>
      </div>
    </div>

    <div class="dp-card dp-card--full">
      <h3 style="margin-top: 0; margin-bottom: 1rem; color: var(--text-primary);">üì∏ Upload Your Product Photos</h3>

      <!-- Upload method tabs -->
      <div style="display: flex; gap: 0.5rem; margin-bottom: 1.5rem; border-bottom: 1px solid var(--border-subtle);">
        <button id="tabLocal" class="upload-tab active" onclick="switchUploadMethod('local')">
          üì§ Upload Files
        </button>
        <button id="tabDropbox" class="upload-tab" onclick="switchUploadMethod('dropbox')">
          üìÅ Dropbox Folder
        </button>
      </div>

      <!-- Local upload panel -->
      <div id="uploadLocal" class="upload-panel">
        <!-- Upload mode toggle - HIDDEN, files mode is default -->
        <div style="display: none; gap: 0.5rem; border-radius: 0.5rem; border: 1px solid var(--border); padding: 0.25rem; background: #f8f9fa; margin-bottom: 1rem;">
          <button id="btnModeFiles" class="btn secondary" style="padding: 0.5rem 1rem; font-size: 0.875rem; border-radius: 0.375rem; margin: 0; background: var(--primary); color: white; border: none;" onclick="setUploadMode('files')">
            üìÑ Upload Files
          </button>
          <button id="btnModeFolder" class="btn secondary" style="padding: 0.5rem 1rem; font-size: 0.875rem; border-radius: 0.375rem; margin: 0; background: transparent; color: #666; border: none;" onclick="setUploadMode('folder')">
            üìÅ Upload Folder
          </button>
        </div>
        <div id="folderModeHint" style="display: none; font-size: 0.85rem; color: #856404; margin-bottom: 0.75rem; padding: 0.5rem; background: #fff3cd; border-radius: 0.375rem; border: 1px solid #ffc107;">
          üí° <strong>Desktop only:</strong> Select an entire folder of images. Mobile users should use "Upload Files".
        </div>
        
        <div class="upload-area" id="uploadArea">
          <div class="upload-icon">üìÅ</div>
          <div class="upload-text">
            <strong id="uploadTitle">Drag & drop photos here</strong>
            <span id="uploadSubtitle">or click to browse</span>
          </div>
          <div class="upload-hint">
            Supports JPG, PNG, WebP (max 10MB each)<br>
            <strong>Tip:</strong> On mobile, tap and hold to select multiple photos at once
          </div>
        </div>
        <input type="file" id="fileInput" accept="image/*" multiple style="display: none;">

        <!-- Selected files preview -->
        <div id="selectedFiles" style="display: none; margin-top: 1rem;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
            <strong><span id="fileCount">0</span> files selected</strong>
            <button class="btn secondary" style="padding: 0.4rem 0.8rem; font-size: 0.85rem;" onclick="clearFiles()">Clear All</button>
          </div>
          <div id="fileList" class="file-list"></div>
        </div>
      </div>

      <!-- Dropbox panel -->
      <div id="uploadDropbox" class="upload-panel" style="display: none;">
        <select id="folderSelect" class="btn secondary" style="margin-bottom: 0; width: 100%;">
          <option value="">Loading folders...</option>
        </select>
        <p style="font-size: 0.85rem; color: var(--muted); margin-top: 0.5rem; margin-bottom: 0;">
          Select a Dropbox folder containing your product photos
        </p>
      </div>

      <button id="btnStart" class="btn primary" onclick="startPipeline()" style="margin-top: 1.5rem; width: 100%;" disabled>
        üöÄ Start Quick List
      </button>
    </div>

    <!-- Promotion Settings Card -->
    <div class="dp-card dp-card--full">
      <h3 style="margin-top: 0; margin-bottom: 1.25rem; color: var(--text-primary); display: flex; align-items: center; gap: 0.5rem;">
        <span>üì¢ Promoted Listings (Optional)</span>
      </h3>
      
      <div style="display: flex; flex-direction: column; gap: 0.75rem;">
        <label class="promo-option">
          <input type="radio" name="promotionMode" value="default" id="promotionDefault" checked />
          <div class="promo-content">
            <div class="promo-title">Use my default settings</div>
            <div class="promo-desc" id="defaultPromotionInfo">Loading...</div>
          </div>
        </label>
        
        <label class="promo-option">
          <input type="radio" name="promotionMode" value="custom" id="promotionCustom" />
          <div class="promo-content">
            <div class="promo-title">Use custom rate for this run</div>
            <div class="promo-desc">Override with a different promotion rate</div>
          </div>
        </label>
        
        <div id="customPromotionInput" style="margin-left: 2.25rem; margin-top: -0.25rem; display: none;">
          <div style="display: flex; gap: 0.625rem; align-items: center;">
            <input type="number" id="customPromotionRate" placeholder="5.0" min="1" max="20" step="0.1" 
                   style="width: 100px; padding: 0.5rem 0.75rem; background: var(--bg-secondary); border: 1px solid var(--line); border-radius: 6px; color: var(--text-primary); font-size: 0.9375rem;" />
            <span style="color: var(--text-muted); font-size: 0.9375rem;">% ad rate</span>
          </div>
        </div>
        
        <label class="promo-option">
          <input type="radio" name="promotionMode" value="none" id="promotionNone" />
          <div class="promo-content">
            <div class="promo-title">No promotion</div>
            <div class="promo-desc">Skip promoted listings for this run</div>
          </div>
        </label>
      </div>
      
      <div style="margin-top: 1.25rem; padding: 0.875rem; background: var(--bg-secondary); border-radius: 8px; border: 1px solid var(--line);">
        <div style="font-size: 0.875rem; color: var(--text-muted); display: flex; gap: 0.5rem;">
          <span style="color: var(--primary);">üí°</span>
          <span>Promoted listings increase visibility on eBay. Configure defaults in <a href="/settings.html" style="color: var(--primary); text-decoration: none; font-weight: 500;">Settings</a>.</span>
        </div>
      </div>
    </div>

    <div class="dp-card dp-card--full">
      <h3 style="margin-top: 0; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem; color: var(--text-primary);">
        <span>üîÑ Automated Pipeline</span>
        <span style="font-size: 0.75rem; font-weight: normal; color: var(--text-muted);">All steps run automatically</span>
      </h3>

      <div class="step" id="step1">
        <div class="step-num">1</div>
        <div class="step-content">
          <div class="step-title">üîç Scan & Analyze Images</div>
          <div class="step-desc">Vision AI examines each photo, extracts product details, text, and visual features</div>
        </div>
        <div class="step-status" id="status1">Pending</div>
      </div>

      <div class="step" id="step2">
        <div class="step-num">2</div>
        <div class="step-content">
          <div class="step-title">üß© Smart Product Matching</div>
          <div class="step-desc">AI pairs front/back images and identifies unique products using CLIP embeddings</div>
        </div>
        <div class="step-status" id="status2">Pending</div>
      </div>

      <!-- Orphans warning (shown if images couldn't be paired) -->
      <div id="orphansWarning" style="display: none; margin-top: 1rem; padding: 1rem; background: rgba(251, 191, 36, 0.1); border: 1px solid rgba(251, 191, 36, 0.5); border-radius: 8px;">
        <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1rem;">
          <div style="font-size: 1.5rem;">‚ö†Ô∏è</div>
          <div style="flex: 1;">
            <div style="font-weight: 600; color: rgb(251, 191, 36); margin-bottom: 0.25rem;">
              <span id="orphansCount">0</span> image(s) couldn't be paired
            </div>
            <div style="font-size: 0.85rem; color: var(--muted);">
              These images were rejected during pairing and may need manual review.
            </div>
          </div>
        </div>
        
        <!-- Rejected images grid -->
        <div id="rejectedImagesGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1rem; margin-top: 1rem;">
          <!-- Will be populated dynamically -->
        </div>
      </div>

      <div class="step" id="step3">
        <div class="step-num">3</div>
        <div class="step-content">
          <div class="step-title">‚úçÔ∏è Generate Professional Listings</div>
          <div class="step-desc">GPT-4 creates titles, descriptions, bullet points, researches pricing, and selects optimal categories</div>
        </div>
        <div class="step-status" id="status3">Pending</div>
      </div>

      <div class="step" id="step4">
        <div class="step-num">4</div>
        <div class="step-content">
          <div class="step-title">üì§ Publish to eBay Drafts</div>
          <div class="step-desc">Creates unpublished eBay offers ready for your final review and publishing</div>
        </div>
        <div class="step-status" id="status4">Pending</div>
      </div>

      <div class="progress">
        <div class="progress-bar" id="progressBar" style="width: 0%"></div>
      </div>
    </div>

    <div class="results" id="results">
      <div class="dp-card" style="background: linear-gradient(135deg, rgba(34, 197, 94, 0.15) 0%, rgba(34, 197, 94, 0.05) 100%); border-color: var(--success);">
        <h3 style="margin-top: 0; color: var(--success); display: flex; align-items: center; gap: 0.5rem;">
          <span style="font-size: 1.5rem;">üéâ</span>
          <span>Success! Drafts Created</span>
        </h3>

        <div class="result-summary">
          <div class="result-stat">
            <div class="result-num" id="totalDrafts">0</div>
            <div class="result-label">üìã eBay Drafts</div>
          </div>
          <div class="result-stat">
            <div class="result-num" id="totalPaired">0</div>
            <div class="result-label">üß© Products Matched</div>
          </div>
          <div class="result-stat">
            <div class="result-num" id="totalImages">0</div>
            <div class="result-label">üì∏ Images Analyzed</div>
          </div>
        </div>

        <div class="actions">
          <a href="/drafts.html" class="btn">‚úì View & Publish Drafts</a>
          <button class="btn secondary" onclick="resetPipeline()">üîÑ Run Again</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);
    const exec = window.authClient?.authFetch || fetch;

    let currentJobId = null;
    let selectedFolder = null;
    let selectedFiles = [];
    let uploadMethod = 'local'; // 'local' or 'dropbox'
    let uploadMode = 'files'; // 'files' or 'folder' (for local uploads)

    // Upload method switching
    function switchUploadMethod(method) {
      uploadMethod = method;

      // Update tabs
      $('tabLocal').classList.toggle('active', method === 'local');
      $('tabDropbox').classList.toggle('active', method === 'dropbox');

      // Update panels
      $('uploadLocal').style.display = method === 'local' ? 'block' : 'none';
      $('uploadDropbox').style.display = method === 'dropbox' ? 'block' : 'none';

      // Update button state
      updateStartButton();
    }

    // Upload mode switching (files vs folder)
    function setUploadMode(mode) {
      uploadMode = mode;
      const fileInput = $('fileInput');
      
      // Update button styles
      if (mode === 'files') {
        $('btnModeFiles').style.background = 'var(--primary)';
        $('btnModeFiles').style.color = 'white';
        $('btnModeFolder').style.background = 'transparent';
        $('btnModeFolder').style.color = '#666';
      } else {
        $('btnModeFiles').style.background = 'transparent';
        $('btnModeFiles').style.color = '#666';
        $('btnModeFolder').style.background = 'var(--primary)';
        $('btnModeFolder').style.color = 'white';
      }
      
      // Show/hide folder mode hint
      $('folderModeHint').style.display = mode === 'folder' ? 'block' : 'none';
      
      // Update UI text
      $('uploadTitle').textContent = mode === 'folder' ? 'Drag & drop a folder here' : 'Drag & drop photos here';
      $('uploadSubtitle').textContent = mode === 'folder' ? 'or click to select folder' : 'or click to browse';
      
      // Update file input attributes
      if (mode === 'folder') {
        fileInput.setAttribute('webkitdirectory', '');
        fileInput.setAttribute('directory', '');
      } else {
        fileInput.removeAttribute('webkitdirectory');
        fileInput.removeAttribute('directory');
      }
      
      // Clear selected files when switching modes
      clearFiles();
    }

    function updateStartButton() {
      const btn = $('btnStart');
      if (uploadMethod === 'local') {
        btn.disabled = selectedFiles.length === 0;
        btn.innerHTML = selectedFiles.length > 0
          ? `üöÄ Start Quick List (${selectedFiles.length} files)`
          : 'üöÄ Start Quick List';
      } else {
        btn.disabled = !selectedFolder;
        btn.innerHTML = 'üöÄ Start Quick List';
      }
    }

    // Local file upload handling
    const uploadArea = $('uploadArea');
    const fileInput = $('fileInput');

    uploadArea.addEventListener('click', () => fileInput.click());

    uploadArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadArea.classList.add('drag-over');
    });

    uploadArea.addEventListener('dragleave', () => {
      uploadArea.classList.remove('drag-over');
    });

    uploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadArea.classList.remove('drag-over');
      const files = Array.from(e.dataTransfer.files).filter(f => f.type.startsWith('image/'));
      addFiles(files);
    });

    fileInput.addEventListener('change', (e) => {
      addFiles(Array.from(e.target.files));
      fileInput.value = ''; // Reset input
    });

    function addFiles(files) {
      selectedFiles.push(...files);
      renderFileList();
      updateStartButton();
    }

    function removeFile(index) {
      selectedFiles.splice(index, 1);
      renderFileList();
      updateStartButton();
    }

    function clearFiles() {
      selectedFiles = [];
      renderFileList();
      updateStartButton();
    }

    function renderFileList() {
      const container = $('selectedFiles');
      const list = $('fileList');
      const count = $('fileCount');

      if (selectedFiles.length === 0) {
        container.style.display = 'none';
        return;
      }

      container.style.display = 'block';
      count.textContent = selectedFiles.length;

      list.innerHTML = selectedFiles.map((file, idx) => {
        const url = URL.createObjectURL(file);
        const sizeMB = (file.size / 1024 / 1024).toFixed(2);
        
        // Show folder path if available (from folder upload)
        const relativePath = file.webkitRelativePath || file.name;
        const displayName = relativePath.includes('/') 
          ? `<span style="color: #666; font-size: 0.85em;">${relativePath.split('/').slice(0, -1).join('/')}/</span>${file.name}`
          : file.name;
        
        return `
          <div class="file-item">
            <img src="${url}" class="file-thumbnail" alt="">
            <div class="file-info">
              <div class="file-name">${displayName}</div>
              <div class="file-size">${sizeMB} MB</div>
            </div>
            <button class="file-remove" onclick="removeFile(${idx})">Remove</button>
          </div>
        `;
      }).join('');
    }

    // Make functions global
    window.switchUploadMethod = switchUploadMethod;
    window.setUploadMode = setUploadMode;
    window.removeFile = removeFile;
    window.clearFiles = clearFiles;

    async function fetchJSON(url, opts = {}) {
      try {
        const r = await exec(url, opts);

        // Check if response is valid
        if (!r) {
          throw new Error('No response received from server');
        }

        // Safe JSON parsing - handle empty responses
        let data;
        try {
          const text = await r.text();
          data = text ? JSON.parse(text) : {};
        } catch (parseErr) {
          console.error('[fetchJSON] JSON parse error:', parseErr);
          throw new Error('Invalid JSON response from server');
        }

        if (!r.ok) {
          // Check for auth errors
          if (r.status === 401 || r.status === 403) {
            console.error('[Auth] Unauthorized request, redirecting to login...');
            sessionStorage.setItem('returnTo', window.location.pathname + window.location.search);
            window.location.replace('/login.html');
            throw new Error('Authentication required');
          }
          // More descriptive error for 502
          if (r.status === 502) {
            const errorMsg = data.error || 'Backend service unavailable';
            console.error('[API] 502 Error:', errorMsg, 'URL:', url);
            throw new Error(`Service Error: ${errorMsg}`);
          }
          // Include detail field for better debugging
          const errorMsg = data.error || `HTTP ${r.status}`;
          const fullError = data.detail ? `${errorMsg}: ${data.detail}` : errorMsg;
          console.error('[API] Error response:', { status: r.status, error: data.error, detail: data.detail, groupId: data.groupId });
          throw new Error(fullError);
        }
        return data;
      } catch (err) {
        // Check if it's an auth-related error
        if (err.message?.includes('Authentication expired') ||
            err.message?.includes('AUTH_EXPIRED')) {
          console.error('[Auth] Token expired, redirecting to login...');
          sessionStorage.setItem('returnTo', window.location.pathname + window.location.search);
          window.location.replace('/login.html');
        }
        throw err;
      }
    }

    async function loadFolders() {
      try {
        const data = await fetchJSON('/.netlify/functions/dropbox-list-folders');
        const select = $('folderSelect');

        if (!data.folders || data.folders.length === 0) {
          select.innerHTML = '<option value="">No folders found</option>';
          return;
        }

        select.innerHTML = '<option value="">-- Select a folder --</option>';
        data.folders.forEach(folder => {
          const opt = document.createElement('option');
          opt.value = folder.path_lower;
          opt.textContent = folder.name;
          select.appendChild(opt);
        });

        select.addEventListener('change', (e) => {
          selectedFolder = e.target.value;
          $('btnStart').disabled = !selectedFolder;
        });

      } catch (err) {
        console.error('Failed to load folders:', err);
        $('folderSelect').innerHTML = '<option value="">Error loading folders</option>';
      }
    }

    function updateStep(num, status) {
      const step = $(`step${num}`);
      const statusEl = $(`status${num}`);

      step.classList.remove('active', 'complete', 'warning');
      if (status === 'active') {
        step.classList.add('active');
        statusEl.innerHTML = '<span class="spinner"></span>Running...';
      } else if (status === 'complete') {
        step.classList.add('complete');
        statusEl.textContent = '‚úì Complete';
      } else if (status === 'warning') {
        step.classList.add('warning');
        // Status text set by caller
      }

      // Update progress bar
      const progress = (num / 4) * 100;
      $('progressBar').style.width = `${progress}%`;
    }

    // Upload files in batches to avoid payload limits
    async function uploadFilesInBatches(files) {
      const MAX_BATCH_SIZE_BYTES = 5 * 1024 * 1024; // 5MB per batch (Netlify limit is 6MB)
      const allUploadedFiles = [];

      // Prepare file data with base64 encoding
      const fileData = await Promise.all(files.map(async (file) => {
        const base64 = await new Promise((resolve) => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result.split(',')[1]);
          reader.readAsDataURL(file);
        });

        return {
          name: file.name,
          mime: file.type,
          data: base64,
          base64Size: base64.length,
        };
      }));

      // Smart batching by size
      const batches = [];
      let currentBatch = [];
      let currentBatchSize = 0;

      for (const file of fileData) {
        if (file.base64Size > MAX_BATCH_SIZE_BYTES) {
          // Large file goes alone
          if (currentBatch.length > 0) {
            batches.push(currentBatch);
            currentBatch = [];
            currentBatchSize = 0;
          }
          batches.push([file]);
        } else if (currentBatchSize + file.base64Size > MAX_BATCH_SIZE_BYTES) {
          // Start new batch
          batches.push(currentBatch);
          currentBatch = [file];
          currentBatchSize = file.base64Size;
        } else {
          // Add to current batch
          currentBatch.push(file);
          currentBatchSize += file.base64Size;
        }
      }

      if (currentBatch.length > 0) {
        batches.push(currentBatch);
      }

      // Upload batches
      for (let i = 0; i < batches.length; i++) {
        const batch = batches[i];
        $('status1').innerHTML = `<span class="spinner"></span>Uploading batch ${i + 1}/${batches.length}...`;

        const uploadRes = await fetchJSON('/.netlify/functions/ingest-local-upload', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ files: batch }),
        });

        allUploadedFiles.push(...uploadRes.files);
      }

      return allUploadedFiles;
    }

    async function checkEbaySetup() {
      // Check if user has required eBay policies and location
      try {
        const [policiesRes, locationRes] = await Promise.all([
          fetchJSON('/.netlify/functions/ebay-get-policy-defaults'),
          fetchJSON('/.netlify/functions/ebay-get-location-user')
        ]);
        
        const missingItems = [];
        const policies = policiesRes?.defaults || {};
        
        if (!policies.fulfillment) missingItems.push('Fulfillment Policy');
        if (!policies.payment) missingItems.push('Payment Policy');
        if (!policies.return) missingItems.push('Return Policy');
        if (!locationRes?.merchantLocationKey) missingItems.push('Inventory Location');
        
        if (missingItems.length > 0) {
          const msg = `‚ùå Missing required eBay setup:\n\n${missingItems.map(item => '‚Ä¢ ' + item).join('\n')}\n\nPlease complete setup before using Quick List.`;
          alert(msg);
          
          // Redirect to setup page
          if (confirm('Go to Setup page now?')) {
            window.location.href = '/onboarding.html';
          }
          return false;
        }
        
        return true;
      } catch (err) {
        console.error('[Quick List] Setup check failed:', err);
        // Allow to proceed if check fails (might be network issue)
        return true;
      }
    }

    async function startPipeline() {
      // Pre-flight check: Verify user has required eBay setup
      const setupOk = await checkEbaySetup();
      if (!setupOk) {
        return;
      }
      
      // Get promotion settings for this run
      const promotionSettings = getPromotionSettings();
      if (promotionSettings === null) {
        return; // Validation failed (custom rate out of range)
      }
      
      console.log('[Quick List] Promotion settings for this run:', promotionSettings);
      
      const btn = $('btnStart');
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner"></span>Processing...';
      $('results').classList.remove('show');

      // Reset all steps to clear previous run state
      for (let i = 1; i <= 4; i++) {
        const step = $(`step${i}`);
        const status = $(`status${i}`);
        step.classList.remove('active', 'complete', 'warning');
        status.textContent = 'Pending';
      }
      $('progressBar').style.width = '0%';

      // Hide orphans warning from previous run
      $('orphansWarning').style.display = 'none';

      try {
        let scanJobId;

        if (uploadMethod === 'local') {
          // LOCAL UPLOAD FLOW
          if (selectedFiles.length === 0) {
            alert('Please select files to upload');
            return;
          }

          // Step 1a: Upload files
          updateStep(1, 'active');
          $('status1').innerHTML = '<span class="spinner"></span>Uploading files...';

          const uploadedFiles = await uploadFilesInBatches(selectedFiles);
          const stagedUrls = uploadedFiles.map(f => f.stagedUrl);

          // Step 1b: Start scan with stagedUrls
          $('status1').innerHTML = '<span class="spinner"></span>Starting analysis...';

          const scanRes = await fetchJSON('/.netlify/functions/smartdrafts-scan-bg', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ stagedUrls })
          });

          console.log('[Quick List] Scan start response:', scanRes);

          if (!scanRes.ok || !scanRes.jobId) {
            const errorDetail = scanRes.error || scanRes.message || 'Scan failed to start';
            console.error('[Quick List] Scan failed:', scanRes);
            throw new Error(errorDetail);
          }

          scanJobId = scanRes.jobId;

        } else {
          // DROPBOX FLOW
          if (!selectedFolder) {
            alert('Please select a Dropbox folder first');
            return;
          }

          // Step 1: Scan/Analyze (enqueue background job)
          updateStep(1, 'active');
          const scanRes = await fetchJSON('/.netlify/functions/smartdrafts-scan-bg', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              path: selectedFolder,
              force: false
            })
          });

          console.log('[Quick List] Dropbox scan start response:', scanRes);

          if (!scanRes.ok || !scanRes.jobId) {
            const errorDetail = scanRes.error || scanRes.message || 'Scan failed to start';
            console.error('[Quick List] Dropbox scan failed:', scanRes);
            throw new Error(errorDetail);
          }

          scanJobId = scanRes.jobId;
        }

        currentJobId = scanJobId;
        console.log('[Quick List] Scan job started:', currentJobId);

        // Poll for scan completion
        let scanComplete = false;
        let attempts = 0;
        const maxAttempts = 200; // 5 minutes max (1.5s intervals) - increased for large batches

        while (!scanComplete && attempts < maxAttempts) {
          await new Promise(resolve => setTimeout(resolve, 1500));
          attempts++;

          const statusRes = await fetchJSON(`/.netlify/functions/smartdrafts-scan-status?jobId=${currentJobId}`);

          if (statusRes.state === 'complete') {
            scanComplete = true;
            updateStep(1, 'complete');
            $('totalImages').textContent = (statusRes.groups || []).length || 0;
            console.log('[Quick List] Scan complete:', statusRes.groups?.length, 'groups');
          } else if (statusRes.state === 'error') {
            throw new Error(statusRes.error || 'Scan failed');
          } else {
            const progress = Math.min(95, Math.round((attempts / maxAttempts) * 100));
            $('status1').innerHTML = `<span class="spinner"></span>Analyzing... ${progress}%`;
          }
        }

        if (!scanComplete) {
          throw new Error('Scan timeout after 5 minutes');
        }

        // Step 2: Pair using pairing-v2 (existing working endpoint)
        updateStep(2, 'active');
        $('status2').innerHTML = '<span class="spinner"></span>Starting pairing...';
        
        const pairStartRes = await fetchJSON('/.netlify/functions/smartdrafts-pairing-v2-start-from-scan', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ scanJobId: currentJobId })
        });

        if (!pairStartRes.ok || !pairStartRes.jobId) {
          throw new Error(pairStartRes.error || 'Failed to start pairing');
        }

        const pairingJobId = pairStartRes.jobId;
        console.log('[Quick List] Pairing job started:', pairingJobId);

        // Poll for pairing completion (max 10 minutes, check every 10 seconds)
        let pairingComplete = false;
        let pairAttempts = 0;
        let products = [];
        let unpaired = [];

        while (!pairingComplete && pairAttempts++ < 120) {
          // Adaptive polling: 3s for first 20 checks (1min), 5s for next 24 (2min), 10s after that
          const pollDelay = pairAttempts <= 20 ? 3000 : pairAttempts <= 44 ? 5000 : 10000;
          await new Promise(resolve => setTimeout(resolve, pollDelay));

          const statusRes = await fetchJSON(`/.netlify/functions/smartdrafts-pairing-v2-status?jobId=${pairingJobId}`);

          if (statusRes.status === 'completed') {
            pairingComplete = true;
            
            const pairs = statusRes.result?.pairs || [];
            unpaired = statusRes.result?.unpaired || [];
            
            // Convert pairs to products
            products = pairs.map((pair, index) => ({
              productId: `product-${index + 1}`,
              brand: pair.brand || null,
              brandWebsite: pair.brandWebsite || null,
              title: pair.title || null,
              product: pair.product || null,
              keyText: pair.keyText || [],
              categoryPath: pair.categoryPath || undefined,
              heroDisplayUrl: pair.frontUrl || '',
              backDisplayUrl: pair.backUrl || ''
            }));
            
            // Add high-quality unpaired fronts as single-image products
            // After two-pass pairing, any unpaired front is definitely a solo product
            const unpairedFronts = unpaired.filter(item => {
              return item.panel === 'front' && item.imageUrl; // Must be front panel with valid URL
            });
            
            if (unpairedFronts.length > 0) {
              console.log(`[Quick List] Creating ${unpairedFronts.length} single-image products from unpaired fronts (survived two-pass pairing)`);
              
              unpairedFronts.forEach((item, index) => {
                products.push({
                  productId: `product-single-${index + 1}`,
                  brand: item.brand || null,
                  brandWebsite: item.brandWebsite || null,
                  title: item.title || null,
                  product: item.product || null,
                  keyText: item.keyText || [],
                  categoryPath: item.categoryPath || undefined,
                  heroDisplayUrl: item.imageUrl,
                  backDisplayUrl: '' // No back image
                });
              });
              
              // Remove the unpaired fronts from the unpaired list since we're using them as products
              unpaired = unpaired.filter(item => item.panel !== 'front');
            }

            $('totalPaired').textContent = products.length;
            
            // Show pairing details in console for debugging
            console.log('[Quick List] Pairing Results:');
            console.log(`  ‚úÖ Paired: ${pairs.length} products`);
            console.log(`  ‚ö†Ô∏è Unpaired: ${unpaired.length} images`);
            
            pairs.forEach((pair, idx) => {
              console.log(`\nPair ${idx + 1}:`);
              console.log(`  Front: ${pair.front}`);
              console.log(`  Back: ${pair.back}`);
              console.log(`  Brand: ${pair.brand || 'null'}`);
              console.log(`  Product: ${pair.product || 'null'}`);
              console.log(`  Confidence: ${pair.confidence || 'N/A'}`);
            });
            
            if (unpaired.length > 0) {
              console.log('\n‚ùå Unpaired Images:');
              unpaired.forEach(item => {
                console.log(`  ${item.imagePath}: ${item.reason}`);
              });
            }

            if (unpaired.length > 0) {
              $('orphansCount').textContent = unpaired.length;
              $('orphansWarning').style.display = 'block';
              
              // Populate rejected images grid
              const grid = $('rejectedImagesGrid');
              grid.innerHTML = ''; // Clear previous content
              
              unpaired.forEach(item => {
                const card = document.createElement('div');
                card.style.cssText = 'background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(251, 191, 36, 0.3); border-radius: 8px; padding: 0.75rem; display: flex; flex-direction: column; gap: 0.5rem;';
                
                // Image thumbnail
                const img = document.createElement('img');
                img.src = item.imageUrl || '';
                img.alt = item.imagePath || 'Rejected image';
                img.style.cssText = 'width: 100%; height: 150px; object-fit: cover; border-radius: 4px; background: rgba(0, 0, 0, 0.2);';
                img.onerror = () => {
                  img.style.display = 'none';
                  // Show filename if image fails to load
                  const filename = document.createElement('div');
                  filename.textContent = item.imagePath?.split('/').pop() || 'Unknown';
                  filename.style.cssText = 'font-size: 0.75rem; color: var(--muted); text-align: center; padding: 1rem;';
                  card.insertBefore(filename, card.firstChild);
                };
                
                // Filename
                const filename = document.createElement('div');
                filename.textContent = item.imagePath?.split('/').pop() || 'Unknown';
                filename.style.cssText = 'font-size: 0.75rem; font-weight: 500; color: var(--text-primary); overflow: hidden; text-overflow: ellipsis; white-space: nowrap;';
                filename.title = item.imagePath || '';
                
                // Reason
                const reason = document.createElement('div');
                reason.textContent = item.reason || 'Unknown reason';
                reason.style.cssText = 'font-size: 0.7rem; color: rgb(251, 191, 36); line-height: 1.4;';
                
                card.appendChild(img);
                card.appendChild(filename);
                card.appendChild(reason);
                grid.appendChild(card);
              });
            }

            console.log('[Quick List] Pairing complete:', products.length, 'products');
          } else if (statusRes.status === 'failed') {
            throw new Error(statusRes.error || 'Pairing failed');
          } else {
            const progress = Math.min(95, Math.round((pairAttempts / 120) * 100));
            $('status2').innerHTML = `<span class="spinner"></span>Pairing images... ${progress}%`;
          }
        }

        if (!pairingComplete) {
          throw new Error('Pairing timeout');
        }

        if (products.length === 0) {
          throw new Error('No products were paired');
        }

        updateStep(2, 'complete');

        // Step 3: Create Drafts (existing working endpoint)
        updateStep(3, 'active');
        $('status3').innerHTML = '<span class="spinner"></span>Starting draft creation...';

        const draftBgRes = await fetchJSON('/.netlify/functions/smartdrafts-create-drafts-bg', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            products,
            promotion: promotionSettings
          })
        });

        if (!draftBgRes.ok || !draftBgRes.jobId) {
          throw new Error(draftBgRes.error || 'Failed to start draft creation');
        }

        const draftJobId = draftBgRes.jobId;
        console.log('[Quick List] Draft job started:', draftJobId);

        // Poll for draft completion (max 10 minutes, check every 10 seconds)
        let draftAttempts = 0;
        let drafts = [];

        while (draftAttempts++ < 120) {
          // Adaptive polling: 3s for first 20 checks (1min), 5s for next 24 (2min), 10s after that
          const pollDelay = draftAttempts <= 20 ? 3000 : draftAttempts <= 44 ? 5000 : 10000;
          await new Promise(resolve => setTimeout(resolve, pollDelay));

          const statusRes = await fetchJSON(`/.netlify/functions/smartdrafts-create-drafts-status?jobId=${encodeURIComponent(draftJobId)}`);

          if (!statusRes.ok) continue;

          const job = statusRes.job || {};
          const processed = job.processedProducts || 0;
          const total = job.totalProducts || products.length;

          $('status3').innerHTML = `<span class="spinner"></span>Creating drafts (${processed}/${total})...`;

          if (job.state === 'completed') {
            drafts = job.drafts || [];
            $('totalDrafts').textContent = drafts.length;
            console.log('[Quick List] Drafts complete:', drafts.length);
            break;
          } else if (job.state === 'error') {
            throw new Error(job.error || 'Draft creation failed');
          }
        }

        if (drafts.length === 0) {
          throw new Error('Draft creation timed out or failed');
        }

        updateStep(3, 'complete');
        console.log('[Quick List] Drafts received:', JSON.stringify(drafts, null, 2));

        // Step 4: Publish to eBay Drafts
        updateStep(4, 'active');

        // Build groups with proper structure for create-ebay-draft-user
        // Match drafts to products by index
        const groupsWithDrafts = drafts
          .map((draft, idx) => {
            if (!draft) return null; // Skip failed drafts

            const product = products[idx];
            if (!product) return null;

            // Skip drafts with missing price or images
            if (!draft.price || draft.price <= 0) {
              console.warn(`[Quick List] Skipping ${draft.productId} - no price available`);
              return null;
            }

            const images = draft.images || [];
            if (images.length === 0) {
              console.warn(`[Quick List] Skipping ${draft.productId} - no images available`);
              return null;
            }

            return {
              groupId: draft.productId || product.productId || product.groupId,
              brand: draft.brand || 'Unknown',
              product: draft.product || 'Product',
              variant: product.variant,
              size: product.size,
              images: images,
              title: draft.title,
              description: draft.description,
              aspects: draft.aspects,
              price: draft.price,
              pricing: { ebay: draft.price },
              quantity: 1,
              condition: draft.condition,
              category: draft.category,
              categoryPath: draft.category?.title || product.categoryPath
            };
          })
          .filter(g => g !== null); // Remove nulls

        if (groupsWithDrafts.length === 0) {
          throw new Error('No valid drafts to publish to eBay');
        }

        console.log('[Quick List] Publishing', groupsWithDrafts.length, 'drafts to eBay');

        const pubRes = await fetchJSON('/.netlify/functions/create-ebay-draft-user', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            jobId: currentJobId,
            groups: groupsWithDrafts
          })
        });

        // Handle merchant location key error with helpful message
        if (!pubRes.ok && pubRes.error === 'Invalid merchantLocationKey') {
          const invalidKey = pubRes.invalidKey || 'unknown';
          const availableKeys = Array.isArray(pubRes.availableKeys) ? pubRes.availableKeys.join(', ') : 'none';
          const errorMsg = `‚ùå Inventory Location Error\n\n` +
            `The location "${invalidKey}" was not found in your eBay account.\n\n` +
            `Available locations: ${availableKeys}\n\n` +
            `To fix this:\n` +
            `1. Go to Settings ‚Üí Inventory Locations\n` +
            `2. Create a location or set an existing one as default\n` +
            `3. Return here and try again\n\n` +
            `Would you like to go to Inventory Locations now?`;
          
          if (confirm(errorMsg)) {
            window.location.href = '/location.html';
            return;
          }
          throw new Error(`Invalid inventory location: ${invalidKey}`);
        }

        if (!pubRes.ok) {
          throw new Error(pubRes.error || 'Publishing to eBay failed');
        }

        updateStep(4, 'complete');
        
        // Handle both dry-run and real publish responses
        const isDryRun = pubRes.dryRun === true;
        const published = isDryRun ? (pubRes.count || 0) : (pubRes.created || 0);
        
        if (isDryRun) {
          console.log('[Quick List] DRY RUN - Previewed', published, 'drafts (not actually published)');
        } else {
          console.log('[Quick List] Published', published, 'drafts to eBay');
        }

        // Show results
        $('progressBar').style.width = '100%';
        $('results').classList.add('show');
        btn.textContent = '‚úì Complete!';
        btn.style.background = 'var(--success)';

      } catch (err) {
        console.error('Pipeline error:', err);

        // Check if it's an auth error - user will be redirected, so don't show alert
        if (err.message?.includes('Authentication') ||
            err.message?.includes('AUTH_EXPIRED') ||
            err.message?.includes('Unauthorized')) {
          // Auth error - redirect is already happening in fetchJSON
          return;
        }

        // Mark the current active step as warning state
        for (let i = 1; i <= 4; i++) {
          const step = $(`step${i}`);
          if (step.classList.contains('active')) {
            step.classList.remove('active');
            step.classList.add('warning');
            $(`status${i}`).textContent = 'Failed';
            break;
          }
        }

        // Show friendly error message for common issues
        let errorMessage = err.message;
        if (err.message?.includes('Invalid inventory location')) {
          errorMessage = `‚ö†Ô∏è ${err.message}\n\nPlease set up your inventory location in Settings before creating listings.`;
        }

        alert(`Error: ${errorMessage}`);
        btn.disabled = false;
        btn.textContent = 'üîÑ Retry Quick List';
        btn.style.background = 'linear-gradient(135deg, var(--primary) 0%, var(--primary-600) 100%)';
      }
    }

    function resetPipeline() {
      // Reset all steps
      for (let i = 1; i <= 4; i++) {
        const step = $(`step${i}`);
        const status = $(`status${i}`);
        step.classList.remove('active', 'complete', 'warning');
        status.textContent = 'Pending';
      }

      // Hide orphans warning
      $('orphansWarning').style.display = 'none';

      $('progressBar').style.width = '0%';
      $('results').classList.remove('show');
      $('btnStart').disabled = false;
      $('btnStart').textContent = 'üöÄ Start Quick List';
      $('btnStart').style.background = 'linear-gradient(135deg, var(--primary) 0%, var(--primary-600) 100%)';
      currentJobId = null;
    }

    function initUserMenu() {
      const userCard = document.getElementById('userCard');
      const userMenu = document.getElementById('userMenu');
      
      if (!userCard || !userMenu) return;
      
      userCard.addEventListener('click', (e) => {
        e.stopPropagation();
        const isVisible = userMenu.style.display !== 'none';
        userMenu.style.display = isVisible ? 'none' : 'block';
      });
      
      // Close menu when clicking outside
      document.addEventListener('click', (e) => {
        if (!userCard.contains(e.target) && !userMenu.contains(e.target)) {
          userMenu.style.display = 'none';
        }
      });
    }
    
    // Promotion settings state
    let defaultPromotionSettings = {
      enabled: false,
      rate: null
    };
    
    // Load user's default promotion settings
    async function loadPromotionSettings() {
      try {
        const response = await authClient.authFetch('/.netlify/functions/user-settings-get');
        if (response.ok) {
          const settings = await response.json();
          defaultPromotionSettings = {
            enabled: settings.autoPromoteEnabled || false,
            rate: settings.defaultPromotionRate || null
          };
          
          // Update the default option info text
          const infoEl = document.getElementById('defaultPromotionInfo');
          if (infoEl) {
            if (defaultPromotionSettings.enabled && defaultPromotionSettings.rate) {
              infoEl.textContent = `Promotion enabled at ${defaultPromotionSettings.rate}% ad rate`;
              infoEl.style.color = 'var(--success)';
            } else {
              infoEl.textContent = 'No promotion (not configured in settings)';
              infoEl.style.color = 'var(--text-muted)';
            }
          }
        }
      } catch (err) {
        console.error('[Quick List] Failed to load promotion settings:', err);
        const infoEl = document.getElementById('defaultPromotionInfo');
        if (infoEl) {
          infoEl.textContent = 'Failed to load settings';
          infoEl.style.color = '#ef4444';
        }
      }
    }
    
    // Handle promotion radio button changes
    function initPromotionControls() {
      const customRadio = document.getElementById('promotionCustom');
      const customInput = document.getElementById('customPromotionInput');
      const radios = document.querySelectorAll('input[name="promotionMode"]');
      
      radios.forEach(radio => {
        radio.addEventListener('change', () => {
          if (customInput) {
            customInput.style.display = customRadio?.checked ? 'block' : 'none';
          }
        });
      });
    }
    
    // Get current promotion settings for this run
    function getPromotionSettings() {
      const mode = document.querySelector('input[name="promotionMode"]:checked')?.value;
      
      if (mode === 'none') {
        return { enabled: false, rate: null };
      } else if (mode === 'custom') {
        const rate = parseFloat(document.getElementById('customPromotionRate')?.value || '0');
        if (rate < 1 || rate > 20) {
          alert('Please enter a promotion rate between 1% and 20%');
          return null;
        }
        return { enabled: true, rate };
      } else {
        // default
        return defaultPromotionSettings;
      }
    }
    
    async function bootstrap() {
      try {
        const ok = await authClient.requireAuth();
        if (!ok) return;
        await authClient.updateUserDisplay().catch(() => {});

        // Load Dropbox folders and promotion settings
        await Promise.all([
          loadFolders(),
          loadPromotionSettings()
        ]);
        
        // Initialize promotion controls
        initPromotionControls();
      } catch (e) {
        console.error('Auth check failed', e);
      }
    }

    initUserMenu();
    bootstrap();
  </script>
  
  </main>
  </div>
  </div>
  
  <!-- Mobile Menu Script -->
  <script>
    (function() {
      const menuButton = document.getElementById('mobileMenuButton');
      const backdrop = document.getElementById('mobileBackdrop');
      const shell = document.querySelector('.dp-shell');
      
      if (menuButton && backdrop && shell) {
        // Close menu when clicking backdrop
        backdrop.addEventListener('click', () => {
          shell.classList.remove('dp-shell--nav-open');
        });
        
        // Toggle menu when clicking hamburger
        menuButton.addEventListener('click', () => {
          const willOpen = !shell.classList.contains('dp-shell--nav-open');
          shell.classList.toggle('dp-shell--nav-open', willOpen);
          menuButton.setAttribute('aria-expanded', willOpen);
        });
        
        // Close menu when clicking nav link
        const navLinks = document.querySelectorAll('.dp-sidebar a');
        navLinks.forEach(link => {
          link.addEventListener('click', () => {
            shell.classList.remove('dp-shell--nav-open');
          });
        });
      }
    })();
  </script>
</body>
</html>
