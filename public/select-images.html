<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Select Images from Dropbox</title>
  <link rel="stylesheet" href="/draftpilot.css">
  <style>
    body { margin: 24px; }
    header { display: flex; align-items: center; gap: 12px; flex-wrap: wrap; margin-bottom: 24px; }
    header h1 { margin: 0; font-size: 1.5rem; }
    .form-row { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
    .form-row input[type=text] { 
      padding: 0.75rem 1rem; 
      min-width: 320px; 
      background: var(--bg-card);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-md);
      color: var(--text-primary);
      font-size: 0.9375rem;
    }
    .form-row input[type=text]:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-soft);
    }
    .form-row input[type=number] {
      width: 100px;
      padding: 0.75rem;
      background: var(--bg-card);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-md);
      color: var(--text-primary);
    }
    .form-row label {
      display: flex;
      align-items: center;
      gap: 6px;
      color: var(--text-secondary);
      cursor: pointer;
    }
    .picker { margin-top: 24px; }
    .select-wrap { position: relative; width: 100%; max-width: 720px; }
    
    /* Grid and Cards */
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 12px; margin-top: 24px; }
    .card { 
      border: 1px solid var(--border-subtle); 
      border-radius: var(--radius-md); 
      overflow: hidden; 
      background: var(--bg-card);
      transition: border-color 0.2s ease;
    }
    .card:hover { border-color: var(--accent); }
    .card img { width: 100%; height: 160px; object-fit: contain; background: var(--bg-elevated, #1a1a2e); display: block; }
    .card .cap { padding: 10px; font-size: 0.8125rem; color: var(--text-secondary); }
    
    .bar { display: flex; gap: 12px; margin-top: 24px; }
    textarea { 
      width: 100%; 
      max-width: 840px; 
      height: 120px; 
      font-family: ui-monospace, Menlo, Consolas, monospace; 
      font-size: 0.8125rem; 
      padding: 12px;
      background: var(--bg-card);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-md);
      color: var(--text-primary);
    }
    section h3 { margin: 24px 0 12px; font-size: 1rem; }
  </style>
</head>
<body>
  <header>
    <h1>Select Images</h1>
    <form class="form-row" id="frm">
      <input type="text" id="path" name="path" value="/EBAY" placeholder="Dropbox path" />
      <label><input type="checkbox" id="recursive" /> Recursive</label>
      <input type="number" id="limit" placeholder="Limit" />
      <button type="submit" class="dp-btn dp-btn-primary">Load</button>
    </form>
  </header>

  <section class="picker">
    <div class="select-wrap dp-dropdown" id="selectWrap">
      <div class="dp-dropdown__trigger" id="dropdown">
        <span class="dp-dropdown__trigger-text placeholder" id="dropdownText">Choose images…</span>
        <svg class="dp-dropdown__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="6 9 12 15 18 9"></polyline>
        </svg>
      </div>
      <div class="dp-dropdown__panel" id="options"></div>
      <div class="dp-dropdown__chips" id="chips"></div>
    </div>
  </section>

  <section class="bar">
    <button id="copy" class="dp-btn dp-btn-secondary">Copy selected URLs</button>
    <button id="clear" class="dp-btn dp-btn-secondary">Clear</button>
  </section>

  <section class="grid" id="grid"></section>

  <section>
    <h3>Selected URLs (comma-separated)</h3>
    <textarea id="out" readonly></textarea>
  </section>

  <script>
    const $ = (s) => document.querySelector(s);
    const optsEl = $('#options');
    const dropdown = $('#dropdown');
    const dropdownWrap = $('#selectWrap');
    const dropdownText = $('#dropdownText');
    const chips = $('#chips');
    const grid = $('#grid');
    const out = $('#out');

    let items = [];
    const selected = new Map(); // key: url, value: item

    function optionHtml(it){
      const thumb = it.proxiedUrl;
      return `<div class="dp-dropdown__option" data-url="${encodeURIComponent(it.proxiedUrl)}">
        <img class="dp-dropdown__option-thumb" src="${thumb}" alt="${it.name}" />
        <div class="dp-dropdown__option-content">
          <div class="dp-dropdown__option-title">${it.name}</div>
          <div class="dp-dropdown__option-subtitle">${it.path}</div>
        </div>
        <input type="checkbox" style="width:16px;height:16px;accent-color:var(--accent)" />
      </div>`;
    }

    function chipHtml(it){
      return `<span class="dp-dropdown__chip" data-url="${encodeURIComponent(it.proxiedUrl)}">
        <img src="${it.proxiedUrl}" /> ${it.name}
      </span>`;
    }

    function cardHtml(it){
      return `<div class="card"><img src="${it.proxiedUrl}" alt="${it.name}" /><div class="cap">${it.name}</div></div>`;
    }

    function refreshSelected(){
      chips.innerHTML = Array.from(selected.values()).map(chipHtml).join('');
      grid.innerHTML = Array.from(selected.values()).map(cardHtml).join('');
      out.value = Array.from(selected.keys()).join(',');
      dropdownText.textContent = selected.size ? `${selected.size} selected` : 'Choose images…';
      dropdownText.classList.toggle('placeholder', selected.size === 0);
    }

    dropdown.addEventListener('click', () => {
      dropdownWrap.classList.toggle('open');
    });

    document.addEventListener('click', (e) => {
      if (!dropdownWrap.contains(e.target)) { 
        dropdownWrap.classList.remove('open'); 
      }
    });

    optsEl.addEventListener('click', (e) => {
      const opt = e.target.closest('.dp-dropdown__option');
      if (!opt) return;
      const url = decodeURIComponent(opt.getAttribute('data-url'));
      const it = items.find(i => i.proxiedUrl === url);
      if (!it) return;
      const cb = opt.querySelector('input[type=checkbox]');
      const checked = !cb.checked; // toggle
      cb.checked = checked;
      opt.classList.toggle('selected', checked);
      if (checked) selected.set(url, it); else selected.delete(url);
      refreshSelected();
    });

    $('#clear').addEventListener('click', () => { 
      selected.clear(); 
      optsEl.querySelectorAll('.dp-dropdown__option').forEach(opt => {
        opt.classList.remove('selected');
        const cb = opt.querySelector('input[type=checkbox]');
        if (cb) cb.checked = false;
      });
      refreshSelected(); 
    });
    $('#copy').addEventListener('click', async () => { try { await navigator.clipboard.writeText(out.value); dropdown.focus(); } catch {} });

    $('#frm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const path = $('#path').value || '/EBAY';
      const recursive = $('#recursive').checked ? '1' : '0';
      const limit = $('#limit').value;
      const url = new URL('/.netlify/functions/dropbox-list-images', window.location.origin);
      url.searchParams.set('path', path);
      if (recursive === '1') url.searchParams.set('recursive', '1');
      if (limit) url.searchParams.set('limit', limit);
      const r = await fetch(url);
      const j = await r.json();
      items = j.items || [];
      optsEl.innerHTML = items.map(optionHtml).join('');
      selected.clear(); refreshSelected();
    });

    // initial load
    $('#frm').dispatchEvent(new Event('submit'));
  </script>
</body>
</html>
