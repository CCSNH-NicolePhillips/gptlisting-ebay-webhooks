<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Select Images from Dropbox</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 16px; }
    header { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
    input[type=text] { padding: 6px 8px; min-width: 360px; }
    button { padding: 6px 10px; }
    .row { display: flex; gap: 12px; align-items: center; }
    .picker { margin-top: 16px; }
    .select-wrap { position: relative; width: 100%; max-width: 720px; }
    .dropdown { border: 1px solid #ccc; border-radius: 8px; padding: 8px; cursor: pointer; background: #fff; display: flex; justify-content: space-between; align-items: center; }
    .dropdown.open { border-color: #0a66c2; box-shadow: 0 0 0 3px rgba(10,102,194,0.12); }
    .dropdown .placeholder { color: #666; }
    .options { position: absolute; z-index: 3; top: calc(100% + 4px); left: 0; right: 0; background: #fff; border: 1px solid #ddd; border-radius: 8px; max-height: 360px; overflow: auto; box-shadow: 0 8px 24px rgba(0,0,0,0.1); }
    .option { display: flex; align-items: center; gap: 10px; padding: 8px; border-bottom: 1px solid #f2f2f2; }
    .option:last-child { border-bottom: none; }
    .option:hover { background: #f7fbff; }
    .thumb { width: 48px; height: 48px; object-fit: cover; border-radius: 6px; background: #f0f0f0; }
    .meta { display: flex; flex-direction: column; font-size: 12px; }
    .meta .name { font-weight: 600; color: #333; }
    .meta .path { color: #666; }
    .chips { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 8px; }
    .chip { display: inline-flex; align-items: center; gap: 6px; background: #e9f3ff; color: #0a66c2; border: 1px solid #cae3ff; border-radius: 999px; padding: 4px 8px; font-size: 12px; }
    .chip img { width: 16px; height: 16px; object-fit: cover; border-radius: 3px; }
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 10px; margin-top: 16px; }
    .card { border: 1px solid #ddd; border-radius: 8px; overflow: hidden; background: #fafafa; }
    .card img { width: 100%; height: 160px; object-fit: cover; display: block; }
    .card .cap { padding: 8px; font-size: 12px; color: #333; }
    .bar { display: flex; gap: 8px; margin-top: 16px; }
    textarea { width: 100%; max-width: 840px; height: 120px; font-family: ui-monospace, Menlo, Consolas, monospace; font-size: 12px; padding: 8px; }
  </style>
</head>
<body>
  <header class="row">
    <h1>Select Images</h1>
    <form class="row" id="frm">
      <input type="text" id="path" name="path" value="/EBAY" />
      <label><input type="checkbox" id="recursive" /> recursive</label>
      <input type="number" id="limit" placeholder="limit" />
      <button type="submit">Load</button>
    </form>
  </header>

  <section class="picker">
    <div class="select-wrap" id="selectWrap">
      <div class="dropdown" id="dropdown"><span class="placeholder">Choose images…</span><span>▾</span></div>
      <div class="options" id="options" style="display:none"></div>
      <div class="chips" id="chips"></div>
    </div>
  </section>

  <section class="bar">
    <button id="copy">Copy selected URLs</button>
    <button id="clear">Clear</button>
  </section>

  <section class="grid" id="grid"></section>

  <section style="margin-top:16px">
    <h3>Selected URLs (comma-separated)</h3>
    <textarea id="out" readonly></textarea>
  </section>

  <script>
    const $ = (s) => document.querySelector(s);
    const optsEl = $('#options');
    const dropdown = $('#dropdown');
    const chips = $('#chips');
    const grid = $('#grid');
    const out = $('#out');
    const wrap = $('#selectWrap');

    let items = [];
    const selected = new Map(); // key: url, value: item

    function prox(u){ return u; }

    function optionHtml(it){
      const thumb = it.proxiedUrl;
      return `<div class="option" data-url="${encodeURIComponent(it.proxiedUrl)}">
        <img class="thumb" src="${thumb}" alt="${it.name}" />
        <div class="meta"><div class="name">${it.name}</div><div class="path">${it.path}</div></div>
        <div style="margin-left:auto"><input type="checkbox" /></div>
      </div>`;
    }

    function chipHtml(it){
      return `<span class="chip" data-url="${encodeURIComponent(it.proxiedUrl)}">
        <img src="${it.proxiedUrl}" /> ${it.name}
      </span>`;
    }

    function cardHtml(it){
      return `<div class="card"><img src="${it.proxiedUrl}" alt="${it.name}" /><div class="cap">${it.name}</div></div>`;
    }

    function refreshSelected(){
      chips.innerHTML = Array.from(selected.values()).map(chipHtml).join('');
      grid.innerHTML = Array.from(selected.values()).map(cardHtml).join('');
      out.value = Array.from(selected.keys()).join(',');
      dropdown.querySelector('.placeholder').textContent = selected.size ? `${selected.size} selected` : 'Choose images…';
    }

    dropdown.addEventListener('click', () => {
      const isOpen = optsEl.style.display !== 'none';
      optsEl.style.display = isOpen ? 'none' : 'block';
      dropdown.classList.toggle('open', !isOpen);
    });

    document.addEventListener('click', (e) => {
      if (!wrap.contains(e.target)) { optsEl.style.display = 'none'; dropdown.classList.remove('open'); }
    });

    optsEl.addEventListener('click', (e) => {
      const opt = e.target.closest('.option');
      if (!opt) return;
      const url = decodeURIComponent(opt.getAttribute('data-url'));
      const it = items.find(i => i.proxiedUrl === url);
      if (!it) return;
      const cb = opt.querySelector('input[type=checkbox]');
      const checked = !cb.checked; // toggle
      cb.checked = checked;
      if (checked) selected.set(url, it); else selected.delete(url);
      refreshSelected();
    });

    $('#clear').addEventListener('click', () => { selected.clear(); refreshSelected(); });
    $('#copy').addEventListener('click', async () => { try { await navigator.clipboard.writeText(out.value); dropdown.focus(); } catch {} });

    $('#frm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const path = $('#path').value || '/EBAY';
      const recursive = $('#recursive').checked ? '1' : '0';
      const limit = $('#limit').value;
      const url = new URL('/.netlify/functions/dropbox-list-images', window.location.origin);
      url.searchParams.set('path', path);
      if (recursive === '1') url.searchParams.set('recursive', '1');
      if (limit) url.searchParams.set('limit', limit);
      const r = await fetch(url);
      const j = await r.json();
      items = j.items || [];
      optsEl.innerHTML = items.map(optionHtml).join('');
      selected.clear(); refreshSelected();
    });

    // initial load
    $('#frm').dispatchEvent(new Event('submit'));
  </script>
</body>
</html>
