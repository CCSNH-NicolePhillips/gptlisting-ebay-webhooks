<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>eBay Policies – DraftPilot</title>
    <link rel="stylesheet" href="/draftpilot.css">
    <style>
      /* Policy-specific table styles */
      .policy-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 16px;
      }
      
      .policy-table thead {
        border-bottom: 1px solid var(--border-subtle);
      }
      
      .policy-table th {
        text-align: left;
        padding: 12px 16px;
        font-size: 0.75rem;
        font-weight: 600;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }
      
      .policy-table td {
        padding: 16px;
        border-bottom: 1px solid var(--border-subtle);
        color: var(--text-primary);
      }
      
      .policy-table tbody tr:hover {
        background: rgba(148, 163, 184, 0.02);
      }
      
      .policy-table tbody tr:last-child td {
        border-bottom: none;
      }
      
      .policy-name {
        font-weight: 500;
        color: var(--text-primary);
      }
      
      .policy-id {
        font-family: 'SF Mono', Monaco, 'Courier New', monospace;
        font-size: 0.8125rem;
        color: var(--text-muted);
      }
      
      .default-badge {
        display: inline-flex;
        align-items: center;
        padding: 4px 10px;
        background: rgba(79, 124, 255, 0.1);
        border: 1px solid rgba(79, 124, 255, 0.2);
        border-radius: 6px;
        font-size: 0.75rem;
        font-weight: 600;
        color: var(--accent);
      }
      
      .policy-actions {
        display: flex;
        gap: 8px;
        justify-content: flex-end;
      }
      
      .btn-inspect,
      .btn-set-default,
      .btn-delete {
        padding: 6px 12px;
        font-size: 0.8125rem;
        border-radius: 6px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.15s ease;
        border: none;
      }
      
      .btn-inspect {
        background: transparent;
        color: var(--text-muted);
        border: 1px solid var(--border-subtle);
      }
      
      .btn-inspect:hover {
        background: rgba(148, 163, 184, 0.05);
        color: var(--text-primary);
      }
      
      .btn-set-default {
        background: transparent;
        color: var(--accent);
        border: 1px solid rgba(79, 124, 255, 0.3);
      }
      
      .btn-set-default:hover {
        background: rgba(79, 124, 255, 0.1);
        border-color: var(--accent);
      }
      
      .btn-delete {
        background: transparent;
        color: #ff6b6b;
        border: 1px solid rgba(255, 107, 107, 0.3);
      }
      
      .btn-delete:hover {
        background: rgba(255, 107, 107, 0.1);
        border-color: #ff6b6b;
      }
      
      .policy-section {
        background: var(--bg-card);
        border: 1px solid var(--border-subtle);
        border-radius: 12px;
        padding: 24px;
        margin-bottom: 24px;
      }
      
      .policy-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 8px;
      }
      
      .policy-header h3 {
        margin: 0;
        font-size: 1.125rem;
        font-weight: 600;
        color: var(--text-primary);
      }
      
      .policy-count {
        font-size: 0.875rem;
        color: var(--text-muted);
      }
      
      .inspector-panel {
        background: var(--bg-card);
        border: 1px solid var(--border-subtle);
        border-radius: 12px;
        padding: 24px;
        margin-top: 24px;
      }
      
      .inspector-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 16px;
      }
      
      .inspector-header h3 {
        margin: 0;
        font-size: 1rem;
        font-weight: 600;
        color: var(--text-primary);
      }
      
      .inspector-summary,
      .inspector-json {
        background: var(--bg-subtle);
        border: 1px solid var(--border-subtle);
        border-radius: 8px;
        padding: 16px;
        overflow: auto;
        font-family: 'SF Mono', Monaco, 'Courier New', monospace;
        font-size: 0.8125rem;
        line-height: 1.6;
        color: var(--text-muted);
      }
      
      .inspector-summary {
        max-height: 180px;
        white-space: pre-wrap;
        margin-bottom: 20px;
      }
      
      .inspector-json {
        max-height: 320px;
      }
      
      .inspector-label {
        font-size: 0.75rem;
        font-weight: 600;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 8px;
      }
    </style>
  </head>
  <body>
    <script src="/auth-client.js"></script>
    <script src="/sidebar-toggle.js"></script>
    
    <!-- Main Dashboard Shell -->
    <div class="dp-shell">
      <!-- Sidebar -->
      <aside class="dp-sidebar">
        <div class="dp-sidebar__brand">
          <img src="logo/LogoWhiteText_NoBg.png" alt="DraftPilot" class="dp-brand-logo" />
        </div>
        
        <nav class="dp-sidebar__nav">
          <div class="dp-nav-group">
            <div class="dp-nav-group__label">APP</div>
            <div class="dp-nav-group__items">
              <a href="/index.html" class="dp-nav-item">
                <svg class="dp-nav-item__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                  <polyline points="9 22 9 12 15 12 15 22"></polyline>
                </svg>
                <span class="dp-nav-item__label">Overview</span>
              </a>
              <a href="/quick-list.html" class="dp-nav-item">
                <svg class="dp-nav-item__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon>
                </svg>
                <span class="dp-nav-item__label">Create Listings</span>
              </a>
              <a href="/drafts.html" class="dp-nav-item">
                <svg class="dp-nav-item__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                  <polyline points="14 2 14 8 20 8"></polyline>
                </svg>
                <span class="dp-nav-item__label">Drafts</span>
              </a>
              <a href="/active-listings.html" class="dp-nav-item">
                <svg class="dp-nav-item__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
                </svg>
                <span class="dp-nav-item__label">Active Listings</span>
              </a>
            </div>
          </div>
          
          <div class="dp-nav-group">
            <div class="dp-nav-group__label">ACCOUNT</div>
            <div class="dp-nav-group__items">
              <a href="/policies-manage.html" class="dp-nav-item dp-nav-item--active">
                <svg class="dp-nav-item__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                  <polyline points="14 2 14 8 20 8"></polyline>
                  <line x1="16" y1="13" x2="8" y2="13"></line>
                  <line x1="16" y1="17" x2="8" y2="17"></line>
                  <polyline points="10 9 9 9 8 9"></polyline>
                </svg>
                <span class="dp-nav-item__label">eBay Policies</span>
              </a>
              <a href="/location.html" class="dp-nav-item">
                <svg class="dp-nav-item__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                  <circle cx="12" cy="10" r="3"></circle>
                </svg>
                <span class="dp-nav-item__label">Inventory Locations</span>
              </a>
              <a href="/settings.html" class="dp-nav-item">
                <svg class="dp-nav-item__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="3"></circle>
                  <path d="M12 1v6m0 6v6m5.196-15.196l-4.243 4.243m0 5.656l-4.242 4.243m15.195-5.196l-4.242-4.243m-5.657 0l-4.243-4.243"></path>
                </svg>
                <span class="dp-nav-item__label">Settings</span>
              </a>
              <a href="/faq.html" class="dp-nav-item">
                <svg class="dp-nav-item__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="10"></circle>
                  <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                  <line x1="12" y1="17" x2="12.01" y2="17"></line>
                </svg>
                <span class="dp-nav-item__label">FAQ</span>
              </a>
              <a href="/support.html" class="dp-nav-item">
                <svg class="dp-nav-item__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M18 18.72a9.094 9.094 0 0 0 3.741-.479 3 3 0 0 0-4.682-2.72m.94 3.198.001.031c0 .225-.012.447-.037.666A11.944 11.944 0 0 1 12 21c-2.17 0-4.207-.576-5.963-1.584A6.062 6.062 0 0 1 6 18.719m12 0a5.971 5.971 0 0 0-.941-3.197m0 0A5.995 5.995 0 0 0 12 12.75a5.995 5.995 0 0 0-5.058 2.772m0 0a3 3 0 0 0-4.681 2.72 8.986 8.986 0 0 0 3.74.477m.94-3.197a5.971 5.971 0 0 0-.94 3.197M15 6.75a3 3 0 1 1-6 0 3 3 0 0 1 6 0Zm6 3a2.25 2.25 0 1 1-4.5 0 2.25 2.25 0 0 1 4.5 0Zm-13.5 0a2.25 2.25 0 1 1-4.5 0 2.25 2.25 0 0 1 4.5 0Z"></path>
                </svg>
                <span class="dp-nav-item__label">Support</span>
              </a>
            </div>
          </div>
        </nav>
        
        <div class="dp-sidebar__spacer"></div>
        
        <div class="dp-sidebar__footer">
          <div class="dp-user-card" id="userCard">
            <div class="dp-user-card__avatar" id="userAvatar">U</div>
            <div class="dp-user-card__info">
              <div class="dp-user-card__name" id="userName">Loading...</div>
              <div class="dp-user-card__status" id="userEmail">Signed in</div>
            </div>
          </div>
          <div class="dp-user-menu" id="userMenu" style="display: none;">
            <a href="/logout.html" class="dp-user-menu__item">
              <svg class="dp-user-menu__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                <polyline points="16 17 21 12 16 7"></polyline>
                <line x1="21" y1="12" x2="9" y2="12"></line>
              </svg>
              <span>Sign out</span>
            </a>
          </div>
        </div>
      </aside>
      
      <div class="dp-mobile-backdrop" id="mobileBackdrop"></div>
      
      <!-- Main Content -->
      <div class="dp-main-wrapper">
        <header class="dp-topbar">
          <div class="dp-topbar-left">
            <button
              class="dp-topbar-icon dp-topbar-icon--menu"
              id="mobileMenuButton"
              aria-label="Open navigation"
              type="button"
            >
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="4" y1="6" x2="20" y2="6"></line>
                <line x1="4" y1="12" x2="20" y2="12"></line>
                <line x1="4" y1="18" x2="20" y2="18"></line>
              </svg>
            </button>
            <div class="dp-topbar-heading">
              <h1 class="dp-topbar__title">eBay Policies</h1>
              <p class="dp-topbar__subtitle">Manage shipping, payment, and return policies</p>
            </div>
          </div>
          <div class="dp-topbar-right" style="display: flex !important; gap: 0.75rem;">
            <a href="https://www.ebay.com/bp/manage" target="_blank" class="dp-btn dp-btn-secondary" style="padding: 0.5rem 1rem; font-size: 0.875rem;">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px; margin-right: 0.25rem;">
                <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                <polyline points="15 3 21 3 21 9"></polyline>
                <line x1="10" y1="14" x2="21" y2="3"></line>
              </svg>
              Open in eBay
            </a>
            <a href="/index.html" class="dp-btn dp-btn-secondary" style="padding: 0.5rem 1rem; font-size: 0.875rem;">← Back to Dashboard</a>
            <div class="dp-topbar-avatar" id="topbarAvatar">U</div>
          </div>
        </header>
        
        <main class="dp-main">
          <div id="msg" class="dp-status-message" style="display: none;"></div>

          <div id="msg" class="dp-status-message" style="display: none;"></div>
          
          <!-- Shipping Policies -->
          <div class="policy-section">
            <div class="policy-header">
              <div>
                <h3>Shipping (Fulfillment)</h3>
                <div class="policy-count" id="fStatus">Loading...</div>
              </div>
              <a href="/policy-create.html?type=fulfillment" class="dp-btn dp-btn-primary">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px;">
                  <line x1="12" y1="5" x2="12" y2="19"></line>
                  <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
                Create Policy
              </a>
            </div>
            <table class="policy-table" id="fTable">
              <thead>
                <tr>
                  <th>Policy Name</th>
                  <th>Policy ID</th>
                  <th>Status</th>
                  <th style="text-align: right;">Actions</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
          
          <!-- Payment Policies -->
          <div class="policy-section">
            <div class="policy-header">
              <div>
                <h3>Payment</h3>
                <div class="policy-count" id="pStatus">Loading...</div>
              </div>
              <a href="/policy-create.html?type=payment" class="dp-btn dp-btn-primary">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px;">
                  <line x1="12" y1="5" x2="12" y2="19"></line>
                  <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
                Create Policy
              </a>
            </div>
            <table class="policy-table" id="pTable">
              <thead>
                <tr>
                  <th>Policy Name</th>
                  <th>Policy ID</th>
                  <th>Status</th>
                  <th style="text-align: right;">Actions</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
          
          <!-- Return Policies -->
          <div class="policy-section">
            <div class="policy-header">
              <div>
                <h3>Returns</h3>
                <div class="policy-count" id="rStatus">Loading...</div>
              </div>
              <a href="/policy-create.html?type=return" class="dp-btn dp-btn-primary">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px;">
                  <line x1="12" y1="5" x2="12" y2="19"></line>
                  <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
                Create Policy
              </a>
            </div>
            <table class="policy-table" id="rTable">
              <thead>
                <tr>
                  <th>Policy Name</th>
                  <th>Policy ID</th>
                  <th>Status</th>
                  <th style="text-align: right;">Actions</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
          
          <!-- Promoted Listings (Marketing) -->
          <div class="policy-section">
            <div class="policy-header">
              <div>
                <h3>Promoted Listings (Advertising)</h3>
                <div class="policy-count" id="promoStatus">Loading...</div>
              </div>
              <a href="https://www.ebay.com/sh/mkt/campaigns" target="_blank" class="dp-btn dp-btn-secondary">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px; margin-right: 0.25rem;">
                  <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                  <polyline points="15 3 21 3 21 9"></polyline>
                  <line x1="10" y1="14" x2="21" y2="3"></line>
                </svg>
                View campaigns in eBay
              </a>
            </div>
            <table class="policy-table" id="promoTable">
              <thead>
                <tr>
                  <th>Campaign Name</th>
                  <th>Campaign ID</th>
                  <th>Status</th>
                  <th style="text-align: right;">Actions</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
          
          <!-- Inspector Panel -->
          <div class="inspector-panel" id="inspector" style="display: none;">
            <div class="inspector-header">
              <h3 id="inspectorTitle">Policy Details</h3>
              <button class="dp-btn dp-btn-secondary" id="inspectorHide">Close</button>
            </div>
            <div id="inspectorStatus" class="policy-count">Select a policy to view its full payload and logistics summary.</div>
            <div id="inspectorBody" style="display: none; margin-top: 20px;">
              <div class="inspector-label">Logistics Summary</div>
              <pre class="inspector-summary" id="inspectorSummary">n/a</pre>
              <div class="inspector-label">Raw Payload from eBay</div>
              <pre class="inspector-json" id="inspectorJson">n/a</pre>
            </div>
          </div>
        </main>
      </div>
    </div>
    
    <!-- Mobile Menu Script -->
    <script>
      function initUserMenu() {
        const card = document.getElementById('userCard');
        const menu = document.getElementById('userMenu');
        if (!card || !menu) return;
        
        card.addEventListener('click', (e) => {
          e.stopPropagation();
          const isVisible = menu.style.display === 'block';
          menu.style.display = isVisible ? 'none' : 'block';
        });
        
        document.addEventListener('click', () => {
          menu.style.display = 'none';
        });
      }
      
      (function() {
        const btn = document.getElementById('mobileMenuButton');
        const sidebar = document.querySelector('.dp-sidebar');
        const backdrop = document.getElementById('mobileBackdrop');
        
        if (btn && sidebar && backdrop) {
          btn.addEventListener('click', () => {
            sidebar.classList.toggle('dp-sidebar--mobile-open');
            backdrop.classList.toggle('dp-mobile-backdrop--visible');
          });
          
          backdrop.addEventListener('click', () => {
            sidebar.classList.remove('dp-sidebar--mobile-open');
            backdrop.classList.remove('dp-mobile-backdrop--visible');
          });
        }
      })();
    </script>

    <script>
      // Wait for authClient to be available
      window.addEventListener('DOMContentLoaded', async () => {
        while (typeof authClient === 'undefined') {
          await new Promise(resolve => setTimeout(resolve, 50));
        }
        
        try { 
          await authClient.requireAuth(); 
          await authClient.updateUserDisplay().catch(() => {});
        } catch {}
        
        initUserMenu();
        await init();
      });

      const defaults = { fulfillment: null, payment: null, return: null, promoCampaignId: null };

      async function loadDefaults() {
        try {
          const r = await authClient.authFetch('/.netlify/functions/ebay-get-policy-defaults');
          const j = await r.json();
          Object.assign(defaults, j?.defaults || {});
        } catch {}
      }

      function renderPromoDefaults() {
        const statusEl = document.getElementById('promoStatus');
        if (!statusEl) return;

        const id = defaults.promoCampaignId || '';
        statusEl.textContent = id ? `Default: ${id}` : 'No default configured';
      }

      async function loadPromotionsSection() {
        const table = document.getElementById('promoTable');
        if (!table) return;
        const tbody = table.querySelector('tbody');
        tbody.innerHTML = '';

        let campaigns = [];
        try {
          const r = await authClient.authFetch('/.netlify/functions/ebay-list-campaigns');
          const j = await r.json();
          campaigns = j?.campaigns || [];
        } catch (e) {
          const tr = document.createElement('tr');
          const td = document.createElement('td');
          td.colSpan = 4;
          td.style.textAlign = 'center';
          td.style.padding = '40px';
          td.style.color = 'var(--text-muted)';
          td.textContent = 'Failed to load campaigns: ' + (e?.message || e);
          tr.appendChild(td);
          tbody.appendChild(tr);
          return;
        }

        if (campaigns.length === 0) {
          const tr = document.createElement('tr');
          const td = document.createElement('td');
          td.colSpan = 4;
          td.style.textAlign = 'center';
          td.style.padding = '40px';
          td.style.color = 'var(--text-muted)';
          td.innerHTML = 'No campaigns found. <a href="https://www.ebay.com/sh/mkt/campaigns" target="_blank" rel="noopener">Create a campaign on eBay ↗</a>';
          tr.appendChild(td);
          tbody.appendChild(tr);
          return;
        }

        const chosen = defaults.promoCampaignId || '';
        campaigns.forEach((c) => {
          const tr = document.createElement('tr');
          
          // Name column
          const nameCell = document.createElement('td');
          const nameSpan = document.createElement('span');
          nameSpan.className = 'policy-name';
          nameSpan.textContent = c.name || '(unnamed)';
          nameCell.appendChild(nameSpan);
          
          // ID column
          const idCell = document.createElement('td');
          const idSpan = document.createElement('span');
          idSpan.className = 'policy-id';
          const campaignId = c.campaignId || '';
          idSpan.textContent = campaignId;
          idCell.appendChild(idSpan);
          
          // Status column
          const statusCell = document.createElement('td');
          if (String(campaignId) === String(chosen)) {
            const badge = document.createElement('span');
            badge.className = 'default-badge';
            badge.textContent = 'Default';
            statusCell.appendChild(badge);
          } else if (c.status) {
            const statusSpan = document.createElement('span');
            statusSpan.textContent = c.status;
            statusCell.appendChild(statusSpan);
          }
          
          // Actions column
          const actionsCell = document.createElement('td');
          const actionsDiv = document.createElement('div');
          actionsDiv.className = 'policy-actions';
          
          const setBtn = document.createElement('button');
          setBtn.textContent = 'Set Default';
          setBtn.className = 'btn-set-default';
          setBtn.onclick = async () => {
            try {
              const body = { promoCampaignId: campaignId };
              const r = await authClient.authFetch('/.netlify/functions/ebay-set-policy-defaults', { 
                method: 'POST', 
                headers: {'Content-Type': 'application/json'}, 
                body: JSON.stringify(body)
              });
              const j = await r.json(); 
              Object.assign(defaults, j?.defaults || {});
              renderPromoDefaults();
              await loadPromotionsSection();
              showMsg('✓ Default campaign updated', 'success');
            } catch (e) { 
              showMsg('Failed to set default: ' + (e?.message || e), 'error'); 
            }
          };
          
          const clearBtn = document.createElement('button');
          clearBtn.textContent = 'Clear Default';
          clearBtn.className = 'btn-secondary';
          clearBtn.onclick = async () => {
            try {
              const body = { promoCampaignId: null };
              const r = await authClient.authFetch('/.netlify/functions/ebay-set-policy-defaults', { 
                method: 'POST', 
                headers: {'Content-Type': 'application/json'}, 
                body: JSON.stringify(body)
              });
              const j = await r.json(); 
              Object.assign(defaults, j?.defaults || {});
              renderPromoDefaults();
              await loadPromotionsSection();
              showMsg('✓ Default campaign cleared', 'success');
            } catch (e) { 
              showMsg('Failed to clear default: ' + (e?.message || e), 'error'); 
            }
          };
          
          actionsDiv.appendChild(setBtn);
          if (String(campaignId) === String(chosen)) {
            actionsDiv.appendChild(clearBtn);
          }
          actionsCell.appendChild(actionsDiv);
          
          tr.appendChild(nameCell);
          tr.appendChild(idCell);
          tr.appendChild(statusCell);
          tr.appendChild(actionsCell);
          tbody.appendChild(tr);
        });
      }

      function renderTable(elId, list, typeKey) {
        const table = document.getElementById(elId);
        if (!table) return;
        const tbody = table.querySelector('tbody');
        tbody.innerHTML = '';
        
        if (list.length === 0) {
          const tr = document.createElement('tr');
          const td = document.createElement('td');
          td.colSpan = 4;
          td.style.textAlign = 'center';
          td.style.padding = '40px';
          td.style.color = 'var(--text-muted)';
          td.textContent = 'No policies found. Create your first policy to get started.';
          tr.appendChild(td);
          tbody.appendChild(tr);
          return;
        }
        
        const chosen = defaults[typeKey] || '';
        list.forEach((p) => {
          const tr = document.createElement('tr');
          
          // Name column
          const nameCell = document.createElement('td');
          const nameSpan = document.createElement('span');
          nameSpan.className = 'policy-name';
          nameSpan.textContent = p.name || '(unnamed)';
          nameCell.appendChild(nameSpan);
          
          // ID column
          const idCell = document.createElement('td');
          const idSpan = document.createElement('span');
          idSpan.className = 'policy-id';
          const policyId = p.id || p[`${typeKey}PolicyId`] || '';
          idSpan.textContent = policyId;
          idCell.appendChild(idSpan);
          
          // Status column
          const statusCell = document.createElement('td');
          if (String(policyId) === String(chosen)) {
            const badge = document.createElement('span');
            badge.className = 'default-badge';
            badge.textContent = 'Default';
            statusCell.appendChild(badge);
          }
          
          // Actions column
          const actionsCell = document.createElement('td');
          const actionsDiv = document.createElement('div');
          actionsDiv.className = 'policy-actions';
          
          const inspectBtn = document.createElement('button');
          inspectBtn.textContent = 'Inspect';
          inspectBtn.className = 'btn-inspect';
          inspectBtn.onclick = () => inspectPolicy(typeKey, policyId, p.name);
          
          const setBtn = document.createElement('button');
          setBtn.textContent = 'Set Default';
          setBtn.className = 'btn-set-default';
          setBtn.onclick = async () => {
            try {
              const body = {}; 
              body[typeKey] = policyId;
              const r = await authClient.authFetch('/.netlify/functions/ebay-set-policy-defaults', { 
                method: 'POST', 
                headers: {'Content-Type': 'application/json'}, 
                body: JSON.stringify(body)
              });
              const j = await r.json(); 
              Object.assign(defaults, j?.defaults || {});
              await populate();
              showMsg('✓ Default policy updated', 'success');
            } catch (e) { 
              showMsg('Failed to set default: ' + (e?.message || e), 'error'); 
            }
          };
          
          const delBtn = document.createElement('button');
          delBtn.textContent = 'Delete';
          delBtn.className = 'btn-delete';
          delBtn.onclick = async () => {
            if (!confirm('Delete this policy on eBay? This cannot be undone.')) return;
            try {
              const url = new URL('/.netlify/functions/ebay-delete-policy', window.location.origin);
              url.searchParams.set('type', typeKey);
              url.searchParams.set('id', policyId);
              const r = await authClient.authFetch(url.toString(), { method: 'DELETE' });
              if (!r.ok) { 
                const t = await r.text(); 
                throw new Error(t); 
              }
              showMsg('✓ Policy deleted. Refreshing...', 'success');
              await populate();
            } catch (e) { 
              showMsg('Delete failed: ' + (e?.message || e), 'error'); 
            }
          };
          
          actionsDiv.appendChild(inspectBtn);
          actionsDiv.appendChild(setBtn);
          actionsDiv.appendChild(delBtn);
          actionsCell.appendChild(actionsDiv);
          
          tr.appendChild(nameCell);
          tr.appendChild(idCell);
          tr.appendChild(statusCell);
          tr.appendChild(actionsCell);
          tbody.appendChild(tr);
        });
      }

      function showMsg(s, type = 'info') { 
        const el = document.getElementById('msg'); 
        if (el) {
          el.textContent = s;
          el.className = 'dp-status-message dp-status-message--' + type;
          el.style.display = s ? 'block' : 'none';
          
          if (type === 'success') {
            setTimeout(() => {
              el.style.display = 'none';
            }, 3000);
          }
        }
      }

      function ensureInspectorVisible() {
        const box = document.getElementById('inspector');
        if (box) box.style.display = 'block';
      }

      function formatSummary(typeKey, policy) {
        if (!policy || typeof policy !== 'object') return 'n/a';
        if (typeKey === 'fulfillment') {
          const lines = [];
          const options = Array.isArray(policy.shippingOptions) ? policy.shippingOptions : [];
          options.forEach((opt, idx) => {
            lines.push(`Option ${idx + 1}: ${opt.optionType || 'n/a'} · ${opt.costType || 'n/a'}`);
            const shipTo = opt.shipToLocations?.regionIncluded || [];
            if (shipTo.length) {
              lines.push('  Ship to: ' + shipTo.map((r) => `${r.regionType || ''}:${r.regionName || ''}`).join(', '));
            }
            const services = Array.isArray(opt.shippingServices) ? opt.shippingServices : [];
            services.forEach((svc) => {
              const parts = [svc.shippingServiceCode || 'service'];
              if (svc.shippingCarrierCode) parts.push(`carrier=${svc.shippingCarrierCode}`);
              if (svc.freeShipping) parts.push('free');
              if (!svc.freeShipping && svc.shippingCost?.value)
                parts.push(`cost=${svc.shippingCost.value} ${svc.shippingCost.currency || ''}`.trim());
              if (svc.additionalShippingCost?.value)
                parts.push(`addl=${svc.additionalShippingCost.value} ${svc.additionalShippingCost.currency || ''}`.trim());
              if (svc.sortOrder != null) parts.push(`sort=${svc.sortOrder}`);
              lines.push('  Service: ' + parts.join(' · '));
            });
            if (opt.calculatedShippingRate) {
              const calc = opt.calculatedShippingRate;
              const dims = ['packageLength', 'packageWidth', 'packageHeight']
                .map((k) => calc[k] ? `${k.replace('package','').toLowerCase()}=${calc[k].value}${calc[k].unit ? ' ' + calc[k].unit : ''}` : null)
                .filter(Boolean)
                .join(', ');
              const weights = ['weightMajor', 'weightMinor']
                .map((k) => calc[k] ? `${k.replace('weight','weight ').toLowerCase()}=${calc[k].value}${calc[k].unit ? ' ' + calc[k].unit : ''}` : null)
                .filter(Boolean)
                .join(', ');
              lines.push(`  Calculated rate: ${calc.measurementSystem || 'n/a'} · ${calc.packageType || 'n/a'}`);
              if (dims) lines.push('    ' + dims);
              if (weights) lines.push('    ' + weights);
            }
          });
          return lines.length ? lines.join('\n') : 'No shipping options in payload';
        }
        if (typeKey === 'payment') {
          const methods = Array.isArray(policy.paymentMethods)
            ? policy.paymentMethods.map((m) => m.paymentMethodType || JSON.stringify(m)).join(', ')
            : 'n/a';
          return `Immediate pay: ${policy.immediatePay ? 'Yes' : 'No'}\nPayment methods: ${methods}`;
        }
        if (typeKey === 'return') {
          const period = policy.returnPeriod ? `${policy.returnPeriod.value} ${policy.returnPeriod.unit}` : 'n/a';
          return `Returns accepted: ${policy.returnsAccepted ? 'Yes' : 'No'}\nReturn period: ${period}`;
        }
        return 'n/a';
      }

      async function inspectPolicy(typeKey, policyId, policyName) {
        if (!policyId) return;
        ensureInspectorVisible();
        const title = document.getElementById('inspectorTitle');
        const status = document.getElementById('inspectorStatus');
        const body = document.getElementById('inspectorBody');
        const summary = document.getElementById('inspectorSummary');
        const raw = document.getElementById('inspectorJson');
        if (title) title.textContent = `${policyName || 'Policy'} · ${typeKey}`;
        if (body) body.style.display = 'none';
        if (status) status.textContent = 'Loading full policy payload…';
        try {
          const url = new URL('/.netlify/functions/ebay-get-policy', window.location.origin);
          url.searchParams.set('type', typeKey);
          url.searchParams.set('id', policyId);
          const res = await authClient.authFetch(url.toString());
          const json = await res.json();
          if (!res.ok || !json?.ok) throw new Error(json?.error || 'Fetch failed');
          if (summary) summary.textContent = formatSummary(typeKey, json.policy);
          if (raw) raw.textContent = JSON.stringify(json.policy, null, 2);
          if (status) status.textContent = `Policy ID ${policyId}`;
          if (body) body.style.display = 'block';
        } catch (e) {
          if (status) status.textContent = 'Failed to load policy: ' + (e?.message || e);
        }
      }

      (function setupInspectorHide() {
        const btn = document.getElementById('inspectorHide');
        if (!btn) return;
        btn.onclick = () => {
          const box = document.getElementById('inspector');
          if (box) box.style.display = 'none';
        };
      })();

      // Promo defaults now handled by table buttons in loadPromotionsSection()


      async function populate() {
        showMsg('', 'info');
        try {
          await loadDefaults();
          console.log('[Policies] Fetching policy list...');
          const r = await authClient.authFetch('/.netlify/functions/ebay-list-policies');
          console.log('[Policies] Response status:', r.status);
          const j = await r.json();
          console.log('[Policies] Response data:', j);
          const f = (j?.fulfillment?.json?.fulfillmentPolicies) || [];
          const p = (j?.payment?.json?.paymentPolicies) || [];
          const rr = (j?.returns?.json?.returnPolicies) || [];
          console.log('[Policies] Counts - Fulfillment:', f.length, 'Payment:', p.length, 'Return:', rr.length);
          renderTable('fTable', f, 'fulfillment');
          renderTable('pTable', p, 'payment');
          renderTable('rTable', rr, 'return');
          document.getElementById('fStatus').textContent = f.length ? `${f.length} ${f.length === 1 ? 'policy' : 'policies'}` : 'No policies';
          document.getElementById('pStatus').textContent = p.length ? `${p.length} ${p.length === 1 ? 'policy' : 'policies'}` : 'No policies';
          document.getElementById('rStatus').textContent = rr.length ? `${rr.length} ${rr.length === 1 ? 'policy' : 'policies'}` : 'No policies';
          renderPromoDefaults();
          await loadPromotionsSection();
        } catch (e) { 
          console.error('[Policies] Error:', e);
          showMsg('Error loading policies: ' + (e?.message || e), 'error'); 
        }
      }

      // If redirected back after creation, show a short status message
      (function(){
        try { 
          const usp = new URLSearchParams(location.search); 
          const c = usp.get('created'); 
          if (c) { 
            showMsg('✓ Created new ' + c + ' policy', 'success'); 
            setTimeout(() => { 
              history.replaceState({}, document.title, '/policies-manage.html'); 
            }, 1500); 
          } 
        } catch {}
      })();

      // Initialize after authClient is ready
      async function init() {
        populate();
      }

      // Edit modal JS removed.
    </script>
  </body>
</html>
