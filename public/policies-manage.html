<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Manage Policies · GPTListing</title>
    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin:0; padding:2rem; background:#0b1020; color:#f4f6fb; }
      .card { max-width: 980px; margin: 0 auto; background: #141a33; border: 1px solid #2a335c; border-radius: 12px; padding: 1.25rem; }
      .muted { color:#a2a9c8; }
      a { color:#a8c1ff; }
      button { background:#4f7cff; color:#fff; border:none; border-radius:8px; padding:.45rem .7rem; cursor:pointer; font-weight:600; }
      button.secondary { background: transparent; color: #cbd5ff; border: 1px solid #3d4a86; }
      table { width:100%; border-collapse: collapse; margin-top: .5rem; }
      th, td { text-align:left; padding: .5rem; border-bottom: 1px solid #26305a; }
      .badge { display:inline-block; padding:.1rem .4rem; border-radius: 6px; font-size: .75rem; background:#223066; color:#cbd5ff; border:1px solid #2f3f7a; }
  /* Stack sections vertically for clearer reading */
  .row { display:block; }
  .col { background:#0f1530; border:1px solid #26305a; border-radius:10px; padding:.9rem; margin:0 0 1rem; }
  /* Tighter, consistent action buttons in tables */
  .btn-sm { padding:.35rem .6rem; font-size:.85rem; border-radius:7px; }
  td.actions { text-align:right; white-space:nowrap; }
  th:last-child, td:last-child { width:1%; }
    </style>
  </head>
  <body>
    <script src="/auth-client.js"></script>
    <div class="card">
      <h2>Manage business policies</h2>
      <p class="muted">Set preferred defaults used when creating drafts. You can also delete policies here; for full edits, use Seller Hub.</p>
      <div style="margin:.5rem 0 1rem;">
        <a class="secondary" href="/">← Back to landing</a>
        <a class="secondary" href="/policies.html" style="margin-left:.5rem;">Create baseline policies</a>
        <a class="secondary" href="https://www.ebay.com/sh/str/selling-policies" target="_blank" style="margin-left:.5rem;">Open in eBay ↗</a>
      </div>

      <div class="row">
        <div class="col">
          <div style="display:flex; align-items:center; justify-content:space-between; gap:.5rem;">
            <h3 style="margin:0">Shipping (Fulfillment)</h3>
            <a class="secondary btn-sm" href="/policy-create.html?type=fulfillment">Create new</a>
          </div>
          <div class="muted small" id="fStatus">Loading…</div>
          <table id="fTable"><thead><tr><th>Name</th><th>ID</th><th>Default</th><th>Actions</th></tr></thead><tbody></tbody></table>
        </div>
        <div class="col">
          <div style="display:flex; align-items:center; justify-content:space-between; gap:.5rem;">
            <h3 style="margin:0">Payment</h3>
            <a class="secondary btn-sm" href="/policy-create.html?type=payment">Create new</a>
          </div>
          <div class="muted small" id="pStatus">Loading…</div>
          <table id="pTable"><thead><tr><th>Name</th><th>ID</th><th>Default</th><th>Actions</th></tr></thead><tbody></tbody></table>
        </div>
        <div class="col">
          <div style="display:flex; align-items:center; justify-content:space-between; gap:.5rem;">
            <h3 style="margin:0">Returns</h3>
            <a class="secondary btn-sm" href="/policy-create.html?type=return">Create new</a>
          </div>
          <div class="muted small" id="rStatus">Loading…</div>
          <table id="rTable"><thead><tr><th>Name</th><th>ID</th><th>Default</th><th>Actions</th></tr></thead><tbody></tbody></table>
        </div>
      </div>

      <div id="msg" class="muted" style="margin-top:.75rem;"></div>
    </div>

    <!-- Lightweight modal for editing policies -->
    <div id="modal" style="display:none; position:fixed; inset:0; background:rgba(3,6,20,.7); align-items:center; justify-content:center; z-index:50;">
      <div style="width: min(720px, 92vw); background:#0f1530; border:1px solid #26305a; border-radius:12px; padding:1rem; box-shadow:0 10px 40px rgba(0,0,0,.4);">
        <div style="display:flex; align-items:center; justify-content:space-between; gap:.5rem;">
          <h3 id="modalTitle" style="margin:.25rem 0;">Edit policy</h3>
          <div>
            <button class="secondary" id="btnCloseModal">Cancel</button>
            <button id="btnSaveModal" style="margin-left:.5rem;">Save</button>
          </div>
        </div>
        <div id="modalMsg" class="muted" style="min-height:1.25rem; margin:.25rem 0 .5rem;"></div>
        <form id="modalForm">
          <input type="hidden" name="type" />
          <input type="hidden" name="id" />
          <div style="display:grid; grid-template-columns: 1fr 1fr; gap:.75rem;">
            <label style="display:block;">
              <div class="muted" style="font-size:.85rem;">Name</div>
              <input name="name" type="text" style="width:100%; padding:.45rem .6rem; background:#0b1020; color:#f4f6fb; border:1px solid #26305a; border-radius:8px;" />
            </label>
            <div id="field_immediatePay" style="display:none;">
              <div class="muted" style="font-size:.85rem;">Immediate pay</div>
              <label style="display:inline-flex; align-items:center; gap:.5rem;">
                <input name="immediatePay" type="checkbox" /> Require immediate payment
              </label>
            </div>
            <div id="field_handlingTime" style="display:none;">
              <div class="muted" style="font-size:.85rem;">Handling time (days)</div>
              <input name="handlingTimeDays" type="number" min="0" step="1" style="width:100%; padding:.45rem .6rem; background:#0b1020; color:#f4f6fb; border:1px solid #26305a; border-radius:8px;" />
            </div>
            <div id="field_freeDomestic" style="display:none;">
              <div class="muted" style="font-size:.85rem;">Domestic shipping</div>
              <label style="display:inline-flex; align-items:center; gap:.5rem;">
                <input name="freeDomestic" type="checkbox" /> Offer free domestic shipping
              </label>
                <div id="field_domesticPaid" style="margin-top:.5rem; display:none;">
                  <div class="muted" style="font-size:.85rem; margin-bottom:.25rem;">If not free, choose a service</div>
                  <div style="display:grid; grid-template-columns: 1fr 1fr; gap:.5rem;">
                    <label style="display:block;">
                      <div class="muted" style="font-size:.85rem;">Carrier</div>
                      <select name="shippingCarrierCode" style="width:100%; padding:.45rem .6rem; background:#0b1020; color:#f4f6fb; border:1px solid #26305a; border-radius:8px;">
                        <option value="USPS">USPS</option>
                        <option value="UPS">UPS</option>
                        <option value="FedEx">FedEx</option>
                      </select>
                    </label>
                    <label style="display:block;">
                      <div class="muted" style="font-size:.85rem;">Service</div>
                      <select name="shippingServiceCode" style="width:100%; padding:.45rem .6rem; background:#0b1020; color:#f4f6fb; border:1px solid #26305a; border-radius:8px;">
                        <!-- Options will update based on carrier -->
                      </select>
                    </label>
                  </div>
                </div>
            </div>
            <div id="field_returnsAccepted" style="display:none;">
              <div class="muted" style="font-size:.85rem;">Returns accepted</div>
              <label style="display:inline-flex; align-items:center; gap:.5rem;">
                <input name="returnsAccepted" type="checkbox" /> Allow returns
              </label>
            </div>
            <div id="field_returnPeriod" style="display:none;">
              <div class="muted" style="font-size:.85rem;">Return period (days)</div>
              <input name="returnPeriodDays" type="number" min="1" step="1" style="width:100%; padding:.45rem .6rem; background:#0b1020; color:#f4f6fb; border:1px solid #26305a; border-radius:8px;" />
            </div>
            <div id="field_refundMethod" style="display:none;">
              <div class="muted" style="font-size:.85rem;">Refund method</div>
              <select name="refundMethod" style="width:100%; padding:.45rem .6rem; background:#0b1020; color:#f4f6fb; border:1px solid #26305a; border-radius:8px;">
                <option value="MONEY_BACK">Money back</option>
                <option value="REPLACEMENT">Replacement</option>
              </select>
            </div>
            <div id="field_returnShippingCostPayer" style="display:none;">
              <div class="muted" style="font-size:.85rem;">Return shipping paid by</div>
              <select name="returnShippingCostPayer" style="width:100%; padding:.45rem .6rem; background:#0b1020; color:#f4f6fb; border:1px solid #26305a; border-radius:8px;">
                <option value="BUYER">Buyer</option>
                <option value="SELLER">Seller</option>
              </select>
            </div>
          </div>
        </form>
      </div>
    </div>

    <script>
      (async () => { try { await authClient.requireAuth(); } catch {} })();

      const defaults = { fulfillment: null, payment: null, return: null };

      async function loadDefaults() {
        try {
          const r = await authClient.authFetch('/.netlify/functions/ebay-get-policy-defaults');
          const j = await r.json();
          Object.assign(defaults, j?.defaults || {});
        } catch {}
      }

      function renderTable(elId, list, typeKey) {
        const table = document.getElementById(elId);
        if (!table) return;
        const tbody = table.querySelector('tbody');
        tbody.innerHTML = '';
        const chosen = defaults[typeKey] || '';
        list.forEach((p) => {
          const tr = document.createElement('tr');
          const name = document.createElement('td');
          name.textContent = p.name || '(unnamed)';
          const id = document.createElement('td');
          id.textContent = p.id || p[`${typeKey}PolicyId`] || '';
          const def = document.createElement('td');
          def.innerHTML = (String(id.textContent) === String(chosen)) ? '<span class="badge">Default</span>' : '';
          const act = document.createElement('td'); act.className = 'actions';
          const setBtn = document.createElement('button'); setBtn.textContent = 'Set default'; setBtn.className='secondary btn-sm';
          setBtn.onclick = async () => {
            try {
              const body = {}; body[typeKey] = id.textContent;
              const r = await authClient.authFetch('/.netlify/functions/ebay-set-policy-defaults', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)});
              const j = await r.json(); Object.assign(defaults, j?.defaults || {});
              await populate();
            } catch (e) { showMsg('Failed to set default: '+(e?.message||e)); }
          };
          const editBtn = document.createElement('button'); editBtn.textContent = 'Edit'; editBtn.style.marginLeft = '.5rem'; editBtn.className='secondary btn-sm';
          editBtn.onclick = () => openEdit(typeKey, id.textContent, name.textContent);
          const delBtn = document.createElement('button'); delBtn.textContent = 'Delete'; delBtn.style.marginLeft='.5rem'; delBtn.className='btn-sm';
          delBtn.onclick = async () => {
            if (!confirm('Delete this policy on eBay? This cannot be undone.')) return;
            try {
              const url = new URL('/.netlify/functions/ebay-delete-policy', window.location.origin);
              url.searchParams.set('type', typeKey); url.searchParams.set('id', id.textContent);
              const r = await authClient.authFetch(url.toString(), { method: 'DELETE' });
              if (!r.ok) { const t = await r.text(); throw new Error(t); }
              showMsg('Deleted. Refreshing…');
              await populate();
            } catch (e) { showMsg('Delete failed: '+(e?.message||e)); }
          };
          act.appendChild(setBtn); act.appendChild(editBtn); act.appendChild(delBtn);
          tr.appendChild(name); tr.appendChild(id); tr.appendChild(def); tr.appendChild(act);
          tbody.appendChild(tr);
        });
      }

      function showMsg(s) { const el = document.getElementById('msg'); if (el) el.textContent = s; }

      function showModal() { const m = document.getElementById('modal'); if (m) m.style.display = 'flex'; }
      function hideModal() { const m = document.getElementById('modal'); if (m) m.style.display = 'none'; }

      async function openEdit(typeKey, id, displayName) {
        try {
          const url = new URL('/.netlify/functions/ebay-get-policy', window.location.origin);
          url.searchParams.set('type', typeKey);
          url.searchParams.set('id', id);
          const r = await authClient.authFetch(url.toString());
          const j = await r.json();
          if (!r.ok || !j?.ok) throw new Error(j?.error || 'Failed to load policy');
          const policy = j.policy || {};
          const form = document.getElementById('modalForm');
          form.type.value = typeKey; form.id.value = id;
          document.getElementById('modalTitle').textContent = `Edit ${typeKey} policy`;
          document.getElementById('modalMsg').textContent = '';

          // Reset conditional sections
          const sections = ['field_immediatePay','field_handlingTime','field_freeDomestic','field_returnsAccepted','field_returnPeriod','field_refundMethod','field_returnShippingCostPayer'];
          sections.forEach(id => document.getElementById(id).style.display = 'none');

          // Common field
          form.name.value = policy.name || displayName || '';

          if (typeKey === 'payment') {
            document.getElementById('field_immediatePay').style.display = 'block';
            form.immediatePay.checked = !!policy.immediatePay;
          } else if (typeKey === 'fulfillment') {
            document.getElementById('field_handlingTime').style.display = 'block';
            document.getElementById('field_freeDomestic').style.display = 'block';
            const days = Number(policy?.handlingTime?.value ?? 1);
            form.handlingTimeDays.value = isNaN(days) ? 1 : days;
            // Heuristic: if any domestic shipping service is free, pre-check
            const shipOpts = policy?.shippingOptions || [];
            let free = false; try {
              for (const opt of shipOpts) {
                if (opt?.optionType === 'DOMESTIC') {
                  for (const svc of (opt.shippingServices||[])) { if (svc?.freeShipping) { free = true; break; } }
                  // Prefill carrier/service if not free
                  if (!free) {
                    const firstSvc = (opt.shippingServices||[])[0] || {};
                    form.shippingCarrierCode.value = firstSvc.shippingCarrierCode || 'USPS';
                    updateServiceOptions();
                    if (firstSvc.shippingServiceCode) form.shippingServiceCode.value = firstSvc.shippingServiceCode;
                  }
                }
                if (free) break;
              }
            } catch {}
            form.freeDomestic.checked = !!free;
            document.getElementById('field_domesticPaid').style.display = free ? 'none' : 'block';
            form.shippingServiceCode.required = !free;
            // Ensure the service dropdown has options at least once
            updateServiceOptions();
          } else if (typeKey === 'return') {
            document.getElementById('field_returnsAccepted').style.display = 'block';
            document.getElementById('field_returnPeriod').style.display = 'block';
            document.getElementById('field_refundMethod').style.display = 'block';
            document.getElementById('field_returnShippingCostPayer').style.display = 'block';
            form.returnsAccepted.checked = policy.returnsAccepted !== false;
            const rp = Number(policy?.returnPeriod?.value ?? 30);
            form.returnPeriodDays.value = isNaN(rp) ? 30 : rp;
            form.refundMethod.value = policy.refundMethod || 'MONEY_BACK';
            form.returnShippingCostPayer.value = policy.returnShippingCostPayer || 'BUYER';
          }

          showModal();
        } catch (e) {
          showMsg('Failed to load policy for edit: ' + (e?.message || e));
        }
      }

      async function saveEdit() {
        const form = document.getElementById('modalForm');
        const type = form.type.value; const id = form.id.value;
        const payload = { type, id };
        if (form.name.value) payload.name = form.name.value;
        if (type === 'payment') {
          payload.immediatePay = !!form.immediatePay.checked;
        } else if (type === 'fulfillment') {
          payload.handlingTimeDays = Number(form.handlingTimeDays.value || 1);
          payload.freeDomestic = !!form.freeDomestic.checked;
          if (!payload.freeDomestic) {
            const carrier = form.shippingCarrierCode.value;
            const service = form.shippingServiceCode.value;
            if (!service) { document.getElementById('modalMsg').textContent = 'Please select a shipping service.'; return; }
            payload.shippingCarrierCode = carrier;
            payload.shippingServiceCode = service;
          }
        } else if (type === 'return') {
          payload.returnsAccepted = !!form.returnsAccepted.checked;
          payload.returnPeriodDays = Number(form.returnPeriodDays.value || 30);
          payload.refundMethod = form.refundMethod.value || 'MONEY_BACK';
          payload.returnShippingCostPayer = form.returnShippingCostPayer.value || 'BUYER';
        }
        try {
          const r = await authClient.authFetch('/.netlify/functions/ebay-update-policy', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
          const j = await r.json();
          if (!r.ok || !j?.ok) throw new Error(j?.error || 'Update failed');
          document.getElementById('modalMsg').textContent = 'Saved.';
          hideModal();
          await populate();
        } catch (e) {
          const em = document.getElementById('modalMsg');
          em.textContent = 'Save failed: ' + (e?.message || e);
        }
      }

      async function populate() {
        showMsg('');
        try {
          await loadDefaults();
          const r = await authClient.authFetch('/.netlify/functions/ebay-list-policies');
          const j = await r.json();
          const f = (j?.fulfillment?.json?.fulfillmentPolicies) || [];
          const p = (j?.payment?.json?.paymentPolicies) || [];
          const rr = (j?.returns?.json?.returnPolicies) || [];
          renderTable('fTable', f, 'fulfillment');
          renderTable('pTable', p, 'payment');
          renderTable('rTable', rr, 'return');
          document.getElementById('fStatus').textContent = f.length? `${f.length} policy(ies)` : 'No policies';
          document.getElementById('pStatus').textContent = p.length? `${p.length} policy(ies)` : 'No policies';
          document.getElementById('rStatus').textContent = rr.length? `${rr.length} policy(ies)` : 'No policies';
        } catch (e) { showMsg('Error loading policies: ' + (e?.message || e)); }
      }

      // If redirected back after creation, show a short status message
      (function(){
        try { const usp = new URLSearchParams(location.search); const c = usp.get('created'); if (c) { showMsg('Created new ' + c + ' policy. Refreshing…'); setTimeout(()=>{ showMsg(''); history.replaceState({}, document.title, '/policies-manage.html'); }, 1500); } } catch {}
      })();

      populate();

      // Wire modal buttons
      document.getElementById('btnCloseModal').addEventListener('click', () => hideModal());
      document.getElementById('btnSaveModal').addEventListener('click', (e) => { e.preventDefault(); saveEdit(); });

      // Shipping carrier -> service options
      function serviceOptionsFor(carrier) {
        if (carrier === 'UPS') return [
          ['UPSGround','UPS Ground'],
          ['UPS3DaySelect','UPS 3 Day Select'],
        ];
        if (carrier === 'FedEx') return [
          ['FedExHomeDelivery','FedEx Home Delivery'],
          ['FedEx2Day','FedEx 2Day'],
        ];
        // Default USPS
        return [
          ['USPSFirstClass','USPS First Class'],
          ['USPSPriority','USPS Priority'],
        ];
      }
      function updateServiceOptions() {
        const form = document.getElementById('modalForm');
        const carrier = form.shippingCarrierCode.value || 'USPS';
        const svcSel = form.shippingServiceCode;
        const cur = svcSel.value;
        svcSel.innerHTML = '';
        const opts = serviceOptionsFor(carrier);
        for (const [val,label] of opts) {
          const o = document.createElement('option'); o.value = val; o.textContent = label; svcSel.appendChild(o);
        }
        // try keep selection
        if (cur) { svcSel.value = cur; }
      }
      document.addEventListener('change', (e) => {
        const t = e.target;
        const nm = t && t.getAttribute ? t.getAttribute('name') : undefined;
        if (nm === 'freeDomestic') {
          const on = t && typeof t.checked === 'boolean' ? t.checked : false;
          document.getElementById('field_domesticPaid').style.display = on ? 'none' : 'block';
          const form = document.getElementById('modalForm');
          form.shippingServiceCode.required = !on;
          if (!on) {
            // Populate services when switching to paid shipping
            updateServiceOptions();
            // Select first service by default if none
            if (!form.shippingServiceCode.value && form.shippingServiceCode.options.length) {
              form.shippingServiceCode.selectedIndex = 0;
            }
          }
        }
        if (nm === 'shippingCarrierCode') {
          updateServiceOptions();
        }
      });
    </script>
  </body>
</html>
