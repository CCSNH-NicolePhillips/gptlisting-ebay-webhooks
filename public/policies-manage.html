<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Manage Policies · GPTListing</title>
    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin:0; padding:2rem; background:#0b1020; color:#f4f6fb; }
      .card { max-width: 980px; margin: 0 auto; background: #141a33; border: 1px solid #2a335c; border-radius: 12px; padding: 1.25rem; }
      .muted { color:#a2a9c8; }
      a { color:#a8c1ff; }
      button { background:#4f7cff; color:#fff; border:none; border-radius:8px; padding:.45rem .7rem; cursor:pointer; font-weight:600; }
      button.secondary { background: transparent; color: #cbd5ff; border: 1px solid #3d4a86; }
      table { width:100%; border-collapse: collapse; margin-top: .5rem; }
      th, td { text-align:left; padding: .5rem; border-bottom: 1px solid #26305a; }
      .badge { display:inline-block; padding:.1rem .4rem; border-radius: 6px; font-size: .75rem; background:#223066; color:#cbd5ff; border:1px solid #2f3f7a; }
  /* Stack sections vertically for clearer reading */
  .row { display:block; }
  .col { background:#0f1530; border:1px solid #26305a; border-radius:10px; padding:.9rem; margin:0 0 1rem; }
  /* Tighter, consistent action buttons in tables */
  .btn-sm { padding:.35rem .6rem; font-size:.85rem; border-radius:7px; }
  td.actions { text-align:right; white-space:nowrap; }
  th:last-child, td:last-child { width:1%; }
    </style>
  </head>
  <body>
    <script src="/auth-client.js"></script>
    <div class="card">
      <h2>Manage business policies</h2>
      <p class="muted">Set preferred defaults used when creating drafts. You can also delete policies here; for full edits, use Seller Hub.</p>
      <div style="margin:.5rem 0 1rem;">
        <a class="secondary" href="/">← Back to landing</a>
        <a class="secondary" href="/policies.html" style="margin-left:.5rem;">Create baseline policies</a>
        <a class="secondary" href="https://www.ebay.com/sh/str/selling-policies" target="_blank" style="margin-left:.5rem;">Open in eBay ↗</a>
        <a class="secondary" href="/policies.html#debug" style="margin-left:.5rem;">Debug tools</a>
      </div>

      <div class="row">
        <div class="col">
          <div style="display:flex; align-items:center; justify-content:space-between; gap:.5rem;">
            <h3 style="margin:0">Shipping (Fulfillment)</h3>
            <a class="secondary btn-sm" href="/policy-create.html?type=fulfillment">Create new</a>
          </div>
          <div class="muted small" id="fStatus">Loading…</div>
          <table id="fTable"><thead><tr><th>Name</th><th>ID</th><th>Default</th><th>Actions</th></tr></thead><tbody></tbody></table>
        </div>
        <div class="col">
          <div style="display:flex; align-items:center; justify-content:space-between; gap:.5rem;">
            <h3 style="margin:0">Payment</h3>
            <a class="secondary btn-sm" href="/policy-create.html?type=payment">Create new</a>
          </div>
          <div class="muted small" id="pStatus">Loading…</div>
          <table id="pTable"><thead><tr><th>Name</th><th>ID</th><th>Default</th><th>Actions</th></tr></thead><tbody></tbody></table>
        </div>
        <div class="col">
          <div style="display:flex; align-items:center; justify-content:space-between; gap:.5rem;">
            <h3 style="margin:0">Returns</h3>
            <a class="secondary btn-sm" href="/policy-create.html?type=return">Create new</a>
          </div>
          <div class="muted small" id="rStatus">Loading…</div>
          <table id="rTable"><thead><tr><th>Name</th><th>ID</th><th>Default</th><th>Actions</th></tr></thead><tbody></tbody></table>
        </div>
      </div>

      <div class="col" id="inspector" style="display:none;">
        <div style="display:flex; align-items:center; justify-content:space-between; gap:.5rem;">
          <h3 style="margin:0" id="inspectorTitle">Policy details</h3>
          <button class="secondary btn-sm" id="inspectorHide">Close</button>
        </div>
        <div class="muted small" id="inspectorStatus">Select a policy to view its full payload and logistics summary.</div>
        <div id="inspectorBody" style="display:none; margin-top:.75rem;">
          <div class="muted" style="font-size:.85rem; margin-bottom:.35rem;">Logistics summary</div>
          <pre id="inspectorSummary" style="background:#0b1020; border:1px solid #26305a; border-radius:6px; padding:.6rem; overflow:auto; max-height:180px; white-space:pre-wrap; font-size:.85rem;">n/a</pre>
          <div class="muted" style="font-size:.85rem; margin:.75rem 0 .35rem;">Raw payload from eBay</div>
          <pre id="inspectorJson" style="background:#0b1020; border:1px solid #26305a; border-radius:6px; padding:.6rem; overflow:auto; max-height:320px;">n/a</pre>
        </div>
      </div>

      <div id="msg" class="muted" style="margin-top:.75rem;"></div>
    </div>

    <!-- Edit modal removed (we now create new policies instead). -->

    <script>
      (async () => { try { await authClient.requireAuth(); } catch {} })();

      const defaults = { fulfillment: null, payment: null, return: null };

      async function loadDefaults() {
        try {
          const r = await authClient.authFetch('/.netlify/functions/ebay-get-policy-defaults');
          const j = await r.json();
          Object.assign(defaults, j?.defaults || {});
        } catch {}
      }

      function renderTable(elId, list, typeKey) {
        const table = document.getElementById(elId);
        if (!table) return;
        const tbody = table.querySelector('tbody');
        tbody.innerHTML = '';
        const chosen = defaults[typeKey] || '';
        list.forEach((p) => {
          const tr = document.createElement('tr');
          const name = document.createElement('td');
          name.textContent = p.name || '(unnamed)';
          const id = document.createElement('td');
          id.textContent = p.id || p[`${typeKey}PolicyId`] || '';
          const def = document.createElement('td');
          def.innerHTML = (String(id.textContent) === String(chosen)) ? '<span class="badge">Default</span>' : '';
          const act = document.createElement('td'); act.className = 'actions';
          const inspectBtn = document.createElement('button');
          inspectBtn.textContent = 'Inspect';
          inspectBtn.className = 'secondary btn-sm';
          inspectBtn.onclick = () => inspectPolicy(typeKey, id.textContent, name.textContent);
          act.appendChild(inspectBtn);
          const setBtn = document.createElement('button'); setBtn.textContent = 'Set default'; setBtn.className='secondary btn-sm';
          setBtn.style.marginLeft = '.35rem';
          setBtn.onclick = async () => {
            try {
              const body = {}; body[typeKey] = id.textContent;
              const r = await authClient.authFetch('/.netlify/functions/ebay-set-policy-defaults', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)});
              const j = await r.json(); Object.assign(defaults, j?.defaults || {});
              await populate();
            } catch (e) { showMsg('Failed to set default: '+(e?.message||e)); }
          };
          const delBtn = document.createElement('button'); delBtn.textContent = 'Delete'; delBtn.style.marginLeft='.35rem'; delBtn.className='btn-sm';
          delBtn.onclick = async () => {
            if (!confirm('Delete this policy on eBay? This cannot be undone.')) return;
            try {
              const url = new URL('/.netlify/functions/ebay-delete-policy', window.location.origin);
              url.searchParams.set('type', typeKey); url.searchParams.set('id', id.textContent);
              const r = await authClient.authFetch(url.toString(), { method: 'DELETE' });
              if (!r.ok) { const t = await r.text(); throw new Error(t); }
              showMsg('Deleted. Refreshing…');
              await populate();
            } catch (e) { showMsg('Delete failed: '+(e?.message||e)); }
          };
          act.appendChild(setBtn); act.appendChild(delBtn);
          tr.appendChild(name); tr.appendChild(id); tr.appendChild(def); tr.appendChild(act);
          tbody.appendChild(tr);
        });
      }

      function showMsg(s) { const el = document.getElementById('msg'); if (el) el.textContent = s; }

      function ensureInspectorVisible() {
        const box = document.getElementById('inspector');
        if (box) box.style.display = 'block';
      }

      function formatSummary(typeKey, policy) {
        if (!policy || typeof policy !== 'object') return 'n/a';
        if (typeKey === 'fulfillment') {
          const lines = [];
          const options = Array.isArray(policy.shippingOptions) ? policy.shippingOptions : [];
          options.forEach((opt, idx) => {
            lines.push(`Option ${idx + 1}: ${opt.optionType || 'n/a'} · ${opt.costType || 'n/a'}`);
            const shipTo = opt.shipToLocations?.regionIncluded || [];
            if (shipTo.length) {
              lines.push('  Ship to: ' + shipTo.map((r) => `${r.regionType || ''}:${r.regionName || ''}`).join(', '));
            }
            const services = Array.isArray(opt.shippingServices) ? opt.shippingServices : [];
            services.forEach((svc) => {
              const parts = [svc.shippingServiceCode || 'service'];
              if (svc.shippingCarrierCode) parts.push(`carrier=${svc.shippingCarrierCode}`);
              if (svc.freeShipping) parts.push('free');
              if (!svc.freeShipping && svc.shippingCost?.value)
                parts.push(`cost=${svc.shippingCost.value} ${svc.shippingCost.currency || ''}`.trim());
              if (svc.additionalShippingCost?.value)
                parts.push(`addl=${svc.additionalShippingCost.value} ${svc.additionalShippingCost.currency || ''}`.trim());
              if (svc.sortOrder != null) parts.push(`sort=${svc.sortOrder}`);
              lines.push('  Service: ' + parts.join(' · '));
            });
            if (opt.calculatedShippingRate) {
              const calc = opt.calculatedShippingRate;
              const dims = ['packageLength', 'packageWidth', 'packageHeight']
                .map((k) => calc[k] ? `${k.replace('package','').toLowerCase()}=${calc[k].value}${calc[k].unit ? ' ' + calc[k].unit : ''}` : null)
                .filter(Boolean)
                .join(', ');
              const weights = ['weightMajor', 'weightMinor']
                .map((k) => calc[k] ? `${k.replace('weight','weight ').toLowerCase()}=${calc[k].value}${calc[k].unit ? ' ' + calc[k].unit : ''}` : null)
                .filter(Boolean)
                .join(', ');
              lines.push(`  Calculated rate: ${calc.measurementSystem || 'n/a'} · ${calc.packageType || 'n/a'}`);
              if (dims) lines.push('    ' + dims);
              if (weights) lines.push('    ' + weights);
            }
          });
          return lines.length ? lines.join('\n') : 'No shipping options in payload';
        }
        if (typeKey === 'payment') {
          const methods = Array.isArray(policy.paymentMethods)
            ? policy.paymentMethods.map((m) => m.paymentMethodType || JSON.stringify(m)).join(', ')
            : 'n/a';
          return `Immediate pay: ${policy.immediatePay ? 'Yes' : 'No'}\nPayment methods: ${methods}`;
        }
        if (typeKey === 'return') {
          const period = policy.returnPeriod ? `${policy.returnPeriod.value} ${policy.returnPeriod.unit}` : 'n/a';
          return `Returns accepted: ${policy.returnsAccepted ? 'Yes' : 'No'}\nReturn period: ${period}`;
        }
        return 'n/a';
      }

      async function inspectPolicy(typeKey, policyId, policyName) {
        if (!policyId) return;
        ensureInspectorVisible();
        const title = document.getElementById('inspectorTitle');
        const status = document.getElementById('inspectorStatus');
        const body = document.getElementById('inspectorBody');
        const summary = document.getElementById('inspectorSummary');
        const raw = document.getElementById('inspectorJson');
        if (title) title.textContent = `${policyName || 'Policy'} · ${typeKey}`;
        if (body) body.style.display = 'none';
        if (status) status.textContent = 'Loading full policy payload…';
        try {
          const url = new URL('/.netlify/functions/ebay-get-policy', window.location.origin);
          url.searchParams.set('type', typeKey);
          url.searchParams.set('id', policyId);
          const res = await authClient.authFetch(url.toString());
          const json = await res.json();
          if (!res.ok || !json?.ok) throw new Error(json?.error || 'Fetch failed');
          if (summary) summary.textContent = formatSummary(typeKey, json.policy);
          if (raw) raw.textContent = JSON.stringify(json.policy, null, 2);
          if (status) status.textContent = `Policy ID ${policyId}`;
          if (body) body.style.display = 'block';
        } catch (e) {
          if (status) status.textContent = 'Failed to load policy: ' + (e?.message || e);
        }
      }

      (function setupInspectorHide(){
        const btn = document.getElementById('inspectorHide');
        if (!btn) return;
        btn.onclick = () => {
          const box = document.getElementById('inspector');
          if (box) box.style.display = 'none';
        };
      })();


      async function populate() {
        showMsg('');
        try {
          await loadDefaults();
          const r = await authClient.authFetch('/.netlify/functions/ebay-list-policies');
          const j = await r.json();
          const f = (j?.fulfillment?.json?.fulfillmentPolicies) || [];
          const p = (j?.payment?.json?.paymentPolicies) || [];
          const rr = (j?.returns?.json?.returnPolicies) || [];
          renderTable('fTable', f, 'fulfillment');
          renderTable('pTable', p, 'payment');
          renderTable('rTable', rr, 'return');
          document.getElementById('fStatus').textContent = f.length? `${f.length} policy(ies)` : 'No policies';
          document.getElementById('pStatus').textContent = p.length? `${p.length} policy(ies)` : 'No policies';
          document.getElementById('rStatus').textContent = rr.length? `${rr.length} policy(ies)` : 'No policies';
        } catch (e) { showMsg('Error loading policies: ' + (e?.message || e)); }
      }

      // If redirected back after creation, show a short status message
      (function(){
        try { const usp = new URLSearchParams(location.search); const c = usp.get('created'); if (c) { showMsg('Created new ' + c + ' policy. Refreshing…'); setTimeout(()=>{ showMsg(''); history.replaceState({}, document.title, '/policies-manage.html'); }, 1500); } } catch {}
      })();

      populate();

      // Edit modal JS removed.
    </script>
  </body>
</html>
