<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Drafts</title>
    <style>
      :root {
        --bg: #0b1020;
        --panel: #141a33;
        --panel-2: #0f1530;
        --line: #2a335c;
        --text: #f4f6fb;
        --muted: #a2a9c8;
        --primary: #4f7cff;
        --primary-600: #3e66d6;
        --accent: #22c55e;
        --danger: #ef4444;
        --warning: #f59e0b;
      }
      * {
        box-sizing: border-box;
      }
      body {
        font-family:
          ui-sans-serif,
          system-ui,
          -apple-system,
          Segoe UI,
          Roboto,
          Arial,
          sans-serif;
        margin: 0;
        background: var(--bg);
        color: var(--text);
      }
      .wrap {
        max-width: 1140px;
        margin: 0 auto;
        padding: 2rem 1.25rem;
      }
      header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 1rem;
        margin-bottom: 1rem;
      }
      h1 {
        font-size: 1.5rem;
        margin: 0;
      }
      .flash {
        color: var(--muted);
        min-height: 1.25rem;
      }
      .toolbar {
        display: flex;
        gap: 0.5rem;
        align-items: center;
      }
      .btn {
        background: var(--primary);
        color: #fff;
        border: none;
        border-radius: 10px;
        padding: 0.55rem 0.85rem;
        font-weight: 600;
        cursor: pointer;
        box-shadow: 0 1px 0 rgba(0, 0, 0, 0.25);
      }
      .btn:hover {
        background: var(--primary-600);
      }
      .btn.secondary {
        background: transparent;
        color: #cbd5ff;
        border: 1px solid var(--line);
        box-shadow: none;
      }
      .btn.danger {
        background: transparent;
        color: #ffb4b4;
        border: 1px solid rgba(239, 68, 68, 0.35);
      }
      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 1rem;
      }
      .card {
        background: linear-gradient(180deg, var(--panel), var(--panel-2));
        border: 1px solid var(--line);
        border-radius: 14px;
        overflow: hidden;
        display: flex;
        flex-direction: column;
      }
      .thumb {
        position: relative;
        width: 100%;
        padding-top: 56%;
        background: #0d1430;
        border-bottom: 1px solid var(--line);
      }
      .thumb img {
        position: absolute;
        inset: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
        opacity: 0;
        transition: opacity 0.25s ease;
      }
      .thumb img.loaded {
        opacity: 1;
      }
      .skeleton {
        position: absolute;
        inset: 0;
        background: linear-gradient(
          90deg,
          rgba(255, 255, 255, 0.03),
          rgba(255, 255, 255, 0.06),
          rgba(255, 255, 255, 0.03)
        );
        background-size: 200% 100%;
        animation: shimmer 1.2s infinite;
      }
      @keyframes shimmer {
        0% {
          background-position: 200% 0;
        }
        100% {
          background-position: -200% 0;
        }
      }
      /* lightweight page-level loader */
      .loading {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 2rem;
        color: var(--muted);
        gap: 0.6rem;
      }
      .loading .spinner {
        width: 28px;
        height: 28px;
        border: 3px solid rgba(255, 255, 255, 0.15);
        border-top-color: var(--primary);
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
      .body {
        padding: 0.9rem 0.9rem 1rem;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        flex: 1; /* take remaining height under thumbnail */
      }
      .title {
        font-weight: 700;
        line-height: 1.3;
        display: -webkit-box;
        -webkit-line-clamp: 3; /* clamp long titles */
        line-clamp: 3;
        -webkit-box-orient: vertical;
        overflow: hidden;
      }
      .desc {
        color: var(--muted);
        font-size: 0.92rem;
        line-height: 1.35;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
      }
      .meta {
        color: var(--muted);
        font-size: 0.9rem;
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
      }
      .row {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
        margin-top: 0.5rem;
      }
      /* push actions to the bottom of the card body */
      .body .row {
        margin-top: auto;
      }
      .badge {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        font-size: 0.75rem;
        padding: 0.2rem 0.5rem;
        border-radius: 999px;
        border: 1px solid var(--line);
        color: #d6e1ff;
      }
      /* anchor status badge near bottom, above actions */
      .body .badge {
        margin-top: auto;
      }
      .badge .dot {
        width: 6px;
        height: 6px;
        border-radius: 999px;
        background: var(--warning);
        box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.18);
      }
      .muted {
        color: var(--muted);
      }
      .empty {
        color: var(--muted);
        background: rgba(255, 255, 255, 0.02);
        border: 1px dashed var(--line);
        border-radius: 12px;
        padding: 1.25rem;
        text-align: center;
      }
      a {
        color: #9db2ff;
        text-decoration: none;
      }
      a:hover {
        text-decoration: underline;
      }
      .topbar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin: 0.25rem 0 1rem;
      }
    </style>
  </head>
  <body>
    <script src="/auth-client.js"></script>
    <script src="/auth-client.js"></script>
    <div class="wrap">
      <header>
  <h1>Drafts</h1>
        <div class="toolbar">
          <button id="btnClean" class="btn danger" title="Delete ALL UNPUBLISHED drafts">
            Delete all drafts
          </button>
          <a class="btn secondary" href="/draft-wizard.html">Create Draft</a>
        </div>
      </header>
      <div class="topbar">
        <div id="flash" class="flash"></div>
        <div>
          <button id="btnRefresh" class="btn secondary" title="Reload drafts">Refresh</button>
        </div>
      </div>
      
      <div id="needsAttention" style="margin-bottom: 2rem;">
        <h2 style="font-size: 1.25rem; margin: 1.5rem 0 1rem; color: var(--warning);">⚠️ Needs Attention <span id="needsCount" style="font-size: 0.875rem; color: var(--muted);"></span></h2>
        <div id="needsList" class="grid" aria-live="polite"></div>
      </div>
      
      <div id="readySection">
        <h2 style="font-size: 1.25rem; margin: 1.5rem 0 1rem; color: var(--accent);">✓ Ready to Publish <span id="readyCount" style="font-size: 0.875rem; color: var(--muted);"></span></h2>
        <div id="readyList" class="grid" aria-live="polite"></div>
      </div>
    </div>

    <script>
      // Store last publish attempt for debugging
      let lastPublishAttempt = null;
      async function fetchJSON(url, opts) {
        const exec = authClient && typeof authClient.authFetch === 'function' ? authClient.authFetch : fetch;
        // Add cache-buster and force no-store to avoid stale CDN/browser caches
        const bust = (url.includes('?') ? '&' : '?') + '_ts=' + Date.now();
        const r = await exec(url + bust, Object.assign({ cache: 'no-store' }, opts));
        const t = await r.text();
        let j;
        try {
          j = JSON.parse(t);
        } catch {
          j = { raw: t };
        }
        if (!r.ok)
          throw Object.assign(new Error('HTTP ' + r.status), { response: j, status: r.status });
        return j;
      }
      const $ = (id) => document.getElementById(id);
      const readyList = $('readyList');
      const needsList = $('needsList');
      const flash = $('flash');

      const fmtPrice = (v, c) =>
        v != null && c
          ? new Intl.NumberFormat(undefined, { style: 'currency', currency: c }).format(Number(v))
          : '';

      function card(offer) {
        const el = document.createElement('div');
        el.className = 'card';
        // thumbnail area
        const th = document.createElement('div');
        th.className = 'thumb';
        const sk = document.createElement('div');
        sk.className = 'skeleton';
        th.appendChild(sk);
        const img = document.createElement('img');
        th.appendChild(img);
        // body
        const body = document.createElement('div');
        body.className = 'body';
        const title = document.createElement('div');
        title.className = 'title';
  // Use enriched title from backend if available, otherwise show SKU temporarily
  title.textContent = offer?._enrichedTitle || offer?.title || offer?.sku || '(loading title…)';
  const desc = document.createElement('div');
  desc.className = 'desc';
  const descSrc = (offer.listingDescription || '').replace(/\s+/g, ' ').trim();
  desc.textContent = descSrc ? descSrc.slice(0, 180) : '';
        const meta = document.createElement('div');
        meta.className = 'meta';
        const priceStr = fmtPrice(
          offer?.pricingSummary?.price?.value,
          offer?.pricingSummary?.price?.currency
        );
        
        // Check for pricing status from custom merchant data
        const pricingStatus = offer?.merchantData?.pricingStatus;
        const needsReview = pricingStatus === 'NEEDS_REVIEW';
        
        meta.textContent = [
          offer.sku ? `SKU: ${offer.sku}` : null,
          offer.categoryId ? `Cat: ${offer.categoryId}` : null,
          offer.availableQuantity != null ? `Qty: ${offer.availableQuantity}` : null,
          priceStr ? `Price: ${priceStr}` : (needsReview ? 'Price: ⚠️ Needs Review' : null),
        ]
          .filter(Boolean)
          .join(' • ');
  const badge = document.createElement('div');
  badge.className = 'badge';
  const st = String(offer?.status || 'UNPUBLISHED');
  badge.innerHTML = `<span class="dot"></span> ${st}`;
        const row = document.createElement('div');
        row.className = 'row';
        
        const pub = document.createElement('button');
        pub.className = 'btn';
        pub.textContent = 'Publish';
        
        const edit = document.createElement('button');
        edit.className = 'btn secondary';
        edit.textContent = 'Edit';
        edit.title = 'Edit draft details';
        const del = document.createElement('button');
        del.className = 'btn danger';
        del.textContent = 'Delete';

        edit.onclick = () => {
          if (!offer.offerId) {
            flash.textContent = 'Cannot edit: Offer ID not found';
            return;
          }
          window.location.href = `/edit-draft.html?offerId=${encodeURIComponent(offer.offerId)}`;
        };

        pub.onclick = async () => {
          pub.disabled = true;
          del.disabled = true;
          flash.textContent = 'Publishing…';
          
          // Store for debugging
          lastPublishAttempt = {
            offerId: offer.offerId,
            offer: offer,
            timestamp: new Date().toISOString(),
          };
          
          try {
            const exec = (window.authClient && typeof window.authClient.authFetch === 'function') ? window.authClient.authFetch : fetch;
            const r = await exec('/.netlify/functions/ebay-publish-offer', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ offerId: offer.offerId }),
            });
            
            // Safe JSON parsing
            let data;
            try {
              const text = await r.text();
              data = text ? JSON.parse(text) : {};
            } catch (parseErr) {
              console.error('[Publish] JSON parse error:', parseErr);
              flash.textContent = 'Publish error: Invalid response from server';
              pub.disabled = del.disabled = false;
              return;
            }
            
            // Store response for debugging
            lastPublishAttempt.response = data;
            lastPublishAttempt.status = r.status;
            
            if (r.ok && data.ok && !data.deleted) {
              sessionStorage.removeItem('drafts-cache');
              sessionStorage.removeItem('drafts-cache-time');
              el.remove();
              flash.textContent = `Published ${offer.offerId}`;
              return;
            }
            if (r.ok && data.ok && data.deleted) {
              sessionStorage.removeItem('drafts-cache');
              sessionStorage.removeItem('drafts-cache-time');
              el.remove();
              flash.textContent = `Draft ${offer.offerId} had errors and was deleted.`;
              return;
            }
            // Improve error details: surface common onboarding/privilege errors with a direct link
            try {
              const errs = (data?.publish?.detail?.errors && Array.isArray(data.publish.detail.errors)) ? data.publish.detail.errors : [];
              const e25018 = errs.find((e) => Number(e?.errorId) === 25018);
              if (e25018) {
                const params = Array.isArray(e25018.parameters) ? e25018.parameters : [];
                const urlParam = params.find((p) => typeof p?.value === 'string' && /^https:\/\//i.test(p.value));
                const url = urlParam?.value || 'https://ebaypayonboardingweb.ebay.com/seller-reg?client=THIRD_PARTY_API';
                flash.innerHTML = '';
                const span = document.createElement('span');
                span.textContent = 'Publish error: Selling privileges required. ';
                const a = document.createElement('a');
                a.href = url; a.target = '_blank'; a.rel = 'noopener noreferrer'; a.textContent = 'Complete eBay onboarding';
                flash.appendChild(span);
                flash.appendChild(a);
              } else {
                const detail =
                  typeof data?.publish?.detail === 'string'
                    ? data.publish.detail
                    : data?.publish?.detail?.message || JSON.stringify(data?.publish?.detail || data);
                flash.textContent = `Publish error: ${data.error || ''}${detail ? ' — ' + detail : ''}`;
              }
            } catch {
              flash.textContent = `Publish error: ${data.error || ''}`;
            }
            pub.disabled = del.disabled = false;
          } catch (e) {
            flash.textContent = 'Publish error: ' + e.message;
            pub.disabled = del.disabled = false;
          }
        };
        del.onclick = async () => {
          if (!confirm('Delete this draft?')) return;
          pub.disabled = true;
          del.disabled = true;
          flash.textContent = 'Deleting…';
          try {
            const exec = (window.authClient && typeof window.authClient.authFetch === 'function') ? window.authClient.authFetch : fetch;
            const r = await exec(
              '/.netlify/functions/ebay-delete-offer?offerId=' + encodeURIComponent(offer.offerId)
            );
            
            // Safe JSON parsing
            let data;
            try {
              const text = await r.text();
              data = text ? JSON.parse(text) : {};
            } catch (parseErr) {
              console.error('[Delete] JSON parse error:', parseErr);
              flash.textContent = 'Delete error: Invalid response from server';
              pub.disabled = del.disabled = false;
              return;
            }
            if (r.ok && data.ok) {
              sessionStorage.removeItem('drafts-cache');
              sessionStorage.removeItem('drafts-cache-time');
              el.remove();
              flash.textContent = `Deleted ${offer.offerId}`;
            } else {
              flash.textContent = `Delete error: ${data.error || ''}`;
              pub.disabled = del.disabled = false;
            }
          } catch (e) {
            flash.textContent = 'Delete error: ' + e.message;
            pub.disabled = del.disabled = false;
          }
        };

        // Only add publish button if pricing is OK
        if (!needsReview) {
          row.appendChild(pub);
        }
        row.appendChild(edit);
        row.appendChild(del);
        body.appendChild(title);
  if (desc.textContent) body.appendChild(desc);
  body.appendChild(meta);
        body.appendChild(badge);
        body.appendChild(row);
        el.appendChild(th);
        el.appendChild(body);
        // attach lazy thumbnail loader
        el.dataset.sku = offer.sku || '';
        el.dataset.offerId = offer.offerId || '';
  el._img = img;
  el._sk = sk;
  // @ts-ignore
  el._title = title;
  return el;
      }

      function escapeHtml(s) {
        return String(s).replace(
          /[&<>"]/g,
          (c) => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;' })[c]
        );
      }

      async function load() {
        readyList.innerHTML = '';
        needsList.innerHTML = '';
        const loader = document.createElement('div');
        loader.className = 'loading';
        loader.innerHTML =
          '<div class="spinner" role="status" aria-label="Loading"></div><div class="label">Loading drafts…</div>';
        readyList.appendChild(loader.cloneNode(true));
        needsList.appendChild(loader);
        
        try {
          const cacheKey = 'drafts-cache';
          const cacheTimeKey = 'drafts-cache-time';
          const cacheMaxAge = 30000; // 30 seconds
          
          // Try cache first for faster initial load
          let offers = null;
          try {
            const cached = sessionStorage.getItem(cacheKey);
            const cacheTime = sessionStorage.getItem(cacheTimeKey);
            if (cached && cacheTime && (Date.now() - Number(cacheTime)) < cacheMaxAge) {
              offers = JSON.parse(cached);
              console.log('[Drafts] Using cached data');
            }
          } catch {}
          
          // Fetch fresh data if no cache
          if (!offers) {
            // Prefer explicit status queries to ensure UNPUBLISHED/DRAFT/INACTIVE are returned on accounts
            // where the upstream API does not include them by default without offer_status.
            const rawSku = new URL(location.href).searchParams.get('sku') || '';
            const skuOk = /^[A-Za-z0-9]{1,50}$/.test(rawSku);
            const base =
              '/.netlify/functions/ebay-list-offers?limit=100' +
              (skuOk ? '&sku=' + encodeURIComponent(rawSku) : '');

            // Single aggregated query to rely on server-side multi-status handling and safe-aggregate fallback
            const agg = await fetchJSON(base + '&status=' + encodeURIComponent('UNPUBLISHED,DRAFT,INACTIVE'));
            offers = Array.isArray(agg?.offers) ? agg.offers : [];

            // Fallback: if explicit queries yielded nothing, do a broad fetch and client-filter
            if (!offers.length) {
              const j = await fetchJSON(base);
              const all = Array.isArray(j.offers) ? j.offers : [];
              const allowed = new Set(['UNPUBLISHED', 'DRAFT', 'INACTIVE']);
              offers = all.filter((o) => allowed.has(String(o?.status || '').toUpperCase()));
            }
            
            // Cache the results
            try {
              sessionStorage.setItem(cacheKey, JSON.stringify(offers));
              sessionStorage.setItem(cacheTimeKey, String(Date.now()));
            } catch {}
          }

          if (!offers.length) {
            readyList.innerHTML =
              '<div class="empty">No drafts found (UNPUBLISHED/DRAFT/INACTIVE). Create your first listing draft from the wizard.</div>';
            needsList.innerHTML = '';
            return;
          }
          
          // Separate drafts by pricing status
          const needsAttention = offers.filter(o => o?.merchantData?.pricingStatus === 'NEEDS_REVIEW');
          const ready = offers.filter(o => o?.merchantData?.pricingStatus !== 'NEEDS_REVIEW');
          
          readyList.innerHTML = '';
          needsList.innerHTML = '';
          
          // Update counts
          $('needsCount').textContent = needsAttention.length ? `(${needsAttention.length})` : '';
          $('readyCount').textContent = ready.length ? `(${ready.length})` : '';
          
          // Hide sections if empty
          $('needsAttention').style.display = needsAttention.length ? 'block' : 'none';
          $('readySection').style.display = ready.length ? 'block' : 'none';
          
          try { 
            if (flash) {
              flash.textContent = `Loaded ${offers.length} drafts (${ready.length} ready, ${needsAttention.length} need attention) - Loading images...`; 
            }
          } catch {}
          
          // Render cards immediately for fast initial display
          needsAttention.forEach((o) => needsList.appendChild(card(o)));
          ready.forEach((o) => readyList.appendChild(card(o)));
          
          // Load images and titles in parallel in the background
          Promise.all([lazyLoadThumbs(), enrichTitles()]).then(() => {
            try {
              if (flash) {
                flash.textContent = `${offers.length} drafts loaded (${ready.length} ready, ${needsAttention.length} need attention)`;
              }
            } catch {}
          }).catch(() => {});
        } catch (e) {
          const wrap = document.createElement('div');
          wrap.className = 'empty';
          const msg = e?.response
            ? JSON.stringify(e.response).slice(0, 500)
            : e?.message || String(e);
          wrap.innerHTML = `Failed to load drafts.<br/><small class="muted">${escapeHtml(msg)}</small> <div style="margin-top:.75rem"><button class="btn secondary" id="retryBtn">Retry</button></div>`;
          readyList.innerHTML = '';
          needsList.innerHTML = '';
          readyList.appendChild(wrap);
          document.getElementById('retryBtn')?.addEventListener('click', load);
        }
      }

      function proxied(url) {
        return '/.netlify/functions/image-proxy?url=' + encodeURIComponent(url);
      }

      async function getImagesForSKU(sku) {
        if (!sku) return [];
        const trySku = async (s) => {
          const j = await fetchJSON(
            '/.netlify/functions/ebay-get-inventory-item?sku=' + encodeURIComponent(s)
          );
          const imgs =
            j?.item?.product?.imageUrls ||
            j?.item?.product?.images ||
            j?.item?.product?.image ||
            [];
          const arr = Array.isArray(imgs) ? imgs : imgs ? [imgs] : [];
          return arr;
        };
        try {
          // First, try given SKU
          const primary = await trySku(sku);
          if (primary.length) return primary;
        } catch {}
        // If SKU contains invalid chars, try sanitized fallback
        const san = String(sku)
          .replace(/[^A-Za-z0-9]/g, '')
          .slice(0, 50);
        if (san && san !== sku) {
          try {
            const fallback = await trySku(san);
            if (fallback.length) return fallback;
          } catch {}
        }
        return [];
      }

      function lazyLoadThumbs() {
        const nodes = [
          ...Array.from(readyList.querySelectorAll('.card')),
          ...Array.from(needsList.querySelectorAll('.card'))
        ];
        const q = [];
        const exec = authClient && typeof authClient.authFetch === 'function' ? authClient.authFetch : fetch;
        for (const n of nodes) {
          const offerId = n.dataset.offerId;
          if (!offerId) continue;
          q.push(async () => {
            // Prefer server-side offer thumb to avoid client CORS/SKU issues
            const url = `/.netlify/functions/ebay-offer-thumb?offerId=${encodeURIComponent(offerId)}`;
            if (url && n._img) {
              try {
                const resp = await exec(url);
                if (!resp.ok) {
                  // Silently skip if thumb endpoint isn't available
                  if (resp.status === 404) {
                    n._sk?.remove?.();
                    return;
                  }
                  throw new Error(`thumb fetch failed: ${resp.status}`);
                }
                const type = (resp.headers.get('content-type') || '').toLowerCase();
                if (type && !type.startsWith('image/')) throw new Error('unexpected content-type');
                const blob = await resp.blob();
                const objectUrl = URL.createObjectURL(blob);
                const revoke = () => {
                  try {
                    URL.revokeObjectURL(objectUrl);
                  } catch {}
                };
                n._img.alt = 'Draft image';
                n._img.onload = () => {
                  n._img.classList.add('loaded');
                  n._sk?.remove?.();
                  revoke();
                };
                n._img.onerror = () => {
                  n._sk?.remove?.();
                  revoke();
                };
                n._img.src = objectUrl;
              } catch (err) {
                n._sk?.remove?.();
              }
            } else {
              // No image found – clear skeleton and leave a subtle placeholder
              if (n._sk) n._sk.remove();
            }
          });
        }
        // run with limited concurrency
        const concurrency = 12;
        let i = 0;
        async function next() {
          const fn = q[i++];
          if (!fn) return;
          await fn();
          return next();
        }
        const workers = Array.from({ length: Math.min(concurrency, q.length) }, next);
        return Promise.all(workers);
      }

      // Fetch inventory item titles for each card by SKU and update the title element
      function enrichTitles() {
        const nodes = [
          ...Array.from(readyList.querySelectorAll('.card')),
          ...Array.from(needsList.querySelectorAll('.card'))
        ];
        const cache = new Map();
        const q = [];
        for (const n of nodes) {
          // @ts-ignore
          const sku = n.dataset?.sku;
          // @ts-ignore
          if (!sku || !n._title) continue;
          
          // Skip if title is already set (enriched from backend)
          // @ts-ignore
          const currentTitle = n._title.textContent || '';
          if (currentTitle && currentTitle !== sku && !currentTitle.includes('loading')) {
            continue; // Already has a real title
          }
          
          q.push(async () => {
            if (cache.has(sku)) {
              const t = cache.get(sku);
              // @ts-ignore
              if (t) n._title.textContent = t;
              return;
            }
            try {
              const j = await fetchJSON(
                '/.netlify/functions/ebay-get-inventory-item?sku=' + encodeURIComponent(sku)
              );
              const t = j?.item?.product?.title || j?.item?.title || '';
              if (t) {
                cache.set(sku, t);
                // @ts-ignore
                n._title.textContent = t;
              }
            } catch {}
          });
        }
        const concurrency = 12;
        let i = 0;
        async function next() {
          const fn = q[i++];
          if (!fn) return;
          await fn();
          return next();
        }
        const workers = Array.from({ length: Math.min(concurrency, q.length) }, next);
        return Promise.all(workers);
      }

      const params = new URLSearchParams(location.search);
      if (params.get('created')) {
        flash.textContent = `Created draft ${params.get('created')}`;
      }
      // wire cleaner
      document.getElementById('btnClean')?.addEventListener('click', async () => {
        const sure = confirm('Delete ALL UNPUBLISHED drafts? This cannot be undone.');
        if (!sure) return;
        const q = '?deleteAll=true&deleteInventory=true';
        
        let totalDeleted = 0;
        let attempts = 0;
        const maxAttempts = 10; // Safety limit
        
        try {
          flash.textContent = 'Deleting drafts…';
          
          // Loop until no more deletions (handles partial batches due to timeout)
          while (attempts < maxAttempts) {
            attempts++;
            const res = await fetch('/.netlify/functions/ebay-clean-broken-drafts' + q);
            
            // Handle 502 Gateway Timeout - deletions likely succeeded
            if (res.status === 502) {
              console.log('[Delete All] 502 timeout - waiting and retrying to check remaining drafts...');
              flash.textContent = `Processing... (batch ${attempts})`;
              await new Promise(resolve => setTimeout(resolve, 2000));
              continue; // Try again to see if there are more drafts
            }
            
            // Handle empty or non-JSON responses
            let j;
            try {
              const text = await res.text();
              j = text ? JSON.parse(text) : {};
            } catch (parseErr) {
              console.error('[Delete All] JSON parse error:', parseErr);
              flash.textContent = 'Checking results...';
              // Wait and continue to next iteration to verify deletions
              await new Promise(resolve => setTimeout(resolve, 2000));
              continue;
            }
            
            if (!res.ok) {
              const errorMsg = j.error || j.detail || 'Unknown error';
              
              // Check for eBay token errors
              if (errorMsg.includes('invalid_grant') || errorMsg.includes('token refresh failed')) {
                flash.textContent = '⚠️ eBay token expired - please reconnect eBay on the Connections page';
                console.error('[Delete All] eBay token expired:', j);
              } else {
                flash.textContent = `Delete failed: ${errorMsg}`;
                console.error('[Delete All] Error:', j);
              }
              break;
            }
            
            const deleted = j.deletedOffers?.length || 0;
            totalDeleted += deleted;
            
            flash.textContent = `Deleted ${totalDeleted} drafts so far…`;
            
            // Check if there are more to delete
            if (!j.summary?.hasMore && !j.timedOut) {
              // All done - show no drafts message without reloading
              flash.textContent = `✓ Deleted ${totalDeleted} drafts total`;
              list.innerHTML =
                '<div class="empty">No drafts found (UNPUBLISHED/DRAFT/INACTIVE). Create your first listing draft from the wizard.</div>';
              break;
            }
            
            // Wait a bit before next batch
            await new Promise(resolve => setTimeout(resolve, 1000));
          }
          
          if (attempts >= maxAttempts) {
            flash.textContent = `Deleted ${totalDeleted} drafts (stopped after ${maxAttempts} batches)`;
            // Show no drafts message without reloading
            list.innerHTML =
              '<div class="empty">No drafts found (UNPUBLISHED/DRAFT/INACTIVE). Create your first listing draft from the wizard.</div>';
          }
          
        } catch (e) {
          flash.textContent = 'Delete error: ' + (e?.message || String(e));
          console.error('[Delete All] Exception:', e);
        }
      });
      
      // Debug button handler
      document.getElementById('btnShowDebug')?.addEventListener('click', () => {
        const debugPanel = document.getElementById('debugPanel');
        const debugOffer = document.getElementById('debugOffer');
        const debugError = document.getElementById('debugError');
        
        if (!lastPublishAttempt) {
          alert('No publish attempts yet. Try publishing a draft first.');
          return;
        }
        
        // Show panel
        debugPanel.style.display = 'block';
        debugPanel.setAttribute('open', '');
        
        // Populate debug info
        debugOffer.textContent = JSON.stringify({
          offerId: lastPublishAttempt.offerId,
          sku: lastPublishAttempt.offer?.sku,
          categoryId: lastPublishAttempt.offer?.categoryId,
          title: lastPublishAttempt.offer?.listing?.title,
          aspects: lastPublishAttempt.offer?.listing?.aspects,
          condition: lastPublishAttempt.offer?.listing?.condition,
          status: lastPublishAttempt.offer?.status,
        }, null, 2);
        
        debugError.textContent = JSON.stringify({
          status: lastPublishAttempt.status,
          response: lastPublishAttempt.response,
          timestamp: lastPublishAttempt.timestamp,
        }, null, 2);
        
        // Scroll to it
        debugPanel.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      });
      
      async function bootstrap() {
        try {
          const ok = await authClient.requireAuth();
          if (!ok) return;
        } catch (e) {
          console.error('Auth check failed', e);
          return;
        }
        load();
      }
      document.getElementById('btnRefresh')?.addEventListener('click', () => { 
        try {
          // Clear cache to force fresh data
          sessionStorage.removeItem('drafts-cache');
          sessionStorage.removeItem('drafts-cache-time');
          load(); 
        } catch {} 
      });
      bootstrap();
    </script>
  </body>
</html>
