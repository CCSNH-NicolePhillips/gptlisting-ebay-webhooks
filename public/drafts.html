<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Drafts ‚Äì DraftPilot</title>
    <link rel="stylesheet" href="/draftpilot.css">
    <style>
      /* Drafts page specific styles */
      }
      .flash {
        color: var(--muted);
        min-height: 1.25rem;
      }
      .toolbar {
        display: flex;
        gap: 0.5rem;
        align-items: center;
      }
      .btn {
        background: var(--primary);
        color: #fff;
        border: none;
        border-radius: 10px;
        padding: 0.55rem 0.85rem;
        font-weight: 600;
        cursor: pointer;
        box-shadow: 0 1px 0 rgba(0, 0, 0, 0.25);
      }
      .btn:hover {
        background: var(--primary-600);
      }
      .btn.secondary {
        background: transparent;
        color: #cbd5ff;
        border: 1px solid var(--line);
        box-shadow: none;
      }
      .btn.danger {
        background: transparent;
        color: #ffb4b4;
        border: 1px solid rgba(239, 68, 68, 0.35);
      }
      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
        gap: 1.5rem;
        align-items: flex-start;
        margin-top: 1.5rem;
      }

      /* Slightly denser grid on big monitors */
      @media (min-width: 1280px) {
        .grid {
          grid-template-columns: repeat(4, minmax(0, 1fr));
        }
      }
      .card {
        display: flex;
        flex-direction: column;
        background: var(--dp-surface-elevated, #020617);
        border-radius: 18px;
        padding: 0.9rem;
        border: 1px solid rgba(148, 163, 184, 0.15);
        box-shadow: 0 18px 40px rgba(15, 23, 42, 0.45);
        transition: transform 0.15s ease-out, box-shadow 0.15s ease-out,
          border-color 0.15s ease-out;
      }

      .card:hover {
        transform: translateY(-2px);
        box-shadow: 0 22px 55px rgba(15, 23, 42, 0.6);
        border-color: rgba(94, 234, 212, 0.5);
      }
      .thumb {
        position: relative;
        width: 100%;
        height: 220px;   /* fixed height instead of padding-top percentage */
        background: #0d1430;
        border-radius: 14px;
        overflow: hidden;
        margin-bottom: 0.75rem;
      }
      .thumb img {
        position: absolute;
        inset: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
        opacity: 0;
        transition: opacity 0.25s ease;
        border-radius: 14px;
      }

      @media (max-width: 640px) {
        .thumb {
          height: 190px;
        }
      }
      .thumb img.loaded {
        opacity: 1;
      }
      .skeleton {
        position: absolute;
        inset: 0;
        background: linear-gradient(
          90deg,
          rgba(255, 255, 255, 0.03),
          rgba(255, 255, 255, 0.06),
          rgba(255, 255, 255, 0.03)
        );
        background-size: 200% 100%;
        animation: shimmer 1.2s infinite;
      }
      @keyframes shimmer {
        0% {
          background-position: 200% 0;
        }
        100% {
          background-position: -200% 0;
        }
      }
      /* lightweight page-level loader */
      .loading {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 2rem;
        color: var(--muted);
        gap: 0.6rem;
      }
      .loading .spinner {
        width: 28px;
        height: 28px;
        border: 3px solid rgba(255, 255, 255, 0.15);
        border-top-color: var(--primary);
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
      .body {
        display: flex;
        flex-direction: column;
        gap: 0.45rem;
        flex: 1;
      }
      .title {
        font-size: 0.95rem;
        font-weight: 600;
        line-height: 1.3;
        display: -webkit-box;
        -webkit-line-clamp: 3; /* clamp long titles */
        line-clamp: 3;
        -webkit-box-orient: vertical;
        overflow: hidden;
      }
      .desc {
        color: var(--muted);
        font-size: 0.8rem;
        line-height: 1.35;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
      }
      .meta {
        color: var(--muted);
        font-size: 0.8rem;
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
      }
      .row {
        display: flex;
        gap: 0.4rem;
        flex-wrap: wrap;
        margin-top: 0.7rem;
      }
      /* push actions to the bottom of the card body */
      .body .row {
        margin-top: auto;
      }
      .row .btn {
        flex: 1;
        font-size: 0.78rem;
        padding: 0.4rem 0.5rem;
      }
      .badge {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        font-size: 0.75rem;
        padding: 0.2rem 0.5rem;
        border-radius: 999px;
        border: 1px solid var(--line);
        color: #d6e1ff;
      }
      /* anchor status badge near bottom, above actions */
      .body .badge {
        margin-top: auto;
      }
      .badge .dot {
        width: 6px;
        height: 6px;
        border-radius: 999px;
        background: var(--warning);
        box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.18);
      }
      .muted {
        color: var(--muted);
      }
      .empty {
        color: var(--muted);
        background: rgba(255, 255, 255, 0.02);
        border: 1px dashed var(--line);
        border-radius: 12px;
        padding: 1.25rem;
        text-align: center;
      }
      a {
        color: #9db2ff;
        text-decoration: none;
      }
      a:hover {
        text-decoration: underline;
      }
      .topbar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin: 0.25rem 0 1rem;
      }
      
      /* Promotion controls */
      .promo-controls {
        display: flex;
        flex-direction: column;
        gap: 0.4rem;
        padding: 0.6rem;
        background: rgba(99, 102, 241, 0.08);
        border: 1px solid rgba(99, 102, 241, 0.2);
        border-radius: 8px;
        margin-top: 0.6rem;
        font-size: 0.8rem;
      }
      .promo-toggle {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        cursor: pointer;
        user-select: none;
      }
      .promo-toggle input[type="checkbox"] {
        width: 16px;
        height: 16px;
        cursor: pointer;
      }
      .promo-toggle label {
        cursor: pointer;
        color: #cbd5ff;
        font-weight: 500;
      }
      .promo-rate {
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }
      .promo-rate label {
        color: var(--muted);
        font-size: 0.75rem;
      }
      .promo-rate input[type="number"] {
        width: 60px;
        padding: 0.3rem 0.4rem;
        background: rgba(0, 0, 0, 0.3);
        border: 1px solid var(--line);
        border-radius: 6px;
        color: #fff;
        font-size: 0.8rem;
      }
      .promo-rate span {
        color: var(--muted);
        font-size: 0.75rem;
      }
      .promo-save {
        padding: 0.35rem 0.6rem;
        background: rgba(99, 102, 241, 0.2);
        border: 1px solid rgba(99, 102, 241, 0.4);
        color: #cbd5ff;
        border-radius: 6px;
        font-size: 0.75rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.15s ease;
      }
      .promo-save:hover {
        background: rgba(99, 102, 241, 0.3);
        border-color: rgba(99, 102, 241, 0.6);
      }
      .promo-save:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
    </style>
  </head>
  <body>
    <script src="/auth-client.js"></script>
    
    <div class="dp-shell">
      <!-- Sidebar -->
      <aside class="dp-sidebar">
        <!-- Brand Area -->
        <div class="dp-sidebar__brand">
          <img src="logo/LogoWhiteText_NoBg.png" alt="DraftPilot - AI Listing Studio" class="dp-brand-logo" />
        </div>
        
        <!-- Navigation -->
        <nav class="dp-sidebar__nav">
          <!-- Primary Navigation Group -->
          <div class="dp-nav-group">
            <div class="dp-nav-group__label">APP</div>
            <div class="dp-nav-group__items">
              <a href="/index.html" class="dp-nav-item">
                <svg class="dp-nav-item__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                  <polyline points="9 22 9 12 15 12 15 22"></polyline>
                </svg>
                <span class="dp-nav-item__label">Overview</span>
              </a>
              <a href="/quick-list.html" class="dp-nav-item">
                <svg class="dp-nav-item__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon>
                </svg>
                <span class="dp-nav-item__label">Create Listings</span>
              </a>
              <a href="/drafts.html" class="dp-nav-item dp-nav-item--active">
                <svg class="dp-nav-item__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                  <polyline points="14 2 14 8 20 8"></polyline>
                </svg>
                <span class="dp-nav-item__label">Drafts</span>
              </a>
              <a href="/active-listings.html" class="dp-nav-item">
                <svg class="dp-nav-item__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect>
                  <path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path>
                </svg>
                <span class="dp-nav-item__label">Active Listings</span>
              </a>
            </div>
          </div>
          
          <!-- Account Navigation Group -->
          <div class="dp-nav-group">
            <div class="dp-nav-group__label">ACCOUNT</div>
            <div class="dp-nav-group__items">
              <a href="/policies-manage.html" class="dp-nav-item">
                <svg class="dp-nav-item__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                  <polyline points="14 2 14 8 20 8"></polyline>
                  <line x1="16" y1="13" x2="8" y2="13"></line>
                  <line x1="16" y1="17" x2="8" y2="17"></line>
                  <polyline points="10 9 9 9 8 9"></polyline>
                </svg>
                <span class="dp-nav-item__label">eBay Policies</span>
              </a>
              <a href="/location.html" class="dp-nav-item">
                <svg class="dp-nav-item__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                  <circle cx="12" cy="10" r="3"></circle>
                </svg>
                <span class="dp-nav-item__label">Inventory Locations</span>
              </a>
              <a href="/settings.html" class="dp-nav-item">
                <svg class="dp-nav-item__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="3"></circle>
                  <path d="M12 1v6m0 6v6m5.196-15.196l-4.243 4.243m0 5.656l-4.242 4.243m15.195-5.196l-4.242-4.243m-5.657 0l-4.243-4.243"></path>
                </svg>
                <span class="dp-nav-item__label">Settings</span>
              </a>
              <a href="/faq.html" class="dp-nav-item">
                <svg class="dp-nav-item__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="10"></circle>
                  <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                  <line x1="12" y1="17" x2="12.01" y2="17"></line>
                </svg>
                <span class="dp-nav-item__label">FAQ</span>
              </a>
              <a href="/support.html" class="dp-nav-item">
                <svg class="dp-nav-item__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="10"></circle>
                  <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                  <line x1="12" y1="17" x2="12.01" y2="17"></line>
                </svg>
                <span class="dp-nav-item__label">Support</span>
              </a>
            </div>
          </div>
        </nav>
        
        <!-- Spacer -->
        <div class="dp-sidebar__spacer"></div>
        
        <!-- User Footer -->
        <div class="dp-sidebar__footer">
          <div class="dp-user-card" id="userCard">
            <div class="dp-user-card__avatar" id="userAvatar">U</div>
            <div class="dp-user-card__info">
              <div class="dp-user-card__name" id="userName">Loading...</div>
              <div class="dp-user-card__status" id="userEmail">Signed in</div>
            </div>
          </div>
          <div class="dp-user-menu" id="userMenu" style="display: none;">
            <a href="/logout.html" class="dp-user-menu__item">
              <svg class="dp-user-menu__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                <polyline points="16 17 21 12 16 7"></polyline>
                <line x1="21" y1="12" x2="9" y2="12"></line>
              </svg>
              <span>Sign out</span>
            </a>
          </div>
        </div>
      </aside>
      
      <div class="dp-mobile-backdrop" id="mobileBackdrop"></div>
      
      <!-- Main Content Wrapper -->
      <div class="dp-main-wrapper">
        <!-- Top Bar -->
        <header class="dp-topbar">
          <!-- Left: Mobile menu + Page Title & Subtitle -->
          <div class="dp-topbar-left">
            <!-- Mobile-only hamburger -->
            <button
              class="dp-topbar-icon dp-topbar-icon--menu"
              id="mobileMenuButton"
              aria-label="Open navigation"
              aria-expanded="false"
              type="button"
            >
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="4" y1="6" x2="20" y2="6"></line>
                <line x1="4" y1="12" x2="20" y2="12"></line>
                <line x1="4" y1="18" x2="20" y2="18"></line>
              </svg>
            </button>

            <div class="dp-topbar-heading">
              <h1 class="dp-topbar__title">Drafts</h1>
              <p class="dp-topbar__subtitle">
                Manage your eBay listing drafts
              </p>
            </div>
          </div>
          
          <!-- Right: Actions -->
          <div class="dp-topbar-right" style="display: flex !important; gap: 0.75rem;">
            <button id="btnPromoteNow" class="dp-btn dp-btn-primary" title="Promote all published drafts" style="padding: 0.5rem 1rem; font-size: 0.875rem;">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 0.35rem;">
                <circle cx="12" cy="12" r="10"></circle>
                <polyline points="16 12 12 8 8 12"></polyline>
                <line x1="12" y1="8" x2="12" y2="16"></line>
              </svg>
              Promote Now
            </button>
            <button id="btnRefresh" class="dp-btn dp-btn-secondary" title="Reload drafts" style="padding: 0.5rem 1rem; font-size: 0.875rem;">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 0.35rem;">
                <polyline points="23 4 23 10 17 10"></polyline>
                <polyline points="1 20 1 14 7 14"></polyline>
                <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
              </svg>
              Refresh
            </button>
            <a href="/index.html" class="dp-btn dp-btn-secondary" style="padding: 0.5rem 1rem; font-size: 0.875rem;">‚Üê Back to Dashboard</a>
            <button id="btnClean" class="dp-btn dp-btn-danger" title="Delete ALL UNPUBLISHED drafts" style="padding: 0.5rem 1rem; font-size: 0.875rem;">
              Delete all drafts
            </button>
            <a class="dp-btn dp-btn-secondary" href="/draft-wizard.html" style="padding: 0.5rem 1rem; font-size: 0.875rem;">Create Draft</a>
          </div>
        </header>
        
        <!-- Main Content Area -->
        <main class="dp-main">
      <div style="margin-bottom: 1.5rem;">
        <div id="flash" class="flash"></div>
      </div>
      
      <div id="initialLoader" class="loading" style="margin: 3rem 0;">
        <div class="spinner" role="status" aria-label="Loading"></div>
        <div class="label">Loading drafts‚Ä¶</div>
      </div>
      
      <div id="needsAttention" style="display: none; margin-bottom: 2rem;">
        <h2 style="font-size: 1.25rem; margin: 1.5rem 0 1rem; color: var(--warning);">‚ö†Ô∏è Needs Attention <span id="needsCount" style="font-size: 0.875rem; color: var(--text-muted);"></span></h2>
        <div id="needsList" class="grid" aria-live="polite">
          <div class="loading">
            <div class="spinner" role="status" aria-label="Loading"></div>
            <div class="label">Loading drafts‚Ä¶</div>
          </div>
        </div>
      </div>
      
      <div id="readySection" style="display: none;">
        <h2 style="font-size: 1.25rem; margin: 1.5rem 0 1rem; color: var(--success);">‚úì Ready to Publish <span id="readyCount" style="font-size: 0.875rem; color: var(--text-muted);"></span></h2>
        <div id="readyList" class="grid" aria-live="polite">
          <div class="loading">
            <div class="spinner" role="status" aria-label="Loading"></div>
            <div class="label">Loading drafts‚Ä¶</div>
          </div>
        </div>
      </div>
    </main>
    </div>
    </div>

    <script>
      // Store last publish attempt for debugging
      let lastPublishAttempt = null;
      async function fetchJSON(url, opts) {
        const exec = authClient && typeof authClient.authFetch === 'function' ? authClient.authFetch : fetch;
        // Add cache-buster and force no-store to avoid stale CDN/browser caches
        const bust = (url.includes('?') ? '&' : '?') + '_ts=' + Date.now();
        const r = await exec(url + bust, Object.assign({ cache: 'no-store' }, opts));
        const t = await r.text();
        let j;
        try {
          j = JSON.parse(t);
        } catch {
          j = { raw: t };
        }
        if (!r.ok)
          throw Object.assign(new Error('HTTP ' + r.status), { response: j, status: r.status });
        return j;
      }
      const $ = (id) => document.getElementById(id);
      const readyList = $('readyList');
      const needsList = $('needsList');
      const flash = $('flash');

      const fmtPrice = (v, c) =>
        v != null && c
          ? new Intl.NumberFormat(undefined, { style: 'currency', currency: c }).format(Number(v))
          : '';

      function card(offer) {
        const el = document.createElement('div');
        el.className = 'card';
        // thumbnail area
        const th = document.createElement('div');
        th.className = 'thumb';
        const sk = document.createElement('div');
        sk.className = 'skeleton';
        th.appendChild(sk);
        const img = document.createElement('img');
        th.appendChild(img);
        // body
        const body = document.createElement('div');
        body.className = 'body';
        const title = document.createElement('div');
        title.className = 'title';
  // Use enriched title from backend if available, otherwise show SKU temporarily
  title.textContent = offer?._enrichedTitle || offer?.title || offer?.sku || '(loading title‚Ä¶)';
  const desc = document.createElement('div');
  desc.className = 'desc';
  const descSrc = (offer.listingDescription || '').replace(/\s+/g, ' ').trim();
  desc.textContent = descSrc ? descSrc.slice(0, 180) : '';
        const meta = document.createElement('div');
        meta.className = 'meta';
        const priceStr = fmtPrice(
          offer?.pricingSummary?.price?.value,
          offer?.pricingSummary?.price?.currency
        );
        
        // Check for pricing status from custom merchant data
        const pricingStatus = offer?.merchantData?.pricingStatus;
        const needsReview = pricingStatus === 'NEEDS_REVIEW';
        
        meta.textContent = [
          offer.sku ? `SKU: ${offer.sku}` : null,
          offer.categoryId ? `Cat: ${offer.categoryId}` : null,
          offer.availableQuantity != null ? `Qty: ${offer.availableQuantity}` : null,
          priceStr ? `Price: ${priceStr}` : (needsReview ? 'Price: ‚ö†Ô∏è Needs Review' : null),
        ]
          .filter(Boolean)
          .join(' ‚Ä¢ ');
  const badge = document.createElement('div');
  badge.className = 'badge';
  const st = String(offer?.status || 'UNPUBLISHED');
  badge.innerHTML = `<span class="dot"></span> ${st}`;
        const row = document.createElement('div');
        row.className = 'row';
        
        const pub = document.createElement('button');
        pub.className = 'btn';
        pub.textContent = 'Publish';
        
        const edit = document.createElement('button');
        edit.className = 'btn secondary';
        edit.textContent = 'Edit';
        edit.title = 'Edit draft details';
        const del = document.createElement('button');
        del.className = 'btn danger';
        del.textContent = 'Delete';

        edit.onclick = () => {
          if (!offer.offerId) {
            flash.textContent = 'Cannot edit: Offer ID not found';
            return;
          }
          window.location.href = `/edit-draft.html?offerId=${encodeURIComponent(offer.offerId)}`;
        };

        pub.onclick = async () => {
          pub.disabled = true;
          del.disabled = true;
          flash.textContent = 'Publishing‚Ä¶';
          
          // Store for debugging
          lastPublishAttempt = {
            offerId: offer.offerId,
            offer: offer,
            timestamp: new Date().toISOString(),
          };
          
          try {
            const exec = (window.authClient && typeof window.authClient.authFetch === 'function') ? window.authClient.authFetch : fetch;
            const r = await exec('/.netlify/functions/ebay-publish-offer', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ offerId: offer.offerId }),
            });
            
            // Safe JSON parsing
            let data;
            try {
              const text = await r.text();
              data = text ? JSON.parse(text) : {};
            } catch (parseErr) {
              console.error('[Publish] JSON parse error:', parseErr);
              flash.textContent = 'Publish error: Invalid response from server';
              pub.disabled = del.disabled = false;
              return;
            }
            
            // Store response for debugging
            lastPublishAttempt.response = data;
            lastPublishAttempt.status = r.status;
            
            if (r.ok && data.ok && !data.deleted) {
              sessionStorage.removeItem('drafts-cache');
              sessionStorage.removeItem('drafts-cache-time');
              el.remove();
              flash.textContent = `Published ${offer.offerId}`;
              return;
            }
            if (r.ok && data.ok && data.deleted) {
              sessionStorage.removeItem('drafts-cache');
              sessionStorage.removeItem('drafts-cache-time');
              el.remove();
              flash.textContent = `Draft ${offer.offerId} had errors and was deleted.`;
              return;
            }
            // Improve error details: surface common onboarding/privilege errors with a direct link
            try {
              const errs = (data?.publish?.detail?.errors && Array.isArray(data.publish.detail.errors)) ? data.publish.detail.errors : [];
              const e25018 = errs.find((e) => Number(e?.errorId) === 25018);
              if (e25018) {
                const params = Array.isArray(e25018.parameters) ? e25018.parameters : [];
                const urlParam = params.find((p) => typeof p?.value === 'string' && /^https:\/\//i.test(p.value));
                const url = urlParam?.value || 'https://ebaypayonboardingweb.ebay.com/seller-reg?client=THIRD_PARTY_API';
                flash.innerHTML = '';
                const span = document.createElement('span');
                span.textContent = 'Publish error: Selling privileges required. ';
                const a = document.createElement('a');
                a.href = url; a.target = '_blank'; a.rel = 'noopener noreferrer'; a.textContent = 'Complete eBay onboarding';
                flash.appendChild(span);
                flash.appendChild(a);
              } else {
                const detail =
                  typeof data?.publish?.detail === 'string'
                    ? data.publish.detail
                    : data?.publish?.detail?.message || JSON.stringify(data?.publish?.detail || data);
                flash.textContent = `Publish error: ${data.error || ''}${detail ? ' ‚Äî ' + detail : ''}`;
              }
            } catch {
              flash.textContent = `Publish error: ${data.error || ''}`;
            }
            pub.disabled = del.disabled = false;
          } catch (e) {
            flash.textContent = 'Publish error: ' + e.message;
            pub.disabled = del.disabled = false;
          }
        };
        del.onclick = async () => {
          if (!confirm('Delete this draft?')) return;
          pub.disabled = true;
          del.disabled = true;
          flash.textContent = 'Deleting‚Ä¶';
          try {
            const exec = (window.authClient && typeof window.authClient.authFetch === 'function') ? window.authClient.authFetch : fetch;
            const r = await exec(
              '/.netlify/functions/ebay-delete-offer?offerId=' + encodeURIComponent(offer.offerId)
            );
            
            // Safe JSON parsing
            let data;
            try {
              const text = await r.text();
              data = text ? JSON.parse(text) : {};
            } catch (parseErr) {
              console.error('[Delete] JSON parse error:', parseErr);
              flash.textContent = 'Delete error: Invalid response from server';
              pub.disabled = del.disabled = false;
              return;
            }
            if (r.ok && data.ok) {
              sessionStorage.removeItem('drafts-cache');
              sessionStorage.removeItem('drafts-cache-time');
              el.remove();
              flash.textContent = `Deleted ${offer.offerId}`;
              
              // Check if the parent section is now empty and hide it
              const parentList = el.parentElement;
              if (parentList && parentList.children.length === 0) {
                if (parentList.id === 'readyList') {
                  $('readySection').style.display = 'none';
                } else if (parentList.id === 'needsList') {
                  $('needsAttention').style.display = 'none';
                }
              }
              
              // Update counts
              const readyCards = document.querySelectorAll('#readyList .card').length;
              const needsCards = document.querySelectorAll('#needsList .card').length;
              $('readyCount').textContent = readyCards ? `(${readyCards})` : '';
              $('needsCount').textContent = needsCards ? `(${needsCards})` : '';
            } else {
              flash.textContent = `Delete error: ${data.error || ''}`;
              pub.disabled = del.disabled = false;
            }
          } catch (e) {
            flash.textContent = 'Delete error: ' + e.message;
            pub.disabled = del.disabled = false;
          }
        };

        // Only add publish button if pricing is OK
        if (!needsReview) {
          row.appendChild(pub);
        }
        row.appendChild(edit);
        row.appendChild(del);
        
        // Promotion controls
        const promoControls = document.createElement('div');
        promoControls.className = 'promo-controls';
        
        const promoToggleDiv = document.createElement('div');
        promoToggleDiv.className = 'promo-toggle';
        
        const promoCheckbox = document.createElement('input');
        promoCheckbox.type = 'checkbox';
        promoCheckbox.id = `promo-${offer.offerId}`;
        promoCheckbox.checked = offer.merchantData?.autoPromote || false;
        
        const promoLabel = document.createElement('label');
        promoLabel.htmlFor = `promo-${offer.offerId}`;
        promoLabel.textContent = 'üöÄ Promote when listed';
        
        promoToggleDiv.appendChild(promoCheckbox);
        promoToggleDiv.appendChild(promoLabel);
        
        const promoRateDiv = document.createElement('div');
        promoRateDiv.className = 'promo-rate';
        promoRateDiv.style.display = promoCheckbox.checked ? 'flex' : 'none';
        
        const rateLabel = document.createElement('label');
        rateLabel.textContent = 'Ad rate:';
        
        const rateInput = document.createElement('input');
        rateInput.type = 'number';
        rateInput.min = '1';
        rateInput.max = '20';
        rateInput.step = '0.1';
        rateInput.value = String(offer.merchantData?.autoPromoteAdRate || 5);
        
        const ratePercent = document.createElement('span');
        ratePercent.textContent = '%';
        
        promoRateDiv.appendChild(rateLabel);
        promoRateDiv.appendChild(rateInput);
        promoRateDiv.appendChild(ratePercent);
        
        const promoSaveBtn = document.createElement('button');
        promoSaveBtn.className = 'promo-save';
        promoSaveBtn.textContent = 'Save Promo Settings';
        
        // Toggle rate input visibility
        promoCheckbox.addEventListener('change', () => {
          promoRateDiv.style.display = promoCheckbox.checked ? 'flex' : 'none';
        });
        
        // Save promotion settings
        promoSaveBtn.addEventListener('click', async () => {
          promoSaveBtn.disabled = true;
          promoSaveBtn.textContent = 'Saving...';
          
          try {
            const exec = (window.authClient && typeof window.authClient.authFetch === 'function') 
              ? window.authClient.authFetch 
              : fetch;
            
            const response = await exec('/.netlify/functions/ebay-update-draft-promo', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                offerId: offer.offerId,
                autoPromote: promoCheckbox.checked,
                autoPromoteAdRate: parseFloat(rateInput.value) || 5,
              }),
            });
            
            const data = await response.json();
            
            if (response.ok && data.ok) {
              flash.textContent = `‚úì Promotion settings saved for ${offer.offerId}`;
              promoSaveBtn.textContent = 'Saved ‚úì';
              
              // Update local offer data
              if (!offer.merchantData) offer.merchantData = {};
              offer.merchantData.autoPromote = data.autoPromote;
              offer.merchantData.autoPromoteAdRate = data.autoPromoteAdRate;
              
              // Clear cache to reflect changes on reload
              sessionStorage.removeItem('drafts-cache');
              sessionStorage.removeItem('drafts-cache-time');
              
              setTimeout(() => {
                promoSaveBtn.textContent = 'Save Promo Settings';
              }, 2000);
            } else {
              flash.textContent = `Promo save error: ${data.error || 'Unknown error'}`;
              promoSaveBtn.textContent = 'Save Promo Settings';
            }
          } catch (e) {
            flash.textContent = `Promo save error: ${e.message}`;
            promoSaveBtn.textContent = 'Save Promo Settings';
          } finally {
            promoSaveBtn.disabled = false;
          }
        });
        
        promoControls.appendChild(promoToggleDiv);
        promoControls.appendChild(promoRateDiv);
        promoControls.appendChild(promoSaveBtn);
        
        body.appendChild(title);
  if (desc.textContent) body.appendChild(desc);
  body.appendChild(meta);
        body.appendChild(badge);
        body.appendChild(promoControls);
        body.appendChild(row);
        el.appendChild(th);
        el.appendChild(body);
        // attach lazy thumbnail loader
        el.dataset.sku = offer.sku || '';
        el.dataset.offerId = offer.offerId || '';
  el._img = img;
  el._sk = sk;
  // @ts-ignore
  el._title = title;
  return el;
      }

      function escapeHtml(s) {
        return String(s).replace(
          /[&<>"]/g,
          (c) => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;' })[c]
        );
      }

      async function load() {
        const initialLoader = document.getElementById('initialLoader');
        
        // Show loading state
        readyList.innerHTML = '';
        needsList.innerHTML = '';
        const loader = document.createElement('div');
        loader.className = 'loading';
        loader.innerHTML =
          '<div class="spinner" role="status" aria-label="Loading"></div><div class="label">Loading drafts‚Ä¶</div>';
        readyList.appendChild(loader.cloneNode(true));
        needsList.appendChild(loader);
        
        try {
          const cacheKey = 'drafts-cache';
          const cacheTimeKey = 'drafts-cache-time';
          const cacheMaxAge = 30000; // 30 seconds
          
          // Try cache first for faster initial load
          let offers = null;
          try {
            const cached = sessionStorage.getItem(cacheKey);
            const cacheTime = sessionStorage.getItem(cacheTimeKey);
            if (cached && cacheTime && (Date.now() - Number(cacheTime)) < cacheMaxAge) {
              offers = JSON.parse(cached);
              console.log('[Drafts] Using cached data');
            }
          } catch {}
          
          // Fetch fresh data if no cache
          if (!offers) {
            // Prefer explicit status queries to ensure UNPUBLISHED/DRAFT/INACTIVE are returned on accounts
            // where the upstream API does not include them by default without offer_status.
            const rawSku = new URL(location.href).searchParams.get('sku') || '';
            const skuOk = /^[A-Za-z0-9]{1,50}$/.test(rawSku);
            const base =
              '/.netlify/functions/ebay-list-offers?limit=100' +
              (skuOk ? '&sku=' + encodeURIComponent(rawSku) : '');

            // Single aggregated query to rely on server-side multi-status handling and safe-aggregate fallback
            const agg = await fetchJSON(base + '&status=' + encodeURIComponent('UNPUBLISHED,DRAFT,INACTIVE'));
            offers = Array.isArray(agg?.offers) ? agg.offers : [];

            // Fallback: if explicit queries yielded nothing, do a broad fetch and client-filter
            if (!offers.length) {
              const j = await fetchJSON(base);
              const all = Array.isArray(j.offers) ? j.offers : [];
              const allowed = new Set(['UNPUBLISHED', 'DRAFT', 'INACTIVE']);
              offers = all.filter((o) => allowed.has(String(o?.status || '').toUpperCase()));
            }
            
            // Cache the results
            try {
              sessionStorage.setItem(cacheKey, JSON.stringify(offers));
              sessionStorage.setItem(cacheTimeKey, String(Date.now()));
            } catch {}
          }

          // Hide initial loader once we have data
          if (initialLoader) initialLoader.style.display = 'none';
          
          if (!offers.length) {
            readyList.innerHTML =
              '<div class="empty">No drafts found (UNPUBLISHED/DRAFT/INACTIVE). Create your first listing draft from the wizard.</div>';
            needsList.innerHTML = '';
            // Show at least the ready section for the empty message
            $('readySection').style.display = 'block';
            $('needsAttention').style.display = 'none';
            return;
          }
          
          // Separate drafts by pricing status
          const needsAttention = offers.filter(o => o?.merchantData?.pricingStatus === 'NEEDS_REVIEW');
          const ready = offers.filter(o => o?.merchantData?.pricingStatus !== 'NEEDS_REVIEW');
          
          readyList.innerHTML = '';
          needsList.innerHTML = '';
          
          // Update counts
          $('needsCount').textContent = needsAttention.length ? `(${needsAttention.length})` : '';
          $('readyCount').textContent = ready.length ? `(${ready.length})` : '';
          
          // Show sections before rendering to prevent layout shift
          $('needsAttention').style.display = needsAttention.length ? 'block' : 'none';
          $('readySection').style.display = ready.length ? 'block' : 'none';
          
          try { 
            if (flash) {
              flash.textContent = `Loaded ${offers.length} drafts (${ready.length} ready, ${needsAttention.length} need attention) - Loading images...`; 
            }
          } catch {}
          
          // Render cards immediately for fast initial display
          needsAttention.forEach((o) => needsList.appendChild(card(o)));
          ready.forEach((o) => readyList.appendChild(card(o)));
          
          // Load images and titles in parallel in the background
          Promise.all([lazyLoadThumbs(), enrichTitles()]).then(() => {
            try {
              if (flash) {
                flash.textContent = `${offers.length} drafts loaded (${ready.length} ready, ${needsAttention.length} need attention)`;
              }
            } catch {}
          }).catch(() => {});
        } catch (e) {
          // Hide initial loader on error
          if (initialLoader) initialLoader.style.display = 'none';
          
          const wrap = document.createElement('div');
          wrap.className = 'dp-card';
          wrap.style.cssText = 'text-align: center; padding: 3rem 2rem;';
          const msg = e?.response
            ? JSON.stringify(e.response).slice(0, 500)
            : e?.message || String(e);
          wrap.innerHTML = `
            <div style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;">‚ö†Ô∏è</div>
            <div style="font-size: 1.25rem; font-weight: 600; color: var(--text-primary); margin-bottom: 0.5rem;">Failed to load drafts</div>
            <div style="font-size: 0.9rem; color: var(--text-muted); margin-bottom: 1.5rem;">${escapeHtml(msg)}</div>
            <button class="dp-btn dp-btn-secondary" id="retryBtn">Retry</button>
          `;
          readyList.innerHTML = '';
          needsList.innerHTML = '';
          readyList.appendChild(wrap);
          document.getElementById('retryBtn')?.addEventListener('click', load);
        }
      }

      function proxied(url) {
        return '/.netlify/functions/image-proxy?url=' + encodeURIComponent(url);
      }

      async function getImagesForSKU(sku) {
        if (!sku) return [];
        const trySku = async (s) => {
          const j = await fetchJSON(
            '/.netlify/functions/ebay-get-inventory-item?sku=' + encodeURIComponent(s)
          );
          const imgs =
            j?.item?.product?.imageUrls ||
            j?.item?.product?.images ||
            j?.item?.product?.image ||
            [];
          const arr = Array.isArray(imgs) ? imgs : imgs ? [imgs] : [];
          return arr;
        };
        try {
          // First, try given SKU
          const primary = await trySku(sku);
          if (primary.length) return primary;
        } catch {}
        // If SKU contains invalid chars, try sanitized fallback
        const san = String(sku)
          .replace(/[^A-Za-z0-9]/g, '')
          .slice(0, 50);
        if (san && san !== sku) {
          try {
            const fallback = await trySku(san);
            if (fallback.length) return fallback;
          } catch {}
        }
        return [];
      }

      function lazyLoadThumbs() {
        const nodes = [
          ...Array.from(readyList.querySelectorAll('.card')),
          ...Array.from(needsList.querySelectorAll('.card'))
        ];
        const q = [];
        const exec = authClient && typeof authClient.authFetch === 'function' ? authClient.authFetch : fetch;
        for (const n of nodes) {
          const offerId = n.dataset.offerId;
          if (!offerId) continue;
          q.push(async () => {
            // Prefer server-side offer thumb to avoid client CORS/SKU issues
            const url = `/.netlify/functions/ebay-offer-thumb?offerId=${encodeURIComponent(offerId)}`;
            if (url && n._img) {
              try {
                const resp = await exec(url);
                if (!resp.ok) {
                  // Silently skip if thumb endpoint isn't available
                  if (resp.status === 404) {
                    n._sk?.remove?.();
                    return;
                  }
                  throw new Error(`thumb fetch failed: ${resp.status}`);
                }
                const type = (resp.headers.get('content-type') || '').toLowerCase();
                if (type && !type.startsWith('image/')) throw new Error('unexpected content-type');
                const blob = await resp.blob();
                const objectUrl = URL.createObjectURL(blob);
                const revoke = () => {
                  try {
                    URL.revokeObjectURL(objectUrl);
                  } catch {}
                };
                n._img.alt = 'Draft image';
                n._img.onload = () => {
                  n._img.classList.add('loaded');
                  n._sk?.remove?.();
                  revoke();
                };
                n._img.onerror = () => {
                  n._sk?.remove?.();
                  revoke();
                };
                n._img.src = objectUrl;
              } catch (err) {
                n._sk?.remove?.();
              }
            } else {
              // No image found ‚Äì clear skeleton and leave a subtle placeholder
              if (n._sk) n._sk.remove();
            }
          });
        }
        // run with limited concurrency
        const concurrency = 12;
        let i = 0;
        async function next() {
          const fn = q[i++];
          if (!fn) return;
          await fn();
          return next();
        }
        const workers = Array.from({ length: Math.min(concurrency, q.length) }, next);
        return Promise.all(workers);
      }

      // Fetch inventory item titles for each card by SKU and update the title element
      function enrichTitles() {
        const nodes = [
          ...Array.from(readyList.querySelectorAll('.card')),
          ...Array.from(needsList.querySelectorAll('.card'))
        ];
        const cache = new Map();
        const q = [];
        for (const n of nodes) {
          // @ts-ignore
          const sku = n.dataset?.sku;
          // @ts-ignore
          if (!sku || !n._title) continue;
          
          // Skip if title is already set (enriched from backend)
          // @ts-ignore
          const currentTitle = n._title.textContent || '';
          if (currentTitle && currentTitle !== sku && !currentTitle.includes('loading')) {
            continue; // Already has a real title
          }
          
          q.push(async () => {
            if (cache.has(sku)) {
              const t = cache.get(sku);
              // @ts-ignore
              if (t) n._title.textContent = t;
              return;
            }
            try {
              const j = await fetchJSON(
                '/.netlify/functions/ebay-get-inventory-item?sku=' + encodeURIComponent(sku)
              );
              const t = j?.item?.product?.title || j?.item?.title || '';
              if (t) {
                cache.set(sku, t);
                // @ts-ignore
                n._title.textContent = t;
              }
            } catch {}
          });
        }
        const concurrency = 12;
        let i = 0;
        async function next() {
          const fn = q[i++];
          if (!fn) return;
          await fn();
          return next();
        }
        const workers = Array.from({ length: Math.min(concurrency, q.length) }, next);
        return Promise.all(workers);
      }

      const params = new URLSearchParams(location.search);
      if (params.get('created')) {
        flash.textContent = `Created draft ${params.get('created')}`;
      }
      // wire cleaner
      document.getElementById('btnClean')?.addEventListener('click', async () => {
        const sure = confirm('Delete ALL UNPUBLISHED drafts? This cannot be undone.');
        if (!sure) return;
        let queryParams = '?deleteAll=true&deleteInventory=true';
        
        let totalDeleted = 0;
        let attempts = 0;
        const maxAttempts = 10; // Safety limit
        
        try {
          flash.textContent = 'Deleting drafts‚Ä¶';
          
          // Loop until no more deletions (handles partial batches due to timeout)
          while (attempts < maxAttempts) {
            attempts++;
            const res = await fetch('/.netlify/functions/ebay-clean-broken-drafts' + queryParams);
            
            // Handle 502 Gateway Timeout - deletions likely succeeded
            if (res.status === 502) {
              console.log('[Delete All] 502 timeout - waiting and retrying to check remaining drafts...');
              flash.textContent = `Processing... (batch ${attempts})`;
              await new Promise(resolve => setTimeout(resolve, 2000));
              continue; // Try again to see if there are more drafts
            }
            
            // Handle empty or non-JSON responses
            let j;
            try {
              const text = await res.text();
              j = text ? JSON.parse(text) : {};
            } catch (parseErr) {
              console.error('[Delete All] JSON parse error:', parseErr);
              flash.textContent = 'Checking results...';
              // Wait and continue to next iteration to verify deletions
              await new Promise(resolve => setTimeout(resolve, 2000));
              continue;
            }
            
            if (!res.ok) {
              const errorMsg = j.error || j.detail || 'Unknown error';
              
              // Check for eBay token errors
              if (errorMsg.includes('invalid_grant') || errorMsg.includes('token refresh failed')) {
                flash.textContent = '‚ö†Ô∏è eBay token expired - please reconnect eBay on the Connections page';
                console.error('[Delete All] eBay token expired:', j);
              } else {
                flash.textContent = `Delete failed: ${errorMsg}`;
                console.error('[Delete All] Error:', j);
              }
              break;
            }
            
            const deleted = j.deletedOffers?.length || 0;
            totalDeleted += deleted;
            
            // If server says to skip fast scan on next retry, add the flag
            if (j.skipFastScan) {
              queryParams = '?deleteAll=true&deleteInventory=true&skipFastScan=true';
            }
            
            flash.textContent = `Deleted ${totalDeleted} drafts so far‚Ä¶`;
            
            // Check if there are more to delete
            if (!j.summary?.hasMore && !j.timedOut) {
              // All done - show no drafts message without reloading
              flash.textContent = `‚úì Deleted ${totalDeleted} drafts total`;
              const readyList = document.getElementById('readyList');
              const needsList = document.getElementById('needsList');
              if (readyList) readyList.innerHTML =
                '<div class="empty">No drafts found (UNPUBLISHED/DRAFT/INACTIVE). Create your first listing draft from the wizard.</div>';
              if (needsList) needsList.innerHTML = '';
              break;
            }
            
            // Wait a bit before next batch
            await new Promise(resolve => setTimeout(resolve, 1000));
          }
          
          if (attempts >= maxAttempts) {
            flash.textContent = `Deleted ${totalDeleted} drafts (stopped after ${maxAttempts} batches)`;
            // Show no drafts message without reloading
            const readyList = document.getElementById('readyList');
            const needsList = document.getElementById('needsList');
            if (readyList) readyList.innerHTML =
              '<div class="empty">No drafts found (UNPUBLISHED/DRAFT/INACTIVE). Create your first listing draft from the wizard.</div>';
            if (needsList) needsList.innerHTML = '';
          }
          
        } catch (e) {
          flash.textContent = 'Delete error: ' + (e?.message || String(e));
          console.error('[Delete All] Exception:', e);
        }
      });
      
      // Debug button handler
      document.getElementById('btnShowDebug')?.addEventListener('click', () => {
        const debugPanel = document.getElementById('debugPanel');
        const debugOffer = document.getElementById('debugOffer');
        const debugError = document.getElementById('debugError');
        
        if (!lastPublishAttempt) {
          alert('No publish attempts yet. Try publishing a draft first.');
          return;
        }
        
        // Show panel
        debugPanel.style.display = 'block';
        debugPanel.setAttribute('open', '');
        
        // Populate debug info
        debugOffer.textContent = JSON.stringify({
          offerId: lastPublishAttempt.offerId,
          sku: lastPublishAttempt.offer?.sku,
          categoryId: lastPublishAttempt.offer?.categoryId,
          title: lastPublishAttempt.offer?.listing?.title,
          aspects: lastPublishAttempt.offer?.listing?.aspects,
          condition: lastPublishAttempt.offer?.listing?.condition,
          status: lastPublishAttempt.offer?.status,
        }, null, 2);
        
        debugError.textContent = JSON.stringify({
          status: lastPublishAttempt.status,
          response: lastPublishAttempt.response,
          timestamp: lastPublishAttempt.timestamp,
        }, null, 2);
        
        // Scroll to it
        debugPanel.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      });
      
      function initUserMenu() {
        const userCard = document.getElementById('userCard');
        const userMenu = document.getElementById('userMenu');
        
        if (!userCard || !userMenu) return;
        
        userCard.addEventListener('click', (e) => {
          e.stopPropagation();
          const isVisible = userMenu.style.display !== 'none';
          userMenu.style.display = isVisible ? 'none' : 'block';
        });
        
        // Close menu when clicking outside
        document.addEventListener('click', (e) => {
          if (!userCard.contains(e.target) && !userMenu.contains(e.target)) {
            userMenu.style.display = 'none';
          }
        });
      }
      
      async function bootstrap() {
        try {
          const ok = await authClient.requireAuth();
          if (!ok) return;
          await authClient.updateUserDisplay().catch(() => {});
        } catch (e) {
          console.error('Auth check failed', e);
          return;
        }
        load();
      }
      document.getElementById('btnRefresh')?.addEventListener('click', () => { 
        try {
          // Clear cache to force fresh data
          sessionStorage.removeItem('drafts-cache');
          sessionStorage.removeItem('drafts-cache-time');
          load(); 
        } catch {} 
      });
      initUserMenu();
      bootstrap();
    </script>
    
    </main>
    </div>
    </div>
    
    <!-- Mobile Menu Script -->
    <script>
      (function() {
        const menuButton = document.getElementById('mobileMenuButton');
        const backdrop = document.getElementById('mobileBackdrop');
        const shell = document.querySelector('.dp-shell');
        
        if (menuButton && backdrop && shell) {
          backdrop.addEventListener('click', () => {
            shell.classList.remove('dp-shell--nav-open');
          });
          
          menuButton.addEventListener('click', () => {
            const willOpen = !shell.classList.contains('dp-shell--nav-open');
            shell.classList.toggle('dp-shell--nav-open', willOpen);
            menuButton.setAttribute('aria-expanded', willOpen);
          });
          
          const navLinks = document.querySelectorAll('.dp-sidebar a');
          navLinks.forEach(link => {
            link.addEventListener('click', () => {
              shell.classList.remove('dp-shell--nav-open');
            });
          });
        }
      })();
    </script>
  </body>
</html>
