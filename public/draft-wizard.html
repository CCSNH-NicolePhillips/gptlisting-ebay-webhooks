<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Create draft ¬∑ Wizard</title>
    <style>
      body {
        font-family:
          system-ui,
          -apple-system,
          Segoe UI,
          Roboto,
          Arial,
          sans-serif;
        margin: 0;
        padding: 2rem;
        background: #0b1020;
        color: #f4f6fb;
      }
      .card {
        max-width: 920px;
        margin: 0 auto 1rem;
        background: #141a33;
        border: 1px solid #2a335c;
        border-radius: 12px;
        padding: 1.25rem 1.5rem;
      }
      .filter-box { display: none; }

      /* Responsive grid for category/aspect listings */
      .row {
        display: grid;
        gap: 1rem;
        grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
        margin-bottom: 0.75rem;
      }
      .col { min-width: 0; }
      /* Structured row layout for the Step 2 form */
      .form-row {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        margin-bottom: 0.85rem;
      }
      .form-field {
        flex: 1 1 250px;
        min-width: 220px;
      }
      .form-field.compact {
        flex: 0 0 160px;
        min-width: 140px;
      }
      .form-field.tiny {
        flex: 0 0 120px;
        min-width: 110px;
      }
      .form-field.wide {
        flex: 1 1 100%;
        min-width: 100%;
      }
      .form-field label > small {
        display: block;
        margin-top: 0.35rem;
        font-size: 0.75rem;
        line-height: 1.3;
      }
      .compact-input {
        max-width: 140px;
        text-align: right;
      }
      .text-warn { color: #ff8f8f; }
      @media (max-width: 680px) {
        .form-row { flex-direction: column; }
        .form-field,
        .form-field.compact,
        .form-field.tiny,
        .form-field.wide { flex: 1 1 100%; min-width: 100%; }
        .compact-input { max-width: none; }
      }
      label { display: block; margin: 0.4rem 0 0.25rem; }
      input, textarea, select {
        background: #0f1530;
        color: #f4f6fb;
        border: 1px solid #26305a;
        border-radius: 8px;
        padding: 0.6rem 0.7rem;
        width: 100%;
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
      }
      textarea { min-height: 110px; }
      input:focus, textarea:focus, select:focus {
        outline: none;
        border-color: #4f7cff;
        box-shadow: 0 0 0 2px rgba(79, 124, 255, 0.2);
      }
      button { background: #4f7cff; color: white; border: none; border-radius: 8px; padding: 0.7rem 1rem; cursor: pointer; font-weight: 600; }
      button.secondary { background: transparent; color: #cbd5ff; border: 1px solid #3d4a86; }
      .muted { color: #a2a9c8; }
      .inline { display: inline-block; }
      .hide { display: none !important; }
      details { border: 1px dashed #2a335c; padding: 0.4rem 0.6rem; border-radius: 8px; }
      .hr { margin: 0.8rem 0; border: none; border-top: 1px solid #2a335c; }
      .overlay {
        position: fixed;
        inset: 0;
        background: rgba(11, 16, 32, 0.85);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9998;
      }
      .overlay-box {
        background: rgba(20, 26, 51, 0.92);
        border: 1px solid #2a335c;
        border-radius: 12px;
        padding: 1.35rem 1.75rem;
        text-align: center;
        box-shadow: 0 12px 36px rgba(0, 0, 0, 0.35);
      }
      .spinner-lg {
        width: 48px;
        height: 48px;
        border: 4px solid rgba(255, 255, 255, 0.2);
        border-top-color: #4f7cff;
        border-radius: 50%;
        animation: spin 0.85s linear infinite;
        margin: 0 auto 0.85rem;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
      /* Modal layout */
      .modal {
        position: fixed;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        background: rgba(0, 0, 0, 0.6);
      }
    </style>
  </head>
  <body>
    <script src="/auth-client.js"></script>
    <script>
      authClient.requireAuth();
    </script>
    <script>
      // TEMPORARY: Redirect to Quick List until ChatGPT guided wizard is ready
      // TODO: Remove this redirect when implementing ChatGPT chat box feature
      if (!window.location.search.includes('dev')) {
        window.location.href = '/quick-list.html';
      }
    </script>
    <div id="pageLoader" class="overlay hide" role="status" aria-live="polite">
      <div class="overlay-box">
        <div class="spinner-lg" aria-hidden="true"></div>
        <div class="muted" style="font-size:.9rem;">Loading‚Ä¶</div>
      </div>
    </div>
    <div class="card">
      <a class="secondary" href="/">‚Üê Back</a>
      <h2>Create draft ‚Äì Step 1: Pick category</h2>
      <p class="muted">
        Start with a category so we can populate the right required and optional fields.
      </p>
      <!-- Step 1 is category-only: choose a leaf via Browse; raw IDs are hidden -->
      <div class="row" style="margin-top: -0.25rem">
        <div class="col"><button id="btnBrowse" class="secondary">Browse categories</button></div>
      </div>
      <div id="categoryPreview" class="muted" style="margin: 0.25rem 0 0.25rem"></div>
      <div id="browseModal" class="modal hide" role="dialog" aria-modal="true">
        <div
          id="browsePanel"
          style="
            background: #141a33;
            border: 1px solid #2a335c;
            border-radius: 12px;
            max-width: 900px;
            width: 92%;
            padding: 1rem 1.25rem;
            max-height: 80vh;
            overflow: auto;
          "
        >
          <div style="display: flex; justify-content: space-between; align-items: center">
            <h3 style="margin: 0.2rem 0">Browse categories</h3>
            <button id="browseClose" type="button" class="secondary">Close</button>
          </div>
          <div id="crumbs" class="muted" style="margin: 0.4rem 0 0.6rem"></div>
          <div id="browseList" class="row"></div>
        </div>
      </div>
      <div
        style="margin: 0.5rem 0; display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap"
      >
        <button id="btnNext" disabled>Next ‚Üí</button>
        <span id="msg1" class="muted"></span>
      </div>
    </div>

    <div id="step2" class="card hide">
      <h2>Step 2: Details and create</h2>
      <p id="catPath" class="muted"></p>
      <div class="form-row">
        <div class="form-field wide">
          <label>Title<input id="title" placeholder="Type your listing title" /></label>
        </div>
      </div>
      <div class="form-row">
        <div class="form-field">
          <label>SKU
            <input id="sku" placeholder="SKU123" maxlength="50" />
            <small id="skuHint" class="muted">Use 1-50 letters or numbers. No spaces or punctuation.</small>
          </label>
        </div>
        <div class="form-field compact">
          <label>Price USD<input id="price" class="compact-input" type="number" inputmode="decimal" min="0" step="0.01" placeholder="19.99" /></label>
        </div>
        <div class="form-field compact">
          <label>Qty<input id="qty" class="compact-input" type="number" inputmode="numeric" min="1" step="1" value="1" /></label>
        </div>
      </div>
      <div class="form-row">
        <div class="form-field wide">
          <label>Images</label>
          <input id="images" type="hidden" />
          <div id="imgPicker" style="margin-top:.25rem">
            <div id="imgDropdown" style="border:1px solid #2a335c;border-radius:8px;padding:.55rem .7rem;cursor:pointer;display:flex;justify-content:space-between;align-items:center;background:#0f1530">
              <span id="imgPlaceholder" class="muted"><span id="imgPhText">Choose images‚Ä¶</span><span id="imgSpinner" style="display:none;margin-left:8px" aria-hidden="true">‚è≥</span></span><span>‚ñæ</span>
            </div>
            <div id="imgOptions" style="display:none;position:relative;border:1px solid #2a335c;border-top:none;border-radius:0 0 8px 8px;max-height:360px;overflow:auto;background:#0f1530"></div>
            <div id="imgChips" style="display:flex;flex-wrap:wrap;gap:6px;margin-top:.5rem"></div>
            <div id="imgGrid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:8px;margin-top:.5rem"></div>
          </div>
          <small class="muted" id="imgTip"></small>
        </div>
      </div>
      <div class="form-row">
        <div class="form-field compact">
          <label>Weight (lbs)<input id="weightLbs" class="compact-input" type="number" step="0.01" min="0" placeholder="1.0" /></label>
        </div>
        <div class="form-field compact">
          <label>Weight (oz)<input id="weightOz" class="compact-input" type="number" step="0.1" min="0" placeholder="16" /></label>
        </div>
      </div>
      <div class="form-row">
        <div class="form-field wide">
          <label
            >Description<textarea
              id="description"
              rows="3"
              placeholder="Describe the item, ingredients, material, etc."
            ></textarea>
          </label>
        </div>
      </div>
      <div class="form-row">
        <div class="form-field">
          <label>Condition<select id="condition"></select></label>
        </div>
        <div class="form-field">
          <label>Location<select id="location"></select></label>
        </div>
      </div>
      <div class="hr"></div>
      <div id="reqAspectsWrap" class="hide">
        <h3 style="margin: 0.2rem 0">Required specifics</h3>
        <div id="reqAspects" class="row"></div>
      </div>
      <details style="margin-top: 0.6rem">
        <summary>Optional specifics</summary>
        <div id="optAspects" class="row" style="margin-top: 0.4rem"></div>
      </details>
      <div style="margin: 0.8rem 0 0.2rem; display: flex; gap: 0.5rem; align-items: center">
        <button id="btnCreate">Create draft</button>
        <button id="btnPublish" class="secondary" disabled>Publish now</button>
        <button id="btnShowDebug" class="secondary" style="margin-left: auto">üêõ Debug</button>
        <span id="msg2" class="muted"></span>
      </div>
      
      <!-- Debug Panel -->
      <details id="debugPanel" style="margin-top: 1rem; display: none">
        <summary style="cursor: pointer; font-weight: bold; color: #0066cc">
          üêõ Debug Info (Draft Data Being Sent)
        </summary>
        <div style="margin-top: 0.5rem; background: #f5f5f5; padding: 1rem; border-radius: 4px; font-family: monospace; font-size: 0.85rem;">
          <div style="margin-bottom: 0.5rem">
            <strong>Group Data:</strong>
            <pre id="debugGroup" style="background: white; padding: 0.5rem; overflow-x: auto; margin: 0.25rem 0"></pre>
          </div>
          <div style="margin-bottom: 0.5rem">
            <strong>Mapped Draft (Inventory):</strong>
            <pre id="debugInventory" style="background: white; padding: 0.5rem; overflow-x: auto; margin: 0.25rem 0"></pre>
          </div>
          <div>
            <strong>Offer Data:</strong>
            <pre id="debugOffer" style="background: white; padding: 0.5rem; overflow-x: auto; margin: 0.25rem 0"></pre>
          </div>
        </div>
      </details>
    </div>

    <script>
      const $ = (id) => document.getElementById(id);
      const catPreview = $('categoryPreview');
      const titleEl = $('title');
      // removed search input
      const nextBtn = $('btnNext');
      const step2 = $('step2');
      const msg1 = $('msg1');
      const conditionSel = $('condition');
      const locationSel = $('location');
      const modal = $('browseModal');
      const browseBtn = $('btnBrowse');
      const btnShowDebug = $('btnShowDebug');
      const debugPanel = $('debugPanel');
      const debugGroup = $('debugGroup');
      const debugInventory = $('debugInventory');
      const debugOffer = $('debugOffer');

      const browseClose = $('browseClose');
      const browseList = $('browseList');
      const crumbs = $('crumbs');
      const browsePanel = $('browsePanel');
      const skuInput = $('sku');
      const skuHintEl = $('skuHint');
      const skuDefaultHint = 'Use 1-50 letters or numbers. No spaces or punctuation.';
      const skuPattern = /^[A-Za-z0-9]{1,50}$/;
      
      // Global to store last created draft data for debugging
      let lastDraftData = null;
      
      // Edit mode detection
      const urlParams = new URLSearchParams(window.location.search);
      const IS_EDIT_MODE = urlParams.get('edit') === 'true';
      const EDIT_OFFER_ID = urlParams.get('offerId');

      function updateSkuHint(value) {
        if (!skuHintEl) return;
        const trimmed = (value || '').trim();
        if (!trimmed) {
          skuHintEl.textContent = skuDefaultHint;
          skuHintEl.classList.remove('text-warn');
          return;
        }
        if (skuPattern.test(trimmed)) {
          skuHintEl.textContent = 'Looks good. Keep using only letters or numbers.';
          skuHintEl.classList.remove('text-warn');
        } else {
          skuHintEl.textContent = 'SKU must be 1-50 characters, letters and numbers only.';
          skuHintEl.classList.add('text-warn');
        }
      }
      if (skuInput) {
        const sanitizeSku = (raw) => (raw || '').replace(/[^A-Za-z0-9]/g, '');
        const syncSku = (raw) => {
          const clean = sanitizeSku(raw);
          if (skuInput.value !== clean) {
            skuInput.value = clean;
            try {
              const pos = clean.length;
              skuInput.setSelectionRange(pos, pos);
            } catch {}
          }
          updateSkuHint(clean);
        };
        updateSkuHint(sanitizeSku(skuInput.value));
        skuInput.addEventListener('input', () => syncSku(skuInput.value));
        skuInput.addEventListener('blur', () => syncSku(skuInput.value));
      }
      // Internal category selection state (browse-only flow)
      let SELECTED_CATEGORY_ID = '';
      let SELECTED_CATEGORY_PATH = '';
      // Category CSV data (if available)
      let CAT_ROWS = null; // Array of {categoryId, categoryName, categoryPath}
      let CAT_TREE = null; // Tree built from CSV paths
      let ID_INDEX = null; // Map of id -> { leaf, path, name }

      async function fetchJSON(url, opts) {
        const r = await fetch(url, opts);
        let j;
        try {
          j = await r.json();
        } catch {
          j = { raw: await r.text() };
        }
        if (!r.ok)
          throw Object.assign(new Error('HTTP ' + r.status), { response: j, status: r.status });
        return j;
      }
      // No free-text picker in Step 1; category chosen via Browse only.
      const debounce = (fn, ms = 300) => {
        let t;
        return (...a) => {
          clearTimeout(t);
          t = setTimeout(() => fn(...a), ms);
        };
      };
      async function loadCategoriesCsv() {
        if (CAT_ROWS) return CAT_ROWS;
        // Prefer relative (served from public/) then absolute
        const tryUrls = ['taxonomy-categories-EBAY_US.csv', '/taxonomy-categories-EBAY_US.csv'];
        let text = null;
        for (const url of tryUrls) {
          try {
            const r = await fetch(url);
            if (r.ok) {
              text = await r.text();
              break;
            }
          } catch {}
        }
        if (!text) {
          return null;
        }
        // parse CSV (3 columns: categoryId,categoryName,categoryPath), quoted
        const lines = text.split(/\r?\n/).filter(Boolean);
        const rows = [];
        for (let i = 1; i < lines.length; i++) {
          const line = lines[i];
          const cols = [];
          let cur = '';
          let inQ = false;
          for (let j = 0; j < line.length; j++) {
            const ch = line[j];
            if (ch === '"') {
              if (inQ && line[j + 1] === '"') {
                cur += '"';
                j++;
              } else inQ = !inQ;
            } else if (ch === ',' && !inQ) {
              cols.push(cur);
              cur = '';
            } else cur += ch;
          }
          cols.push(cur);
          if (cols.length >= 3) {
            const [categoryId, categoryName, categoryPath] = cols;
            if (categoryId && categoryName)
              rows.push({ categoryId, categoryName, categoryPath: categoryPath || categoryName });
          }
        }
        CAT_ROWS = rows;
        // build tree
        const root = { name: 'Root', children: new Map(), path: '', leaf: false };
        const idIndex = new Map();
        rows.forEach((r) => {
          const parts = (r.categoryPath || r.categoryName).split(' > ').filter(Boolean);
          let node = root;
          let pathAcc = [];
          for (let idx = 0; idx < parts.length; idx++) {
            const part = parts[idx];
            pathAcc.push(part);
            if (!node.children.has(part))
              node.children.set(part, {
                name: part,
                children: new Map(),
                path: pathAcc.join(' > '),
                leaf: false,
              });
            node = node.children.get(part);
          }
          // mark leaf and attach id
          node.leaf = true;
          node.id = r.categoryId;
          node.path = r.categoryPath || pathAcc.join(' > ');
          idIndex.set(String(r.categoryId), {
            leaf: true,
            path: node.path,
            name: parts[parts.length - 1] || r.categoryName,
          });
        });
        CAT_TREE = root;
        ID_INDEX = idIndex;
        return rows;
      }

      // Step 1 intentionally has no Title/Photo inputs; browse-only selection.

      async function loadLocations() {
        try {
          const j = await fetchJSON('/.netlify/functions/ebay-list-locations');
          const list = j.locations || [];
          locationSel.innerHTML = '';
          list.forEach((loc) => {
            const o = document.createElement('option');
            o.value = loc.merchantLocationKey;
            o.textContent =
              loc.merchantLocationKey + (loc.location?.name ? ' ‚Äî ' + loc.location.name : '');
            locationSel.appendChild(o);
          });
        } catch (e) {
          locationSel.innerHTML = '';
          const o = document.createElement('option');
          o.value = '';
          o.textContent = 'No locations found';
          locationSel.appendChild(o);
        }
      }

      function renderAspect(containerId, aspect, required) {
        const wrap = document.createElement('div');
        wrap.className = 'col';
        const id = 'asp_' + (aspect.localizedAspectName || aspect.aspectName).replace(/\s+/g, '_');
        const label = document.createElement('label');
        label.textContent =
          (aspect.localizedAspectName || aspect.aspectName) + (required ? ' *' : '');
        const name = aspect.aspectName || aspect.localizedAspectName;
        const values = Array.isArray(aspect.aspectValues) ? aspect.aspectValues : [];
        const cardinality = aspect.aspectConstraint?.itemToAspectCardinality || 'SINGLE';
        const isEnum = values.length > 0;
        const isMulti = cardinality === 'MULTI';
        let field;
        if (isEnum) {
          const sel = document.createElement('select');
          sel.id = id;
          sel.setAttribute('data-aspect', name);
          if (isMulti) sel.multiple = true;
          if (!required && !isMulti) {
            const blank = document.createElement('option');
            blank.value = '';
            blank.textContent = '‚Äî';
            sel.appendChild(blank);
          }
          values.forEach((v) => {
            const o = document.createElement('option');
            const val = v.localizedValue || v.value || v;
            o.value = val;
            o.textContent = val;
            sel.appendChild(o);
          });
          field = sel;
        } else {
          const inp = document.createElement('input');
          inp.id = id;
          inp.setAttribute('data-aspect', name);
          field = inp;
        }
        wrap.appendChild(label);
        wrap.appendChild(field);
        $(containerId).appendChild(wrap);
      }

      async function enterStep2() {
        const cid = (SELECTED_CATEGORY_ID || '').trim();
        if (!cid) {
          msg1.textContent = 'Select a category first.';
          return;
        }
        nextBtn.disabled = true;
        msg1.textContent = 'Loading requirements‚Ä¶';
        try {
          // Resolve taxonomy treeId first for reliability
          let treeId = '0';
          try {
            const t = await fetchJSON('/.netlify/functions/ebay-taxonomy-tree-id');
            treeId = String(t.categoryTreeId || '0');
          } catch {}
          // Call requirements with treeId and retry once on transient 502
          let req;
          try {
            req = await fetchJSON(
              `/.netlify/functions/ebay-category-requirements?treeId=${encodeURIComponent(treeId)}&categoryId=${encodeURIComponent(cid)}`
            );
          } catch (e) {
            if (e?.status === 502) {
              await new Promise((r) => setTimeout(r, 400));
              req = await fetchJSON(
                `/.netlify/functions/ebay-category-requirements?treeId=${encodeURIComponent(treeId)}&categoryId=${encodeURIComponent(cid)}`
              );
            } else throw e;
          }
          // render path and condition
          $('catPath').textContent = SELECTED_CATEGORY_PATH
            ? 'Category: ' + SELECTED_CATEGORY_PATH
            : 'Category selected';
          conditionSel.innerHTML = '';
          const conds = req.allowedConditions || [];
          if (conds.length) {
            conds.forEach((c) => {
              const o = document.createElement('option');
              o.value = c.conditionId;
              o.textContent = `${c.conditionId} ‚Äî ${c.conditionDescription}`;
              conditionSel.appendChild(o);
            });
            // Default-select New (1000) if present, otherwise first
            const prefer = conds.find((c) => String(c.conditionId) === '1000');
            conditionSel.value = prefer
              ? String(prefer.conditionId)
              : String(conds[0]?.conditionId || '');
          } else {
            const o = document.createElement('option');
            o.value = '';
            o.textContent = '(none)';
            conditionSel.appendChild(o);
          }
          // render aspects
          const reqWrap = $('reqAspectsWrap');
          $('reqAspects').innerHTML = '';
          $('optAspects').innerHTML = '';
          const reqList = Array.isArray(req.requiredAspects) ? req.requiredAspects : [];
          reqList.forEach((a) => renderAspect('reqAspects', a, true));
          if (reqWrap) {
            reqWrap.classList.add('hide');
            reqWrap.setAttribute('aria-hidden', 'true');
          }
          (req.optionalAspects || []).forEach((a) => renderAspect('optAspects', a, false));
          await loadLocations();
          step2.classList.remove('hide');
          msg1.textContent = '';
          // Update image tip with default Dropbox folder
          try {
            const def = localStorage.getItem('dbxDefaultFolder') || '';
            const tip = document.getElementById('imgTip');
            if (tip)
              tip.textContent = def
                ? `Default Dropbox folder: ${def}. Images will be easiest to pick from that folder in the selector pages.`
                : 'Tip: Use the Select Images page to pick proxied URLs, or paste direct image links.';
          } catch {}
          // Auto-load images from default folder into the inline picker
          try { ImagePickerWizard.loadDefault(); } catch {}
          window.scrollTo({ top: step2.offsetTop - 10, behavior: 'smooth' });
        } catch (e) {
          const detail = e?.response?.errorId || e?.response?.message || e?.message || String(e);
          msg1.textContent =
            'Requirements error: ' +
            detail +
            '. If this persists, pick a leaf category via Browse.';
          console.error('requirements error', e);
        } finally {
          nextBtn.disabled = false;
        }
      }
      nextBtn.addEventListener('click', enterStep2);

      function collectAspects() {
        const map = {};
        document.querySelectorAll('[id^="asp_"]').forEach((el) => {
          const name = el.getAttribute('data-aspect');
          if (!name) return;
          if (el.tagName === 'SELECT' && el.multiple) {
            const vals = Array.from(el.selectedOptions)
              .map((o) => o.value)
              .filter(Boolean);
            if (vals.length) map[name] = vals;
          } else {
            const val = (el.value || '').trim();
            if (val) map[name] = val;
          }
        });
        return map;
      }

      $('btnCreate').addEventListener('click', async () => {
        const msg = $('msg2');
        msg.textContent = 'Submitting‚Ä¶';
        const skuRaw = (skuInput || { value: '' }).value.trim();
        const title = (titleEl || { value: '' }).value.trim();
        const price = parseFloat(($('price') || { value: '' }).value);
        const qty = parseInt(($('qty') || { value: '1' }).value, 10) || 1;
        const imagesRaw = ($('images') || { value: '' }).value.trim();
        const images = imagesRaw
          ? imagesRaw
              .split(',')
              .map((s) => s.trim())
              .filter(Boolean)
          : [];
        const description = ($('description') || { value: '' }).value.trim();
        const merchantLocationKey = (locationSel || { value: '' }).value.trim();
        const categoryId = (SELECTED_CATEGORY_ID || '').trim();
        const condition = (conditionSel || { value: '' }).value.trim(); // numeric string like '1000'
        if (!skuRaw) {
          updateSkuHint(skuRaw);
          msg.textContent = 'SKU is required and must be alphanumeric.';
          return;
        }
        if (!skuPattern.test(skuRaw)) {
          updateSkuHint(skuRaw);
          msg.textContent = 'SKU must be 1-50 characters, using letters and numbers only.';
          return;
        }
        const sku = skuRaw;
        if (!title) {
          msg.textContent = 'Title is required.';
          return;
        }
        if (!Number.isFinite(price) || price <= 0) {
          msg.textContent = 'Price must be a positive number.';
          return;
        }
        if (!Number.isFinite(qty) || qty <= 0) {
          msg.textContent = 'Quantity must be a positive whole number.';
          return;
        }
        if (!images.length) {
          msg.textContent = 'Add at least one image URL before creating a draft.';
          return;
        }
        const aspects = collectAspects();
        
        // Store draft data for debugging
        lastDraftData = {
          sku,
          title,
          price,
          qty,
          images,
          merchantLocationKey,
          categoryId,
          description: description || undefined,
          condition: condition || undefined,
          aspects: Object.keys(aspects).length ? aspects : undefined,
          weightLbs: weightLbs || undefined,
          weightOz: weightOz || undefined,
        };
        
        try {
          const weightLbs = (document.getElementById('weightLbs') || { value: '' }).value.trim();
          const weightOz = (document.getElementById('weightOz') || { value: '' }).value.trim();
          const r = await authClient.authFetch('/.netlify/functions/ebay-create-draft', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(lastDraftData),
          });
          const data = await r.json();
          const resultsCount = Array.isArray(data?.results) ? data.results.length : 0;
          const failuresCount = Array.isArray(data?.failures) ? data.failures.length : 0;
          const ok = r.ok && (data?.ok !== false);
          if (ok && resultsCount > 0) {
            const first = Array.isArray(data.results) ? data.results[0] : null;
            const offerId = first?.offerId || data.draftOffer?.offerId || null;
            const status = (first?.status || data.status || 'UNPUBLISHED').toString();
            const sUp = status.toUpperCase();
            const draftStatuses = new Set(['UNPUBLISHED','DRAFT','INACTIVE']);
            // Redirect to drafts page listing all drafts; include created id for flash if we have an id
            if (offerId) {
              // Set a quick message before redirect (best-effort)
              if (draftStatuses.has(sUp)) msg.textContent = `Draft created: Offer ${offerId} (status: ${sUp})`;
              else msg.textContent = `Offer status: ${sUp} (Offer ${offerId})`;
              location.href = `/drafts.html?created=${encodeURIComponent(offerId)}`;
              return;
            }
            // No offerId came back; summarize outcome
            const parts = [];
            if (resultsCount) parts.push(`${resultsCount} draft${resultsCount>1?'s':''} created`);
            if (failuresCount) parts.push(`${failuresCount} failed`);
            const summary = parts.join(', ') || (draftStatuses.has(sUp) ? 'Draft created' : 'Offer result');
            msg.textContent = `${summary} (${sUp}).`;
          } else {
            const detail =
              typeof data.detail === 'string'
                ? data.detail
                : data.detail?.message ||
                  data.detail?.errors ||
                  data.detail?.warnings ||
                  data.detail;
            msg.textContent = `Error: ${data.error || 'request failed'}${data.status ? ' (' + data.status + ')' : ''} ‚Äî ${detail ? (typeof detail === 'string' ? detail : JSON.stringify(detail)) : JSON.stringify(data)}`;
          }
        } catch (e) {
          msg.textContent = 'Error: ' + e.message;
        }
      });

      // Publish button handler
      (function () {
        const btnPub = document.getElementById('btnPublish');
        if (!btnPub) return;
        btnPub.addEventListener('click', async () => {
          const offerId = btnPub.dataset.offerId;
          const msg = document.getElementById('msg2');
          if (!offerId) {
            msg.textContent = 'No offerId to publish.';
            return;
          }
          msg.textContent = 'Publishing‚Ä¶';
          btnPub.disabled = true;
          try {
            const cond = (document.getElementById('condition') || { value: '' }).value;
            const r = await authClient.authFetch('/.netlify/functions/ebay-publish-offer', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ offerId, condition: cond ? Number(cond) : undefined }),
            });
            const data = await r.json();
            if (r.ok && data.ok) {
              msg.textContent = `Published: ${offerId}`;
              try {
                // Defer cleanup: when user leaves this page, delete any leftover UNPUBLISHED drafts for this SKU (excluding this offerId)
                var skuEl = document.getElementById('sku');
                var sku = skuEl && skuEl.value ? skuEl.value : '';
                const payload = JSON.stringify({ items: [{ sku, excludeOfferId: offerId }] });
                const url = '/.netlify/functions/ebay-clean-drafts';
                // Prefer beacon for background cleanup; fallback to fetch if beacon unsupported
                if (!navigator.sendBeacon || !navigator.sendBeacon(url, new Blob([payload], { type: 'application/json' }))) {
                  window.addEventListener('beforeunload', () => {
                    fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: payload }).catch(() => {});
                  }, { once: true });
                } else {
                  window.addEventListener('beforeunload', () => {
                    navigator.sendBeacon(url, new Blob([payload], { type: 'application/json' }));
                  }, { once: true });
                }
              } catch {}
            } else {
              const detail =
                typeof data.detail === 'string'
                  ? data.detail
                  : data.detail?.message ||
                    data.detail?.errors ||
                    data.detail?.warnings ||
                    data.detail;
              msg.textContent = `Publish error: ${data.error || 'request failed'}${data.status ? ' (' + data.status + ')' : ''} ‚Äî ${detail ? (typeof detail === 'string' ? detail : JSON.stringify(detail)) : JSON.stringify(data)}`;
              btnPub.disabled = false;
            }
          } catch (e) {
            msg.textContent = 'Publish error: ' + e.message;
            btnPub.disabled = false;
          }
        });
      })();

      // No free-text category picker; Next is enabled only after a leaf is chosen in Browse.

      function renderBrowseLocal(node, trail) {
        // breadcrumbs
        const parts = [];
        const rootA = document.createElement('a');
        rootA.href = '#';
        rootA.textContent = 'Root';
        rootA.onclick = (e) => {
          e.preventDefault();
          renderBrowseLocal(CAT_TREE, []);
        };
        parts.push(rootA);
        trail.forEach((n) => {
          const sep = document.createElement('span');
          sep.textContent = ' > ';
          parts.push(sep);
          const a = document.createElement('a');
          a.href = '#';
          a.textContent = n.name;
          a.onclick = (e) => {
            e.preventDefault();
            const idx = trail.indexOf(n);
            renderBrowseLocal(idx >= 0 ? trail[idx] : CAT_TREE, trail.slice(0, idx + 1));
          };
          parts.push(a);
        });
        crumbs.innerHTML = '';
        parts.forEach((x) => crumbs.appendChild(x));
        // list (chunked render to reduce lag)
        browseList.innerHTML = '';
        const entries = Array.from(node.children?.entries?.() || []);
        const step = 60;
        function renderChunk(start) {
          const frag = document.createDocumentFragment();
          for (const [name, child] of entries.slice(start, start + step)) {
            const wrap = document.createElement('div');
            wrap.className = 'col';
            wrap.style.minWidth = '260px';
            const btn = document.createElement('button');
            btn.className = 'secondary';
            btn.style.width = '100%';
            const isLeaf = !!child.leaf && (!child.children || child.children.size === 0);
            btn.textContent = (isLeaf ? 'üìÑ ' : 'üìÅ ') + name;
            btn.title = child.path;
            btn.onclick = () => {
              if (isLeaf && child.id) {
                SELECTED_CATEGORY_ID = String(child.id);
                SELECTED_CATEGORY_PATH = child.path || name;
                catPreview.textContent = SELECTED_CATEGORY_PATH;
                nextBtn.disabled = false;
                msg1.textContent = '';
                modal.classList.add('hide');
              } else {
                renderBrowseLocal(child, [...trail, child]);
              }
            };
            wrap.appendChild(btn);
            frag.appendChild(wrap);
          }
          browseList.appendChild(frag);
          if (start + step < entries.length) {
            const more = document.createElement('button');
            more.type = 'button';
            more.className = 'secondary';
            more.textContent = `Load more (${entries.length - (start + step)})`;
            more.onclick = () => {
              more.remove();
              renderChunk(start + step);
            };
            browseList.appendChild(more);
          }
        }
        renderChunk(0);
      }

      async function browse(categoryId) {
        const rows = CAT_ROWS || (await loadCategoriesCsv());
        if (rows && CAT_TREE) {
          renderBrowseLocal(CAT_TREE, []);
          return;
        }
        // fallback to remote
        try {
          const url =
            '/.netlify/functions/ebay-category-browse' +
            (categoryId ? '?categoryId=' + encodeURIComponent(categoryId) : '');
          const j = await fetchJSON(url);
          // crumbs (clickable)
          const bc = j.breadcrumbs || [];
          const parts = [];
          const rootA = document.createElement('a');
          rootA.href = '#';
          rootA.textContent = 'Root';
          rootA.onclick = (e) => {
            e.preventDefault();
            browse();
          };
          parts.push(rootA);
          bc.forEach((b, idx) => {
            const sep = document.createElement('span');
            sep.textContent = ' > ';
            parts.push(sep);
            const a = document.createElement('a');
            a.href = '#';
            a.textContent = b.name;
            a.onclick = (e) => {
              e.preventDefault();
              browse(b.id);
            };
            parts.push(a);
          });
          crumbs.innerHTML = '';
          parts.forEach((el) => crumbs.appendChild(el));
          // list
          browseList.innerHTML = '';
          const children = j.children || [];
          const step = 60;
          function renderChunk(start) {
            const frag = document.createDocumentFragment();
            for (const n of children.slice(start, start + step)) {
              const wrap = document.createElement('div');
              wrap.className = 'col';
              wrap.style.minWidth = '260px';
              const btn = document.createElement('button');
              btn.className = 'secondary';
              btn.style.width = '100%';
              btn.textContent = (n.leaf ? 'üìÑ ' : 'üìÅ ') + n.name;
              btn.title = n.path;
              btn.onclick = () => {
                if (n.leaf) {
                  SELECTED_CATEGORY_ID = String(n.id);
                  SELECTED_CATEGORY_PATH = n.path || n.name;
                  catPreview.textContent = SELECTED_CATEGORY_PATH;
                  nextBtn.disabled = false;
                  msg1.textContent = '';
                  modal.classList.add('hide');
                } else {
                  browse(n.id);
                }
              };
              wrap.appendChild(btn);
              frag.appendChild(wrap);
            }
            browseList.appendChild(frag);
            if (start + step < children.length) {
              const more = document.createElement('button');
              more.type = 'button';
              more.className = 'secondary';
              more.textContent = `Load more (${children.length - (start + step)})`;
              more.onclick = () => {
                more.remove();
                renderChunk(start + step);
              };
              browseList.appendChild(more);
            }
          }
          renderChunk(0);
        } catch (e) {
          crumbs.textContent = 'Browse error: ' + (e.response?.error || e.message);
        }
      }

      if (browseBtn)
        browseBtn.onclick = () => {
          modal.classList.remove('hide');
          browse();
        };
      if (browseClose)
        browseClose.onclick = () => {
          modal.classList.add('hide');
          setTimeout(() => {
            try {
              browseBtn?.focus();
            } catch {}
          }, 0);
        };
      // Backdrop click closes (use currentTarget for safety)
      if (modal)
        modal.addEventListener('click', (e) => {
          if (e.currentTarget === e.target) {
            modal.classList.add('hide');
            setTimeout(() => {
              try {
                browseBtn?.focus();
              } catch {}
            }, 0);
          }
        });
      if (browsePanel) browsePanel.addEventListener('click', (e) => e.stopPropagation());
      // Escape key closes
      window.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && !modal.classList.contains('hide')) {
          modal.classList.add('hide');
          setTimeout(() => {
            try {
              browseBtn?.focus();
            } catch {}
          }, 0);
        }
      });

      // Inline Dropbox image picker for Step 2
      const ImagePickerWizard = (() => {
        const byId = (id) => document.getElementById(id);
        const dd = byId('imgDropdown');
        const ddOpts = byId('imgOptions');
        const ddPh = byId('imgPhText');
        const ddSpinner = byId('imgSpinner');
        const chips = byId('imgChips');
        const grid = byId('imgGrid');
        const imagesInput = byId('images');
        const pageLoader = document.getElementById('pageLoader');
        let items = [];
        const selected = new Map(); // proxiedUrl -> item
        let isLoading = false;

        function setLoading(v) {
          isLoading = !!v;
          if (ddSpinner) ddSpinner.style.display = v ? 'inline' : 'none';
          if (pageLoader) {
            if (v) {
              pageLoader.classList.remove('hide');
              try { document.body.style.overflow = 'hidden'; } catch {}
            } else {
              pageLoader.classList.add('hide');
              try { document.body.style.overflow = ''; } catch {}
            }
          }
          // Provide a loading placeholder inside the dropdown options
          if (v) {
            ddOpts.style.display = 'none';
            ddOpts.innerHTML = '<div style="padding:.75rem" class="muted">Loading images‚Ä¶</div>';
          } else if (!items.length) {
            // If nothing loaded, keep it empty but hide to reduce confusion
            ddOpts.style.display = 'none';
            ddOpts.innerHTML = '';
          }
        }

        function optionRow(it) {
          const row = document.createElement('div');
          row.style.display = 'flex';
          row.style.alignItems = 'center';
          row.style.gap = '10px';
          row.style.padding = '.55rem .7rem';
          row.style.borderTop = '1px solid #2a335c';
          const img = document.createElement('img');
          img.src = it.proxiedUrl; img.alt = it.name; img.width = 48; img.height = 48; img.loading = 'lazy';
          img.style.objectFit = 'cover'; img.style.borderRadius = '6px';
          const meta = document.createElement('div');
          meta.innerHTML = `<div style="font-size:12px;font-weight:600">${it.name}</div><div class="muted" style="font-size:11px">${it.path}</div>`;
          const cb = document.createElement('input');
          cb.type = 'checkbox'; cb.style.marginLeft = 'auto';
          cb.checked = selected.has(it.proxiedUrl);
          cb.onchange = () => { if (cb.checked) selected.set(it.proxiedUrl, it); else selected.delete(it.proxiedUrl); refresh(); };
          row.append(img, meta, cb);
          row.onclick = (e) => { if (e.target !== cb) { cb.checked = !cb.checked; cb.onchange(); } };
          return row;
        }

        function chip(it) {
          const c = document.createElement('span');
          c.style.display = 'inline-flex'; c.style.alignItems = 'center'; c.style.gap = '6px';
          c.style.background = '#1c254d'; c.style.border = '1px solid #2a335c'; c.style.borderRadius = '999px'; c.style.padding = '4px 8px'; c.style.fontSize = '12px';
          const img = document.createElement('img'); img.src = it.proxiedUrl; img.width = 16; img.height = 16; img.style.objectFit = 'cover'; img.style.borderRadius = '3px';
          const txt = document.createElement('span'); txt.textContent = it.name;
          c.append(img, txt);
          return c;
        }

        function card(it) {
          const wrap = document.createElement('div');
          wrap.style.border = '1px solid #2a335c'; wrap.style.borderRadius = '8px'; wrap.style.overflow = 'hidden';
          const img = document.createElement('img'); img.src = it.proxiedUrl; img.alt = it.name; img.style.width = '100%'; img.style.height = '140px'; img.style.objectFit = 'cover'; img.loading = 'lazy';
          const cap = document.createElement('div'); cap.textContent = it.name; cap.style.fontSize = '12px'; cap.style.padding = '.5rem';
          wrap.append(img, cap);
          return wrap;
        }

        function refresh() {
          // options list (preserve scroll)
          const scrollTop = ddOpts.scrollTop;
          ddOpts.innerHTML = '';
          items.forEach((it) => ddOpts.appendChild(optionRow(it)));
          ddOpts.scrollTop = scrollTop;
          // chips/grid
          chips.innerHTML = ''; grid.innerHTML = '';
          Array.from(selected.values()).forEach((it) => { chips.appendChild(chip(it)); grid.appendChild(card(it)); });
          // update hidden images input
          imagesInput.value = Array.from(selected.keys()).join(',');
          ddPh.textContent = selected.size ? `${selected.size} selected` : 'Choose images‚Ä¶';
        }

        async function loadFrom(path, recursive = true, limit = 200) {
          if (!path) {
            setLoading(false);
            ddPh.textContent = 'Set default Dropbox folder on landing page';
            ddOpts.innerHTML = '';
            chips.innerHTML = '';
            grid.innerHTML = '';
            selected.clear();
            refresh();
            return;
          }
          setLoading(true);
          ddPh.textContent = 'Loading images‚Ä¶';
          const url = new URL('/.netlify/functions/dropbox-list-images', window.location.origin);
          url.searchParams.set('path', path);
          if (recursive) url.searchParams.set('recursive', '1');
          if (limit) url.searchParams.set('limit', String(limit));
          try {
            const res = await fetch(url.toString());
            const j = await res.json();
            items = (j && j.items) || [];
            refresh();
            ddPh.textContent = items.length ? 'Choose images‚Ä¶' : 'No images found';
          } catch (e) {
            ddPh.textContent = 'Failed to load images';
          }
          setLoading(false);
          ddOpts.style.display = 'none';
        }

        // dropdown open/close
        dd.addEventListener('click', () => {
          const open = ddOpts.style.display !== 'none';
          ddOpts.style.display = open ? 'none' : 'block';
        });
        document.addEventListener('click', (e) => {
          if (!dd.contains(e.target) && !ddOpts.contains(e.target)) ddOpts.style.display = 'none';
        });

        return {
          loadDefault: () => {
            try {
              const def = localStorage.getItem('dbxDefaultFolder') || '';
              loadFrom(def);
            } catch {
              // ignore
            }
          },
          loadFrom,
        };
      })();
      
      // Debug button handler
      if (btnShowDebug) {
        btnShowDebug.addEventListener('click', () => {
          if (!lastDraftData) {
            alert('No draft data yet. Create a draft first to see debug info.');
            return;
          }
          
          // Show the debug panel
          debugPanel.style.display = 'block';
          debugPanel.setAttribute('open', '');
          
          // Populate debug info
          debugGroup.textContent = JSON.stringify(lastDraftData, null, 2);
          debugInventory.textContent = 'Create draft to see what gets sent to eBay API...';
          debugOffer.textContent = 'After draft is created, offerId will appear here.';
          
          // Scroll to it
          debugPanel.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        });
      }
    </script>
  </body>
</html>
