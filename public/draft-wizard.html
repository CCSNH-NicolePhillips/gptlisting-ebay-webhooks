<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Create draft · Wizard</title>
    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; padding: 2rem; background:#0b1020; color:#f4f6fb; }
      .card { max-width: 920px; margin: 0 auto 1rem; background: #141a33; border: 1px solid #2a335c; border-radius: 12px; padding: 1.25rem 1.5rem; }
      .row { display:flex; gap:1rem; flex-wrap:wrap; margin-bottom: .75rem; }
  .col { flex:1 1 260px; min-width:0 }
  .col.title { flex:2 1 420px }
      label { display:block; margin:.4rem 0 .25rem }
      input, textarea, select { background: #0f1530; color: #f4f6fb; border: 1px solid #26305a; border-radius: 8px; padding: .6rem .7rem; width:100% }
      button { background: #4f7cff; color: white; border: none; border-radius: 8px; padding: .7rem 1rem; cursor: pointer; font-weight: 600; }
      button.secondary { background: transparent; color: #cbd5ff; border: 1px solid #3d4a86; }
      .muted { color: #a2a9c8; }
      .inline { display:inline-block }
      .hide { display:none !important }
      details { border: 1px dashed #2a335c; padding:.4rem .6rem; border-radius: 8px; }
      .hr { margin: .8rem 0; border:none; border-top:1px solid #2a335c }
      /* Modal layout: keep display control in CSS, not inline */
      .modal { position:fixed; inset:0; display:flex; align-items:center; justify-content:center; z-index:9999; background:rgba(0,0,0,.6); }
    </style>
  </head>
  <body>
    <div class="card">
      <a class="secondary" href="/">← Back</a>
      <h2>Create draft – Step 1: Pick category</h2>
      <p class="muted">Start with a category so we can populate the right required and optional fields.</p>
      <div class="row">
        <div class="col title"><label>Title<input id="title" placeholder="Type your listing title"/></label></div>
        <div class="col"><label>Search categories<input id="catSearch" placeholder="Type keywords e.g., supplements, jeans" list="categoryOptions"/></label></div>
      </div>
      <div class="row">
        <div class="col"><label>Or choose a photo (optional)<input id="photo" type="file" accept="image/*" /></label><small class="muted">We use the file name text for suggestions.</small></div>
      </div>
      <div class="row">
        <div class="col"><label>Or paste an image link (optional)<input id="photoUrl" placeholder="https://... (Dropbox links ok; add ?dl=1 for direct)"/></label><small class="muted">We use the URL file name for suggestions.</small></div>
      </div>
      <div class="row">
        <div class="col"><label>Category<input id="categoryPicker" list="categoryOptions" placeholder="Start typing or pick a suggestion" /><datalist id="categoryOptions"></datalist></label><div id="categoryPreview" class="muted" style="margin-top:.25rem"></div></div>
        <div class="col"><label>Category ID<input id="categoryId" placeholder="e.g., 31413"/></label></div>
      </div>
      <div class="row" style="margin-top:-.25rem">
        <div class="col"><button id="btnBrowse" class="secondary">Browse categories</button></div>
      </div>
      <div id="browseModal" class="modal hide" role="dialog" aria-modal="true">
        <div id="browsePanel" style="background:#141a33;border:1px solid #2a335c;border-radius:12px;max-width:900px;width:92%;padding:1rem 1.25rem;max-height:80vh;overflow:auto">
          <div style="display:flex;justify-content:space-between;align-items:center"><h3 style="margin:.2rem 0">Browse categories</h3><button id="browseClose" type="button" class="secondary">Close</button></div>
          <div id="crumbs" class="muted" style="margin:.4rem 0 .6rem"></div>
          <div id="browseList" class="row"></div>
        </div>
      </div>
      <div style="margin:.5rem 0">
        <button id="btnNext" disabled>Next →</button>
        <span id="msg1" class="muted"></span>
      </div>
    </div>

    <div id="step2" class="card hide">
      <h2>Step 2: Details and create</h2>
      <p id="catPath" class="muted"></p>
      <div class="row">
        <div class="col"><label>SKU<input id="sku" placeholder="SKU-123"/></label></div>
        <div class="col"><label>Price USD<input id="price" type="number" min="0" step="0.01" placeholder="19.99"/></label></div>
        <div class="col"><label>Qty<input id="qty" type="number" min="1" value="1"/></label></div>
      </div>
      <div class="row">
        <div class="col"><label>Image URLs (comma-separated)<input id="images" placeholder="https://...jpg, https://...png"/></label></div>
      </div>
      <div class="row">
        <div class="col"><label>Description<textarea id="description" rows="3" placeholder="Describe the item, ingredients, material, etc."></textarea></label></div>
      </div>
      <div class="row">
        <div class="col"><label>Condition<select id="condition"></select></label></div>
        <div class="col"><label>Location<select id="location"></select></label></div>
      </div>
      <div class="hr"></div>
      <div>
        <h3 style="margin:.2rem 0">Required specifics</h3>
        <div id="reqAspects" class="row"></div>
      </div>
      <details style="margin-top:.6rem">
        <summary>Optional specifics</summary>
        <div id="optAspects" class="row" style="margin-top:.4rem"></div>
      </details>
      <div style="margin:.8rem 0 .2rem">
        <button id="btnCreate">Create draft</button>
        <span id="msg2" class="muted"></span>
      </div>
    </div>

    <script>
      const $ = (id) => document.getElementById(id);
      const datalist = $('categoryOptions');
      const picker = $('categoryPicker');
      const categoryIdEl = $('categoryId');
      const catPreview = $('categoryPreview');
      const titleEl = $('title');
      const searchEl = $('catSearch');
      const nextBtn = $('btnNext');
      const step2 = $('step2');
      const msg1 = $('msg1');
      const conditionSel = $('condition');
      const locationSel = $('location');
      const modal = $('browseModal');
  const browseBtn = $('btnBrowse');
      const browseClose = $('browseClose');
      const browseList = $('browseList');
      const crumbs = $('crumbs');
  const browsePanel = $('browsePanel');
  // Category CSV data (if available)
  let CAT_ROWS = null; // Array of {categoryId, categoryName, categoryPath}
  let CAT_TREE = null; // Tree built from CSV paths

      async function fetchJSON(url, opts) { const r = await fetch(url, opts); let j; try { j = await r.json(); } catch { j = { raw: await r.text() }; } if (!r.ok) throw Object.assign(new Error('HTTP '+r.status), { response:j, status:r.status }); return j; }
      const applyOptions = (list) => { datalist.innerHTML = ''; (list||[]).slice(0,80).forEach(item => { const opt = document.createElement('option'); opt.value = `${item.categoryId} — ${item.categoryName}`; opt.setAttribute('data-id', item.categoryId); opt.setAttribute('data-path', item.categoryPath || item.categoryName); datalist.appendChild(opt); }); };
      const updatePreview = (opt) => { catPreview.textContent = opt ? (opt.getAttribute('data-path')||'') : ''; };
      const debounce = (fn, ms=300) => { let t; return (...a) => { clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; };
      async function loadCategoriesCsv(){
        if (CAT_ROWS) return CAT_ROWS;
        const tryUrls = [ '/taxonomy-categories-EBAY_US.csv' ];
        let text = null;
        for (const url of tryUrls){
          try { const r = await fetch(url); if (r.ok) { text = await r.text(); break; } } catch {}
        }
        if (!text) return null;
        // parse CSV (3 columns: categoryId,categoryName,categoryPath), quoted
        const lines = text.split(/\r?\n/).filter(Boolean);
        const rows = [];
        for (let i=1;i<lines.length;i++){
          const line = lines[i];
          const cols = [];
          let cur=''; let inQ=false;
          for (let j=0;j<line.length;j++){
            const ch = line[j];
            if (ch==='"'){
              if (inQ && line[j+1]==='"'){ cur+='"'; j++; }
              else inQ = !inQ;
            } else if (ch===',' && !inQ){ cols.push(cur); cur=''; }
            else cur+=ch;
          }
          cols.push(cur);
          if (cols.length>=3){
            const [categoryId, categoryName, categoryPath] = cols;
            if (categoryId && categoryName) rows.push({ categoryId, categoryName, categoryPath: categoryPath||categoryName });
          }
        }
        CAT_ROWS = rows;
        // build tree
        const root = { name:'Root', children: new Map(), path: '', leaf:false };
        rows.forEach(r=>{
          const parts = (r.categoryPath||r.categoryName).split(' > ').filter(Boolean);
          let node = root; let pathAcc=[];
          for (let idx=0; idx<parts.length; idx++){
            const part = parts[idx]; pathAcc.push(part);
            if (!node.children.has(part)) node.children.set(part, { name: part, children: new Map(), path: pathAcc.join(' > '), leaf:false });
            node = node.children.get(part);
          }
          // mark leaf and attach id
          node.leaf = true; node.id = r.categoryId; node.path = r.categoryPath || pathAcc.join(' > ');
        });
        CAT_TREE = root;
        return rows;
      }

      const localSuggest = debounce(async (q) => {
        const rows = CAT_ROWS || await loadCategoriesCsv();
        if (!rows) { return; }
        const qq = (q || '').toLowerCase();
        if (!qq) { datalist.innerHTML=''; return; }
        const matches = [];
        for (const r of rows) {
          const nameLC = (r.categoryName||'').toLowerCase();
          const lastSeg = (r.categoryPath||r.categoryName||'').split(' > ').pop() || '';
          const lastLC = lastSeg.toLowerCase();
          if (nameLC.startsWith(qq) || lastLC.startsWith(qq)) {
            matches.push({ categoryId: r.categoryId, categoryName: r.categoryName, categoryPath: r.categoryPath });
            if (matches.length >= 150) break;
          }
        }
        applyOptions(matches);
      }, 150);

      // Fallback remote suggestions if CSV unavailable
      const remoteSuggest = debounce(async (q) => { if (!q) return; try { const j = await fetchJSON('/.netlify/functions/ebay-category-suggestions?q='+encodeURIComponent(q)); applyOptions(j.suggestions||[]); } catch(e){ msg1.textContent = 'Suggest error'; } }, 350);
  if (titleEl) titleEl.addEventListener('input', async (e)=> { const rows = CAT_ROWS || await loadCategoriesCsv(); if (rows) localSuggest(e.target.value); else remoteSuggest(e.target.value); });
  if (searchEl) searchEl.addEventListener('input', async (e)=> { const rows = CAT_ROWS || await loadCategoriesCsv(); if (rows) localSuggest(e.target.value); else remoteSuggest(e.target.value); });
      const photoEl = $('photo');
      if (photoEl) photoEl.addEventListener('change', () => { const f = photoEl.files && photoEl.files[0]; if (!f) return; const name = (f.name||'').replace(/\.[^.]+$/, '').replace(/[_-]+/g,' '); if (name) { titleEl.value = titleEl.value||name; suggest(name); } });
      const photoUrlEl = $('photoUrl');
      if (photoUrlEl) photoUrlEl.addEventListener('input', () => { const url = photoUrlEl.value.trim(); if (!url) return; try { const last = url.split('?')[0].split('#')[0].split('/').pop()||''; const base = last.replace(/\.[^.]+$/, '').replace(/[_-]+/g,' '); if (base) { titleEl.value = titleEl.value||base; }
        const rows = CAT_ROWS; if (rows) localSuggest(base); else remoteSuggest(base); } catch {} });
      
      if (categoryIdEl) categoryIdEl.addEventListener('input', () => { nextBtn.disabled = !categoryIdEl.value.trim(); });

      async function loadLocations() {
        try { const j = await fetchJSON('/.netlify/functions/ebay-list-locations'); const list = j.locations||[]; locationSel.innerHTML=''; list.forEach(loc=>{ const o=document.createElement('option'); o.value = loc.merchantLocationKey; o.textContent = loc.merchantLocationKey + (loc.location?.name? (' — '+loc.location.name):''); locationSel.appendChild(o); }); } catch(e){ locationSel.innerHTML=''; const o=document.createElement('option'); o.value=''; o.textContent='No locations found'; locationSel.appendChild(o); }
      }

      function renderAspect(containerId, aspect, required){
        const wrap = document.createElement('div'); wrap.className='col';
        const id = 'asp_'+(aspect.localizedAspectName||aspect.aspectName).replace(/\s+/g,'_');
        const label = document.createElement('label'); label.textContent = (aspect.localizedAspectName||aspect.aspectName) + (required?' *':'');
        const name = aspect.aspectName || aspect.localizedAspectName;
        const values = Array.isArray(aspect.aspectValues) ? aspect.aspectValues : [];
        const cardinality = aspect.aspectConstraint?.itemToAspectCardinality || 'SINGLE';
        const isEnum = values.length > 0;
        const isMulti = cardinality === 'MULTI';
        let field;
        if (isEnum) {
          const sel = document.createElement('select'); sel.id = id; sel.setAttribute('data-aspect', name);
          if (isMulti) sel.multiple = true;
          // optional empty for optional fields
          if (!required && !isMulti) { const o=document.createElement('option'); o.value=''; o.textContent='—'; sel.appendChild(o); }
          values.slice(0,200).forEach(v => { const o=document.createElement('option'); const val = v.localizedValue || v.value || v; o.value = val; o.textContent = val; sel.appendChild(o); });
          field = sel;
        } else {
          const inp = document.createElement('input'); inp.id = id; inp.setAttribute('data-aspect', name); field = inp;
        }
        wrap.appendChild(label); wrap.appendChild(field);
        $(containerId).appendChild(wrap);
      }

      async function enterStep2(){
        const cid = categoryIdEl.value.trim(); if (!cid) return;
        nextBtn.disabled = true; msg1.textContent = 'Loading requirements…';
        try {
          const req = await fetchJSON('/.netlify/functions/ebay-category-requirements?categoryId='+encodeURIComponent(cid));
          // render path and condition
          $('catPath').textContent = 'Category '+cid;
          conditionSel.innerHTML='';
          const conds = req.allowedConditions||[];
          if (conds.length) conds.forEach(c=>{ const o=document.createElement('option'); o.value=c.conditionId; o.textContent = `${c.conditionId} — ${c.conditionDescription}`; conditionSel.appendChild(o); });
          else { const o=document.createElement('option'); o.value=''; o.textContent='(none)'; conditionSel.appendChild(o); }
          // render aspects
          $('reqAspects').innerHTML=''; $('optAspects').innerHTML='';
          (req.requiredAspects||[]).forEach(a=>renderAspect('reqAspects', a, true));
          (req.optionalAspects||[]).forEach(a=>renderAspect('optAspects', a, false));
          await loadLocations();
          step2.classList.remove('hide');
          window.scrollTo({ top: step2.offsetTop - 10, behavior: 'smooth' });
  } catch(e){ msg1.textContent = 'Requirements error: ' + (e.response?.error || e.message) + '. If this persists, pick a leaf category via Browse.'; }
        finally { nextBtn.disabled = false; }
      }
      nextBtn.addEventListener('click', enterStep2);

      function collectAspects(){
        const map = {};
        document.querySelectorAll('[id^="asp_"]').forEach((el)=>{
          const name = el.getAttribute('data-aspect');
          if (!name) return;
          if (el.tagName === 'SELECT' && el.multiple) {
            const vals = Array.from(el.selectedOptions).map(o=>o.value).filter(Boolean);
            if (vals.length) map[name] = vals;
          } else {
            const val = (el.value || '').trim();
            if (val) map[name] = val;
          }
        });
        return map;
      }

      $('btnCreate').addEventListener('click', async () => {
        const msg = $('msg2'); msg.textContent='Submitting…';
        const sku = ($('sku')||{value:''}).value.trim();
        const title = (titleEl||{value:''}).value.trim();
        const price = parseFloat(($('price')||{value:''}).value);
        const qty = parseInt(($('qty')||{value:'1'}).value, 10) || 1;
        const imagesRaw = ($('images')||{value:''}).value.trim();
        const images = imagesRaw ? imagesRaw.split(',').map(s=>s.trim()).filter(Boolean) : [];
        const description = ($('description')||{value:''}).value.trim();
        const merchantLocationKey = (locationSel||{value:''}).value.trim();
        const categoryId = (categoryIdEl||{value:''}).value.trim();
        const condition = (conditionSel||{value:''}).value.trim();
        if (!sku || !title || !Number.isFinite(price) || !images.length) { msg.textContent='Please provide SKU, title, price, and at least one image URL.'; return; }
        const aspects = collectAspects();
        try {
          const r = await fetch('/.netlify/functions/ebay-create-draft', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ sku, title, price, qty, images, merchantLocationKey, categoryId, description: description||undefined, condition: condition||undefined, aspects: Object.keys(aspects).length? aspects: undefined }) });
          const data = await r.json();
          if (r.ok && data.ok) { msg.textContent = 'Draft created: ' + (data.draftOffer?.offerId||'unknown'); }
          else msg.textContent = 'Error: ' + (data.error || JSON.stringify(data));
        } catch(e){ msg.textContent='Error: '+e.message; }
      });

      // As the user types in the category picker, fetch suggestions and fill dropdown
      if (picker) picker.addEventListener('input', async () => {
        const val = picker.value.trim();
        const opt = Array.from(datalist.options).find(o=>o.value===val);
        updatePreview(opt);
        const id = opt ? opt.getAttribute('data-id') : '';
        if (id) { categoryIdEl.value = id; nextBtn.disabled = false; return; }
        nextBtn.disabled = !categoryIdEl.value.trim();
        if (val.length >= 1) {
          const rows = CAT_ROWS || await loadCategoriesCsv();
          if (rows) { localSuggest(val); }
          else {
            try { const j = await fetchJSON('/.netlify/functions/ebay-category-suggestions?q='+encodeURIComponent(val)); applyOptions(j.suggestions||[]); }
            catch(e){ msg1.textContent = 'Suggest error: ' + (e.response?.error || e.message || ''); }
          }
        }
      });

      function renderBrowseLocal(node, trail){
        // breadcrumbs
        const parts=[]; const rootA=document.createElement('a'); rootA.href='#'; rootA.textContent='Root'; rootA.onclick=(e)=>{e.preventDefault(); renderBrowseLocal(CAT_TREE, []);}; parts.push(rootA);
        trail.forEach((n)=>{ const sep=document.createElement('span'); sep.textContent=' > '; parts.push(sep); const a=document.createElement('a'); a.href='#'; a.textContent=n.name; a.onclick=(e)=>{e.preventDefault(); const idx=trail.indexOf(n); renderBrowseLocal(idx>=0? trail[idx]:CAT_TREE, trail.slice(0, idx+1));}; parts.push(a); });
        crumbs.innerHTML=''; parts.forEach(x=>crumbs.appendChild(x));
        // list
        browseList.innerHTML='';
        const entries = Array.from(node.children?.entries?.() || []);
        entries.forEach(([name, child])=>{
          const wrap = document.createElement('div'); wrap.className='col'; wrap.style.minWidth='260px';
          const btn = document.createElement('button'); btn.className='secondary'; btn.style.width='100%';
          const isLeaf = !!child.leaf && (!child.children || child.children.size===0);
          btn.textContent = (isLeaf? '📄 ' : '📁 ') + name;
          btn.title = child.path;
          btn.onclick = () => {
            if (isLeaf && child.id){
              picker.value = `${child.id} — ${name}`;
              categoryIdEl.value = child.id;
              catPreview.textContent = child.path;
              nextBtn.disabled = false;
              modal.classList.add('hide');
            } else {
              renderBrowseLocal(child, [...trail, child]);
            }
          };
          wrap.appendChild(btn);
          browseList.appendChild(wrap);
        });
      }

      async function browse(categoryId){
        const rows = CAT_ROWS || await loadCategoriesCsv();
        if (rows && CAT_TREE) {
          renderBrowseLocal(CAT_TREE, []);
          return;
        }
        // fallback to remote
        try {
          const url = '/.netlify/functions/ebay-category-browse' + (categoryId ? ('?categoryId='+encodeURIComponent(categoryId)) : '');
          const j = await fetchJSON(url);
          // crumbs (clickable)
          const bc = j.breadcrumbs||[];
          const parts = [];
          const rootA = document.createElement('a'); rootA.href = '#'; rootA.textContent = 'Root'; rootA.onclick = (e)=>{ e.preventDefault(); browse(); };
          parts.push(rootA);
          bc.forEach((b, idx) => { const sep = document.createElement('span'); sep.textContent = ' > '; parts.push(sep); const a = document.createElement('a'); a.href='#'; a.textContent = b.name; a.onclick = (e)=>{ e.preventDefault(); browse(b.id); }; parts.push(a); });
          crumbs.innerHTML=''; parts.forEach(el=>crumbs.appendChild(el));
          // list
          browseList.innerHTML='';
          (j.children||[]).forEach((n)=>{ const wrap = document.createElement('div'); wrap.className='col'; wrap.style.minWidth='260px'; const btn = document.createElement('button'); btn.className='secondary'; btn.style.width='100%'; btn.textContent = (n.leaf? '📄 ' : '📁 ') + n.name; btn.title = n.path; btn.onclick = () => { if (n.leaf) { picker.value = `${n.id} — ${n.name}`; categoryIdEl.value = n.id; catPreview.textContent = n.path; nextBtn.disabled = false; modal.classList.add('hide'); } else { browse(n.id); } }; wrap.appendChild(btn); browseList.appendChild(wrap); });
        } catch(e){ crumbs.textContent = 'Browse error: ' + (e.response?.error || e.message); }
      }

  if (browseBtn) browseBtn.onclick = () => { modal.classList.remove('hide'); browse(); };
  if (browseClose) browseClose.onclick = () => { modal.classList.add('hide'); setTimeout(()=>{ try{ browseBtn?.focus(); }catch{} }, 0); };
  // Backdrop click closes (use currentTarget for safety)
  if (modal) modal.addEventListener('click', (e) => { if (e.currentTarget === e.target) { modal.classList.add('hide'); setTimeout(()=>{ try{ browseBtn?.focus(); }catch{} }, 0); } });
  if (browsePanel) browsePanel.addEventListener('click', (e)=> e.stopPropagation());
  // Escape key closes
  window.addEventListener('keydown', (e) => { if (e.key === 'Escape' && !modal.classList.contains('hide')) { modal.classList.add('hide'); setTimeout(()=>{ try{ browseBtn?.focus(); }catch{} }, 0); } });
    </script>
  </body>
  </html>
