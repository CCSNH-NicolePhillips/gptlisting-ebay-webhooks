<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Auth0 Debug</title>
  <script src="/.netlify/functions/cdn-auth0-spa?v=2.5"></script>
    <style>
      body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 20px; }
      pre { background: #0b1020; color: #a8ff60; padding: 10px; border-radius: 6px; white-space: pre-wrap; }
      button { margin-right: 8px; margin-bottom: 8px; }
      .warn { color: #b00; }
      .ok { color: #070; }
    </style>
  </head>
  <body>
    <h1>Auth0 Debug</h1>
    <p>This page tests Auth0 end-to-end without the app helper.</p>
    <div id="status">Loading…</div>
    <div>
      <button id="btnLogin">Login (redirect)</button>
      <button id="btnLogout">Logout</button>
      <button id="btnSilent">Try silent token</button>
    </div>
    <h3>Config</h3>
    <pre id="cfg"></pre>
  <h3>Preflight</h3>
  <pre id="preflight"></pre>
  <h3>User / Tokens</h3>
    <pre id="out"></pre>
    <h3>Errors</h3>
    <pre id="err"></pre>

    <script>
      const S = (t, cls) => {
        const el = document.getElementById('status');
        el.textContent = t; el.className = cls || '';
      };
      const describe = (e) => {
        if (!e) return '';
        if (typeof e === 'string') return e;
        if (e instanceof Error) return `${e.message}\n${e.stack || ''}`;
        try { return JSON.stringify(e, null, 2); } catch { return String(e); }
      };
      const log = (id, x) => {
        const el = document.getElementById(id);
        el.textContent += describe(x) + "\n";
      };
      const set = (id, x) => { document.getElementById(id).textContent = typeof x === 'string' ? x : JSON.stringify(x, null, 2); };

      (async function() {
        try {
          // 1) Load public config from Netlify function
          const res = await fetch('/.netlify/functions/get-public-config', { cache: 'no-store' });
          const cfg = await res.json().catch(() => ({}));
          set('cfg', cfg);
          if (!res.ok) throw new Error('get-public-config failed: ' + (cfg.error || res.status));
          const mode = (cfg.AUTH_MODE || 'none').toLowerCase();
          if (mode !== 'auth0') {
            S('AUTH_MODE is not auth0. Set AUTH_MODE=auth0 in Netlify envs.', 'warn');
            return;
          }
          if (!cfg.AUTH0_DOMAIN || !cfg.AUTH0_CLIENT_ID) {
            S('Missing AUTH0_DOMAIN or AUTH0_CLIENT_ID in get-public-config output.', 'warn');
            return;
          }

          // 2) Ensure Auth0 SDK is available (diagnose CDN/CSP issues)
          async function preflight(url){
            try{
              const r = await fetch(url, { cache: 'no-store' });
              const ct = r.headers.get('content-type');
              const txt = await r.text();
              set('preflight', {
                url,
                status: r.status,
                contentType: ct,
                snippet: txt.slice(0, 120)
              });
              return { ok: r.ok, txt };
            }catch(e){
              set('preflight', { url, error: describe(e) });
              return { ok: false };
            }
          }
          function beginAmdDisable(){
            const hadDefine = typeof window.define === 'function';
            const saved = hadDefine ? window.define : undefined;
            try { if (hadDefine) window.define = undefined; } catch {}
            return () => {
              try {
                if (hadDefine && saved) window.define = saved;
                else if (hadDefine && !saved) delete window.define;
              } catch {}
            };
          }
          async function injectScript(url){
            return new Promise((resolve, reject) => {
              const restore = beginAmdDisable();
              const s = document.createElement('script');
              s.src = url; s.async = true;
              s.onload = () => { try { restore(); } catch{}; resolve(); };
              s.onerror = (e) => { try { restore(); } catch{}; reject(e); };
              document.head.appendChild(s);
            });
          }
          async function injectFromBlob(js){
            const blob = new Blob([js], { type: 'application/javascript' });
            const u = URL.createObjectURL(blob);
            try { await injectScript(u); } finally { URL.revokeObjectURL(u); }
          }
          async function ensureSdk(version) {
            if (window.createAuth0Client) return true;
            await new Promise((resolve) => setTimeout(resolve, 50));
            if (window.createAuth0Client) return true;
            return new Promise((resolve) => {
              const s = document.createElement('script');
              s.src = `https://cdn.auth0.com/js/auth0-spa-js/${version}/auth0-spa-js.production.js`;
              s.onload = () => resolve(true);
              s.onerror = () => resolve(false);
              document.head.appendChild(s);
            });
          }

          const proxyUrl = '/.netlify/functions/cdn-auth0-spa?v=2.5';
          const amdDetected = typeof window.define === 'function';
          await preflight(proxyUrl);
          if (amdDetected) log('err', 'AMD loader detected (window.define is a function). Applying AMD guard while loading SDK.');
          const hasCreate = () => (window.auth0 && window.auth0.createAuth0Client) || window.createAuth0Client;
          let sdkOk = !!hasCreate();
          if (!sdkOk) {
            try { await injectScript(proxyUrl); } catch {}
            sdkOk = !!hasCreate();
          }
          if (!sdkOk) {
            // Try blob-based injection from proxy fetch
            const pf = await preflight(proxyUrl);
            if (pf.ok && pf.txt) {
              try { await injectFromBlob(pf.txt); } catch {}
              sdkOk = !!hasCreate();
            }
          }
          if (!sdkOk) sdkOk = await ensureSdk('2.5');
          if (!sdkOk) sdkOk = await ensureSdk('2.1');
          if (!sdkOk || !window.createAuth0Client) {
            S('Init error', 'warn');
            log('err', 'Auth0 SDK failed to load. We tried: proxy script tag, proxy blob injection, and CDN. Check network/CSP and extensions.');
            return;
          }

          // 3) Initialize Auth0
          const redirectUri = location.origin + '/auth-debug.html';
          const mk = (window.auth0 && window.auth0.createAuth0Client) || window.createAuth0Client;
          if (!mk) throw new Error('Auth0 SDK not loaded');
          const auth0 = await mk({
            domain: cfg.AUTH0_DOMAIN,
            clientId: cfg.AUTH0_CLIENT_ID,
            cacheLocation: 'localstorage',
            useRefreshTokens: true,
            authorizationParams: {
              redirect_uri: redirectUri,
              audience: cfg.AUTH0_AUDIENCE || undefined,
            },
          });

          // 4) Handle callback if returning from Auth0
          if (location.search.includes('code=') && location.search.includes('state=')) {
            try { await auth0.handleRedirectCallback(); }
            catch (e) { log('err', e); }
            history.replaceState({}, document.title, redirectUri);
          }

          // 5) Try silent token (ok to fail on first run)
          try { await auth0.getTokenSilently(); } catch (e) { log('err', 'Silent token failed (ok on first run): ' + describe(e)); }

          const authed = await auth0.isAuthenticated();
          S(authed ? 'Authenticated' : 'Not authenticated', authed ? 'ok' : 'warn');
          if (authed) {
            const user = await auth0.getUser();
            set('out', user);
          }

          document.getElementById('btnLogin').onclick = async () => {
            try {
              await auth0.loginWithRedirect({ authorizationParams: { redirect_uri: redirectUri } });
            } catch (e) { log('err', e); }
          };
          document.getElementById('btnLogout').onclick = async () => {
            try { await auth0.logout({ logoutParams: { returnTo: location.origin + '/' } }); }
            catch (e) { log('err', e); }
          };
          document.getElementById('btnSilent').onclick = async () => {
            try {
              const t = await auth0.getTokenSilently();
              log('out', { tokenSnippet: t && (t.slice(0, 20) + '…') });
            } catch (e) { log('err', e); }
          };
        } catch (e) {
          S('Init error', 'warn');
          log('err', e);
          log('err', 'Tip: Ensure Auth0 Allowed Callback URLs includes ' + (location.origin + '/auth-debug.html') + ' and Web Origins includes ' + location.origin + '.');
        }
      })();
    </script>
  </body>
</html>
