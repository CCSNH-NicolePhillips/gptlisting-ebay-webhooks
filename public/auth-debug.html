<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Auth0 Debug</title>
    <script src="https://cdn.auth0.com/js/auth0-spa-js/2.5/auth0-spa-js.production.js"></script>
    <style>
      body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 20px; }
      pre { background: #0b1020; color: #a8ff60; padding: 10px; border-radius: 6px; white-space: pre-wrap; }
      button { margin-right: 8px; margin-bottom: 8px; }
      .warn { color: #b00; }
      .ok { color: #070; }
    </style>
  </head>
  <body>
    <h1>Auth0 Debug</h1>
    <p>This page tests Auth0 end-to-end without the app helper.</p>
    <div id="status">Loading…</div>
    <div>
      <button id="btnLogin">Login (redirect)</button>
      <button id="btnLogout">Logout</button>
      <button id="btnSilent">Try silent token</button>
    </div>
    <h3>Config</h3>
    <pre id="cfg"></pre>
  <h3>Preflight</h3>
  <pre id="preflight"></pre>
  <h3>User / Tokens</h3>
    <pre id="out"></pre>
    <h3>Errors</h3>
    <pre id="err"></pre>

    <script>
      const S = (t, cls) => {
        const el = document.getElementById('status');
        el.textContent = t; el.className = cls || '';
      };
      const describe = (e) => {
        if (!e) return '';
        if (typeof e === 'string') return e;
        if (e instanceof Error) return `${e.message}\n${e.stack || ''}`;
        try { return JSON.stringify(e, null, 2); } catch { return String(e); }
      };
      const log = (id, x) => {
        const el = document.getElementById(id);
        el.textContent += describe(x) + "\n";
      };
      const set = (id, x) => { document.getElementById(id).textContent = typeof x === 'string' ? x : JSON.stringify(x, null, 2); };

      (async function() {
        try {
          // 1) Load public config from Netlify function
          const res = await fetch('/.netlify/functions/get-public-config', { cache: 'no-store' });
          const cfg = await res.json().catch(() => ({}));
          set('cfg', cfg);
          if (!res.ok) throw new Error('get-public-config failed: ' + (cfg.error || res.status));
          const rawMode = (cfg.AUTH_MODE_RAW || cfg.AUTH_MODE || 'none').toLowerCase();
          const mode = ['admin', 'user', 'mixed', 'auth0'].includes(rawMode) ? 'auth0' : rawMode;
          if (mode !== 'auth0') {
            S('Auth is not configured for Auth0. Set AUTH_MODE=user (or mixed) with valid AUTH0_DOMAIN/CLIENT_ID.', 'warn');
            return;
          }
          if (!cfg.AUTH0_DOMAIN || !cfg.AUTH0_CLIENT_ID) {
            S('Missing AUTH0_DOMAIN or AUTH0_CLIENT_ID in get-public-config output.', 'warn');
            return;
          }

          // 2) Ensure Auth0 SDK is available
          if (!window.createAuth0Client) {
            throw new Error('Auth0 SPA SDK not available on window.createAuth0Client');
          }

          // 3) Initialize Auth0
          const auth0 = await window.createAuth0Client({
            domain: cfg.AUTH0_DOMAIN,
            clientId: cfg.AUTH0_CLIENT_ID,
            cacheLocation: 'localstorage',
            useRefreshTokens: true,
            authorizationParams: {
              audience: cfg.AUTH0_AUDIENCE || undefined,
              redirect_uri: window.location.origin + '/auth-debug.html',
            },
          });
          window.__auth0Debug = auth0;

          // 4) Handle callback if returning from Auth0
          if (location.search.includes('code=') && location.search.includes('state=')) {
            try { await auth0.handleRedirectCallback(); }
            catch (e) { log('err', e); }
            history.replaceState({}, document.title, window.location.origin + '/auth-debug.html');
          }

          // 5) Try silent token (ok to fail on first run)
          try { await auth0.getTokenSilently(); } catch (e) { log('err', 'Silent token failed (ok on first run): ' + describe(e)); }

          const authed = await auth0.isAuthenticated();
          S(authed ? 'Authenticated' : 'Not authenticated', authed ? 'ok' : 'warn');
          if (authed) {
            const user = await auth0.getUser();
            set('out', user);
          }

          document.getElementById('btnLogin').onclick = async () => {
            try {
              await auth0.loginWithRedirect({ authorizationParams: { redirect_uri: window.location.origin + '/auth-debug.html' } });
            } catch (e) { log('err', e); }
          };
          document.getElementById('btnLogout').onclick = async () => {
            try { await auth0.logout({ logoutParams: { returnTo: location.origin + '/' } }); }
            catch (e) { log('err', e); }
          };
          document.getElementById('btnSilent').onclick = async () => {
            try {
              const t = await auth0.getTokenSilently();
              log('out', { tokenSnippet: t && (t.slice(0, 20) + '…') });
            } catch (e) { log('err', e); }
          };
        } catch (e) {
          S('Init error', 'warn');
          log('err', e);
          log('err', 'Tip: Ensure Auth0 Allowed Callback URLs includes ' + (location.origin + '/auth-debug.html') + ' and Web Origins includes ' + location.origin + '.');
        }
      })();
    </script>
  </body>
</html>
