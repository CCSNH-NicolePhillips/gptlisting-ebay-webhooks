<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Auth0 Debug</title>
    <script src="/.netlify/functions/cdn-auth0-spa?v=2.1"></script>
    <style>
      body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 20px; }
      pre { background: #0b1020; color: #a8ff60; padding: 10px; border-radius: 6px; white-space: pre-wrap; }
      button { margin-right: 8px; margin-bottom: 8px; }
      .warn { color: #b00; }
      .ok { color: #070; }
    </style>
  </head>
  <body>
    <h1>Auth0 Debug</h1>
    <p>This page tests Auth0 end-to-end without the app helper.</p>
    <div id="status">Loading…</div>
    <div>
      <button id="btnLogin">Login (redirect)</button>
      <button id="btnLogout">Logout</button>
      <button id="btnSilent">Try silent token</button>
    </div>
    <h3>Config</h3>
    <pre id="cfg"></pre>
  <h3>Preflight</h3>
  <pre id="preflight"></pre>
  <h3>User / Tokens</h3>
    <pre id="out"></pre>
    <h3>Errors</h3>
    <pre id="err"></pre>

    <script>
      const S = (t, cls) => {
        const el = document.getElementById('status');
        el.textContent = t; el.className = cls || '';
      };
      const describe = (e) => {
        if (!e) return '';
        if (typeof e === 'string') return e;
        if (e instanceof Error) return `${e.message}\n${e.stack || ''}`;
        try { return JSON.stringify(e, null, 2); } catch { return String(e); }
      };
      const log = (id, x) => {
        const el = document.getElementById(id);
        el.textContent += describe(x) + "\n";
      };
      const set = (id, x) => { document.getElementById(id).textContent = typeof x === 'string' ? x : JSON.stringify(x, null, 2); };

      (async function() {
        try {
          // 1) Check if SDK loaded
          S('Checking Auth0 SDK...', '');
          log('preflight', 'window.createAuth0Client exists: ' + (!!window.createAuth0Client));
          if (!window.createAuth0Client) {
            S('Auth0 SDK failed to load', 'warn');
            log('err', 'The Auth0 SPA SDK script tag failed to load.');
            log('err', 'Possible causes:');
            log('err', '- Content Security Policy (CSP) blocking cdn.auth0.com');
            log('err', '- Browser extension blocking the script');
            log('err', '- Network connectivity issue');
            log('err', '- Check the browser console for additional errors');
            return;
          }

          // 2) Load public config from Netlify function
          S('Loading config...', '');
          const res = await fetch('/.netlify/functions/get-public-config', { cache: 'no-store' });
          log('preflight', 'get-public-config status: ' + res.status);
          const cfg = await res.json().catch(() => ({}));
          set('cfg', cfg);

          if (!res.ok) throw new Error('get-public-config failed: ' + (cfg.error || res.status));

          const rawMode = (cfg.AUTH_MODE_RAW || cfg.AUTH_MODE || 'none').toLowerCase();
          const mode = ['admin', 'user', 'mixed', 'auth0'].includes(rawMode) ? 'auth0' : rawMode;

          if (mode !== 'auth0') {
            S('Auth is not configured for Auth0. Set AUTH_MODE=user (or mixed) with valid AUTH0_DOMAIN/CLIENT_ID.', 'warn');
            return;
          }
          if (!cfg.AUTH0_DOMAIN || !cfg.AUTH0_CLIENT_ID) {
            S('Missing AUTH0_DOMAIN or AUTH0_CLIENT_ID in get-public-config output.', 'warn');
            return;
          }

          log('preflight', 'Config validated successfully');

          // 3) Initialize Auth0
          S('Initializing Auth0 client...', '');
          const auth0 = await window.createAuth0Client({
            domain: cfg.AUTH0_DOMAIN,
            clientId: cfg.AUTH0_CLIENT_ID,
            cacheLocation: 'localstorage',
            useRefreshTokens: true,
            authorizationParams: {
              audience: cfg.AUTH0_AUDIENCE || undefined,
              redirect_uri: window.location.origin + '/auth-debug.html',
            },
          });
          window.__auth0Debug = auth0;
          log('preflight', 'Auth0 client created successfully');

          // 4) Handle callback if returning from Auth0
          if (location.search.includes('code=') && location.search.includes('state=')) {
            S('Handling Auth0 callback...', '');
            try {
              await auth0.handleRedirectCallback();
              log('preflight', 'Callback handled successfully');
            } catch (e) {
              log('err', 'Callback error: ' + describe(e));
            }
            history.replaceState({}, document.title, window.location.origin + '/auth-debug.html');
          }

          // 5) Check authentication status
          S('Checking authentication status...', '');
          const authed = await auth0.isAuthenticated();
          log('preflight', 'isAuthenticated: ' + authed);

          S(authed ? 'Authenticated ✓' : 'Not authenticated', authed ? 'ok' : 'warn');

          if (authed) {
            const user = await auth0.getUser();
            set('out', user);

            // Try to get token
            try {
              const token = await auth0.getTokenSilently();
              log('out', '\n--- TOKEN ---');
              log('out', 'Token (first 40 chars): ' + (token ? token.slice(0, 40) + '...' : 'null'));
              log('out', 'Token length: ' + (token ? token.length : 0));
            } catch (e) {
              log('err', 'getTokenSilently error: ' + describe(e));
            }
          }

          // 6) Wire up buttons
          document.getElementById('btnLogin').onclick = async () => {
            try {
              S('Redirecting to Auth0...', '');
              await auth0.loginWithRedirect({
                authorizationParams: {
                  redirect_uri: window.location.origin + '/auth-debug.html'
                }
              });
            } catch (e) {
              log('err', 'Login error: ' + describe(e));
              S('Login failed', 'warn');
            }
          };

          document.getElementById('btnLogout').onclick = async () => {
            try {
              S('Logging out...', '');
              await auth0.logout({ logoutParams: { returnTo: location.origin + '/' } });
            } catch (e) {
              log('err', 'Logout error: ' + describe(e));
              S('Logout failed', 'warn');
            }
          };

          document.getElementById('btnSilent').onclick = async () => {
            try {
              S('Fetching token silently...', '');
              const t = await auth0.getTokenSilently();
              log('out', '\n--- NEW TOKEN ---');
              log('out', 'Token (first 40 chars): ' + (t ? t.slice(0, 40) + '...' : 'null'));
              log('out', 'Token length: ' + (t ? t.length : 0));
              S('Token fetched successfully', 'ok');
            } catch (e) {
              log('err', 'getTokenSilently error: ' + describe(e));
              S('Token fetch failed', 'warn');
            }
          };
        } catch (e) {
          S('Initialization error', 'warn');
          log('err', describe(e));
          log('err', '\nTroubleshooting tips:');
          log('err', '- Ensure Auth0 Allowed Callback URLs includes: ' + (location.origin + '/auth-debug.html'));
          log('err', '- Ensure Auth0 Allowed Web Origins includes: ' + location.origin);
          log('err', '- Check browser console for CSP or network errors');
          log('err', '- Try disabling browser extensions');
        }
      })();
    </script>
  </body>
</html>
