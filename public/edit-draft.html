<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Edit Draft ‚Äì DraftPilot</title>
  <link rel="stylesheet" href="/draftpilot.css?v=2">
  <style>
    /* Edit draft specific styles */
    .form-row {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      margin-bottom: 1.25rem;
      align-items: flex-start;
    }
    .form-field {
      flex: 1 1 250px;
      min-width: 220px;
    }
    .form-field label {
      display: block;
      font-weight: 500;
      margin-bottom: 0.5rem;
      font-size: 0.875rem;
      color: #cbd5ff;
    }
    .form-field input, 
    .form-field textarea, 
    .form-field select {
      width: 100%;
      background: var(--bg-card);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-md);
      padding: 0.75rem;
      color: var(--text-primary);
      font-family: inherit;
      font-size: 0.9375rem;
      box-sizing: border-box;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    .form-field input[type="number"] {
      max-width: 150px;
    }
    .form-field select {
      cursor: pointer;
    }
    .form-field select:hover {
      border-color: var(--accent);
    }
    .form-field input:focus, 
    .form-field textarea:focus, 
    .form-field select:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-soft);
    }
    #price {
      max-width: 200px;
    }
    #condition {
      max-width: 300px;
    }
    .form-field textarea {
      resize: vertical;
      min-height: 140px;
      line-height: 1.6;
    }
    .muted-hint {
      font-size: 0.85rem;
      color: var(--text-muted);
      margin-top: 0.3rem;
    }
    .aspect-item {
      display: grid;
      grid-template-columns: minmax(160px, 0.4fr) minmax(220px, 1fr) auto;
      gap: 0.75rem;
      margin-bottom: 0.65rem;
      align-items: center;
    }
    #aspectsList {
      padding: 0;
      margin-top: 0.5rem;
    }
    .aspect-item input,
    .aspect-item select {
      width: 100%;
      background: var(--bg-card);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-md);
      padding: 0.75rem;
      color: var(--text-primary);
      font-size: 0.9375rem;
      box-sizing: border-box;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    .aspect-item select {
      cursor: pointer;
    }
    .aspect-item select:hover {
      border-color: var(--accent);
    }
    @media (max-width: 768px) {
      .aspect-item {
        grid-template-columns: 1fr;
      }
    }
    .aspect-item input:focus,
    .aspect-item select:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-soft);
    }
    /* Multiselect uses dp-multiselect classes from draftpilot.css */
    .aspect-multiselect {
      position: relative;
      width: 100%;
    }
    .aspect-multiselect-display {
      width: 100%;
      background: var(--bg-card);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-md);
      padding: 0.75rem;
      color: var(--text-primary);
      font-size: 0.9375rem;
      cursor: pointer;
      user-select: none;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: all 0.2s ease;
    }
    .aspect-multiselect-display:hover {
      border-color: var(--accent);
    }
    .aspect-multiselect.open .aspect-multiselect-display {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-soft);
    }
    .aspect-multiselect-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: var(--bg-card);
      border: 1px solid var(--accent);
      border-radius: var(--radius-md);
      margin-top: 4px;
      max-height: 300px;
      overflow-y: auto;
      z-index: 1000;
      display: none;
      box-shadow: var(--shadow-elevated);
    }
    .aspect-multiselect-dropdown.open {
      display: block;
    }
    .aspect-multiselect-search {
      position: sticky;
      top: 0;
      background: var(--bg-card);
      padding: 0.5rem;
      border-bottom: 1px solid var(--border-subtle);
      z-index: 1;
    }
    .aspect-multiselect-search input {
      width: 100%;
      background: var(--bg-base);
      border: 1px solid var(--border-subtle);
      border-radius: 4px;
      padding: 0.5rem;
      color: var(--text-primary);
      font-size: 0.875rem;
    }
    .aspect-multiselect-search input:focus {
      outline: none;
      border-color: var(--accent);
    }
    .aspect-multiselect-options {
      max-height: 250px;
      overflow-y: auto;
    }
    .aspect-multiselect-option {
      padding: 0.75rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      transition: background-color 0.15s ease;
    }
    .aspect-multiselect-option.hidden {
      display: none;
    }
    .aspect-multiselect-option:hover {
      background: var(--accent-soft);
    }
    .aspect-multiselect-option input[type="checkbox"] {
      width: auto;
      margin: 0;
      cursor: pointer;
      accent-color: var(--accent);
    }
    .aspect-multiselect-custom {
      position: sticky;
      bottom: 0;
      background: var(--bg-card);
      padding: 0.5rem;
      border-top: 1px solid var(--border-subtle);
    }
    .aspect-multiselect-custom input {
      width: 100%;
      background: var(--bg-base);
      border: 1px solid var(--border-subtle);
      border-radius: 4px;
      padding: 0.5rem;
      color: var(--text-primary);
      font-size: 0.875rem;
    }
    .aspect-multiselect-custom input:focus {
      outline: none;
      border-color: var(--accent);
    }
    .aspect-multiselect-arrow {
      font-size: 0.75rem;
      transition: transform 0.2s;
      color: var(--text-muted);
    }
    .aspect-multiselect.open .aspect-multiselect-arrow {
      transform: rotate(180deg);
      color: var(--accent);
    }
    .aspect-item button {
      padding: 0.4rem 0.8rem;
      font-size: 0.85rem;
    }
    .images-preview {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 1rem;
      margin-top: 1rem;
    }
    .image-thumb {
      position: relative;
      aspect-ratio: 1;
      border-radius: var(--radius-md);
      overflow: hidden;
      border: 1px solid var(--border-subtle);
      background: rgba(15, 23, 42, 0.5);
      transition: border-color 0.2s, transform 0.2s;
      cursor: move;
    }
    .image-upload-box {
      position: relative;
      aspect-ratio: 1;
      border-radius: var(--radius-md);
      border: 2px dashed var(--border-subtle);
      background: rgba(15, 23, 42, 0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s;
    }
    .image-upload-box:hover {
      border-color: var(--accent);
      background: rgba(56, 189, 248, 0.1);
    }
    .image-upload-box svg {
      width: 48px;
      height: 48px;
      color: var(--text-muted);
      transition: color 0.2s;
    }
    .image-upload-box:hover svg {
      color: var(--accent);
    }
    .image-thumb:hover {
      border-color: var(--accent-hover);
      transform: scale(1.02);
    }
    .image-thumb.dragging {
      opacity: 0.5;
    }
    .image-thumb.drag-over {
      border-color: var(--accent);
      border-width: 2px;
    }
    .image-thumb img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      background: var(--bg-elevated, #1a1a2e);
      pointer-events: none;
    }
    .image-thumb .image-order {
      position: absolute;
      top: 4px;
      left: 4px;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 600;
    }
    .dp-content {
      max-width: 1100px;
      margin: 0 auto;
    }
    /* Two-column row for Quantity + Condition */
    .dp-form-row.two-col {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1.25rem;
      margin-bottom: 1.5rem;
    }
    @media (max-width: 700px) {
      .dp-form-row.two-col {
        grid-template-columns: 1fr;
      }
    }
    .dp-form-col label {
      display: block;
      font-weight: 500;
      margin-bottom: 0.5rem;
      font-size: 0.875rem;
      color: #cbd5ff;
    }
    .dp-form-col input,
    .dp-form-col select {
      width: 100%;
      background: var(--bg-card);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-md);
      padding: 0.75rem;
      color: var(--text-primary);
      font-family: inherit;
      font-size: 0.9375rem;
      box-sizing: border-box;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
      cursor: pointer;
    }
    .dp-form-col select:hover {
      border-color: var(--accent);
    }
    .dp-form-col input:focus,
    .dp-form-col select:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-soft);
    }
    
    /* Toggle switch styles */
    .toggle-switch {
      position: relative;
      display: inline-block;
      width: 48px;
      height: 26px;
    }
    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: var(--line);
      transition: 0.3s;
      border-radius: 26px;
    }
    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 20px;
      width: 20px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: 0.3s;
      border-radius: 50%;
    }
    .toggle-switch input:checked + .toggle-slider {
      background-color: var(--primary);
    }
    .toggle-switch input:checked + .toggle-slider:before {
      transform: translateX(22px);
    }
    
    /* Image Lightbox */
    .image-lightbox {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      z-index: 10000;
      cursor: zoom-out;
      align-items: center;
      justify-content: center;
    }
    .image-lightbox.active {
      display: flex;
    }
    .image-lightbox img {
      max-width: 90%;
      max-height: 90%;
      object-fit: contain;
      border-radius: 8px;
      box-shadow: 0 4px 40px rgba(0, 0, 0, 0.5);
    }
    .image-lightbox-close {
      position: absolute;
      top: 20px;
      right: 30px;
      color: white;
      font-size: 2.5rem;
      font-weight: 300;
      cursor: pointer;
      opacity: 0.8;
      transition: opacity 0.2s;
      z-index: 10001;
    }
    .image-lightbox-close:hover {
      opacity: 1;
    }
    .image-thumb {
      cursor: pointer;
    }
    
    /* AI Decision Logs styles */
    .logs-section {
      margin-top: 0;
    }
    .logs-header {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      cursor: pointer;
      user-select: none;
      padding: 0.5rem 0;
    }
    .logs-header:hover .logs-toggle {
      background: var(--accent-soft);
    }
    .logs-toggle {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 24px;
      height: 24px;
      border-radius: 4px;
      background: var(--bg-base);
      transition: background 0.2s, transform 0.2s;
    }
    .logs-toggle.open {
      transform: rotate(90deg);
    }
    .logs-content {
      display: none;
      margin-top: 1rem;
    }
    .logs-content.open {
      display: block;
    }
    .logs-subsection {
      background: var(--bg-base);
      border-radius: var(--radius-md);
      padding: 1rem;
      margin-bottom: 1rem;
    }
    .logs-subsection h4 {
      margin: 0 0 0.75rem 0;
      font-size: 0.9rem;
      color: var(--accent);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .logs-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
    }
    .logs-table th,
    .logs-table td {
      text-align: left;
      padding: 0.5rem;
      border-bottom: 1px solid var(--border-subtle);
    }
    .logs-table th {
      color: var(--text-muted);
      font-weight: 500;
    }
    .logs-table tr:last-child td {
      border-bottom: none;
    }
    .logs-calculation {
      background: rgba(99, 102, 241, 0.1);
      border-radius: 6px;
      padding: 0.75rem;
      margin-bottom: 0.5rem;
    }
    .logs-calculation .step {
      font-weight: 600;
      color: var(--accent);
      margin-bottom: 0.25rem;
    }
    .logs-calculation .formula {
      font-family: monospace;
      background: var(--bg-card);
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-size: 0.8rem;
      color: var(--text-muted);
    }
    .logs-calculation .result {
      margin-top: 0.5rem;
      font-size: 0.9rem;
    }
    .logs-badge {
      display: inline-flex;
      align-items: center;
      padding: 0.2rem 0.5rem;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 600;
    }
    .logs-badge--high {
      background: rgba(34, 197, 94, 0.2);
      color: #22c55e;
    }
    .logs-badge--medium {
      background: rgba(234, 179, 8, 0.2);
      color: #eab308;
    }
    .logs-badge--low {
      background: rgba(239, 68, 68, 0.2);
      color: #ef4444;
    }
    .logs-summary {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 0.75rem;
      margin-top: 0.75rem;
    }
    .logs-summary-item {
      background: var(--bg-card);
      padding: 0.5rem 0.75rem;
      border-radius: 6px;
      text-align: center;
    }
    .logs-summary-item .label {
      font-size: 0.75rem;
      color: var(--text-muted);
    }
    .logs-summary-item .value {
      font-size: 1rem;
      font-weight: 600;
      color: var(--text-primary);
    }
    .logs-warning {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem;
      background: rgba(234, 179, 8, 0.1);
      border-radius: 4px;
      font-size: 0.85rem;
      color: #eab308;
      margin-top: 0.5rem;
    }
  </style>
</head>
<body>
  <script src="/auth-client.js"></script>
  <script src="/sidebar-toggle.js"></script>
  
  <!-- Image Lightbox -->
  <div class="image-lightbox" id="imageLightbox">
    <span class="image-lightbox-close" id="lightboxClose">&times;</span>
    <img src="" alt="Expanded image" id="lightboxImage" />
  </div>
  
  <div class="dp-shell">
    <!-- Sidebar -->
    <aside class="dp-sidebar">
      <!-- Brand Area -->
      <div class="dp-sidebar__brand">
        <img src="logo/LogoWhiteText_NoBg.png" alt="DraftPilot - AI Listing Studio" class="dp-brand-logo" />
      </div>
      
      <!-- Navigation -->
      <nav class="dp-sidebar__nav">
        <!-- Primary Navigation Group -->
        <div class="dp-nav-group">
          <div class="dp-nav-group__label">APP</div>
          <div class="dp-nav-group__items">
            <a href="/index.html" class="dp-nav-item">
              <svg class="dp-nav-item__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                <polyline points="9 22 9 12 15 12 15 22"></polyline>
              </svg>
              <span class="dp-nav-item__label">Overview</span>
            </a>
            <a href="/quick-list.html" class="dp-nav-item">
              <svg class="dp-nav-item__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon>
              </svg>
              <span class="dp-nav-item__label">Create Listings</span>
            </a>
            <a href="/drafts.html" class="dp-nav-item dp-nav-item--active">
              <svg class="dp-nav-item__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                <polyline points="14 2 14 8 20 8"></polyline>
              </svg>
              <span class="dp-nav-item__label">Drafts</span>
            </a>
            <a href="/active-listings.html" class="dp-nav-item">
              <svg class="dp-nav-item__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
              </svg>
              <span class="dp-nav-item__label">Active Listings</span>
            </a>
          </div>
        </div>
        
        <!-- Account Navigation Group -->
        <div class="dp-nav-group">
          <div class="dp-nav-group__label">ACCOUNT</div>
          <div class="dp-nav-group__items">
            <a href="/policies-manage.html" class="dp-nav-item">
              <svg class="dp-nav-item__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                <polyline points="14 2 14 8 20 8"></polyline>
                <line x1="16" y1="13" x2="8" y2="13"></line>
                <line x1="16" y1="17" x2="8" y2="17"></line>
                <polyline points="10 9 9 9 8 9"></polyline>
              </svg>
              <span class="dp-nav-item__label">eBay Policies</span>
            </a>
            <a href="/location.html" class="dp-nav-item">
              <svg class="dp-nav-item__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                <circle cx="12" cy="10" r="3"></circle>
              </svg>
              <span class="dp-nav-item__label">Inventory Locations</span>
            </a>
            <a href="/settings.html" class="dp-nav-item">
              <svg class="dp-nav-item__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="3"></circle>
                <path d="M12 1v6m0 6v6m5.196-15.196l-4.243 4.243m0 5.656l-4.242 4.243m15.195-5.196l-4.242-4.243m-5.657 0l-4.243-4.243"></path>
              </svg>
              <span class="dp-nav-item__label">Settings</span>
            </a>
            <a href="/faq.html" class="dp-nav-item">
              <svg class="dp-nav-item__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"></circle>
                <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                <line x1="12" y1="17" x2="12.01" y2="17"></line>
              </svg>
              <span class="dp-nav-item__label">FAQ</span>
            </a>
            <a href="/support.html" class="dp-nav-item">
              <svg class="dp-nav-item__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M18 18.72a9.094 9.094 0 0 0 3.741-.479 3 3 0 0 0-4.682-2.72m.94 3.198.001.031c0 .225-.012.447-.037.666A11.944 11.944 0 0 1 12 21c-2.17 0-4.207-.576-5.963-1.584A6.062 6.062 0 0 1 6 18.719m12 0a5.971 5.971 0 0 0-.941-3.197m0 0A5.995 5.995 0 0 0 12 12.75a5.995 5.995 0 0 0-5.058 2.772m0 0a3 3 0 0 0-4.681 2.72 8.986 8.986 0 0 0 3.74.477m.94-3.197a5.971 5.971 0 0 0-.94 3.197M15 6.75a3 3 0 1 1-6 0 3 3 0 0 1 6 0Zm6 3a2.25 2.25 0 1 1-4.5 0 2.25 2.25 0 0 1 4.5 0Zm-13.5 0a2.25 2.25 0 1 1-4.5 0 2.25 2.25 0 0 1 4.5 0Z"></path>
              </svg>
              <span class="dp-nav-item__label">Support</span>
            </a>
          </div>
        </div>
      </nav>
      
      <!-- Spacer -->
      <div class="dp-sidebar__spacer"></div>
      
      <!-- User Footer -->
      <div class="dp-sidebar__footer">
        <div class="dp-user-card" id="userCard">
          <div class="dp-user-card__avatar" id="userAvatar">U</div>
          <div class="dp-user-card__info">
            <div class="dp-user-card__name" id="userName">Loading...</div>
            <div class="dp-user-card__status" id="userEmail">Signed in</div>
          </div>
        </div>
        <div class="dp-user-menu" id="userMenu" style="display: none;">
          <a href="/logout.html" class="dp-user-menu__item">
            <svg class="dp-user-menu__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
              <polyline points="16 17 21 12 16 7"></polyline>
              <line x1="21" y1="12" x2="9" y2="12"></line>
            </svg>
            <span>Sign out</span>
          </a>
        </div>
      </div>
    </aside>
    
    <div class="dp-mobile-backdrop" id="mobileBackdrop"></div>
    
    <!-- Main Content Wrapper -->
    <div class="dp-main-wrapper">
      <!-- Top Bar -->
      <header class="dp-topbar">
        <!-- Left: Mobile menu + Page Title & Subtitle -->
        <div class="dp-topbar-left">
          <!-- Mobile-only hamburger -->
          <button
            class="dp-topbar-icon dp-topbar-icon--menu"
            id="mobileMenuButton"
            aria-label="Open navigation"
            aria-expanded="false"
            type="button"
          >
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="4" y1="6" x2="20" y2="6"></line>
              <line x1="4" y1="12" x2="20" y2="12"></line>
              <line x1="4" y1="18" x2="20" y2="18"></line>
            </svg>
          </button>

          <div class="dp-topbar-heading">
            <h1 class="dp-topbar__title">‚úèÔ∏è Edit Draft</h1>
            <p class="dp-topbar__subtitle">
              Update listing details and item specifics
            </p>
          </div>
        </div>
        
        <!-- Right: Actions -->
        <div class="dp-topbar-right" style="display: flex !important; gap: 0.75rem;">
          <a href="/drafts.html" class="dp-btn dp-btn-secondary" style="padding: 0.5rem 1rem; font-size: 0.875rem;">‚Üê Back to Drafts</a>
        </div>
      </header>
      
      <!-- Main Content Area -->
      <main class="dp-main">
        <div id="flash" style="margin-bottom: 1rem;"></div>
        
        <!-- Basic Information -->
        <div class="dp-card dp-card--full">
          <h3 style="margin-top: 0; margin-bottom: 1rem; color: var(--text-primary);">Basic Information</h3>
          
          <div class="form-row">
            <div class="form-field" style="flex: 2;">
              <label for="title">Title <small class="muted-hint">(max 80 characters)</small></label>
              <input type="text" id="title" maxlength="80" />
              <small class="muted-hint" id="titleCount">0 / 80</small>
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-field" style="flex: 2;">
              <label for="description">Description</label>
              <textarea id="description"></textarea>
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-field">
              <label for="price">Price USD</label>
              <input type="number" id="price" step="0.01" min="0" />
            </div>
            
            <div class="form-field">
              <label for="condition">Condition</label>
              <select id="condition">
                <option value="NEW">New</option>
                <option value="LIKE_NEW">Like New</option>
                <option value="USED_EXCELLENT">Used - Excellent</option>
                <option value="USED_GOOD">Used - Good</option>
                <option value="USED_ACCEPTABLE">Used - Acceptable</option>
              </select>
            </div>
          </div>
          
          <!-- Shipping Weight -->
          <div style="margin-top: 1.5rem; padding: 1rem; background: var(--bg-secondary); border-radius: 8px; border: 1px solid var(--line);">
            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem;">
              <span style="font-size: 1.125rem;">üì¶</span>
              <span style="font-weight: 600; color: var(--text-primary);">Shipping Weight</span>
              <span id="weightWarning" style="display: none; margin-left: auto; color: #fbbf24; font-size: 0.8125rem;">‚ö†Ô∏è Required for accurate shipping</span>
            </div>
            <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
              <div style="flex: 1; min-width: 120px;">
                <label for="weightOz" style="display: block; font-size: 0.875rem; color: var(--text-muted); margin-bottom: 0.5rem;">
                  Weight (ounces)
                </label>
                <input type="number" id="weightOz" min="0" step="0.1" placeholder="e.g. 8"
                       style="width: 100%; padding: 0.5rem 0.75rem; background: var(--bg); border: 1px solid var(--line); border-radius: 6px; color: var(--text-primary); font-size: 0.9375rem;" />
              </div>
              <div style="flex: 1; min-width: 120px;">
                <label for="weightLbs" style="display: block; font-size: 0.875rem; color: var(--text-muted); margin-bottom: 0.5rem;">
                  ‚Äî or Pounds ‚Äî
                </label>
                <input type="number" id="weightLbs" min="0" step="0.01" placeholder="e.g. 0.5"
                       style="width: 100%; padding: 0.5rem 0.75rem; background: var(--bg); border: 1px solid var(--line); border-radius: 6px; color: var(--text-primary); font-size: 0.9375rem;" />
              </div>
            </div>
            <div style="font-size: 0.8125rem; color: var(--text-muted); margin-top: 0.5rem;">
              üí° Enter weight in ounces OR pounds. Most supplements are 4-12 oz. Accurate weight prevents shipping overcharges.
            </div>
          </div>
          
          <!-- Promotion Settings -->
          <div style="margin-top: 1.5rem; padding: 1rem; background: var(--bg-secondary); border-radius: 8px; border: 1px solid var(--line);">
            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem;">
              <span style="font-size: 1.125rem;">üì¢</span>
              <label style="font-weight: 600; color: var(--text-primary); cursor: pointer; user-select: none; flex: 1;" for="promotionEnabled">
                Promoted Listing
              </label>
              <label class="toggle-switch">
                <input type="checkbox" id="promotionEnabled" />
                <span class="toggle-slider"></span>
              </label>
            </div>
            
            <div id="promotionOptions" style="opacity: 0.5; pointer-events: none; transition: opacity 0.2s;">
              <label for="promotionRate" style="display: block; font-size: 0.875rem; color: var(--text-muted); margin-bottom: 0.5rem;">
                Ad Rate (1-20%)
              </label>
              <div style="display: flex; align-items: center; gap: 0.5rem;">
                <input type="number" id="promotionRate" min="1" max="20" step="0.1" placeholder="5.0" 
                       style="width: 100px; padding: 0.5rem 0.75rem; background: var(--bg); border: 1px solid var(--line); border-radius: 6px; color: var(--text-primary); font-size: 0.9375rem;" />
                <span style="color: var(--text-muted); font-size: 0.9375rem;">%</span>
              </div>
              <div style="font-size: 0.8125rem; color: var(--text-muted); margin-top: 0.5rem;">
                üí° Promoted listings appear higher in eBay search results
              </div>
            </div>
          </div>
          
          <!-- Best Offer Settings -->
          <div style="margin-top: 1.5rem; padding: 1rem; background: var(--bg-secondary); border-radius: 8px; border: 1px solid var(--line);">
            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem;">
              <span style="font-size: 1.125rem;">ü§ù</span>
              <label style="font-weight: 600; color: var(--text-primary); cursor: pointer; user-select: none; flex: 1;" for="bestOfferEnabled">
                Best Offer
              </label>
              <label class="toggle-switch">
                <input type="checkbox" id="bestOfferEnabled" />
                <span class="toggle-slider"></span>
              </label>
            </div>
            
            <div id="bestOfferOptions" style="opacity: 0.5; pointer-events: none; transition: opacity 0.2s;">
              <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                <div style="flex: 1; min-width: 140px;">
                  <label for="bestOfferAutoDecline" style="display: block; font-size: 0.875rem; color: var(--text-muted); margin-bottom: 0.5rem;">
                    Minimum Offer (auto-decline below)
                  </label>
                  <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <input type="number" id="bestOfferAutoDecline" min="10" max="95" placeholder="60" 
                           style="width: 80px; padding: 0.5rem 0.75rem; background: var(--bg); border: 1px solid var(--line); border-radius: 6px; color: var(--text-primary); font-size: 0.9375rem;" />
                    <span style="color: var(--text-muted); font-size: 0.9375rem;">%</span>
                  </div>
                </div>
                <div style="flex: 1; min-width: 140px;">
                  <label for="bestOfferAutoAccept" style="display: block; font-size: 0.875rem; color: var(--text-muted); margin-bottom: 0.5rem;">
                    Auto-accept at
                  </label>
                  <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <input type="number" id="bestOfferAutoAccept" min="50" max="100" placeholder="90" 
                           style="width: 80px; padding: 0.5rem 0.75rem; background: var(--bg); border: 1px solid var(--line); border-radius: 6px; color: var(--text-primary); font-size: 0.9375rem;" />
                    <span style="color: var(--text-muted); font-size: 0.9375rem;">%</span>
                  </div>
                </div>
              </div>
              <div style="font-size: 0.8125rem; color: var(--text-muted); margin-top: 0.5rem;">
                üí° Allow buyers to negotiate prices. Auto-decline rejects low offers, auto-accept accepts good offers automatically.
              </div>
            </div>
          </div>
        </div>
        
        <!-- Item Specifics -->
        <div class="dp-card dp-card--full">
          <h3 style="margin-top: 0; margin-bottom: 1rem; color: var(--text-primary);">Item Specifics (Aspects)</h3>
          <div id="aspectsList"></div>
          <button class="dp-btn dp-btn-secondary" style="margin-top: 0.5rem;" onclick="addAspect()">+ Add Aspect</button>
        </div>
        
        <!-- Images -->
        <div class="dp-card dp-card--full">
          <h3 style="margin-top: 0; margin-bottom: 1rem; color: var(--text-primary);">üì∏ Images</h3>
          <input type="file" id="imageUploadInput" accept="image/*" multiple style="display: none;" />
          <div class="images-preview" id="imagesPreview"></div>
        </div>
        
        <!-- AI Decision Logs (Developer feature) -->
        <div class="dp-card dp-card--full logs-section" id="logsSection" style="display: none;">
          <div class="logs-header" onclick="toggleLogs()">
            <span class="logs-toggle" id="logsToggle">‚ñ∂</span>
            <h3 style="margin: 0; color: var(--text-primary);">üß† AI Decision Logs</h3>
            <span style="font-size: 0.8rem; color: var(--text-muted);">(Developer)</span>
          </div>
          <div class="logs-content" id="logsContent">
            <div id="logsLoading" style="text-align: center; padding: 1rem; color: var(--text-muted);">
              Loading logs...
            </div>
            <div id="logsData" style="display: none;">
              <!-- Pricing Decision -->
              <div class="logs-subsection" id="logsPricing">
                <h4>üí∞ Pricing Decision</h4>
                <div id="pricingReasoning"></div>
                <div class="logs-summary" id="pricingSummary"></div>
              </div>
              
              <!-- Competitor Data -->
              <div class="logs-subsection" id="logsCompetitors">
                <h4>üè™ Competitor Prices</h4>
                <table class="logs-table" id="competitorTable">
                  <thead>
                    <tr>
                      <th>Source</th>
                      <th>Title</th>
                      <th>Price</th>
                      <th>Shipping</th>
                      <th>Total</th>
                    </tr>
                  </thead>
                  <tbody id="competitorTableBody"></tbody>
                </table>
              </div>
              
              <!-- Calculation Breakdown -->
              <div class="logs-subsection" id="logsCalculations">
                <h4>üßÆ Calculation Breakdown</h4>
                <div id="calculationSteps"></div>
              </div>
              
              <!-- Warnings -->
              <div class="logs-subsection" id="logsWarnings" style="display: none;">
                <h4>‚ö†Ô∏è Warnings</h4>
                <div id="warningsList"></div>
              </div>
            </div>
            <div id="logsEmpty" style="display: none; text-align: center; padding: 1rem; color: var(--text-muted);">
              No logs available for this draft. Logs are only available for drafts created after this feature was enabled.
            </div>
          </div>
        </div>
        
        <!-- Actions -->
        <div class="dp-card dp-card--full">
          <div style="display: flex; gap: 0.75rem;">
            <button class="dp-btn dp-btn-primary" id="btnSave" onclick="saveDraft()">üíæ Update Draft</button>
            <a href="/drafts.html" class="dp-btn dp-btn-secondary">Cancel</a>
          </div>
        </div>
      </main>
    </div>
  </div>
  
  <script>
    const $ = (id) => document.getElementById(id);
    
    let currentOfferId = null;
    let originalDraft = null;
    
    async function fetchJSON(url, opts = {}) {
      const exec = window.authClient?.authFetch || fetch;
      const r = await exec(url, opts);
      const data = await r.json();
      if (!r.ok) {
        const error = data.error || `HTTP ${r.status}`;
        const detail = data.detail ? ` - ${data.detail}` : '';
        throw new Error(error + detail);
      }
      return data;
    }
    
    function showFlash(message, type = 'success') {
      const flash = $('flash');
      flash.textContent = message;
      flash.className = type === 'error' ? 'dp-flash dp-flash--error' : 'dp-flash dp-flash--success';
      flash.style.display = 'block';
      setTimeout(() => { flash.style.display = 'none'; }, 5000);
    }
    
    function updateTitleCount() {
      const title = $('title');
      $('titleCount').textContent = `${title.value.length} / 80`;
    }
    
    function escapeHtml(str) {
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }
    
    function addAspect(key = '', value = '', isRequired = false, aspectMetadata = null) {
      const container = $('aspectsList');
      const div = document.createElement('div');
      div.className = 'aspect-item';
      const requiredMark = isRequired ? ' <span style="color: #ef4444;">*</span>' : '';
      const keyReadonly = isRequired || key ? 'readonly' : '';
      
      // Parse existing values (could be comma-separated string or array)
      let existingValues = [];
      if (value) {
        if (Array.isArray(value)) {
          existingValues = value;
        } else if (typeof value === 'string') {
          existingValues = value.split(',').map(v => v.trim()).filter(v => v);
        }
      }
      
      console.log(`[addAspect] ${key}:`, {
        value,
        existingValues,
        hasMetadata: !!aspectMetadata,
        cardinality: aspectMetadata?.cardinality,
        aspectValuesCount: aspectMetadata?.aspectValues?.length
      });
      
      // Check if aspect has predefined values (dropdown)
      let valueInput = '';
      if (aspectMetadata?.aspectValues && aspectMetadata.aspectValues.length > 0) {
        const mode = aspectMetadata.aspectConstraint?.aspectMode || 'SELECTION_ONLY';
        const cardinality = aspectMetadata.aspectConstraint?.itemToAspectCardinality || 'SINGLE';
        
        console.log(`[addAspect] ${key} cardinality: ${cardinality}`);
        
        // If multiple selections allowed, create multi-select dropdown
        if (cardinality === 'MULTI') {
          const multiselectId = `multiselect-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
          const displayText = existingValues.length > 0 ? escapeHtml(existingValues.join(', ')) : `Select ${escapeHtml(key)}...`;
          
          const options = aspectMetadata.aspectValues.map(av => {
            const checked = existingValues.includes(av.localizedValue) ? 'checked' : '';
            const escapedValue = escapeHtml(av.localizedValue);
            return `<div class="aspect-multiselect-option" data-value="${escapedValue}">
              <input type="checkbox" value="${escapedValue}" ${checked} />
              <label>${escapedValue}</label>
            </div>`;
          }).join('');
          
          const hasSearch = aspectMetadata.aspectValues.length > 10;
          const escapedJoinedValues = escapeHtml(existingValues.join(', '));
          valueInput = `<div class="aspect-multiselect" data-multiselect-id="${multiselectId}">
            <div class="aspect-multiselect-display">
              <span class="multiselect-text">${displayText}</span>
              <span class="aspect-multiselect-arrow">‚ñº</span>
            </div>
            <div class="aspect-multiselect-dropdown">
              ${hasSearch ? '<div class="aspect-multiselect-search"><input type="text" placeholder="Search..." class="multiselect-search-input" /></div>' : ''}
              <div class="aspect-multiselect-options">
                ${options}
              </div>
              <div class="aspect-multiselect-custom">
                <input type="text" placeholder="Or type custom value and press Enter..." class="multiselect-custom-input" />
              </div>
            </div>
            <input type="hidden" class="aspect-value" value="${escapedJoinedValues}" />
          </div>`;
        } else {
          // Single selection - use regular dropdown
          const selectedValue = existingValues[0] || '';
          const isFreeText = mode === 'FREE_TEXT';
          // Allow custom entry for Brand even when eBay marks it selection-only
          const allowCustom = isFreeText || key?.toLowerCase() === 'brand';
          
          // Check if selected value is in the predefined list
          const valueInList = aspectMetadata.aspectValues.some(av => av.localizedValue === selectedValue);
          
          // Build options - add current value at top if it's not in the list and we have a value
          let customOption = '';
          if (selectedValue && !valueInList) {
            const escapedValue = escapeHtml(selectedValue);
            customOption = `<option value="${escapedValue}" selected>${escapedValue}</option>`;
            console.log(`[addAspect] ${key}: Adding custom value "${selectedValue}" not in eBay's list`);
          }
          
          const options = aspectMetadata.aspectValues.map(av => {
            const selected = av.localizedValue === selectedValue ? 'selected' : '';
            return `<option value="${av.localizedValue}" ${selected}>${av.localizedValue}</option>`;
          }).join('');
          
          // For FREE_TEXT mode, also add a custom input option
          const customInputOption = allowCustom ? `<option value="__custom__">Enter custom value...</option>` : '';
          
          valueInput = `<select class="aspect-value aspect-dropdown-with-custom" data-free-text="${isFreeText}" ${isRequired ? 'required' : ''}>
            <option value="">Select ${key}...</option>
            ${customOption}
            ${options}
            ${customInputOption}
          </select>`;
        }
      } else {
        // Regular text input
        const displayValue = existingValues.join(', ');
        valueInput = `<input type="text" placeholder="Value${requiredMark}" value="${displayValue}" class="aspect-value" ${isRequired ? 'required' : ''} />`;
      }
      
      div.innerHTML = `
        <input type="text" placeholder="Name (e.g. Brand)" value="${key}" class="aspect-key" ${keyReadonly} />
        ${valueInput}
        <button class="dp-btn dp-btn-secondary" onclick="this.parentElement.remove()" ${isRequired ? 'disabled title="Required field"' : ''}>√ó</button>
      `;
      container.appendChild(div);
      
      // Add event listeners for multi-select
      if (aspectMetadata?.aspectValues && (aspectMetadata.aspectConstraint?.itemToAspectCardinality || 'SINGLE') === 'MULTI') {
        const multiselect = div.querySelector('.aspect-multiselect');
        const display = multiselect.querySelector('.aspect-multiselect-display');
        const dropdown = multiselect.querySelector('.aspect-multiselect-dropdown');
        const optionsContainer = multiselect.querySelector('.aspect-multiselect-options');
        const arrow = multiselect.querySelector('.aspect-multiselect-arrow');
        const hiddenInput = multiselect.querySelector('input[type="hidden"]');
        const textDisplay = multiselect.querySelector('.multiselect-text');
        const searchInput = multiselect.querySelector('.multiselect-search-input');
        const customInput = multiselect.querySelector('.multiselect-custom-input');
        
        display.addEventListener('click', (e) => {
          e.stopPropagation();
          multiselect.classList.toggle('open');
          dropdown.classList.toggle('open');
          if (dropdown.classList.contains('open') && searchInput) {
            setTimeout(() => searchInput.focus(), 0);
          }
        });
        
        // Prevent dropdown from closing when clicking inside
        dropdown.addEventListener('click', (e) => {
          e.stopPropagation();
        });
        
        // Close dropdown when clicking outside
        document.addEventListener('click', () => {
          multiselect.classList.remove('open');
          dropdown.classList.remove('open');
        });
        
        // Search functionality
        if (searchInput) {
          searchInput.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            optionsContainer.querySelectorAll('.aspect-multiselect-option').forEach(option => {
              const text = option.querySelector('label').textContent.toLowerCase();
              if (text.includes(searchTerm)) {
                option.classList.remove('hidden');
              } else {
                option.classList.add('hidden');
              }
            });
          });
          
          // Allow adding custom value from search box with Enter
          searchInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && searchInput.value.trim()) {
              e.preventDefault();
              const customValue = searchInput.value.trim();
              
              // Get current values
              const currentValues = hiddenInput.value ? hiddenInput.value.split(',').map(v => v.trim()) : [];
              
              // Add custom value if not already present
              if (!currentValues.includes(customValue)) {
                currentValues.push(customValue);
                hiddenInput.value = currentValues.join(', ');
                textDisplay.textContent = currentValues.join(', ');
              }
              
              searchInput.value = '';
              // Reset search filter
              optionsContainer.querySelectorAll('.aspect-multiselect-option').forEach(option => {
                option.classList.remove('hidden');
              });
            }
          });
        }
        
        // Custom value input
        if (customInput) {
          customInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && customInput.value.trim()) {
              e.preventDefault();
              const customValue = customInput.value.trim();
              
              // Get current values
              const currentValues = hiddenInput.value ? hiddenInput.value.split(',').map(v => v.trim()) : [];
              
              // Add custom value if not already present
              if (!currentValues.includes(customValue)) {
                currentValues.push(customValue);
                hiddenInput.value = currentValues.join(', ');
                textDisplay.textContent = currentValues.join(', ');
              }
              
              customInput.value = '';
              dropdown.classList.remove('open');
              arrow.classList.remove('open');
            }
          });
        }
        
        // Handle checkbox and label clicks
        optionsContainer.querySelectorAll('.aspect-multiselect-option').forEach(option => {
          const checkbox = option.querySelector('input[type="checkbox"]');
          const label = option.querySelector('label');
          
          // Make label clickable
          label.addEventListener('click', (e) => {
            e.preventDefault();
            checkbox.checked = !checkbox.checked;
            updateMultiselectValues();
          });
          
          checkbox.addEventListener('change', updateMultiselectValues);
        });
        
        function updateMultiselectValues() {
          const selectedValues = Array.from(optionsContainer.querySelectorAll('input[type="checkbox"]:checked'))
            .map(cb => cb.value);
          hiddenInput.value = selectedValues.join(', ');
          textDisplay.textContent = selectedValues.length > 0 ? selectedValues.join(', ') : `Select ${key}...`;
        }
      }
      
      // Handle custom value option for single-select dropdowns with FREE_TEXT mode
      const dropdown = div.querySelector('select.aspect-dropdown-with-custom');
      if (dropdown) {
        dropdown.addEventListener('change', function(e) {
          if (this.value === '__custom__') {
            const customValue = prompt(`Enter custom value for ${key}:`);
            if (customValue && customValue.trim()) {
              // Add the custom value as a new option and select it
              const newOption = document.createElement('option');
              newOption.value = customValue.trim();
              newOption.textContent = customValue.trim();
              newOption.selected = true;
              // Insert after the "Select..." option
              this.insertBefore(newOption, this.options[1]);
              this.value = customValue.trim();
            } else {
              // Reset to empty if cancelled
              this.value = '';
            }
          }
        });
      }
    }
    
    async function loadDraft() {
      try {
        const params = new URLSearchParams(window.location.search);
        currentOfferId = params.get('offerId');
        
        if (!currentOfferId) {
          throw new Error('Missing offerId in URL');
        }
        
        console.log('Loading draft for offerId:', currentOfferId);
        showFlash('Loading draft...', 'success');
        
        // Fetch the draft data
        const res = await fetchJSON(`/.netlify/functions/smartdrafts-get-draft?offerId=${encodeURIComponent(currentOfferId)}`);
        
        console.log('Draft loaded:', res);
        
        if (!res.ok || !res.draft) {
          throw new Error('Draft not found');
        }
        
        originalDraft = res.draft;
        
        // Populate form
        $('title').value = originalDraft.title || '';
        $('description').value = originalDraft.description || '';
        $('price').value = originalDraft.price || '';
        $('condition').value = originalDraft.condition || 'NEW';
        
        // Populate weight fields
        if (originalDraft.weight) {
          const weightVal = originalDraft.weight.value || 0;
          const weightUnit = (originalDraft.weight.unit || 'OUNCE').toUpperCase();
          if (weightUnit === 'POUND') {
            $('weightLbs').value = weightVal;
            $('weightOz').value = '';
          } else {
            // Default to ounces
            $('weightOz').value = weightVal;
            $('weightLbs').value = '';
          }
        } else {
          // Show warning if no weight
          $('weightWarning').style.display = 'inline';
        }
        
        // Populate promotion settings
        if (originalDraft.promotion) {
          $('promotionEnabled').checked = originalDraft.promotion.enabled || false;
          $('promotionRate').value = originalDraft.promotion.rate || '';
          if (originalDraft.promotion.enabled) {
            $('promotionOptions').style.opacity = '1';
            $('promotionOptions').style.pointerEvents = 'auto';
          }
        }
        
        // Populate Best Offer settings
        if (originalDraft.bestOffer) {
          $('bestOfferEnabled').checked = originalDraft.bestOffer.enabled || false;
          $('bestOfferAutoDecline').value = originalDraft.bestOffer.autoDeclinePercent || '';
          $('bestOfferAutoAccept').value = originalDraft.bestOffer.autoAcceptPercent || '';
          if (originalDraft.bestOffer.enabled) {
            $('bestOfferOptions').style.opacity = '1';
            $('bestOfferOptions').style.pointerEvents = 'auto';
          }
        }
        
        updateTitleCount();
        
        // Build aspect metadata lookup
        const aspectsMetadata = {};
        if (originalDraft.categoryAspects && Array.isArray(originalDraft.categoryAspects)) {
          originalDraft.categoryAspects.forEach(aspect => {
            aspectsMetadata[aspect.localizedAspectName] = aspect;
          });
        }
        
        // Populate aspects - show existing ones first
        const existingAspects = new Set();
        if (originalDraft.aspects && typeof originalDraft.aspects === 'object') {
          Object.entries(originalDraft.aspects).forEach(([key, values]) => {
            // Pass the array directly, don't join it yet
            const metadata = aspectsMetadata[key];
            addAspect(key, values, false, metadata);
            existingAspects.add(key);
          });
        }
        
        // Add empty fields for category-recommended aspects that aren't filled yet
        if (originalDraft.categoryAspects && Array.isArray(originalDraft.categoryAspects)) {
          originalDraft.categoryAspects.forEach(aspect => {
            const name = aspect.localizedAspectName;
            if (!existingAspects.has(name)) {
              const isRequired = aspect.aspectConstraint?.aspectRequired || false;
              addAspect(name, '', isRequired, aspect);
            }
          });
        }
        
        // Show images with drag-and-drop reordering
        if (originalDraft.images && Array.isArray(originalDraft.images)) {
          const preview = $('imagesPreview');
          originalDraft.images.forEach((url, index) => {
            const div = document.createElement('div');
            div.className = 'image-thumb';
            div.draggable = true;
            div.dataset.url = url;
            div.innerHTML = `
              <div class="image-order">${index + 1}</div>
              <img src="${url}" alt="Product image" />
            `;
            
            // Drag and drop event handlers
            div.addEventListener('dragstart', handleDragStart);
            div.addEventListener('dragend', handleDragEnd);
            div.addEventListener('dragover', handleDragOver);
            div.addEventListener('drop', handleDrop);
            div.addEventListener('dragleave', handleDragLeave);
            
            // Click to expand image
            div.addEventListener('click', (e) => {
              // Don't expand if dragging
              if (e.target.classList.contains('dragging')) return;
              openLightbox(url);
            });
            
            preview.appendChild(div);
          });
          
          // Add upload box at the end
          addUploadBox();
        }
        
        showFlash('Draft loaded successfully!', 'success');
        
      } catch (err) {
        console.error('Failed to load draft:', err);
        showFlash(`Error: ${err.message}`, 'error');
      }
    }
    
    // Drag and drop handlers for image reordering
    let draggedElement = null;
    
    function handleDragStart(e) {
      draggedElement = this;
      this.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
    }
    
    function handleDragEnd(e) {
      this.classList.remove('dragging');
      document.querySelectorAll('.image-thumb').forEach(el => {
        el.classList.remove('drag-over');
      });
      updateImageOrderLabels();
    }
    
    function handleDragOver(e) {
      if (e.preventDefault) e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
      return false;
    }
    
    function handleDrop(e) {
      if (e.stopPropagation) e.stopPropagation();
      
      if (draggedElement !== this) {
        const allImages = Array.from($('imagesPreview').children);
        const draggedIndex = allImages.indexOf(draggedElement);
        const targetIndex = allImages.indexOf(this);
        
        if (draggedIndex < targetIndex) {
          this.parentNode.insertBefore(draggedElement, this.nextSibling);
        } else {
          this.parentNode.insertBefore(draggedElement, this);
        }
      }
      
      this.classList.remove('drag-over');
      return false;
    }
    
    function handleDragLeave(e) {
      this.classList.remove('drag-over');
    }
    
    function updateImageOrderLabels() {
      document.querySelectorAll('.image-thumb').forEach((el, index) => {
        const orderLabel = el.querySelector('.image-order');
        if (orderLabel) orderLabel.textContent = index + 1;
      });
    }
    
    function addUploadBox() {
      const preview = $('imagesPreview');
      const uploadBox = document.createElement('div');
      uploadBox.className = 'image-upload-box';
      uploadBox.innerHTML = `
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="12" y1="5" x2="12" y2="19"></line>
          <line x1="5" y1="12" x2="19" y2="12"></line>
        </svg>
      `;
      uploadBox.onclick = () => $('imageUploadInput').click();
      preview.appendChild(uploadBox);
    }
    
    /**
     * Uploads base64 images to R2/S3 via ingest-local-upload function
     * Returns array of HTTPS URLs that eBay can access
     */
    async function uploadImagesToStorage(files) {
      // Convert files to the format expected by ingest-local-upload
      const fileData = [];
      for (const file of files) {
        const reader = new FileReader();
        const base64 = await new Promise((resolve, reject) => {
          reader.onload = (e) => {
            // Remove data URL prefix to get pure base64
            const result = e.target.result;
            const base64Data = result.split(',')[1];
            resolve(base64Data);
          };
          reader.onerror = reject;
          reader.readAsDataURL(file);
        });
        fileData.push({
          name: file.name,
          mime: file.type || 'image/jpeg',
          data: base64,
        });
      }
      
      // Upload to R2/S3
      const res = await fetchJSON('/.netlify/functions/ingest-local-upload', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ files: fileData }),
      });
      
      if (!res.ok) {
        throw new Error(res.error || 'Failed to upload images');
      }
      
      // Return the staged URLs (signed HTTPS URLs)
      return res.files.map(f => f.stagedUrl);
    }

    async function handleImageUpload(event) {
      const files = event.target.files;
      if (!files || files.length === 0) return;
      
      try {
        showFlash('Uploading images to storage...', 'success');
        
        // Upload images to R2/S3 and get HTTPS URLs
        const uploadedUrls = await uploadImagesToStorage(Array.from(files));
        
        // Add new images to the preview (before the upload box)
        const preview = $('imagesPreview');
        const uploadBox = preview.querySelector('.image-upload-box');
        
        uploadedUrls.forEach((url, index) => {
          const currentImageCount = document.querySelectorAll('.image-thumb').length;
          const div = document.createElement('div');
          div.className = 'image-thumb';
          div.draggable = true;
          div.dataset.url = url; // Store the HTTPS URL, not base64
          div.innerHTML = `
            <div class="image-order">${currentImageCount + index + 1}</div>
            <img src="${url}" alt="Product image" />
          `;
          
          // Drag and drop event handlers
          div.addEventListener('dragstart', handleDragStart);
          div.addEventListener('dragend', handleDragEnd);
          div.addEventListener('dragover', handleDragOver);
          div.addEventListener('drop', handleDrop);
          div.addEventListener('dragleave', handleDragLeave);
          
          preview.insertBefore(div, uploadBox);
        });
        
        showFlash(`Added ${uploadedUrls.length} image(s)`, 'success');
        
        // Clear the file input
        event.target.value = '';
      } catch (err) {
        console.error('Image upload failed:', err);
        showFlash(`Error uploading images: ${err.message}`, 'error');
      }
    }
    
    // Attach upload handler
    $('imageUploadInput').addEventListener('change', handleImageUpload);
    
    async function saveDraft() {
      try {
        const btn = $('btnSave');
        btn.disabled = true;
        btn.textContent = 'Saving...';
        
        // Collect aspects
        const aspects = {};
        document.querySelectorAll('.aspect-item').forEach(item => {
          const key = item.querySelector('.aspect-key').value.trim();
          const valueElement = item.querySelector('.aspect-value');
          const value = valueElement.value.trim();
          if (key && value) {
            // Split comma-separated values into array
            aspects[key] = value.includes(',') ? value.split(',').map(v => v.trim()) : [value];
          }
        });
        
        // Collect images in their current order
        const images = Array.from(document.querySelectorAll('.image-thumb')).map(el => el.dataset.url);
        
        // Validate that all images are proper HTTPS URLs (not base64 data URLs)
        const invalidImages = images.filter(url => url && url.startsWith('data:'));
        if (invalidImages.length > 0) {
          throw new Error(`${invalidImages.length} image(s) failed to upload. Please remove them and try adding again.`);
        }
        
        // Collect promotion settings
        const promotionEnabled = $('promotionEnabled').checked;
        const promotionRate = parseFloat($('promotionRate').value) || null;
        
        // Collect Best Offer settings
        const bestOfferEnabled = $('bestOfferEnabled').checked;
        const bestOfferAutoDecline = parseInt($('bestOfferAutoDecline').value) || 60;
        const bestOfferAutoAccept = parseInt($('bestOfferAutoAccept').value) || 90;
        
        // Collect weight (prefer oz, convert lbs to oz if only lbs given)
        const weightOzRaw = parseFloat($('weightOz').value) || 0;
        const weightLbsRaw = parseFloat($('weightLbs').value) || 0;
        let weightValue = null;
        let weightUnit = 'OUNCE';
        if (weightOzRaw > 0) {
          weightValue = weightOzRaw;
        } else if (weightLbsRaw > 0) {
          weightValue = weightLbsRaw * 16; // Convert to oz for consistency
        }
        
        const updatedDraft = {
          ...originalDraft,
          title: $('title').value.trim(),
          description: $('description').value.trim(),
          price: parseFloat($('price').value) || 0,
          condition: $('condition').value,
          aspects,
          images, // Include reordered images
          promotion: {
            enabled: promotionEnabled,
            rate: promotionEnabled ? promotionRate : null
          },
          bestOffer: {
            enabled: bestOfferEnabled,
            autoDeclinePercent: bestOfferEnabled ? bestOfferAutoDecline : null,
            autoAcceptPercent: bestOfferEnabled ? bestOfferAutoAccept : null
          },
          weight: weightValue ? { value: weightValue, unit: weightUnit } : null
        };
        
        // Save to backend
        const res = await fetchJSON('/.netlify/functions/smartdrafts-update-draft', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            offerId: currentOfferId,
            draft: updatedDraft,
          }),
        });
        
        if (res.ok) {
          showFlash('Draft saved successfully!', 'success');
          setTimeout(() => window.location.href = '/drafts.html', 1500);
        } else {
          throw new Error(res.error || 'Failed to save draft');
        }
        
      } catch (err) {
        console.error('Failed to save draft:', err);
        showFlash(`Error: ${err.message}`, 'error');
        $('btnSave').disabled = false;
        $('btnSave').textContent = 'Update Draft';
      }
    }
    
    $('title').addEventListener('input', updateTitleCount);
    
    function initUserMenu() {
      const userCard = document.getElementById('userCard');
      const userMenu = document.getElementById('userMenu');
      
      if (!userCard || !userMenu) return;
      
      userCard.addEventListener('click', (e) => {
        e.stopPropagation();
        const isVisible = userMenu.style.display !== 'none';
        userMenu.style.display = isVisible ? 'none' : 'block';
      });
      
      // Close menu when clicking outside
      document.addEventListener('click', (e) => {
        if (!userCard.contains(e.target) && !userMenu.contains(e.target)) {
          userMenu.style.display = 'none';
        }
      });
    }
    
    async function bootstrap() {
      try {
        // Wait for authClient to be available
        if (!window.authClient) {
          console.log('Waiting for authClient...');
          await new Promise(resolve => {
            const check = setInterval(() => {
              if (window.authClient) {
                clearInterval(check);
                resolve();
              }
            }, 100);
          });
        }
        
        const ok = await window.authClient.requireAuth();
        if (!ok) {
          showFlash('Authentication required. Redirecting to login...', 'error');
          return;
        }
        
        // Populate sidebar user info
        await window.authClient.updateUserDisplay().catch(() => {});
        
        // Setup promotion toggle handler
        const promotionToggle = $('promotionEnabled');
        const promotionOptions = $('promotionOptions');
        if (promotionToggle && promotionOptions) {
          promotionToggle.addEventListener('change', () => {
            if (promotionToggle.checked) {
              promotionOptions.style.opacity = '1';
              promotionOptions.style.pointerEvents = 'auto';
            } else {
              promotionOptions.style.opacity = '0.5';
              promotionOptions.style.pointerEvents = 'none';
            }
          });
        }
        
        // Setup Best Offer toggle handler
        const bestOfferToggle = $('bestOfferEnabled');
        const bestOfferOptions = $('bestOfferOptions');
        if (bestOfferToggle && bestOfferOptions) {
          bestOfferToggle.addEventListener('change', () => {
            if (bestOfferToggle.checked) {
              bestOfferOptions.style.opacity = '1';
              bestOfferOptions.style.pointerEvents = 'auto';
            } else {
              bestOfferOptions.style.opacity = '0.5';
              bestOfferOptions.style.pointerEvents = 'none';
            }
          });
        }
        
        await loadDraft();
        
        // Load AI decision logs if enabled in settings
        await checkAndLoadLogs();
      } catch (e) {
        console.error('Bootstrap failed', e);
        showFlash(`Failed to load: ${e.message}`, 'error');
      }
    }
    
    // Lightbox functions
    function openLightbox(imageUrl) {
      const lightbox = $('imageLightbox');
      const lightboxImg = $('lightboxImage');
      if (lightbox && lightboxImg) {
        lightboxImg.src = imageUrl;
        lightbox.classList.add('active');
        document.body.style.overflow = 'hidden';
      }
    }
    
    function closeLightbox() {
      const lightbox = $('imageLightbox');
      if (lightbox) {
        lightbox.classList.remove('active');
        document.body.style.overflow = '';
      }
    }
    
    // Close lightbox on click or escape
    $('imageLightbox')?.addEventListener('click', closeLightbox);
    $('lightboxClose')?.addEventListener('click', closeLightbox);
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') closeLightbox();
    });
    
    // ========================================
    // AI Decision Logs Functions
    // ========================================
    
    let logsOpen = false;
    
    function toggleLogs() {
      logsOpen = !logsOpen;
      const toggle = $('logsToggle');
      const content = $('logsContent');
      if (logsOpen) {
        toggle.classList.add('open');
        content.classList.add('open');
      } else {
        toggle.classList.remove('open');
        content.classList.remove('open');
      }
    }
    
    async function checkAndLoadLogs() {
      // First check if user has logs enabled in settings
      try {
        const settings = await fetchJSON('/.netlify/functions/user-settings-get');
        if (!settings.showPricingLogs) {
          // Setting not enabled, keep section hidden
          return;
        }
        
        // Show the section (collapsed by default)
        $('logsSection').style.display = 'block';
        
        // Load the logs when expanded (lazy load)
        // For now, load immediately
        await loadDraftLogs();
      } catch (err) {
        console.error('Failed to check logs setting:', err);
      }
    }
    
    async function loadDraftLogs() {
      if (!originalDraft?.sku) {
        console.log('No SKU available for logs');
        $('logsLoading').style.display = 'none';
        $('logsEmpty').style.display = 'block';
        return;
      }
      
      try {
        const params = new URLSearchParams({
          sku: originalDraft.sku,
          ...(currentOfferId ? { offerId: currentOfferId } : {}),
        });
        const res = await fetchJSON(`/.netlify/functions/draft-logs-get?${params.toString()}`);
        
        $('logsLoading').style.display = 'none';
        
        if (!res.ok || !res.logs) {
          $('logsEmpty').style.display = 'block';
          return;
        }
        
        const logs = res.logs;
        $('logsData').style.display = 'block';
        
        // Render pricing decision
        renderPricingDecision(logs.pricing);
        
      } catch (err) {
        console.error('Failed to load draft logs:', err);
        $('logsLoading').style.display = 'none';
        $('logsEmpty').style.display = 'block';
        $('logsEmpty').textContent = `Failed to load logs: ${err.message}`;
      }
    }
    
    function renderPricingDecision(pricing) {
      if (!pricing) {
        $('logsPricing').style.display = 'none';
        $('logsCompetitors').style.display = 'none';
        $('logsCalculations').style.display = 'none';
        return;
      }
      
      // Reasoning and confidence
      const confidenceBadge = pricing.confidence 
        ? `<span class="logs-badge logs-badge--${pricing.confidence}">${pricing.confidence.toUpperCase()}</span>` 
        : '';
      
      $('pricingReasoning').innerHTML = `
        <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem;">
          <span style="font-size: 1.25rem; font-weight: 600; color: var(--text-primary);">$${pricing.finalPrice?.toFixed(2) || '0.00'}</span>
          ${confidenceBadge}
          ${pricing.freeShippingApplied ? '<span style="background: rgba(34, 197, 94, 0.2); color: #22c55e; padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">FREE SHIPPING</span>' : ''}
        </div>
        <p style="color: var(--text-muted); font-size: 0.9rem; margin: 0;">${escapeHtml(pricing.reasoning || 'No reasoning available')}</p>
      `;
      
      // Summary stats
      const summary = pricing.competitorSummary || {};
      let summaryHtml = '';
      if (summary.lowestDeliveredPrice) {
        summaryHtml += `<div class="logs-summary-item"><div class="label">Lowest eBay</div><div class="value">$${summary.lowestDeliveredPrice.toFixed(2)}</div></div>`;
      }
      if (summary.medianDeliveredPrice) {
        summaryHtml += `<div class="logs-summary-item"><div class="label">Median Sold</div><div class="value">$${summary.medianDeliveredPrice.toFixed(2)}</div></div>`;
      }
      if (summary.amazonPrice) {
        summaryHtml += `<div class="logs-summary-item"><div class="label">Amazon</div><div class="value">$${summary.amazonPrice.toFixed(2)}</div></div>`;
      }
      if (summary.walmartPrice) {
        summaryHtml += `<div class="logs-summary-item"><div class="label">Walmart</div><div class="value">$${summary.walmartPrice.toFixed(2)}</div></div>`;
      }
      if (summary.ebayActiveCount) {
        summaryHtml += `<div class="logs-summary-item"><div class="label">eBay Active</div><div class="value">${summary.ebayActiveCount}</div></div>`;
      }
      if (summary.ebaySoldCount) {
        summaryHtml += `<div class="logs-summary-item"><div class="label">eBay Sold</div><div class="value">${summary.ebaySoldCount}</div></div>`;
      }
      $('pricingSummary').innerHTML = summaryHtml;
      
      // Competitor table
      if (pricing.sources && pricing.sources.length > 0) {
        let tableHtml = '';
        pricing.sources.forEach(source => {
          if (source.results && source.results.length > 0) {
            source.results.forEach(result => {
              tableHtml += `
                <tr>
                  <td>${escapeHtml(source.source)}</td>
                  <td title="${escapeHtml(result.title)}">${escapeHtml(result.title?.substring(0, 50) || '‚Äî')}${result.title?.length > 50 ? '...' : ''}</td>
                  <td>$${result.price?.toFixed(2) || '‚Äî'}</td>
                  <td>${result.shipping > 0 ? '$' + result.shipping.toFixed(2) : 'Free'}</td>
                  <td style="font-weight: 600;">$${result.total?.toFixed(2) || '‚Äî'}</td>
                </tr>
              `;
            });
          }
        });
        
        if (tableHtml) {
          $('competitorTableBody').innerHTML = tableHtml;
          $('logsCompetitors').style.display = 'block';
        } else {
          $('logsCompetitors').style.display = 'none';
        }
      } else {
        $('logsCompetitors').style.display = 'none';
      }
      
      // Calculation steps
      if (pricing.calculations && pricing.calculations.length > 0) {
        let calcHtml = '';
        pricing.calculations.forEach(calc => {
          const inputsHtml = Object.entries(calc.input || {})
            .map(([k, v]) => `<span style="color: var(--text-muted);">${k}:</span> ${v}`)
            .join(' ¬∑ ');
          const outputsHtml = Object.entries(calc.output || {})
            .map(([k, v]) => `<span style="color: var(--accent);">${k}:</span> <strong>${v}</strong>`)
            .join(' ¬∑ ');
          
          calcHtml += `
            <div class="logs-calculation">
              <div class="step">${escapeHtml(calc.step)}</div>
              ${calc.formula ? `<div class="formula">${escapeHtml(calc.formula)}</div>` : ''}
              <div class="result">
                ${inputsHtml ? `<div style="font-size: 0.8rem; margin-bottom: 0.25rem;">${inputsHtml}</div>` : ''}
                <div>${outputsHtml}</div>
              </div>
              ${calc.notes ? `<div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 0.5rem;">üí° ${escapeHtml(calc.notes)}</div>` : ''}
            </div>
          `;
        });
        $('calculationSteps').innerHTML = calcHtml;
        $('logsCalculations').style.display = 'block';
      } else {
        $('logsCalculations').style.display = 'none';
      }
      
      // Warnings
      if (pricing.warnings && pricing.warnings.length > 0) {
        const warningsHtml = pricing.warnings.map(w => `
          <div class="logs-warning">‚ö†Ô∏è ${escapeHtml(w)}</div>
        `).join('');
        $('warningsList').innerHTML = warningsHtml;
        $('logsWarnings').style.display = 'block';
      } else {
        $('logsWarnings').style.display = 'none';
      }
    }
    
    initUserMenu();
    bootstrap();
  </script>
</body>
</html>
