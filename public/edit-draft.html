<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Edit Draft ‚Äì DraftPilot</title>
  <link rel="stylesheet" href="/draftpilot.css?v=2">
  <style>
    /* Edit draft specific styles */
    .edit-form {
      max-width: 920px;
      margin: 0 auto;
    }
    .form-row {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      margin-bottom: 1.25rem;
    }
    .form-field {
      flex: 1 1 250px;
      min-width: 220px;
    }
    .form-field label {
      display: block;
      font-weight: 600;
      margin-bottom: 0.5rem;
      font-size: 0.9rem;
      color: var(--text-secondary);
    }
    .form-field input, 
    .form-field textarea, 
    .form-field select {
      width: 100%;
      background: rgba(15, 23, 42, 0.5);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-md);
      padding: 0.7rem 0.9rem;
      color: var(--text-primary);
      font-family: inherit;
      font-size: 0.95rem;
      transition: border-color 0.2s, background 0.2s;
    }
    .form-field input:focus, 
    .form-field textarea:focus, 
    .form-field select:focus {
      outline: none;
      border-color: var(--accent);
      background: rgba(15, 23, 42, 0.8);
    }
    .form-field textarea {
      resize: vertical;
      min-height: 140px;
      line-height: 1.6;
    }
    .muted-hint {
      font-size: 0.85rem;
      color: var(--text-muted);
      margin-top: 0.3rem;
    }
    .aspect-item {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 0.65rem;
      align-items: center;
    }
    .aspect-item input {
      flex: 1;
    }
    .aspect-item button {
      padding: 0.4rem 0.8rem;
      font-size: 0.85rem;
    }
    .images-preview {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 1rem;
      margin-top: 1rem;
    }
    .image-thumb {
      position: relative;
      aspect-ratio: 1;
      border-radius: var(--radius-md);
      overflow: hidden;
      border: 1px solid var(--border-subtle);
      background: rgba(15, 23, 42, 0.5);
      transition: border-color 0.2s, transform 0.2s;
      cursor: move;
    }
    .image-thumb:hover {
      border-color: var(--accent-hover);
      transform: scale(1.02);
    }
    .image-thumb.dragging {
      opacity: 0.5;
    }
    .image-thumb.drag-over {
      border-color: var(--accent);
      border-width: 2px;
    }
    .image-thumb img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      pointer-events: none;
    }
    .image-thumb .image-order {
      position: absolute;
      top: 4px;
      left: 4px;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 600;
    }
    .action-bar {
      display: flex;
      gap: 0.75rem;
      margin-top: 1.5rem;
      padding-top: 1.5rem;
      border-top: 1px solid var(--border-subtle);
    }
  </style>
</head>
<body>
  <script src="/auth-client.js"></script>
  
  <!-- Dashboard Shell -->
  <div class="dp-shell">
    <!-- Sidebar Navigation -->
    <aside class="dp-sidebar">
      <div class="dp-sidebar__brand">
        <a href="/" class="dp-brand-logo">
          <span class="dp-brand-logo__icon">‚ú¶</span>
          <span class="dp-brand-logo__text">DraftPilot</span>
        </a>
      </div>

      <nav class="dp-sidebar__nav">
        <a href="/index.html" class="dp-nav-item">
          <span class="dp-nav-item__icon">üìä</span>
          <span class="dp-nav-item__label">Dashboard</span>
        </a>
        <a href="/drafts.html" class="dp-nav-item dp-nav-item--active">
          <span class="dp-nav-item__icon">üìù</span>
          <span class="dp-nav-item__label">Drafts</span>
        </a>
        <a href="/quick-list.html" class="dp-nav-item">
          <span class="dp-nav-item__icon">‚ö°</span>
          <span class="dp-nav-item__label">Quick List</span>
        </a>
        <a href="/policies-manage.html" class="dp-nav-item">
          <span class="dp-nav-item__icon">üìã</span>
          <span class="dp-nav-item__label">Policies</span>
        </a>
        <a href="/settings.html" class="dp-nav-item">
          <span class="dp-nav-item__icon">‚öôÔ∏è</span>
          <span class="dp-nav-item__label">Settings</span>
        </a>
      </nav>

      <div class="dp-sidebar__footer">
        <div class="dp-user-card" id="userCard">
          <div class="dp-user-card__avatar">?</div>
          <div class="dp-user-card__info">
            <div class="dp-user-card__name" id="userName">Loading...</div>
            <a href="/logout.html" class="dp-user-card__action">Sign out</a>
          </div>
        </div>
      </div>
    </aside>

    <!-- Main Content -->
    <div class="dp-content">
      <div class="dp-page">
        <!-- Header -->
        <header class="dp-header">
          <div class="dp-header__title">
            <h1>Edit Draft</h1>
            <p class="dp-header__subtitle">Update listing details and item specifics</p>
          </div>
          <div class="dp-header__actions">
            <a href="/drafts.html" class="dp-btn dp-btn-secondary">‚Üê Back to Drafts</a>
          </div>
        </header>
        
        <!-- Main Content Area -->
        <main class="dp-main">
          <div class="edit-form">
            <div id="flash" class="dp-flash" style="display: none;"></div>
            
            <!-- Basic Information -->
            <div class="dp-card">
              <div class="dp-card__header">
                <h2 class="dp-card__title">Basic Information</h2>
              </div>
              <div class="dp-card__content">
                <div class="form-row">
                  <div class="form-field" style="flex: 2;">
                    <label for="title">Title <small class="muted-hint">(max 80 characters)</small></label>
                    <input type="text" id="title" maxlength="80" />
                    <small class="muted-hint" id="titleCount">0 / 80</small>
                  </div>
                </div>
                
                <div class="form-row">
                  <div class="form-field" style="flex: 2;">
                    <label for="description">Description</label>
                    <textarea id="description"></textarea>
                  </div>
                </div>
                
                <div class="form-row">
                  <div class="form-field">
                    <label for="price">Price USD</label>
                    <input type="number" id="price" step="0.01" min="0" />
                  </div>
                  
                  <div class="form-field">
                    <label for="condition">Condition</label>
                    <select id="condition">
                      <option value="NEW">New</option>
                      <option value="LIKE_NEW">Like New</option>
                      <option value="USED_EXCELLENT">Used - Excellent</option>
                      <option value="USED_GOOD">Used - Good</option>
                      <option value="USED_ACCEPTABLE">Used - Acceptable</option>
                    </select>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Item Specifics -->
            <div class="dp-card">
              <div class="dp-card__header">
                <h2 class="dp-card__title">Item Specifics (Aspects)</h2>
              </div>
              <div class="dp-card__content">
                <div id="aspectsList"></div>
                <button class="dp-btn dp-btn-secondary" style="margin-top: 0.5rem;" onclick="addAspect()">+ Add Aspect</button>
              </div>
            </div>
            
            <!-- Images -->
            <div class="dp-card">
              <div class="dp-card__header">
                <h2 class="dp-card__title">Images</h2>
              </div>
              <div class="dp-card__content">
                <div class="images-preview" id="imagesPreview"></div>
              </div>
            </div>
            
            <!-- Actions -->
            <div class="dp-card">
              <div class="dp-card__content">
                <div class="action-bar">
                  <button class="dp-btn" id="btnSave" onclick="saveDraft()">üíæ Update Draft</button>
                  <a href="/drafts.html" class="dp-btn dp-btn-secondary">Cancel</a>
                </div>
              </div>
            </div>
          </div>
        </main>
      </div>
    </div>
  </div>
  
  <script>
    const $ = (id) => document.getElementById(id);
    
    let currentOfferId = null;
    let originalDraft = null;
    
    async function fetchJSON(url, opts = {}) {
      const exec = window.authClient?.authFetch || fetch;
      const r = await exec(url, opts);
      const data = await r.json();
      if (!r.ok) {
        const error = data.error || `HTTP ${r.status}`;
        const detail = data.detail ? ` - ${data.detail}` : '';
        throw new Error(error + detail);
      }
      return data;
    }
    
    function showFlash(message, type = 'success') {
      const flash = $('flash');
      flash.textContent = message;
      flash.className = type === 'error' ? 'dp-flash dp-flash--error' : 'dp-flash dp-flash--success';
      flash.style.display = 'block';
      setTimeout(() => { flash.style.display = 'none'; }, 5000);
    }
    
    function updateTitleCount() {
      const title = $('title');
      $('titleCount').textContent = `${title.value.length} / 80`;
    }
    
    function addAspect(key = '', value = '', isRequired = false, aspectMetadata = null) {
      const container = $('aspectsList');
      const div = document.createElement('div');
      div.className = 'aspect-item';
      const requiredMark = isRequired ? ' <span style="color: #ef4444;">*</span>' : '';
      const keyReadonly = isRequired || key ? 'readonly' : '';
      
      // Check if aspect has predefined values (dropdown)
      let valueInput = '';
      if (aspectMetadata?.aspectValues && aspectMetadata.aspectValues.length > 0) {
        // Create dropdown
        const options = aspectMetadata.aspectValues.map(av => {
          const selected = av.localizedValue === value ? 'selected' : '';
          return `<option value="${av.localizedValue}" ${selected}>${av.localizedValue}</option>`;
        }).join('');
        valueInput = `<select class="aspect-value" ${isRequired ? 'required' : ''}>
          <option value="">Select ${key}...</option>
          ${options}
        </select>`;
      } else {
        // Regular text input
        valueInput = `<input type="text" placeholder="Value${requiredMark}" value="${value}" class="aspect-value" ${isRequired ? 'required' : ''} />`;
      }
      
      div.innerHTML = `
        <input type="text" placeholder="Name (e.g. Brand)" value="${key}" class="aspect-key" ${keyReadonly} />
        ${valueInput}
        <button class="dp-btn dp-btn-secondary" onclick="this.parentElement.remove()" ${isRequired ? 'disabled title="Required field"' : ''}>√ó</button>
      `;
      container.appendChild(div);
    }
    
    async function loadDraft() {
      try {
        const params = new URLSearchParams(window.location.search);
        currentOfferId = params.get('offerId');
        
        if (!currentOfferId) {
          throw new Error('Missing offerId in URL');
        }
        
        console.log('Loading draft for offerId:', currentOfferId);
        showFlash('Loading draft...', 'success');
        
        // Fetch the draft data
        const res = await fetchJSON(`/.netlify/functions/smartdrafts-get-draft?offerId=${encodeURIComponent(currentOfferId)}`);
        
        console.log('Draft loaded:', res);
        
        if (!res.ok || !res.draft) {
          throw new Error('Draft not found');
        }
        
        originalDraft = res.draft;
        
        // Populate form
        $('title').value = originalDraft.title || '';
        $('description').value = originalDraft.description || '';
        $('price').value = originalDraft.price || '';
        $('condition').value = originalDraft.condition || 'NEW';
        
        updateTitleCount();
        
        // Build aspect metadata lookup
        const aspectsMetadata = {};
        if (originalDraft.categoryAspects && Array.isArray(originalDraft.categoryAspects)) {
          originalDraft.categoryAspects.forEach(aspect => {
            aspectsMetadata[aspect.localizedAspectName] = aspect;
          });
        }
        
        // Populate aspects - show existing ones first
        const existingAspects = new Set();
        if (originalDraft.aspects && typeof originalDraft.aspects === 'object') {
          Object.entries(originalDraft.aspects).forEach(([key, values]) => {
            const valueStr = Array.isArray(values) ? values.join(', ') : values;
            const metadata = aspectsMetadata[key];
            addAspect(key, valueStr, false, metadata);
            existingAspects.add(key);
          });
        }
        
        // Add empty fields for category-recommended aspects that aren't filled yet
        if (originalDraft.categoryAspects && Array.isArray(originalDraft.categoryAspects)) {
          originalDraft.categoryAspects.forEach(aspect => {
            const name = aspect.localizedAspectName;
            if (!existingAspects.has(name)) {
              const isRequired = aspect.aspectConstraint?.aspectRequired || false;
              addAspect(name, '', isRequired, aspect);
            }
          });
        }
        
        // Show images with drag-and-drop reordering
        if (originalDraft.images && Array.isArray(originalDraft.images)) {
          const preview = $('imagesPreview');
          originalDraft.images.forEach((url, index) => {
            const div = document.createElement('div');
            div.className = 'image-thumb';
            div.draggable = true;
            div.dataset.url = url;
            div.innerHTML = `
              <div class="image-order">${index + 1}</div>
              <img src="${url}" alt="Product image" />
            `;
            
            // Drag and drop event handlers
            div.addEventListener('dragstart', handleDragStart);
            div.addEventListener('dragend', handleDragEnd);
            div.addEventListener('dragover', handleDragOver);
            div.addEventListener('drop', handleDrop);
            div.addEventListener('dragleave', handleDragLeave);
            
            preview.appendChild(div);
          });
        }
        
        showFlash('Draft loaded successfully!', 'success');
        
      } catch (err) {
        console.error('Failed to load draft:', err);
        showFlash(`Error: ${err.message}`, 'error');
      }
    }
    
    // Drag and drop handlers for image reordering
    let draggedElement = null;
    
    function handleDragStart(e) {
      draggedElement = this;
      this.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
    }
    
    function handleDragEnd(e) {
      this.classList.remove('dragging');
      document.querySelectorAll('.image-thumb').forEach(el => {
        el.classList.remove('drag-over');
      });
      updateImageOrderLabels();
    }
    
    function handleDragOver(e) {
      if (e.preventDefault) e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
      return false;
    }
    
    function handleDrop(e) {
      if (e.stopPropagation) e.stopPropagation();
      
      if (draggedElement !== this) {
        const allImages = Array.from($('imagesPreview').children);
        const draggedIndex = allImages.indexOf(draggedElement);
        const targetIndex = allImages.indexOf(this);
        
        if (draggedIndex < targetIndex) {
          this.parentNode.insertBefore(draggedElement, this.nextSibling);
        } else {
          this.parentNode.insertBefore(draggedElement, this);
        }
      }
      
      this.classList.remove('drag-over');
      return false;
    }
    
    function handleDragLeave(e) {
      this.classList.remove('drag-over');
    }
    
    function updateImageOrderLabels() {
      document.querySelectorAll('.image-thumb').forEach((el, index) => {
        const orderLabel = el.querySelector('.image-order');
        if (orderLabel) orderLabel.textContent = index + 1;
      });
    }
    
    async function saveDraft() {
      try {
        const btn = $('btnSave');
        btn.disabled = true;
        btn.textContent = 'Saving...';
        
        // Collect aspects
        const aspects = {};
        document.querySelectorAll('.aspect-item').forEach(item => {
          const key = item.querySelector('.aspect-key').value.trim();
          const valueElement = item.querySelector('.aspect-value');
          const value = valueElement.value.trim();
          if (key && value) {
            // Split comma-separated values into array
            aspects[key] = value.includes(',') ? value.split(',').map(v => v.trim()) : [value];
          }
        });
        
        // Collect images in their current order
        const images = Array.from(document.querySelectorAll('.image-thumb')).map(el => el.dataset.url);
        
        const updatedDraft = {
          ...originalDraft,
          title: $('title').value.trim(),
          description: $('description').value.trim(),
          price: parseFloat($('price').value) || 0,
          condition: $('condition').value,
          aspects,
          images, // Include reordered images
        };
        
        // Save to backend
        const res = await fetchJSON('/.netlify/functions/smartdrafts-update-draft', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            offerId: currentOfferId,
            draft: updatedDraft,
          }),
        });
        
        if (res.ok) {
          showFlash('Draft saved successfully!', 'success');
          setTimeout(() => window.location.href = '/drafts.html', 1500);
        } else {
          throw new Error(res.error || 'Failed to save draft');
        }
        
      } catch (err) {
        console.error('Failed to save draft:', err);
        showFlash(`Error: ${err.message}`, 'error');
        $('btnSave').disabled = false;
        $('btnSave').textContent = 'Update Draft';
      }
    }
    
    $('title').addEventListener('input', updateTitleCount);
    
    async function bootstrap() {
      try {
        // Wait for authClient to be available
        if (!window.authClient) {
          console.log('Waiting for authClient...');
          await new Promise(resolve => {
            const check = setInterval(() => {
              if (window.authClient) {
                clearInterval(check);
                resolve();
              }
            }, 100);
          });
        }
        
        const ok = await window.authClient.requireAuth();
        if (!ok) {
          showFlash('Authentication required. Redirecting to login...', 'error');
          return;
        }
        
        // Populate sidebar user info
        const user = window.authClient.user;
        if (user) {
          const userName = document.getElementById('userName');
          const avatar = document.querySelector('.dp-user-card__avatar');
          if (userName) userName.textContent = user.name || user.email || 'User';
          if (avatar) avatar.textContent = (user.name || user.email || 'U')[0].toUpperCase();
        }
        
        await loadDraft();
      } catch (e) {
        console.error('Bootstrap failed', e);
        showFlash(`Failed to load: ${e.message}`, 'error');
      }
    }
    
    bootstrap();
  </script>
</body>
</html>
