<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Edit Draft</title>
  <style>
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      margin: 0;
      padding: 2rem;
      background: #0b1020;
      color: #f4f6fb;
    }
    .card {
      max-width: 920px;
      margin: 0 auto 1rem;
      background: #141a33;
      border: 1px solid #2a335c;
      border-radius: 12px;
      padding: 1.25rem 1.5rem;
    }
    .section-title {
      font-size: 1.1rem;
      font-weight: 700;
      margin-bottom: 1rem;
      color: #4f7cff;
    }
    h2 {
      margin: 0 0 1rem 0;
      font-size: 1.4rem;
    }
    .form-row {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      margin-bottom: 0.85rem;
    }
    .form-field {
      flex: 1 1 250px;
      min-width: 220px;
    }
    label {
      display: block;
      font-weight: 600;
      margin-bottom: 0.5rem;
      font-size: 0.9rem;
    }
    input, textarea, select {
      width: 100%;
      background: #0f1530;
      border: 1px solid #2a335c;
      border-radius: 6px;
      padding: 0.65rem 0.85rem;
      color: #f4f6fb;
      font-family: inherit;
      font-size: 0.95rem;
    }
    input:focus, textarea:focus, select:focus {
      outline: none;
      border-color: #4f7cff;
    }
    textarea {
      resize: vertical;
      min-height: 120px;
    }
    button {
      background: #4f7cff;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 0.7rem 1.5rem;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
    }
    button:hover:not(:disabled) {
      background: #3e66d6;
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    button.secondary {
      background: #2a335c;
      color: #f4f6fb;
    }
    button.secondary:hover:not(:disabled) {
      background: #3d4770;
    }
    .aspect-item {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
      align-items: center;
    }
    .aspect-item input {
      flex: 1;
    }
    .flash {
      padding: 0.75rem 1rem;
      border-radius: 8px;
      margin-bottom: 1rem;
      display: none;
    }
    .flash.show {
      display: block;
    }
    .flash.success {
      background: rgba(34, 197, 94, 0.1);
      border: 1px solid #22c55e;
      color: #22c55e;
    }
    .flash.error {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid #ef4444;
      color: #ef4444;
    }
    .muted {
      font-size: 0.85rem;
      color: #94a3b8;
      margin-top: 0.25rem;
    }
    .images-preview {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      gap: 0.75rem;
    }
    .image-thumb {
      position: relative;
      aspect-ratio: 1;
      border-radius: 8px;
      overflow: hidden;
      border: 1px solid #2a335c;
    }
    .image-thumb img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
  </style>
</head>
<body>
  <script src="/auth-client.js"></script>
  
  <div class="card">
    <h2>Edit Draft</h2>
    <div class="flash" id="flash"></div>
  </div>
    
  <div class="card">
    <div class="section-title">Basic Information</div>
    
    <div class="form-row">
      <div class="form-field" style="flex: 2;">
        <label for="title">Title <small class="muted">(max 80 characters)</small></label>
        <input type="text" id="title" maxlength="80" />
        <small class="muted" id="titleCount">0 / 80</small>
      </div>
    </div>
    
    <div class="form-row">
      <div class="form-field" style="flex: 2;">
        <label for="description">Description</label>
        <textarea id="description"></textarea>
      </div>
    </div>
    
    <div class="form-row">
      <div class="form-field">
        <label for="price">Price USD</label>
        <input type="number" id="price" step="0.01" min="0" />
      </div>
      
      <div class="form-field">
        <label for="condition">Condition</label>
        <select id="condition">
          <option value="NEW">New</option>
          <option value="LIKE_NEW">Like New</option>
          <option value="USED_EXCELLENT">Used - Excellent</option>
          <option value="USED_GOOD">Used - Good</option>
          <option value="USED_ACCEPTABLE">Used - Acceptable</option>
        </select>
      </div>
    </div>
  </div>
    
  <div class="card">
    <div class="section-title">Item Specifics (Aspects)</div>
    <div id="aspectsList"></div>
    <button class="secondary" style="margin-top: 0.5rem;" onclick="addAspect()">+ Add Aspect</button>
  </div>
    
  <div class="card">
    <div class="section-title">Images</div>
    <div class="images-preview" id="imagesPreview"></div>
  </div>
    
  <div class="card">
    <button id="btnSave" onclick="saveDraft()">Update Draft</button>
    <button class="secondary" onclick="window.location.href='/drafts.html'" style="margin-left: 0.5rem;">Cancel</button>
  </div>
  
  <script>
    const $ = (id) => document.getElementById(id);
    
    let currentOfferId = null;
    let originalDraft = null;
    
    async function fetchJSON(url, opts = {}) {
      const exec = window.authClient?.authFetch || fetch;
      const r = await exec(url, opts);
      const data = await r.json();
      if (!r.ok) {
        const error = data.error || `HTTP ${r.status}`;
        const detail = data.detail ? ` - ${data.detail}` : '';
        throw new Error(error + detail);
      }
      return data;
    }
    
    function showFlash(message, type = 'success') {
      const flash = $('flash');
      flash.textContent = message;
      flash.className = `flash show ${type}`;
      setTimeout(() => flash.classList.remove('show'), 5000);
    }
    
    function updateTitleCount() {
      const title = $('title');
      $('titleCount').textContent = `${title.value.length} / 80`;
    }
    
    function addAspect(key = '', value = '', isRequired = false) {
      const container = $('aspectsList');
      const div = document.createElement('div');
      div.className = 'aspect-item';
      const requiredMark = isRequired ? ' <span style="color: #ef4444;">*</span>' : '';
      const keyReadonly = isRequired || key ? 'readonly' : '';
      div.innerHTML = `
        <input type="text" placeholder="Name (e.g. Brand)" value="${key}" class="aspect-key" ${keyReadonly} />
        <input type="text" placeholder="Value${requiredMark}" value="${value}" class="aspect-value" ${isRequired ? 'required' : ''} />
        <button class="secondary" onclick="this.parentElement.remove()" ${isRequired ? 'disabled title="Required field"' : ''} style="padding: 0.25rem 0.5rem; margin-left: 0.5rem;">âœ•</button>
      `;
      container.appendChild(div);
    }
    
    async function loadDraft() {
      try {
        const params = new URLSearchParams(window.location.search);
        currentOfferId = params.get('offerId');
        
        if (!currentOfferId) {
          throw new Error('Missing offerId in URL');
        }
        
        console.log('Loading draft for offerId:', currentOfferId);
        showFlash('Loading draft...', 'success');
        
        // Fetch the draft data
        const res = await fetchJSON(`/.netlify/functions/smartdrafts-get-draft?offerId=${encodeURIComponent(currentOfferId)}`);
        
        console.log('Draft loaded:', res);
        
        if (!res.ok || !res.draft) {
          throw new Error('Draft not found');
        }
        
        originalDraft = res.draft;
        
        // Populate form
        $('title').value = originalDraft.title || '';
        $('description').value = originalDraft.description || '';
        $('price').value = originalDraft.price || '';
        $('condition').value = originalDraft.condition || 'NEW';
        
        updateTitleCount();
        
        // Populate aspects - show existing ones first
        const existingAspects = new Set();
        if (originalDraft.aspects && typeof originalDraft.aspects === 'object') {
          Object.entries(originalDraft.aspects).forEach(([key, values]) => {
            const valueStr = Array.isArray(values) ? values.join(', ') : values;
            addAspect(key, valueStr, false);
            existingAspects.add(key);
          });
        }
        
        // Add empty fields for category-recommended aspects that aren't filled yet
        if (originalDraft.categoryAspects && Array.isArray(originalDraft.categoryAspects)) {
          originalDraft.categoryAspects.forEach(aspect => {
            const name = aspect.localizedAspectName;
            if (!existingAspects.has(name)) {
              const isRequired = aspect.aspectConstraint?.aspectRequired || false;
              addAspect(name, '', isRequired);
            }
          });
        }
        
        // Show images
        if (originalDraft.images && Array.isArray(originalDraft.images)) {
          const preview = $('imagesPreview');
          originalDraft.images.forEach(url => {
            const div = document.createElement('div');
            div.className = 'image-thumb';
            div.innerHTML = `<img src="${url}" alt="Product image" />`;
            preview.appendChild(div);
          });
        }
        
        showFlash('Draft loaded successfully!', 'success');
        
      } catch (err) {
        console.error('Failed to load draft:', err);
        showFlash(`Error: ${err.message}`, 'error');
      }
    }
    
    async function saveDraft() {
      try {
        const btn = $('btnSave');
        btn.disabled = true;
        btn.textContent = 'Saving...';
        
        // Collect aspects
        const aspects = {};
        document.querySelectorAll('.aspect-item').forEach(item => {
          const key = item.querySelector('.aspect-key').value.trim();
          const value = item.querySelector('.aspect-value').value.trim();
          if (key && value) {
            // Split comma-separated values into array
            aspects[key] = value.includes(',') ? value.split(',').map(v => v.trim()) : [value];
          }
        });
        
        const updatedDraft = {
          ...originalDraft,
          title: $('title').value.trim(),
          description: $('description').value.trim(),
          price: parseFloat($('price').value) || 0,
          condition: $('condition').value,
          aspects,
        };
        
        // Save to backend
        const res = await fetchJSON('/.netlify/functions/smartdrafts-update-draft', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            offerId: currentOfferId,
            draft: updatedDraft,
          }),
        });
        
        if (res.ok) {
          showFlash('Draft saved successfully!', 'success');
          setTimeout(() => window.location.href = '/drafts.html', 1500);
        } else {
          throw new Error(res.error || 'Failed to save draft');
        }
        
      } catch (err) {
        console.error('Failed to save draft:', err);
        showFlash(`Error: ${err.message}`, 'error');
        $('btnSave').disabled = false;
        $('btnSave').textContent = 'Update Draft';
      }
    }
    
    $('title').addEventListener('input', updateTitleCount);
    
    async function bootstrap() {
      try {
        // Wait for authClient to be available
        if (!window.authClient) {
          console.log('Waiting for authClient...');
          await new Promise(resolve => {
            const check = setInterval(() => {
              if (window.authClient) {
                clearInterval(check);
                resolve();
              }
            }, 100);
          });
        }
        
        const ok = await window.authClient.requireAuth();
        if (!ok) {
          showFlash('Authentication required. Redirecting to login...', 'error');
          return;
        }
        
        await loadDraft();
      } catch (e) {
        console.error('Bootstrap failed', e);
        showFlash(`Failed to load: ${e.message}`, 'error');
      }
    }
    
    bootstrap();
  </script>
</body>
</html>
