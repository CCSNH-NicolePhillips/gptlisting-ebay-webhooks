<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Edit Draft ‚Äì DraftPilot</title>
  <link rel="stylesheet" href="/draftpilot.css?v=2">
  <style>
    /* Edit draft specific styles */
    .form-row {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      margin-bottom: 1.25rem;
      align-items: flex-start;
    }
    .form-field {
      flex: 1 1 250px;
      min-width: 220px;
    }
    .form-field label {
      display: block;
      font-weight: 500;
      margin-bottom: 0.5rem;
      font-size: 0.875rem;
      color: #cbd5ff;
    }
    .form-field input, 
    .form-field textarea, 
    .form-field select {
      width: 100%;
      background: #0f1529;
      border: 1px solid #2a335c;
      border-radius: 6px;
      padding: 0.75rem;
      color: #f4f6fb;
      font-family: inherit;
      font-size: 0.9375rem;
      box-sizing: border-box;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    .form-field input[type="number"] {
      max-width: 150px;
    }
    .form-field input:focus, 
    .form-field textarea:focus, 
    .form-field select:focus {
      outline: none;
      border-color: #5b7cff;
      box-shadow: 0 0 0 3px rgba(91, 124, 255, 0.1);
    }
    #price {
      max-width: 200px;
    }
    #condition {
      max-width: 300px;
    }
    .form-field textarea {
      resize: vertical;
      min-height: 140px;
      line-height: 1.6;
    }
    .muted-hint {
      font-size: 0.85rem;
      color: var(--text-muted);
      margin-top: 0.3rem;
    }
    .aspect-item {
      display: grid;
      grid-template-columns: minmax(160px, 0.4fr) minmax(220px, 1fr) auto;
      gap: 0.75rem;
      margin-bottom: 0.65rem;
      align-items: center;
    }
    #aspectsList {
      padding: 0;
      margin-top: 0.5rem;
    }
    .aspect-item input,
    .aspect-item select {
      width: 100%;
      background: #0f1529;
      border: 1px solid #2a335c;
      border-radius: 6px;
      padding: 0.75rem;
      color: #f4f6fb;
      font-size: 0.9375rem;
      box-sizing: border-box;
    }
    @media (max-width: 768px) {
      .aspect-item {
        grid-template-columns: 1fr;
      }
    }
    .aspect-item input:focus,
    .aspect-item select:focus {
      outline: none;
      border-color: #5b7cff;
      box-shadow: 0 0 0 3px rgba(91, 124, 255, 0.1);
    }
    .aspect-multiselect {
      position: relative;
      width: 100%;
    }
    .aspect-multiselect-display {
      width: 100%;
      background: #0f1529;
      border: 1px solid #2a335c;
      border-radius: 6px;
      padding: 0.75rem;
      color: #f4f6fb;
      font-size: 0.9375rem;
      cursor: pointer;
      user-select: none;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .aspect-multiselect-display:hover {
      border-color: #5b7cff;
    }
    .aspect-multiselect-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: #0f1529;
      border: 1px solid #2a335c;
      border-radius: 6px;
      margin-top: 4px;
      max-height: 300px;
      overflow-y: auto;
      z-index: 1000;
      display: none;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }
    .aspect-multiselect-dropdown.open {
      display: block;
    }
    .aspect-multiselect-option {
      padding: 0.75rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      transition: background-color 0.2s;
    }
    .aspect-multiselect-option:hover {
      background: #1a2038;
    }
    .aspect-multiselect-option input[type="checkbox"] {
      width: auto;
      margin: 0;
      cursor: pointer;
    }
    .aspect-multiselect-arrow {
      font-size: 0.75rem;
      transition: transform 0.2s;
    }
    .aspect-multiselect-arrow.open {
      transform: rotate(180deg);
    }
    .aspect-item button {
      padding: 0.4rem 0.8rem;
      font-size: 0.85rem;
    }
    .images-preview {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 1rem;
      margin-top: 1rem;
    }
    .image-thumb {
      position: relative;
      aspect-ratio: 1;
      border-radius: var(--radius-md);
      overflow: hidden;
      border: 1px solid var(--border-subtle);
      background: rgba(15, 23, 42, 0.5);
      transition: border-color 0.2s, transform 0.2s;
      cursor: move;
    }
    .image-upload-box {
      position: relative;
      aspect-ratio: 1;
      border-radius: var(--radius-md);
      border: 2px dashed var(--border-subtle);
      background: rgba(15, 23, 42, 0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s;
    }
    .image-upload-box:hover {
      border-color: var(--accent);
      background: rgba(56, 189, 248, 0.1);
    }
    .image-upload-box svg {
      width: 48px;
      height: 48px;
      color: var(--text-muted);
      transition: color 0.2s;
    }
    .image-upload-box:hover svg {
      color: var(--accent);
    }
    .image-thumb:hover {
      border-color: var(--accent-hover);
      transform: scale(1.02);
    }
    .image-thumb.dragging {
      opacity: 0.5;
    }
    .image-thumb.drag-over {
      border-color: var(--accent);
      border-width: 2px;
    }
    .image-thumb img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      pointer-events: none;
    }
    .image-thumb .image-order {
      position: absolute;
      top: 4px;
      left: 4px;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 600;
    }
    .dp-content {
      max-width: 1100px;
      margin: 0 auto;
    }
    /* Two-column row for Quantity + Condition */
    .dp-form-row.two-col {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1.25rem;
      margin-bottom: 1.5rem;
    }
    @media (max-width: 700px) {
      .dp-form-row.two-col {
        grid-template-columns: 1fr;
      }
    }
    .dp-form-col label {
      display: block;
      font-weight: 500;
      margin-bottom: 0.5rem;
      font-size: 0.875rem;
      color: #cbd5ff;
    }
    .dp-form-col input,
    .dp-form-col select {
      width: 100%;
      background: #0f1529;
      border: 1px solid #2a335c;
      border-radius: 6px;
      padding: 0.75rem;
      color: #f4f6fb;
      font-family: inherit;
      font-size: 0.9375rem;
      box-sizing: border-box;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    .dp-form-col input:focus,
    .dp-form-col select:focus {
      outline: none;
      border-color: #5b7cff;
      box-shadow: 0 0 0 3px rgba(91, 124, 255, 0.1);
    }
  </style>
</head>
<body>
  <script src="/auth-client.js"></script>
  
  <div class="dp-shell">
    <!-- Sidebar -->
    <aside class="dp-sidebar">
      <!-- Brand Area -->
      <div class="dp-sidebar__brand">
        <img src="logo/LogoWhiteText_NoBg.png" alt="DraftPilot - AI Listing Studio" class="dp-brand-logo" />
      </div>
      
      <!-- Navigation -->
      <nav class="dp-sidebar__nav">
        <!-- Primary Navigation Group -->
        <div class="dp-nav-group">
          <div class="dp-nav-group__label">APP</div>
          <div class="dp-nav-group__items">
            <a href="/index.html" class="dp-nav-item">
              <svg class="dp-nav-item__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                <polyline points="9 22 9 12 15 12 15 22"></polyline>
              </svg>
              <span class="dp-nav-item__label">Overview</span>
            </a>
            <a href="/quick-list.html" class="dp-nav-item">
              <svg class="dp-nav-item__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon>
              </svg>
              <span class="dp-nav-item__label">Create Listings</span>
            </a>
            <a href="/drafts.html" class="dp-nav-item dp-nav-item--active">
              <svg class="dp-nav-item__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                <polyline points="14 2 14 8 20 8"></polyline>
              </svg>
              <span class="dp-nav-item__label">Drafts</span>
            </a>
          </div>
        </div>
        
        <!-- Account Navigation Group -->
        <div class="dp-nav-group">
          <div class="dp-nav-group__label">ACCOUNT</div>
          <div class="dp-nav-group__items">
            <a href="/policies-manage.html" class="dp-nav-item">
              <svg class="dp-nav-item__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                <polyline points="14 2 14 8 20 8"></polyline>
                <line x1="16" y1="13" x2="8" y2="13"></line>
                <line x1="16" y1="17" x2="8" y2="17"></line>
                <polyline points="10 9 9 9 8 9"></polyline>
              </svg>
              <span class="dp-nav-item__label">eBay Policies</span>
            </a>
            <a href="/location.html" class="dp-nav-item">
              <svg class="dp-nav-item__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                <circle cx="12" cy="10" r="3"></circle>
              </svg>
              <span class="dp-nav-item__label">Inventory Locations</span>
            </a>
            <a href="/settings.html" class="dp-nav-item">
              <svg class="dp-nav-item__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="3"></circle>
                <path d="M12 1v6m0 6v6m5.196-15.196l-4.243 4.243m0 5.656l-4.242 4.243m15.195-5.196l-4.242-4.243m-5.657 0l-4.243-4.243"></path>
              </svg>
              <span class="dp-nav-item__label">Settings</span>
            </a>
            <a href="/faq.html" class="dp-nav-item">
              <svg class="dp-nav-item__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"></circle>
                <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                <line x1="12" y1="17" x2="12.01" y2="17"></line>
              </svg>
              <span class="dp-nav-item__label">FAQ</span>
            </a>
            <a href="/support.html" class="dp-nav-item">
              <svg class="dp-nav-item__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"></circle>
                <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                <line x1="12" y1="17" x2="12.01" y2="17"></line>
              </svg>
              <span class="dp-nav-item__label">Support</span>
            </a>
          </div>
        </div>
      </nav>
      
      <!-- Spacer -->
      <div class="dp-sidebar__spacer"></div>
      
      <!-- User Footer -->
      <div class="dp-sidebar__footer">
        <div class="dp-user-card" id="userCard">
          <div class="dp-user-card__avatar" id="userAvatar">U</div>
          <div class="dp-user-card__info">
            <div class="dp-user-card__name" id="userName">Loading...</div>
            <div class="dp-user-card__status" id="userEmail">Signed in</div>
          </div>
        </div>
        <div class="dp-user-menu" id="userMenu" style="display: none;">
          <a href="/logout.html" class="dp-user-menu__item">
            <svg class="dp-user-menu__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
              <polyline points="16 17 21 12 16 7"></polyline>
              <line x1="21" y1="12" x2="9" y2="12"></line>
            </svg>
            <span>Sign out</span>
          </a>
        </div>
      </div>
    </aside>
    
    <div class="dp-mobile-backdrop" id="mobileBackdrop"></div>
    
    <!-- Main Content Wrapper -->
    <div class="dp-main-wrapper">
      <!-- Top Bar -->
      <header class="dp-topbar">
        <!-- Left: Mobile menu + Page Title & Subtitle -->
        <div class="dp-topbar-left">
          <!-- Mobile-only hamburger -->
          <button
            class="dp-topbar-icon dp-topbar-icon--menu"
            id="mobileMenuButton"
            aria-label="Open navigation"
            aria-expanded="false"
            type="button"
          >
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="4" y1="6" x2="20" y2="6"></line>
              <line x1="4" y1="12" x2="20" y2="12"></line>
              <line x1="4" y1="18" x2="20" y2="18"></line>
            </svg>
          </button>

          <div class="dp-topbar-heading">
            <h1 class="dp-topbar__title">‚úèÔ∏è Edit Draft</h1>
            <p class="dp-topbar__subtitle">
              Update listing details and item specifics
            </p>
          </div>
        </div>
        
        <!-- Right: Actions -->
        <div class="dp-topbar-right" style="display: flex !important; gap: 0.75rem;">
          <a href="/drafts.html" class="dp-btn dp-btn-secondary" style="padding: 0.5rem 1rem; font-size: 0.875rem;">‚Üê Back to Drafts</a>
        </div>
      </header>
      
      <!-- Main Content Area -->
      <main class="dp-main">
        <div id="flash" style="margin-bottom: 1rem;"></div>
        
        <!-- Basic Information -->
        <div class="dp-card dp-card--full">
          <h3 style="margin-top: 0; margin-bottom: 1rem; color: var(--text-primary);">Basic Information</h3>
          <h3 style="margin-top: 0; margin-bottom: 1rem; color: var(--text-primary);">Basic Information</h3>
          
          <div class="form-row">
            <div class="form-field" style="flex: 2;">
              <label for="title">Title <small class="muted-hint">(max 80 characters)</small></label>
              <input type="text" id="title" maxlength="80" />
              <small class="muted-hint" id="titleCount">0 / 80</small>
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-field" style="flex: 2;">
              <label for="description">Description</label>
              <textarea id="description"></textarea>
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-field">
              <label for="price">Price USD</label>
              <input type="number" id="price" step="0.01" min="0" />
            </div>
            
            <div class="form-field">
              <label for="condition">Condition</label>
              <select id="condition">
                <option value="NEW">New</option>
                <option value="LIKE_NEW">Like New</option>
                <option value="USED_EXCELLENT">Used - Excellent</option>
                <option value="USED_GOOD">Used - Good</option>
                <option value="USED_ACCEPTABLE">Used - Acceptable</option>
              </select>
            </div>
          </div>
        </div>
        
        <!-- Item Specifics -->
        <div class="dp-card dp-card--full">
          <h3 style="margin-top: 0; margin-bottom: 1rem; color: var(--text-primary);">Item Specifics (Aspects)</h3>
          <div id="aspectsList"></div>
          <button class="dp-btn dp-btn-secondary" style="margin-top: 0.5rem;" onclick="addAspect()">+ Add Aspect</button>
        </div>
        
        <!-- Images -->
        <div class="dp-card dp-card--full">
          <h3 style="margin-top: 0; margin-bottom: 1rem; color: var(--text-primary);">üì∏ Images</h3>
          <input type="file" id="imageUploadInput" accept="image/*" multiple style="display: none;" />
          <div class="images-preview" id="imagesPreview"></div>
        </div>
        
        <!-- Actions -->
        <div class="dp-card dp-card--full">
          <div style="display: flex; gap: 0.75rem;">
            <button class="dp-btn dp-btn-primary" id="btnSave" onclick="saveDraft()">üíæ Update Draft</button>
            <a href="/drafts.html" class="dp-btn dp-btn-secondary">Cancel</a>
          </div>
        </div>
      </main>
    </div>
  </div>
  
  <script>
    const $ = (id) => document.getElementById(id);
    
    let currentOfferId = null;
    let originalDraft = null;
    
    async function fetchJSON(url, opts = {}) {
      const exec = window.authClient?.authFetch || fetch;
      const r = await exec(url, opts);
      const data = await r.json();
      if (!r.ok) {
        const error = data.error || `HTTP ${r.status}`;
        const detail = data.detail ? ` - ${data.detail}` : '';
        throw new Error(error + detail);
      }
      return data;
    }
    
    function showFlash(message, type = 'success') {
      const flash = $('flash');
      flash.textContent = message;
      flash.className = type === 'error' ? 'dp-flash dp-flash--error' : 'dp-flash dp-flash--success';
      flash.style.display = 'block';
      setTimeout(() => { flash.style.display = 'none'; }, 5000);
    }
    
    function updateTitleCount() {
      const title = $('title');
      $('titleCount').textContent = `${title.value.length} / 80`;
    }
    
    function escapeHtml(str) {
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }
    
    function addAspect(key = '', value = '', isRequired = false, aspectMetadata = null) {
      const container = $('aspectsList');
      const div = document.createElement('div');
      div.className = 'aspect-item';
      const requiredMark = isRequired ? ' <span style="color: #ef4444;">*</span>' : '';
      const keyReadonly = isRequired || key ? 'readonly' : '';
      
      // Parse existing values (could be comma-separated string or array)
      let existingValues = [];
      if (value) {
        if (Array.isArray(value)) {
          existingValues = value;
        } else if (typeof value === 'string') {
          existingValues = value.split(',').map(v => v.trim()).filter(v => v);
        }
      }
      
      // Check if aspect has predefined values (dropdown)
      let valueInput = '';
      if (aspectMetadata?.aspectValues && aspectMetadata.aspectValues.length > 0) {
        const mode = aspectMetadata.aspectConstraint?.aspectMode || 'SELECTION_ONLY';
        const cardinality = aspectMetadata.cardinality || 'SINGLE';
        
        // If multiple selections allowed, create multi-select dropdown
        if (cardinality === 'MULTI') {
          const multiselectId = `multiselect-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
          const displayText = existingValues.length > 0 ? escapeHtml(existingValues.join(', ')) : `Select ${escapeHtml(key)}...`;
          
          const options = aspectMetadata.aspectValues.map(av => {
            const checked = existingValues.includes(av.localizedValue) ? 'checked' : '';
            const escapedValue = escapeHtml(av.localizedValue);
            return `<div class="aspect-multiselect-option" data-value="${escapedValue}">
              <input type="checkbox" value="${escapedValue}" ${checked} />
              <label>${escapedValue}</label>
            </div>`;
          }).join('');
          
          const escapedJoinedValues = escapeHtml(existingValues.join(', '));
          valueInput = `<div class="aspect-multiselect" data-multiselect-id="${multiselectId}">
            <div class="aspect-multiselect-display">
              <span class="multiselect-text">${displayText}</span>
              <span class="aspect-multiselect-arrow">‚ñº</span>
            </div>
            <div class="aspect-multiselect-dropdown">
              ${options}
            </div>
            <input type="hidden" class="aspect-value" value="${escapedJoinedValues}" />
          </div>`;
        } else {
          // Single selection - use regular dropdown
          const selectedValue = existingValues[0] || '';
          const options = aspectMetadata.aspectValues.map(av => {
            const selected = av.localizedValue === selectedValue ? 'selected' : '';
            return `<option value="${av.localizedValue}" ${selected}>${av.localizedValue}</option>`;
          }).join('');
          valueInput = `<select class="aspect-value" ${isRequired ? 'required' : ''}>
            <option value="">Select ${key}...</option>
            ${options}
          </select>`;
        }
      } else {
        // Regular text input
        const displayValue = existingValues.join(', ');
        valueInput = `<input type="text" placeholder="Value${requiredMark}" value="${displayValue}" class="aspect-value" ${isRequired ? 'required' : ''} />`;
      }
      
      div.innerHTML = `
        <input type="text" placeholder="Name (e.g. Brand)" value="${key}" class="aspect-key" ${keyReadonly} />
        ${valueInput}
        <button class="dp-btn dp-btn-secondary" onclick="this.parentElement.remove()" ${isRequired ? 'disabled title="Required field"' : ''}>√ó</button>
      `;
      container.appendChild(div);
      
      // Add event listeners for multi-select
      if (aspectMetadata?.aspectValues && (aspectMetadata.cardinality || 'SINGLE') === 'MULTI') {
        const multiselect = div.querySelector('.aspect-multiselect');
        const display = multiselect.querySelector('.aspect-multiselect-display');
        const dropdown = multiselect.querySelector('.aspect-multiselect-dropdown');
        const arrow = multiselect.querySelector('.aspect-multiselect-arrow');
        const hiddenInput = multiselect.querySelector('input[type="hidden"]');
        const textDisplay = multiselect.querySelector('.multiselect-text');
        
        display.addEventListener('click', (e) => {
          e.stopPropagation();
          dropdown.classList.toggle('open');
          arrow.classList.toggle('open');
        });
        
        // Prevent dropdown from closing when clicking inside
        dropdown.addEventListener('click', (e) => {
          e.stopPropagation();
        });
        
        // Close dropdown when clicking outside
        document.addEventListener('click', () => {
          dropdown.classList.remove('open');
          arrow.classList.remove('open');
        });
        
        // Handle checkbox and label clicks
        dropdown.querySelectorAll('.aspect-multiselect-option').forEach(option => {
          const checkbox = option.querySelector('input[type="checkbox"]');
          const label = option.querySelector('label');
          
          // Make label clickable
          label.addEventListener('click', (e) => {
            e.preventDefault();
            checkbox.checked = !checkbox.checked;
            updateMultiselectValues();
          });
          
          checkbox.addEventListener('change', updateMultiselectValues);
        });
        
        function updateMultiselectValues() {
          const selectedValues = Array.from(dropdown.querySelectorAll('input[type="checkbox"]:checked'))
            .map(cb => cb.value);
          hiddenInput.value = selectedValues.join(', ');
          textDisplay.textContent = selectedValues.length > 0 ? selectedValues.join(', ') : `Select ${key}...`;
        }
      }
    }
    
    async function loadDraft() {
      try {
        const params = new URLSearchParams(window.location.search);
        currentOfferId = params.get('offerId');
        
        if (!currentOfferId) {
          throw new Error('Missing offerId in URL');
        }
        
        console.log('Loading draft for offerId:', currentOfferId);
        showFlash('Loading draft...', 'success');
        
        // Fetch the draft data
        const res = await fetchJSON(`/.netlify/functions/smartdrafts-get-draft?offerId=${encodeURIComponent(currentOfferId)}`);
        
        console.log('Draft loaded:', res);
        
        if (!res.ok || !res.draft) {
          throw new Error('Draft not found');
        }
        
        originalDraft = res.draft;
        
        // Populate form
        $('title').value = originalDraft.title || '';
        $('description').value = originalDraft.description || '';
        $('price').value = originalDraft.price || '';
        $('condition').value = originalDraft.condition || 'NEW';
        
        updateTitleCount();
        
        // Build aspect metadata lookup
        const aspectsMetadata = {};
        if (originalDraft.categoryAspects && Array.isArray(originalDraft.categoryAspects)) {
          originalDraft.categoryAspects.forEach(aspect => {
            aspectsMetadata[aspect.localizedAspectName] = aspect;
          });
        }
        
        // Populate aspects - show existing ones first
        const existingAspects = new Set();
        if (originalDraft.aspects && typeof originalDraft.aspects === 'object') {
          Object.entries(originalDraft.aspects).forEach(([key, values]) => {
            const valueStr = Array.isArray(values) ? values.join(', ') : values;
            const metadata = aspectsMetadata[key];
            addAspect(key, valueStr, false, metadata);
            existingAspects.add(key);
          });
        }
        
        // Add empty fields for category-recommended aspects that aren't filled yet
        if (originalDraft.categoryAspects && Array.isArray(originalDraft.categoryAspects)) {
          originalDraft.categoryAspects.forEach(aspect => {
            const name = aspect.localizedAspectName;
            if (!existingAspects.has(name)) {
              const isRequired = aspect.aspectConstraint?.aspectRequired || false;
              addAspect(name, '', isRequired, aspect);
            }
          });
        }
        
        // Show images with drag-and-drop reordering
        if (originalDraft.images && Array.isArray(originalDraft.images)) {
          const preview = $('imagesPreview');
          originalDraft.images.forEach((url, index) => {
            const div = document.createElement('div');
            div.className = 'image-thumb';
            div.draggable = true;
            div.dataset.url = url;
            div.innerHTML = `
              <div class="image-order">${index + 1}</div>
              <img src="${url}" alt="Product image" />
            `;
            
            // Drag and drop event handlers
            div.addEventListener('dragstart', handleDragStart);
            div.addEventListener('dragend', handleDragEnd);
            div.addEventListener('dragover', handleDragOver);
            div.addEventListener('drop', handleDrop);
            div.addEventListener('dragleave', handleDragLeave);
            
            preview.appendChild(div);
          });
          
          // Add upload box at the end
          addUploadBox();
        }
        
        showFlash('Draft loaded successfully!', 'success');
        
      } catch (err) {
        console.error('Failed to load draft:', err);
        showFlash(`Error: ${err.message}`, 'error');
      }
    }
    
    // Drag and drop handlers for image reordering
    let draggedElement = null;
    
    function handleDragStart(e) {
      draggedElement = this;
      this.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
    }
    
    function handleDragEnd(e) {
      this.classList.remove('dragging');
      document.querySelectorAll('.image-thumb').forEach(el => {
        el.classList.remove('drag-over');
      });
      updateImageOrderLabels();
    }
    
    function handleDragOver(e) {
      if (e.preventDefault) e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
      return false;
    }
    
    function handleDrop(e) {
      if (e.stopPropagation) e.stopPropagation();
      
      if (draggedElement !== this) {
        const allImages = Array.from($('imagesPreview').children);
        const draggedIndex = allImages.indexOf(draggedElement);
        const targetIndex = allImages.indexOf(this);
        
        if (draggedIndex < targetIndex) {
          this.parentNode.insertBefore(draggedElement, this.nextSibling);
        } else {
          this.parentNode.insertBefore(draggedElement, this);
        }
      }
      
      this.classList.remove('drag-over');
      return false;
    }
    
    function handleDragLeave(e) {
      this.classList.remove('drag-over');
    }
    
    function updateImageOrderLabels() {
      document.querySelectorAll('.image-thumb').forEach((el, index) => {
        const orderLabel = el.querySelector('.image-order');
        if (orderLabel) orderLabel.textContent = index + 1;
      });
    }
    
    function addUploadBox() {
      const preview = $('imagesPreview');
      const uploadBox = document.createElement('div');
      uploadBox.className = 'image-upload-box';
      uploadBox.innerHTML = `
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="12" y1="5" x2="12" y2="19"></line>
          <line x1="5" y1="12" x2="19" y2="12"></line>
        </svg>
      `;
      uploadBox.onclick = () => $('imageUploadInput').click();
      preview.appendChild(uploadBox);
    }
    
    async function handleImageUpload(event) {
      const files = event.target.files;
      if (!files || files.length === 0) return;
      
      try {
        showFlash('Uploading images...', 'success');
        
        // Convert files to base64 data URLs
        const newImages = [];
        for (const file of files) {
          const reader = new FileReader();
          const dataUrl = await new Promise((resolve, reject) => {
            reader.onload = (e) => resolve(e.target.result);
            reader.onerror = reject;
            reader.readAsDataURL(file);
          });
          newImages.push(dataUrl);
        }
        
        // Add new images to the preview (before the upload box)
        const preview = $('imagesPreview');
        const uploadBox = preview.querySelector('.image-upload-box');
        
        newImages.forEach((dataUrl, index) => {
          const currentImageCount = document.querySelectorAll('.image-thumb').length;
          const div = document.createElement('div');
          div.className = 'image-thumb';
          div.draggable = true;
          div.dataset.url = dataUrl;
          div.innerHTML = `
            <div class="image-order">${currentImageCount + index + 1}</div>
            <img src="${dataUrl}" alt="Product image" />
          `;
          
          // Drag and drop event handlers
          div.addEventListener('dragstart', handleDragStart);
          div.addEventListener('dragend', handleDragEnd);
          div.addEventListener('dragover', handleDragOver);
          div.addEventListener('drop', handleDrop);
          div.addEventListener('dragleave', handleDragLeave);
          
          preview.insertBefore(div, uploadBox);
        });
        
        showFlash(`Added ${newImages.length} image(s)`, 'success');
        
        // Clear the file input
        event.target.value = '';
      } catch (err) {
        console.error('Image upload failed:', err);
        showFlash(`Error uploading images: ${err.message}`, 'error');
      }
    }
    
    // Attach upload handler
    $('imageUploadInput').addEventListener('change', handleImageUpload);
    
    async function saveDraft() {
      try {
        const btn = $('btnSave');
        btn.disabled = true;
        btn.textContent = 'Saving...';
        
        // Collect aspects
        const aspects = {};
        document.querySelectorAll('.aspect-item').forEach(item => {
          const key = item.querySelector('.aspect-key').value.trim();
          const valueElement = item.querySelector('.aspect-value');
          const value = valueElement.value.trim();
          if (key && value) {
            // Split comma-separated values into array
            aspects[key] = value.includes(',') ? value.split(',').map(v => v.trim()) : [value];
          }
        });
        
        // Collect images in their current order
        const images = Array.from(document.querySelectorAll('.image-thumb')).map(el => el.dataset.url);
        
        const updatedDraft = {
          ...originalDraft,
          title: $('title').value.trim(),
          description: $('description').value.trim(),
          price: parseFloat($('price').value) || 0,
          condition: $('condition').value,
          aspects,
          images, // Include reordered images
        };
        
        // Save to backend
        const res = await fetchJSON('/.netlify/functions/smartdrafts-update-draft', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            offerId: currentOfferId,
            draft: updatedDraft,
          }),
        });
        
        if (res.ok) {
          showFlash('Draft saved successfully!', 'success');
          setTimeout(() => window.location.href = '/drafts.html', 1500);
        } else {
          throw new Error(res.error || 'Failed to save draft');
        }
        
      } catch (err) {
        console.error('Failed to save draft:', err);
        showFlash(`Error: ${err.message}`, 'error');
        $('btnSave').disabled = false;
        $('btnSave').textContent = 'Update Draft';
      }
    }
    
    $('title').addEventListener('input', updateTitleCount);
    
    function initUserMenu() {
      const userCard = document.getElementById('userCard');
      const userMenu = document.getElementById('userMenu');
      
      if (!userCard || !userMenu) return;
      
      userCard.addEventListener('click', (e) => {
        e.stopPropagation();
        const isVisible = userMenu.style.display !== 'none';
        userMenu.style.display = isVisible ? 'none' : 'block';
      });
      
      // Close menu when clicking outside
      document.addEventListener('click', (e) => {
        if (!userCard.contains(e.target) && !userMenu.contains(e.target)) {
          userMenu.style.display = 'none';
        }
      });
    }
    
    async function bootstrap() {
      try {
        // Wait for authClient to be available
        if (!window.authClient) {
          console.log('Waiting for authClient...');
          await new Promise(resolve => {
            const check = setInterval(() => {
              if (window.authClient) {
                clearInterval(check);
                resolve();
              }
            }, 100);
          });
        }
        
        const ok = await window.authClient.requireAuth();
        if (!ok) {
          showFlash('Authentication required. Redirecting to login...', 'error');
          return;
        }
        
        // Populate sidebar user info
        await window.authClient.updateUserDisplay().catch(() => {});
        
        await loadDraft();
      } catch (e) {
        console.error('Bootstrap failed', e);
        showFlash(`Failed to load: ${e.message}`, 'error');
      }
    }
    
    initUserMenu();
    bootstrap();
  </script>
</body>
</html>
