<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fetch eBay Category Aspects</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; }
    .btn { padding: 0.75rem 1.5rem; border: none; border-radius: 4px; cursor: pointer; font-size: 1rem; }
    .btn:hover { opacity: 0.9; }
    .btn.primary, .btn:not(.secondary):not(.danger) { background: #0066cc; color: white; }
    .btn.secondary { background: #6c757d; color: white; }
    .btn.danger { background: #c41e3a; color: white; }
    .muted { color: #666; font-size: 0.9rem; }
    input, select, textarea { padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem; }
    label { display: block; margin-bottom: 0.25rem; font-weight: 500; }
    ul { margin: 0; padding-left: 1.5rem; }
    code { background: #f0f0f0; padding: 0.2rem 0.4rem; border-radius: 3px; font-family: monospace; }
  </style>
  <style>
    .container { max-width: 900px; margin: 2rem auto; padding: 0 1rem; }
    .card { background: white; border: 1px solid #ddd; border-radius: 8px; padding: 1.5rem; margin-bottom: 1rem; }
    .result { background: #f5f5f5; padding: 1rem; border-radius: 4px; margin-top: 1rem; font-family: monospace; font-size: 0.9rem; max-height: 400px; overflow-y: auto; }
    .success { color: #2d862d; }
    .error { color: #c41e3a; }
    textarea { font-family: monospace; }
    .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-top: 1rem; }
    .stat-box { background: #f0f0f0; padding: 1rem; border-radius: 4px; text-align: center; }
    .stat-box strong { display: block; font-size: 1.5rem; color: #333; }
    .stat-box span { font-size: 0.9rem; color: #666; }
  </style>
</head>
<body>
  <div class="container">
    <h1>üè∑Ô∏è Fetch eBay Category Aspects</h1>
    <p class="muted">Fetch and cache category metadata (required/optional item specifics) from eBay Taxonomy API.</p>
    
    <div style="margin: 1rem 0;">
      <button class="btn danger" onclick="cancelAllJobs()" style="float: right;">üõë Cancel All Running Jobs</button>
      <div style="clear: both;"></div>
    </div>
    
    <div id="authStatus" style="margin: 1rem 0; padding: 1rem; background: #fff3cd; border: 1px solid #ffc107; border-radius: 4px; display: none;">
      <strong>‚ö†Ô∏è Authentication Required</strong>
      <p>Your session has expired. <a href="/login.html" style="color: #0066cc;">Click here to log in again</a></p>
    </div>

    <div class="card">
      <h2>Single Category</h2>
      <form id="singleForm">
        <div style="margin-bottom: 1rem;">
          <label for="categoryId">Category ID:</label>
          <input type="text" id="categoryId" placeholder="177011" style="width: 200px;" required>
        </div>
        <div style="margin-bottom: 1rem;">
          <label for="marketplaceId">Marketplace:</label>
          <select id="marketplaceId">
            <option value="EBAY_US">EBAY_US</option>
            <option value="EBAY_GB">EBAY_GB</option>
            <option value="EBAY_DE">EBAY_DE</option>
            <option value="EBAY_AU">EBAY_AU</option>
            <option value="EBAY_CA">EBAY_CA</option>
            <option value="EBAY_FR">EBAY_FR</option>
            <option value="EBAY_IT">EBAY_IT</option>
            <option value="EBAY_ES">EBAY_ES</option>
          </select>
        </div>
        <button type="submit" class="btn">Fetch Category</button>
      </form>
      <div id="singleResult"></div>
    </div>

    <div class="card">
      <h2>Bulk Fetch Categories</h2>
      <p class="muted">Fetch multiple categories at once. Enter one category ID per line.</p>
      <form id="bulkForm">
        <div style="margin-bottom: 1rem;">
          <label for="bulkCategories">Category IDs (one per line):</label>
          <textarea id="bulkCategories" rows="10" style="width: 100%; font-family: monospace;" placeholder="177011&#10;180959&#10;261328"></textarea>
        </div>
        <div style="margin-bottom: 1rem;">
          <label for="bulkMarketplace">Marketplace:</label>
          <select id="bulkMarketplace">
            <option value="EBAY_US">EBAY_US</option>
            <option value="EBAY_GB">EBAY_GB</option>
            <option value="EBAY_DE">EBAY_DE</option>
            <option value="EBAY_AU">EBAY_AU</option>
            <option value="EBAY_CA">EBAY_CA</option>
            <option value="EBAY_FR">EBAY_FR</option>
            <option value="EBAY_IT">EBAY_IT</option>
            <option value="EBAY_ES">EBAY_ES</option>
          </select>
        </div>
        <div style="margin-bottom: 1rem;">
          <label for="delayMs">Delay between requests (ms):</label>
          <input type="number" id="delayMs" value="100" min="0" max="5000" style="width: 150px;">
          <span class="muted">Prevent rate limiting</span>
        </div>
        <button type="submit" class="btn">Fetch All Categories</button>
      </form>
      <div id="bulkResult"></div>
    </div>

    <div class="card">
      <h2>Common Categories</h2>
      <p class="muted">Quick fetch for commonly used categories.</p>
      <button class="btn secondary" onclick="fetchCommonCategories()">Fetch Common Beauty & Health Categories</button>
      <div id="commonResult"></div>
    </div>

    <div class="card" style="border: 2px solid #ff9800;">
      <h2>‚ö†Ô∏è Fetch ALL Categories (Advanced)</h2>
      <p class="muted" style="color: #c41e3a;"><strong>Warning:</strong> This will fetch ALL leaf categories from eBay (thousands). It may take hours and could hit rate limits. Use with caution!</p>
      <form id="allCategoriesForm">
        <div style="margin-bottom: 1rem;">
          <label for="allMarketplace">Marketplace:</label>
          <select id="allMarketplace">
            <option value="EBAY_US">EBAY_US</option>
            <option value="EBAY_GB">EBAY_GB</option>
            <option value="EBAY_DE">EBAY_DE</option>
            <option value="EBAY_AU">EBAY_AU</option>
            <option value="EBAY_CA">EBAY_CA</option>
            <option value="EBAY_FR">EBAY_FR</option>
            <option value="EBAY_IT">EBAY_IT</option>
            <option value="EBAY_ES">EBAY_ES</option>
          </select>
        </div>
        <div style="margin-bottom: 1rem;">
          <label for="parentCategoryId">Parent Category ID (optional):</label>
          <input type="text" id="parentCategoryId" placeholder="26395 for Health & Beauty" style="width: 300px;">
          <span class="muted">Leave empty for ALL categories</span>
          <div style="margin-top: 0.5rem; font-size: 0.9rem;">
            <strong>Common parent categories:</strong>
            <ul style="margin: 0.5rem 0; padding-left: 1.5rem;">
              <li><code>26395</code> - Health & Beauty</li>
              <li><code>11450</code> - Clothing, Shoes & Accessories</li>
              <li><code>58058</code> - Jewelry & Watches</li>
              <li><code>15032</code> - Home & Garden</li>
              <li><code>293</code> - Electronics</li>
            </ul>
          </div>
        </div>
        <div style="margin-bottom: 1rem;">
          <label for="allDelayMs">Delay between requests (ms):</label>
          <input type="number" id="allDelayMs" value="200" min="100" max="5000" style="width: 150px;">
          <span class="muted">Recommended: 200ms or higher</span>
        </div>
        <div style="margin-bottom: 1rem;">
          <label for="maxCategoriesLimit">Max categories (0 = unlimited):</label>
          <input type="number" id="maxCategoriesLimit" value="100" min="0" max="10000" style="width: 150px;">
          <span class="muted">Test with 100 first!</span>
        </div>
        <button type="submit" class="btn danger">‚ö†Ô∏è Fetch Categories</button>
      </form>
      <div id="allResult"></div>
    </div>
  </div>

  <script src="/auth-client.js"></script>
  <script>
    function showAuthError() {
      document.getElementById('authStatus').style.display = 'block';
    }

    async function fetchSingleCategory(categoryId, marketplaceId) {
      const res = await window.authClient.authFetch('/.netlify/functions/ebay-fetch-category-aspects', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ categoryId, marketplaceId })
      });
      if (res.status === 401) {
        showAuthError();
        throw new Error('Authentication failed. Please log in again.');
      }
      return await res.json();
    }

    async function fetchBulkCategories(categoryIds, marketplaceId, delayMs) {
      const res = await window.authClient.authFetch('/.netlify/functions/ebay-fetch-categories-bulk', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ categoryIds, marketplaceId, delayMs })
      });
      if (res.status === 401) {
        showAuthError();
        throw new Error('Authentication failed. Please log in again.');
      }
      return await res.json();
    }

    async function fetchAllCategories(marketplaceId, delayMs, maxCategories, parentCategoryId) {
      const res = await window.authClient.authFetch('/.netlify/functions/ebay-fetch-all-categories', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ marketplaceId, delayMs, maxCategories, parentCategoryId })
      });
      if (res.status === 401) {
        showAuthError();
        throw new Error('Authentication failed. Please log in again.');
      }
      return await res.json();
    }

    async function checkJobStatus(jobId) {
      const res = await window.authClient.authFetch(`/.netlify/functions/ebay-fetch-categories-status?jobId=${jobId}`);
      if (res.status === 401) {
        showAuthError();
        throw new Error('Authentication failed. Please log in again.');
      }
      return await res.json();
    }

    async function resumeJob(jobId) {
      if (!confirm('Resume this stuck job? This will restart the background worker.')) {
        return;
      }

      try {
        const res = await window.authClient.authFetch('/.netlify/functions/ebay-fetch-categories-background', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ jobId })
        });

        if (!res.ok) {
          alert('Failed to resume job: ' + res.status);
          return;
        }

        alert('Job resumed! The page will auto-trigger batches every 5 seconds.');
        
        // Start polling for this job with auto-trigger
        startAutoTriggerPolling(jobId, 'allResult');
      } catch (err) {
        alert('Error resuming job: ' + err.message);
      }
    }

    async function cancelAllJobs() {
      if (!confirm('Cancel ALL running jobs? This will clear the job index and stop all workers.')) {
        return;
      }

      try {
        // Stop all polling intervals
        activePolls.forEach((intervalId, elementId) => {
          clearInterval(intervalId);
          console.log(`Stopped polling for ${elementId}`);
        });
        activePolls.clear();

        // Clear the job index (removes all active jobs)
        const res = await window.authClient.authFetch('/.netlify/functions/ebay-fetch-categories-background', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: 'cancelAll' })
        });

        if (!res.ok) {
          console.warn('Failed to clear job index:', res.status);
        }

        alert('All jobs cancelled! Polling stopped. Refresh the page to see updated status.');
        
        // Clear UI
        document.getElementById('allResult').innerHTML = '<p>All jobs cancelled. Refresh page to start fresh.</p>';
      } catch (err) {
        alert('Error cancelling jobs: ' + err.message);
      }
    }

    async function manualTriggerBatch(jobId) {
      try {
        const res = await window.authClient.authFetch('/.netlify/functions/ebay-fetch-categories-background', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ jobId })
        });

        if (!res.ok) {
          alert('Failed to trigger batch: ' + res.status);
          return;
        }

        console.log('Batch triggered successfully');
      } catch (err) {
        alert('Error triggering batch: ' + err.message);
      }
    }

    // Global polling intervals tracker
    const activePolls = new Map();

    function startAutoTriggerPolling(jobId, elementId) {
      // Clear any existing poll for this element
      if (activePolls.has(elementId)) {
        clearInterval(activePolls.get(elementId));
      }

      const pollInterval = setInterval(async () => {
        try {
          const statusResult = await checkJobStatus(jobId);
          
          if (!statusResult || !statusResult.status) {
            console.error('Invalid status result:', statusResult);
            return;
          }

          const status = statusResult.status;
          showJobProgress(elementId, status);
          
          // Auto-trigger if stuck (no update in 10 seconds while running)
          if (status.status === 'running' && status.updatedAt) {
            const secondsSinceUpdate = (Date.now() - status.updatedAt) / 1000;
            if (secondsSinceUpdate > 10) {
              console.log(`Job stuck for ${Math.round(secondsSinceUpdate)}s, auto-triggering...`);
              await manualTriggerBatch(jobId);
            }
          }

          // Stop polling when completed
          if (status.status === 'completed' || status.status === 'failed') {
            clearInterval(pollInterval);
            activePolls.delete(elementId);
            
            if (status.errors && status.errors.length > 0) {
              const errorSummary = status.errors.slice(0, 10).map(e => 
                `${e.categoryName} (${e.categoryId}): ${e.error}`
              ).join('\n');
              const errorDiv = `
                <div class="result error" style="margin-top: 1rem;">
                  <p><strong>Errors (showing first 10):</strong></p>
                  <pre>${errorSummary}</pre>
                  ${status.errors.length > 10 ? `<p>... and ${status.errors.length - 10} more errors</p>` : ''}
                </div>
              `;
              document.getElementById(elementId).insertAdjacentHTML('beforeend', errorDiv);
            }
          }
        } catch (err) {
          console.error('Polling error:', err);
        }
      }, 5000); // Poll every 5 seconds

      activePolls.set(elementId, pollInterval);
    }

    function showJobProgress(elementId, status) {
      const el = document.getElementById(elementId);
      const total = status.totalCategories || status.total || 0;
      const percent = total > 0 
        ? Math.round((status.processed / total) * 100)
        : 0;
      
      // Check if job is stuck (status=running but hasn't updated in 2+ minutes)
      const isStuck = status.status === 'running' && 
                     status.updatedAt && 
                     (Date.now() - status.updatedAt) > 120000;
      
      const timeSinceUpdate = status.updatedAt 
        ? Math.round((Date.now() - status.updatedAt) / 1000) + 's ago'
        : 'never';
      
      const resumeButton = isStuck 
        ? `<button class="btn secondary" onclick="resumeJob('${status.jobId}')" style="margin-top: 1rem;">üîÑ Resume Stuck Job</button>`
        : '';
      
      // Always show manual trigger button if job is running
      const manualTrigger = status.status === 'running'
        ? `<button class="btn secondary" onclick="manualTriggerBatch('${status.jobId}')" style="margin-top: 1rem; margin-left: 0.5rem;">‚ö° Trigger Next Batch</button>`
        : '';
      
      const errorsList = status.errors && status.errors.length > 0
        ? `<details style="margin-top: 1rem;">
            <summary style="cursor: pointer; color: #d32f2f; font-weight: bold;">
              ‚ö†Ô∏è ${status.errors.length} Error(s) - Click to view
            </summary>
            <pre style="background: #ffebee; padding: 1rem; margin-top: 0.5rem; overflow-x: auto; max-height: 300px;">${JSON.stringify(status.errors.slice(-10), null, 2)}</pre>
          </details>`
        : '';
      
      const stats = `
        <div class="stats">
          <div class="stat-box">
            <strong>${status.processed} / ${total}</strong>
            <span>Processed (${percent}%)</span>
          </div>
          <div class="stat-box success">
            <strong>${status.success}</strong>
            <span>Successful</span>
          </div>
          <div class="stat-box error">
            <strong>${status.failed}</strong>
            <span>Failed</span>
          </div>
          <div class="stat-box ${isStuck ? 'error' : ''}">
            <strong>${status.status}${isStuck ? ' (STUCK)' : ''}</strong>
            <span>Status (updated ${timeSinceUpdate})</span>
          </div>
        </div>
        <div class="result info">
          <div style="background: #ddd; height: 20px; border-radius: 4px; overflow: hidden;">
            <div style="background: #4CAF50; height: 100%; width: ${percent}%; transition: width 0.3s;"></div>
          </div>
          <p style="margin-top: 0.5rem;">Job ID: <code>${status.jobId}</code></p>
          <p>${status.parentCategory || ''}</p>
          ${errorsList}
          ${resumeButton}
          ${manualTrigger}
        </div>
      `;
      el.innerHTML = stats;
    }

    function showResult(elementId, data, isSuccess = true) {
      const el = document.getElementById(elementId);
      el.innerHTML = `<div class="result ${isSuccess ? 'success' : 'error'}">${JSON.stringify(data, null, 2)}</div>`;
      
      if (isSuccess && data.category) {
        const stats = `
          <div class="stats">
            <div class="stat-box">
              <strong>${data.category.title}</strong>
              <span>Category Name</span>
            </div>
            <div class="stat-box">
              <strong>${data.category.id}</strong>
              <span>Category ID</span>
            </div>
            <div class="stat-box">
              <strong>${data.aspectCount || 0}</strong>
              <span>Total Aspects</span>
            </div>
            <div class="stat-box">
              <strong>${data.requiredCount || 0}</strong>
              <span>Required Aspects</span>
            </div>
          </div>
        `;
        el.insertAdjacentHTML('afterbegin', stats);
      }

      if (isSuccess && data.results) {
        const stats = `
          <div class="stats">
            <div class="stat-box">
              <strong>${data.summary?.total || 0}</strong>
              <span>Total Requested</span>
            </div>
            <div class="stat-box success">
              <strong>${data.summary?.success || 0}</strong>
              <span>Successful</span>
            </div>
            <div class="stat-box error">
              <strong>${data.summary?.failed || 0}</strong>
              <span>Failed</span>
            </div>
          </div>
        `;
        el.insertAdjacentHTML('afterbegin', stats);
      }
    }

    document.getElementById('singleForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const categoryId = document.getElementById('categoryId').value.trim();
      const marketplaceId = document.getElementById('marketplaceId').value;
      
      document.getElementById('singleResult').innerHTML = '<p>Fetching...</p>';
      
      try {
        const result = await fetchSingleCategory(categoryId, marketplaceId);
        showResult('singleResult', result, result.ok);
      } catch (err) {
        showResult('singleResult', { error: err.message }, false);
      }
    });

    document.getElementById('bulkForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const text = document.getElementById('bulkCategories').value;
      const categoryIds = text.split('\n')
        .map(line => line.trim())
        .filter(line => line && /^\d+$/.test(line));
      
      if (categoryIds.length === 0) {
        alert('Please enter at least one category ID');
        return;
      }

      const marketplaceId = document.getElementById('bulkMarketplace').value;
      const delayMs = parseInt(document.getElementById('delayMs').value) || 100;
      
      document.getElementById('bulkResult').innerHTML = `<p>Fetching ${categoryIds.length} categories...</p>`;
      
      try {
        const result = await fetchBulkCategories(categoryIds, marketplaceId, delayMs);
        showResult('bulkResult', result, result.ok);
      } catch (err) {
        showResult('bulkResult', { error: err.message }, false);
      }
    });

    window.fetchCommonCategories = async function() {
      const commonCategoryIds = [
        '177011', // Health & Beauty > Vitamins & Dietary Supplements
        '180959', // Health & Beauty > Makeup
        '31786',  // Health & Beauty > Skin Care
        '11854',  // Health & Beauty > Hair Care & Styling
        '180971', // Health & Beauty > Fragrances
        '261328', // Health & Beauty > Bath & Body
      ];
      
      document.getElementById('commonResult').innerHTML = `<p>Fetching ${commonCategoryIds.length} common categories...</p>`;
      
      try {
        const result = await fetchBulkCategories(commonCategoryIds, 'EBAY_US', 100);
        showResult('commonResult', result, result.ok);
      } catch (err) {
        showResult('commonResult', { error: err.message }, false);
      }
    };

    document.getElementById('allCategoriesForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const marketplaceId = document.getElementById('allMarketplace').value;
      const delayMs = parseInt(document.getElementById('allDelayMs').value) || 200;
      const maxCategories = parseInt(document.getElementById('maxCategoriesLimit').value) || 0;
      const parentCategoryId = document.getElementById('parentCategoryId').value.trim();
      
      const scope = parentCategoryId 
        ? `categories under parent ${parentCategoryId}`
        : 'ALL categories from the entire marketplace';
      
      const confirmed = confirm(
        `‚ö†Ô∏è WARNING: This will queue a background job to fetch ${maxCategories || 'ALL'} ${scope}.\n\n` +
        `The job will process categories in the background.\n` +
        `Processing rate: ~5 categories per minute.\n\n` +
        `Continue?`
      );
      
      if (!confirmed) return;
      
      document.getElementById('allResult').innerHTML = `<p>Creating background job...</p>`;
      
      try {
        const result = await fetchAllCategories(marketplaceId, delayMs, maxCategories, parentCategoryId);
        
        if (!result.ok || !result.jobId) {
          showResult('allResult', result, false);
          return;
        }

        // Start polling for status with auto-trigger
        const jobId = result.jobId;
        
        // Show initial status immediately
        showJobProgress('allResult', {
          jobId: jobId,
          totalCategories: result.totalCategories,
          total: result.totalCategories,
          processed: 0,
          success: 0,
          failed: 0,
          status: 'queued',
          parentCategory: result.parentCategory
        });
        
        // Use centralized auto-trigger polling
        startAutoTriggerPolling(jobId, 'allResult');

      } catch (err) {
        showResult('allResult', { error: err.message }, false);
      }
    });

    // Initialize auth
    window.authClient.requireAuth().catch(() => {
      sessionStorage.setItem('returnTo', window.location.pathname + window.location.search);
      window.location.href = '/login.html';
    });
  </script>
</body>
</html>
