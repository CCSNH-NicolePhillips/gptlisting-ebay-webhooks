<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Inventory Locations – DraftPilot</title>
    <link rel="stylesheet" href="/draftpilot.css">
    <style>
      /* Location-specific styles */
      .locations-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 16px;
      }
      
      .locations-table thead {
        border-bottom: 1px solid var(--border-subtle);
      }
      
      .locations-table th {
        text-align: left;
        padding: 12px 16px;
        font-size: 0.75rem;
        font-weight: 600;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }
      
      .locations-table td {
        padding: 16px;
        border-bottom: 1px solid var(--border-subtle);
        color: var(--text-primary);
      }
      
      .locations-table tbody tr:hover {
        background: rgba(148, 163, 184, 0.02);
      }
      
      .locations-table tbody tr.selected {
        background: rgba(56, 189, 248, 0.08);
      }
      
      .locations-table tbody tr:last-child td {
        border-bottom: none;
      }
      
      .location-name {
        font-weight: 500;
        color: var(--text-primary);
        margin-bottom: 4px;
      }
      
      .location-key {
        font-family: 'SF Mono', Monaco, 'Courier New', monospace;
        font-size: 0.75rem;
        color: var(--text-muted);
        margin-bottom: 4px;
      }
      
      .location-address {
        font-size: 0.8125rem;
        color: var(--text-muted);
      }
      
      .default-badge {
        color: #10b981;
        font-weight: 600;
        font-size: 0.75rem;
        margin-left: 8px;
      }
      
      .location-actions {
        display: flex;
        gap: 8px;
        justify-content: flex-end;
      }
      
      .location-actions button {
        font-size: 0.8125rem;
        padding: 6px 12px;
      }
      
      .btn-delete {
        background: transparent;
        color: #ef4444;
        border: 1px solid rgba(239, 68, 68, 0.3);
        border-radius: 6px;
        padding: 6px 12px;
        cursor: pointer;
        font-weight: 500;
        font-size: 0.8125rem;
        transition: all 0.15s ease;
      }
      
      .btn-delete:hover {
        background: rgba(239, 68, 68, 0.1);
        border-color: #ef4444;
      }
      
      .location-section {
        background: var(--bg-card);
        border: 1px solid var(--border-subtle);
        border-radius: 12px;
        padding: 24px;
        margin-bottom: 24px;
      }
      
      .location-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 8px;
      }
      
      .location-header h3 {
        margin: 0;
        font-size: 1.125rem;
        font-weight: 600;
        color: var(--text-primary);
      }
      
      .location-count {
        font-size: 0.875rem;
        color: var(--text-muted);
        margin-top: 4px;
      }
      
      .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 16px;
        margin-bottom: 20px;
      }
      
      .form-field {
        display: flex;
        flex-direction: column;
      }
      
      .form-label {
        font-size: 0.75rem;
        font-weight: 600;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 6px;
      }
      
      .form-input,
      .form-select {
        background: var(--bg-subtle);
        color: var(--text-primary);
        border: 1px solid var(--border-subtle);
        border-radius: 8px;
        padding: 10px 12px;
        font-size: 0.875rem;
        transition: all 0.15s ease;
      }
      
      .form-input:focus,
      .form-select:focus {
        outline: none;
        border-color: var(--accent);
        background: var(--bg-card);
      }
      
      .inspector-panel {
        background: var(--bg-card);
        border: 1px solid var(--border-subtle);
        border-radius: 12px;
        padding: 24px;
      }
      
      .inspector-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 16px;
      }
      
      .inspector-header h3 {
        margin: 0;
        font-size: 1rem;
        font-weight: 600;
        color: var(--text-primary);
      }
      
      .inspector-section {
        margin-bottom: 16px;
      }
      
      .inspector-label {
        font-size: 0.75rem;
        font-weight: 600;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 6px;
      }
      
      .inspector-value {
        color: var(--text-secondary);
        font-size: 0.875rem;
        line-height: 1.6;
      }
      
      .inspector-json {
        background: var(--bg-subtle);
        border: 1px solid var(--border-subtle);
        border-radius: 8px;
        padding: 16px;
        overflow: auto;
        max-height: 300px;
        font-family: 'SF Mono', Monaco, 'Courier New', monospace;
        font-size: 0.8125rem;
        line-height: 1.6;
        color: var(--text-muted);
      }
      
      .form-actions {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
      }
      
      .header-actions {
        display: flex;
        gap: 12px;
      }
    </style>
  </head>
  <body>
    <script src="/auth-client.js"></script>
    
    <div class="dp-shell">
      <!-- Sidebar -->
      <aside class="dp-sidebar">
        <div class="dp-sidebar__brand">
          <img src="logo/LogoWhiteText_NoBg.png" alt="DraftPilot" class="dp-brand-logo" />
        </div>
        
        <nav class="dp-sidebar__nav">
          <div class="dp-nav-group">
            <div class="dp-nav-group__label">APP</div>
            <div class="dp-nav-group__items">
              <a href="/index.html" class="dp-nav-item">
                <svg class="dp-nav-item__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                  <polyline points="9 22 9 12 15 12 15 22"></polyline>
                </svg>
                <span class="dp-nav-item__label">Overview</span>
              </a>
              <a href="/quick-list.html" class="dp-nav-item">
                <svg class="dp-nav-item__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon>
                </svg>
                <span class="dp-nav-item__label">Create Listings</span>
              </a>
              <a href="/drafts.html" class="dp-nav-item">
                <svg class="dp-nav-item__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                  <polyline points="14 2 14 8 20 8"></polyline>
                </svg>
                <span class="dp-nav-item__label">Drafts</span>
              </a>
            </div>
          </div>
          
          <div class="dp-nav-group">
            <div class="dp-nav-group__label">ACCOUNT</div>
            <div class="dp-nav-group__items">
              <a href="/policies-manage.html" class="dp-nav-item">
                <svg class="dp-nav-item__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                  <polyline points="14 2 14 8 20 8"></polyline>
                  <line x1="16" y1="13" x2="8" y2="13"></line>
                  <line x1="16" y1="17" x2="8" y2="17"></line>
                  <polyline points="10 9 9 9 8 9"></polyline>
                </svg>
                <span class="dp-nav-item__label">eBay Policies</span>
              </a>
              <a href="/location.html" class="dp-nav-item dp-nav-item--active">
                <svg class="dp-nav-item__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                  <circle cx="12" cy="10" r="3"></circle>
                </svg>
                <span class="dp-nav-item__label">Inventory Locations</span>
              </a>
              <a href="/settings.html" class="dp-nav-item">
                <svg class="dp-nav-item__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="3"></circle>
                  <path d="M12 1v6m0 6v6m5.196-15.196l-4.243 4.243m0 5.656l-4.242 4.243m15.195-5.196l-4.242-4.243m-5.657 0l-4.243-4.243"></path>
                </svg>
                <span class="dp-nav-item__label">Settings</span>
              </a>
              <a href="/faq.html" class="dp-nav-item">
                <svg class="dp-nav-item__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="10"></circle>
                  <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                  <line x1="12" y1="17" x2="12.01" y2="17"></line>
                </svg>
                <span class="dp-nav-item__label">FAQ</span>
              </a>
              <a href="/support.html" class="dp-nav-item">
                <svg class="dp-nav-item__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="10"></circle>
                  <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                  <line x1="12" y1="17" x2="12.01" y2="17"></line>
                </svg>
                <span class="dp-nav-item__label">Support</span>
              </a>
            </div>
          </div>
        </nav>
        
        <div class="dp-sidebar__spacer"></div>
        
        <div class="dp-sidebar__footer">
          <div class="dp-user-card" id="userCard">
            <div class="dp-user-card__avatar" id="userAvatar">U</div>
            <div class="dp-user-card__info">
              <div class="dp-user-card__name" id="userName">Loading...</div>
              <div class="dp-user-card__status" id="userEmail">Signed in</div>
            </div>
          </div>
          <div class="dp-user-menu" id="userMenu" style="display: none;">
            <a href="/logout.html" class="dp-user-menu__item">
              <svg class="dp-user-menu__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                <polyline points="16 17 21 12 16 7"></polyline>
                <line x1="21" y1="12" x2="9" y2="12"></line>
              </svg>
              <span>Sign out</span>
            </a>
          </div>
        </div>
      </aside>
      
      <div class="dp-mobile-backdrop" id="mobileBackdrop"></div>
      
      <!-- Main Content Wrapper -->
      <div class="dp-main-wrapper">
        <!-- Top Bar -->
        <header class="dp-topbar">
          <div class="dp-topbar-left">
            <button class="dp-topbar-icon dp-topbar-icon--menu" id="mobileMenuButton" aria-label="Toggle menu">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="3" y1="12" x2="21" y2="12"></line>
                <line x1="3" y1="6" x2="21" y2="6"></line>
                <line x1="3" y1="18" x2="21" y2="18"></line>
              </svg>
            </button>
            <div class="dp-topbar-heading">
              <h1 id="dpUserNameHeading">Inventory Locations</h1>
              <p>Manage eBay fulfillment locations</p>
            </div>
          </div>
          <div class="dp-topbar-right">
            <img src="/logo/default-avatar.svg" alt="User" class="dp-topbar-avatar" id="topbarAvatar">
          </div>
        </header>

        <!-- Main Content -->
        <main class="dp-main-content">
          <!-- Page Actions -->
          <div class="dp-page-actions">
            <a href="https://www.ebay.com/sh/locations" target="_blank" rel="noopener" class="dp-btn-secondary">
              Open in eBay
              <svg style="width:14px;height:14px;margin-left:4px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6M15 3h6v6M10 14L21 3"/>
              </svg>
            </a>
          </div>

          <!-- Existing Locations Section -->
          <div class="location-section">
            <div class="location-header">
              <div>
                <h3>Existing Locations</h3>
                <div class="location-count" id="locationsStatus">Loading...</div>
              </div>
              <div class="header-actions">
                <button class="dp-btn-secondary" id="refreshBtn">Refresh</button>
                <button class="dp-btn-primary" id="setDefaultBtn" disabled>Set as Default</button>
              </div>
            </div>

            <table class="locations-table" id="locationsTable">
              <thead>
                <tr>
                  <th>Name & Address</th>
                  <th>Status</th>
                  <th style="text-align:right;">Actions</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>

          <!-- Inspector Panel -->
          <div class="inspector-panel" id="inspector" style="display:none;">
            <div class="inspector-header">
              <h3 id="inspectorTitle">Location Details</h3>
              <button class="dp-btn-ghost" id="closeInspector">Close</button>
            </div>
            <div id="inspectorStatus" style="color:var(--text-muted);font-size:0.875rem;">Select a location to see its full payload.</div>
            <div id="inspectorBody" style="display:none;margin-top:16px;">
              <div class="inspector-section">
                <div class="inspector-label">Address</div>
                <div id="inspectorAddress" class="inspector-value"></div>
              </div>
              <div class="inspector-section">
                <div class="inspector-label">Location Types</div>
                <div id="inspectorTypes" class="inspector-value"></div>
              </div>
              <div class="inspector-section">
                <div class="inspector-label">Raw Payload</div>
                <pre class="inspector-json" id="inspectorJson">n/a</pre>
              </div>
            </div>
          </div>

          <!-- Create/Update Location Section -->
          <div class="location-section">
            <div class="location-header">
              <div>
                <h3>Create or Update Location</h3>
                <div class="location-count">All fields required for US addresses. Using an existing key will update that location.</div>
              </div>
            </div>

            <div class="form-grid">
              <div class="form-field">
                <label class="form-label" for="locKey">Location Key</label>
                <input class="form-input" id="locKey" placeholder="primary-warehouse" />
              </div>
              <div class="form-field">
                <label class="form-label" for="locName">Location Name</label>
                <input class="form-input" id="locName" placeholder="Main Warehouse" />
              </div>
              <div class="form-field">
                <label class="form-label" for="locAddress1">Address Line 1</label>
                <input class="form-input" id="locAddress1" placeholder="123 Commerce Way" />
              </div>
              <div class="form-field">
                <label class="form-label" for="locCity">City</label>
                <input class="form-input" id="locCity" placeholder="Sampledale" />
              </div>
              <div class="form-field">
                <label class="form-label" for="locState">State</label>
                <select class="form-select" id="locState">
                  <option value="">Select a state…</option>
                  <option value="AL">Alabama</option>
                  <option value="AK">Alaska</option>
                  <option value="AZ">Arizona</option>
                  <option value="AR">Arkansas</option>
                  <option value="CA">California</option>
                  <option value="CO">Colorado</option>
                  <option value="CT">Connecticut</option>
                  <option value="DE">Delaware</option>
                  <option value="FL">Florida</option>
                  <option value="GA">Georgia</option>
                  <option value="HI">Hawaii</option>
                  <option value="ID">Idaho</option>
                  <option value="IL">Illinois</option>
                  <option value="IN">Indiana</option>
                  <option value="IA">Iowa</option>
                  <option value="KS">Kansas</option>
                  <option value="KY">Kentucky</option>
                  <option value="LA">Louisiana</option>
                  <option value="ME">Maine</option>
                  <option value="MD">Maryland</option>
                  <option value="MA">Massachusetts</option>
                  <option value="MI">Michigan</option>
                  <option value="MN">Minnesota</option>
                  <option value="MS">Mississippi</option>
                  <option value="MO">Missouri</option>
                  <option value="MT">Montana</option>
                  <option value="NE">Nebraska</option>
                  <option value="NV">Nevada</option>
                  <option value="NH">New Hampshire</option>
                  <option value="NJ">New Jersey</option>
                  <option value="NM">New Mexico</option>
                  <option value="NY">New York</option>
                  <option value="NC">North Carolina</option>
                  <option value="ND">North Dakota</option>
                  <option value="OH">Ohio</option>
                  <option value="OK">Oklahoma</option>
                  <option value="OR">Oregon</option>
                  <option value="PA">Pennsylvania</option>
                  <option value="RI">Rhode Island</option>
                  <option value="SC">South Carolina</option>
                  <option value="SD">South Dakota</option>
                  <option value="TN">Tennessee</option>
                  <option value="TX">Texas</option>
                  <option value="UT">Utah</option>
                  <option value="VT">Vermont</option>
                  <option value="VA">Virginia</option>
                  <option value="WA">Washington</option>
                  <option value="WV">West Virginia</option>
                  <option value="WI">Wisconsin</option>
                  <option value="WY">Wyoming</option>
                </select>
              </div>
              <div class="form-field">
                <label class="form-label" for="locPostal">Postal Code</label>
                <input class="form-input" id="locPostal" placeholder="03101" />
              </div>
              <div class="form-field">
                <label class="form-label" for="locCountry">Country</label>
                <select class="form-select" id="locCountry">
                  <option value="US">United States</option>
                  <option value="CA">Canada</option>
                  <option value="GB">United Kingdom</option>
                  <option value="AU">Australia</option>
                  <option value="DE">Germany</option>
                </select>
              </div>
            </div>
            
            <div class="form-actions">
              <button class="dp-btn-primary" id="createLocation">Create or Update</button>
              <button class="dp-btn-ghost" id="resetForm">Reset Form</button>
            </div>
          </div>

          <div id="msg" style="color:var(--text-muted);font-size:0.875rem;margin-top:16px;"></div>
        </main>
      </div>
    </div>

    <!-- Mobile Menu + User Menu Script -->
    <script>
      // Mobile menu toggle
      const mobileMenuButton = document.getElementById('mobileMenuButton');
      const sidebar = document.querySelector('.dp-sidebar');
      const mobileBackdrop = document.getElementById('mobileBackdrop');

      function toggleMobileMenu() {
        sidebar?.classList.toggle('dp-sidebar--mobile-open');
        mobileBackdrop?.classList.toggle('dp-mobile-backdrop--visible');
      }

      mobileMenuButton?.addEventListener('click', toggleMobileMenu);
      mobileBackdrop?.addEventListener('click', toggleMobileMenu);

      // User menu toggle
      const userCard = document.getElementById('userCard');
      const userMenu = document.getElementById('userMenu');

      userCard?.addEventListener('click', () => {
        const isVisible = userMenu.style.display === 'block';
        userMenu.style.display = isVisible ? 'none' : 'block';
      });

      // Close user menu when clicking outside
      document.addEventListener('click', (e) => {
        if (!userCard?.contains(e.target) && !userMenu?.contains(e.target)) {
          userMenu.style.display = 'none';
        }
      });
    </script>

    <!-- Location Management Script -->
    <script>
      (async () => {
        try {
          const ok = await authClient.requireAuth();
          if (!ok) return;
          await authClient.updateUserDisplay().catch(() => {});
        } catch (err) {
          console.error('Auth failed', err);
          return;
        }
        initLocations();
      })();

      function initLocations() {
        const state = { locations: [], selectedKey: null, defaultKey: '' };
        const tableBody = document.querySelector('#locationsTable tbody');
        const statusEl = document.getElementById('locationsStatus');
        const msgEl = document.getElementById('msg');
        const inspectorBox = document.getElementById('inspector');
        const inspectorStatus = document.getElementById('inspectorStatus');
        const inspectorBody = document.getElementById('inspectorBody');
        const inspectorAddress = document.getElementById('inspectorAddress');
        const inspectorTypes = document.getElementById('inspectorTypes');
        const inspectorJson = document.getElementById('inspectorJson');
        const closeInspectorBtn = document.getElementById('closeInspector');
        const refreshBtn = document.getElementById('refreshBtn');
        const setDefaultBtn = document.getElementById('setDefaultBtn');
        const createBtn = document.getElementById('createLocation');
        const resetBtn = document.getElementById('resetForm');

        const fields = {
          key: document.getElementById('locKey'),
          name: document.getElementById('locName'),
          address1: document.getElementById('locAddress1'),
          city: document.getElementById('locCity'),
          state: document.getElementById('locState'),
          postal: document.getElementById('locPostal'),
          country: document.getElementById('locCountry'),
        };

        async function getDefaultLocationKey() {
          try {
            const r = await authClient.authFetch('/.netlify/functions/ebay-get-location-user');
            const j = await r.json().catch(() => ({}));
            return (typeof j?.merchantLocationKey === 'string' ? j.merchantLocationKey : '') || '';
          } catch { return ''; }
        }

        async function setDefaultLocationKey(key) {
          const res = await authClient.authFetch('/.netlify/functions/ebay-set-location-user', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ merchantLocationKey: key }),
          });
          if (!res.ok) {
            const txt = await res.text();
            throw new Error(txt || 'Failed to save default');
          }
        }

        function updateDefaultButton() {
          if (!setDefaultBtn) return;
          const sel = (state.selectedKey || '').trim();
          const def = (state.defaultKey || '').trim();
          setDefaultBtn.disabled = !sel || (def && sel === def);
          setDefaultBtn.textContent = def && sel === def ? 'Default set' : 'Set as my default';
        }

        function setMsg(text, type) {
          if (msgEl) {
            msgEl.textContent = text || '';
            msgEl.className = type === 'error' ? 'error' : 'muted';
          }
        }

        function safeParse(text) {
          if (!text) return null;
          try { return JSON.parse(text); } catch { return { raw: text }; }
        }

        function formatAddress(loc) {
          const addr = loc?.location?.address || {};
          const parts = [addr.addressLine1, addr.addressLine2, addr.city, addr.stateOrProvince, addr.postalCode]
            .map((part) => (part || '').trim())
            .filter(Boolean);
          const line = parts.join(', ');
          const country = (addr.country || '').trim();
          return country ? (line ? line + ', ' + country : country) : line || 'n/a';
        }

        function renderInspector() {
          const loc = state.locations.find((l) => l.merchantLocationKey === state.selectedKey);
          if (!loc) {
            if (inspectorBox) inspectorBox.style.display = 'none';
            return;
          }
          if (inspectorBox) inspectorBox.style.display = 'flex';
          if (inspectorStatus) inspectorStatus.style.display = 'none';
          if (inspectorBody) inspectorBody.style.display = 'block';
          const name = loc.name || loc.merchantLocationKey || 'Location';
          const title = document.getElementById('inspectorTitle');
          if (title) title.textContent = name;
          if (inspectorAddress) inspectorAddress.textContent = formatAddress(loc);
          const types = Array.isArray(loc.locationTypes) ? loc.locationTypes.join(', ') : 'n/a';
          if (inspectorTypes) inspectorTypes.textContent = types || 'n/a';
          if (inspectorJson) inspectorJson.textContent = JSON.stringify(loc, null, 2);
        }

        function renderLocations() {
          if (!tableBody) return;
          tableBody.innerHTML = '';
          state.locations.forEach((loc) => {
            const tr = document.createElement('tr');
            if (state.selectedKey && state.selectedKey === loc.merchantLocationKey) tr.classList.add('selected');
            
            const nameTd = document.createElement('td');
            const nameDiv = document.createElement('div');
            nameDiv.className = 'location-name';
            nameDiv.textContent = loc.name || '(unnamed)';
            const keyDiv = document.createElement('div');
            keyDiv.className = 'location-key';
            const isDefault = !!(state.defaultKey && loc.merchantLocationKey && state.defaultKey === loc.merchantLocationKey);
            keyDiv.textContent = loc.merchantLocationKey || '';
            const addressDiv = document.createElement('div');
            addressDiv.className = 'location-address';
            addressDiv.textContent = formatAddress(loc);
            
            nameTd.appendChild(nameDiv);
            nameTd.appendChild(keyDiv);
            nameTd.appendChild(addressDiv);
            
            const statusTd = document.createElement('td');
            const statusText = loc.merchantLocationStatus || 'UNKNOWN';
            statusTd.innerHTML = statusText + (isDefault ? '<span class="default-badge">✓ DEFAULT</span>' : '');
            
            const actionsTd = document.createElement('td');
            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'location-actions';
            
            const inspectBtn = document.createElement('button');
            inspectBtn.textContent = 'Inspect';
            inspectBtn.className = 'dp-btn-secondary';
            inspectBtn.onclick = () => {
              state.selectedKey = loc.merchantLocationKey;
              renderLocations();
              renderInspector();
              updateDefaultButton();
            };
            
            const enableBtn = document.createElement('button');
            enableBtn.textContent = 'Enable';
            enableBtn.className = 'dp-btn-secondary';
            enableBtn.disabled = (loc.merchantLocationStatus || '').toUpperCase() === 'ENABLED';
            enableBtn.onclick = async () => {
              if (!loc.merchantLocationKey) return;
              try {
                setMsg('Enabling…');
                const url = new URL('/.netlify/functions/ebay-enable-location', window.location.origin);
                url.searchParams.set('key', loc.merchantLocationKey);
                const res = await authClient.authFetch(url.toString(), { method: 'POST' });
                const text = await res.text();
                if (!res.ok) throw new Error(text || 'Enable failed');
                setMsg('Location enabled. Refreshing…');
                await loadLocations();
              } catch (err) {
                setMsg('Enable failed: ' + (err?.message || err), 'error');
              }
            };
            
            const deleteBtn = document.createElement('button');
            deleteBtn.textContent = 'Delete';
            deleteBtn.className = 'btn-delete';
            deleteBtn.onclick = async () => {
              if (!loc.merchantLocationKey) return;
              if (!confirm(`Delete location "${loc.merchantLocationKey}" on eBay? This cannot be undone.`)) return;
              try {
                setMsg('Deleting…');
                const res = await authClient.authFetch('/.netlify/functions/ebay-delete-location', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ key: loc.merchantLocationKey }),
                });
                const text = await res.text();
                const payload = safeParse(text);
                if (!res.ok || !payload?.ok) {
                  const detail = payload?.error || payload?.message || text || 'Delete failed';
                  throw new Error(detail);
                }
                setMsg('Deleted. Refreshing…');
                state.selectedKey = null;
                await loadLocations();
              } catch (err) {
                setMsg('Delete failed: ' + (err?.message || err), 'error');
              }
            };
            
            actionsDiv.appendChild(inspectBtn);
            actionsDiv.appendChild(enableBtn);
            actionsDiv.appendChild(deleteBtn);
            actionsTd.appendChild(actionsDiv);
            
            tr.appendChild(nameTd);
            tr.appendChild(statusTd);
            tr.appendChild(actionsTd);
            tableBody.appendChild(tr);
          });
          updateDefaultButton();
        }

        async function loadLocations() {
          statusEl.textContent = 'Loading…';
          try {
            const res = await authClient.authFetch('/.netlify/functions/ebay-list-locations');
            const text = await res.text();
            const payload = safeParse(text) || {};
            if (!res.ok) {
              const errMsg = payload?.error || payload?.message || text || `status ${res.status}`;
              throw new Error(errMsg);
            }
            const list = Array.isArray(payload.locations) ? payload.locations : [];
            state.locations = list;
            statusEl.textContent = list.length ? `${list.length} location${list.length === 1 ? '' : 's'} found.` : 'No locations yet. Create one below.';
            // Refresh default key if not loaded yet
            if (!state.defaultKey) {
              try { state.defaultKey = await getDefaultLocationKey(); } catch {}
            }
            renderLocations();
            if (state.selectedKey) {
              const exists = list.some((loc) => loc.merchantLocationKey === state.selectedKey);
              if (!exists) state.selectedKey = null;
            }
            renderInspector();
            setMsg('');
          } catch (err) {
            statusEl.textContent = 'Failed to load locations.';
            setMsg('Load failed: ' + (err?.message || err), 'error');
          }
        }

        async function handleCreate() {
          // Generate a better default key if user didn't provide one
          const providedKey = (fields.key?.value || '').trim();
          const defaultKey = providedKey || `warehouse-${Date.now().toString(36)}`;
          
          const values = {
            key: defaultKey,
            name: (fields.name?.value || '').trim() || 'Main Warehouse',
            address1: (fields.address1?.value || '').trim(),
            city: (fields.city?.value || '').trim(),
            state: (fields.state?.value || '').trim(),
            postal: (fields.postal?.value || '').trim(),
            country: (fields.country?.value || '').trim() || 'US',
          };
          if (!values.address1 || !values.city || !values.state || !values.postal) {
            setMsg('Fill in address, city, state, and postal code.', 'error');
            return;
          }
          try {
            createBtn.disabled = true;
            setMsg('Saving location…');
            const qs = new URLSearchParams();
            qs.set('key', values.key);
            qs.set('name', values.name);
            qs.set('address1', values.address1);
            qs.set('city', values.city);
            qs.set('state', values.state);
            qs.set('postal', values.postal);
            qs.set('country', values.country);
            qs.set('minimal', 'true');
            const url = `/.netlify/functions/ebay-create-location?${qs.toString()}`;
            const res = await authClient.authFetch(url);
            const text = await res.text();
            const payload = safeParse(text) || {};
            if (!res.ok || payload?.error) {
              const detail = payload?.error || payload?.message || text || 'Save failed';
              throw new Error(detail);
            }
            setMsg('Location saved. Refreshing list…');
            await loadLocations();
          } catch (err) {
            setMsg('Save failed: ' + (err?.message || err), 'error');
          } finally {
            createBtn.disabled = false;
          }
        }

        function resetForm() {
          Object.values(fields).forEach((el) => {
            if (el) el.value = '';
          });
          if (fields.country) fields.country.value = 'US';
          setMsg('');
        }

        if (refreshBtn) refreshBtn.onclick = loadLocations;
        if (setDefaultBtn) setDefaultBtn.onclick = async () => {
          const key = (state.selectedKey || '').trim();
          if (!key) return;
          try {
            setDefaultBtn.disabled = true;
            setMsg('Saving default…');
            await setDefaultLocationKey(key);
            state.defaultKey = key;
            setMsg('Default location saved.');
            renderLocations();
          } catch (err) {
            setMsg('Save default failed: ' + (err?.message || err), 'error');
          } finally {
            updateDefaultButton();
          }
        };
        if (createBtn) createBtn.onclick = handleCreate;
        if (resetBtn) resetBtn.onclick = resetForm;
        if (closeInspectorBtn) closeInspectorBtn.onclick = () => {
          state.selectedKey = null;
          renderLocations();
          if (inspectorBox) inspectorBox.style.display = 'none';
        };

        (async () => {
          try { state.defaultKey = await getDefaultLocationKey(); } catch {}
          loadLocations();
        })();
      }
    </script>
  </body>
</html>
