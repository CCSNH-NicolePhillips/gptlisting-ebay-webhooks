<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>SmartDrafts - Dropbox</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:24px;color:#111;max-width:1040px}
      input[type=text]{width:100%;padding:8px 10px;border:1px solid #ddd;border-radius:8px;font-size:16px}
      button{padding:8px 14px;border:1px solid #111;border-radius:8px;cursor:pointer;background:#111;color:#fff;font-weight:600}
      button:disabled{opacity:.5;cursor:not-allowed}
      .muted{color:#666;font-size:15px}
      .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:16px;margin-top:16px}
      .card{border:1px solid #eee;border-radius:12px;padding:12px;background:#fff;box-shadow:0 1px 2px rgba(17,17,17,0.05)}
      .thumbs{display:flex;gap:6px;flex-wrap:wrap;margin-top:8px}
      .thumbs img{width:64px;height:64px;object-fit:cover;border:1px solid #eee;border-radius:8px;background:#f5f5f5}
      .panel{border:1px solid #ececec;border-radius:12px;padding:16px;margin:18px 0;background:#fafafa}
      .panel h2{margin:0 0 8px;font-size:20px}
      .panel p{margin:4px 0 12px}
      header{margin-bottom:18px}
      header h1{margin:0 0 6px;font-size:26px}
      .controls{margin:12px 0;display:flex;gap:8px;flex-wrap:wrap}
      label.group-toggle{display:flex;align-items:center;gap:6px;font-weight:600;font-size:15px}
    </style>
  </head>
  <body>
    <script src="/auth-client.js"></script>
    <script>
      try { window.authClient?.requireAuth?.(); } catch {}
    </script>

    <header>
      <h1>SmartDrafts - Dropbox Ingest</h1>
      <p class="muted">We pre-fill the Dropbox folder you selected on the Connect page. Scan it or pick another folder from the dropdown to build SmartDraft groups.</p>
    </header>

    <div class="panel">
      <h2>Pick a Dropbox folder</h2>
      <p class="muted">We load your Dropbox folders, defaulting to the path saved on the Connect page. Change the selection to scan a different folder.</p>
      <select id="folderSelect"></select>
      <div class="controls">
        <button id="btnScanFolder">Scan Folder</button>
      </div>
      <div class="muted" id="folderInfo"></div>
    </div>

    <div id="status" class="muted"></div>
    <div id="grid" class="grid"></div>

    <script type="module">
      const $ = (sel) => document.querySelector(sel);
      function el(tag, attrs = {}, children = []) {
        const node = document.createElement(tag);
        Object.entries(attrs).forEach(([key, value]) => {
          if (value === null || value === undefined || value === false) return;
          if (key === 'text') {
            node.textContent = String(value);
            return;
          }
          if (key === 'html') {
            node.innerHTML = String(value);
            return;
          }
          node.setAttribute(key, String(value === true ? '' : value));
        });
        children.forEach((child) => {
          if (child === null || child === undefined) return;
          if (typeof child === 'string') {
            node.appendChild(document.createTextNode(child));
          } else {
            node.appendChild(child);
          }
        });
        return node;
      }
      const folderSelect = $('#folderSelect');
      const btnScanFolder = $('#btnScanFolder');
      const statusEl = $('#status');
      const grid = $('#grid');
      const folderInfo = $('#folderInfo');

      async function ensureAuth() {
        try {
          const ok = await (window.authClient?.ensureAuth?.() ?? Promise.resolve(false));
          return !!ok;
        } catch {
          return false;
        }
      }

      function getStoredFolder() {
        try {
          return localStorage.getItem('dbxDefaultFolder') || '';
        } catch {
          return '';
        }
      }

      function setStatus(message) {
        if (statusEl) statusEl.textContent = message || '';
      }

      async function scanDropbox(payload) {
        const exec = window.authClient?.authFetch ?? fetch;
        const body = JSON.stringify(payload);
        const res = await exec('/.netlify/functions/dbx-list-tree-user', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body,
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok || !data?.ok) {
          const errMsg = data?.error || `Scan failed (${res.status})`;
          throw new Error(errMsg);
        }
        return data;
      }

      let isScanning = false;

      async function runScan(payload, description) {
        if (isScanning) return;
        isScanning = true;
        setStatus(description);
        grid.innerHTML = '';
        try {
          const authed = await ensureAuth();
          if (!authed) {
            setStatus('Please sign in to scan Dropbox.');
            return;
          }
          const data = await scanDropbox(payload);
          const groups = Array.isArray(data.groups) ? data.groups : [];
          window.smartDraftGroups = groups;
          setStatus(`Found ${groups.length} group(s) under "${data.root || '/'}".`);
          renderGroups(groups);
        } catch (err) {
          setStatus(`Error: ${err?.message || err}`);
        } finally {
          isScanning = false;
        }
      }

      function setStoredFolder(path) {
        try {
          localStorage.setItem('dbxDefaultFolder', path || '');
        } catch {}
      }

      async function loadFolders() {
        if (!folderSelect) return;
        folderSelect.disabled = true;
        folderSelect.innerHTML = '<option>Loading folders…</option>';
        try {
          const exec = window.authClient?.authFetch ?? fetch;
          const url = new URL('/.netlify/functions/dropbox-list-folders', window.location.origin);
          url.searchParams.set('recursive', '1');
          const res = await exec(url.toString());
          const data = await res.json();
          const entries = Array.isArray(data?.folders) ? data.folders : [];
          const unique = new Map();
          entries.forEach((entry) => {
            const path = entry?.path_display || entry?.path_lower || entry?.name || '';
            if (path) {
              unique.set(path, path);
            }
          });
          const options = Array.from(unique.keys()).sort((a, b) => a.localeCompare(b));
          const stored = getStoredFolder();
          folderSelect.innerHTML = '';
          options.forEach((path) => {
            const opt = document.createElement('option');
            opt.value = path;
            opt.textContent = path;
            folderSelect.appendChild(opt);
          });
          if (stored && options.includes(stored)) {
            folderSelect.value = stored;
          } else if (options.length) {
            folderSelect.value = options[0];
            setStoredFolder(options[0]);
          }
          folderSelect.disabled = false;
          const current = folderSelect.value || stored;
          if (folderInfo) {
            folderInfo.textContent = current
              ? `Selected folder: ${current}`
              : 'No folder selected.';
          }
          if (current) {
            setStatus(`Ready to scan ${current}.`);
          } else {
            setStatus('Select a Dropbox folder to scan.');
          }
        } catch (err) {
          folderSelect.innerHTML = '<option>Failed to load folders</option>';
          if (folderInfo) folderInfo.textContent = err?.message || 'Error loading folders';
          setStatus('Unable to load folders from Dropbox.');
        }
      }

      function renderGroups(groups) {
        grid.innerHTML = '';
        if (!groups.length) {
          return;
        }
        groups.forEach((group) => {
          const card = el('div', { class: 'card' });
          const checkbox = el('input', {
            type: 'checkbox',
            value: group.groupId,
            'data-group-id': group.groupId,
            checked: 'checked',
          });
          const toggle = el('label', { class: 'group-toggle' }, [checkbox, 'Use group']);
          card.appendChild(toggle);
          const title = el('div', { html: `<strong>${group.name || '(unnamed)'}</strong> <span class="muted">${group.folder || '/'}</span>` });
          card.appendChild(title);
          const thumbs = el('div', { class: 'thumbs' });
          group.images.slice(0, 8).forEach((url) => {
            thumbs.appendChild(el('img', { src: url, alt: 'preview' }));
          });
          card.appendChild(thumbs);
          grid.appendChild(card);
        });
      }
      btnScanFolder?.addEventListener('click', () => {
        const path = (folderSelect?.value || '').trim();
        if (!path) {
          setStatus('Select a Dropbox folder first.');
          return;
        }
        setStoredFolder(path);
        if (folderInfo) folderInfo.textContent = `Selected folder: ${path}`;
        runScan({ path }, `Scanning ${path}…`);
      });

      folderSelect?.addEventListener('change', () => {
        const path = (folderSelect.value || '').trim();
        if (path) {
          setStoredFolder(path);
          if (folderInfo) folderInfo.textContent = `Selected folder: ${path}`;
          setStatus(`Ready to scan ${path}.`);
        }
      });

      (async () => {
        const authed = await ensureAuth();
        if (!authed) {
          setStatus('Please sign in to load Dropbox folders.');
          return;
        }
        await loadFolders();
      })();
    </script>
  </body>
</html>
