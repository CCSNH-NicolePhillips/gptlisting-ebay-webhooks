<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Edit Active Listing ‚Äì DraftPilot</title>
  <link rel="stylesheet" href="/draftpilot.css?v=2">
  <style>
    /* Edit active listing specific styles */
    .form-row {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      margin-bottom: 1.25rem;
      align-items: flex-start;
    }
    .form-field {
      flex: 1 1 250px;
      min-width: 220px;
    }
    .form-field label {
      display: block;
      font-weight: 500;
      margin-bottom: 0.5rem;
      font-size: 0.875rem;
      color: #cbd5ff;
    }
    .form-field input, 
    .form-field textarea, 
    .form-field select {
      width: 100%;
      background: var(--bg-card);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-md);
      padding: 0.75rem;
      color: var(--text-primary);
      font-family: inherit;
      font-size: 0.9375rem;
      box-sizing: border-box;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }
    .form-field input[type="number"] {
      max-width: 150px;
    }
    .form-field select {
      cursor: pointer;
    }
    .form-field select:hover {
      border-color: var(--accent);
    }
    .form-field input:focus, 
    .form-field textarea:focus, 
    .form-field select:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-soft);
    }
    #price {
      max-width: 200px;
    }
    #quantity {
      max-width: 100px;
    }
    #condition {
      max-width: 300px;
    }
    .form-field textarea {
      resize: vertical;
      min-height: 140px;
      line-height: 1.6;
    }
    .muted-hint {
      font-size: 0.85rem;
      color: var(--text-muted);
      margin-top: 0.3rem;
    }
    .aspect-item {
      display: grid;
      grid-template-columns: minmax(160px, 0.4fr) minmax(220px, 1fr) auto;
      gap: 0.75rem;
      margin-bottom: 0.65rem;
      align-items: center;
    }
    #aspectsList {
      padding: 0;
      margin-top: 0.5rem;
    }
    .aspect-item input,
    .aspect-item select {
      width: 100%;
      background: var(--bg-card);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-md);
      padding: 0.75rem;
      color: var(--text-primary);
      font-size: 0.9375rem;
      box-sizing: border-box;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }
    .aspect-item select {
      cursor: pointer;
    }
    .aspect-item select:hover {
      border-color: var(--accent);
    }
    @media (max-width: 768px) {
      .aspect-item {
        grid-template-columns: 1fr;
      }
    }
    .aspect-item input:focus,
    .aspect-item select:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-soft);
    }
    .aspect-item button {
      padding: 0.4rem 0.8rem;
      font-size: 0.85rem;
    }
    .images-preview {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 1rem;
      margin-top: 1rem;
    }
    .image-thumb {
      position: relative;
      aspect-ratio: 1;
      border-radius: var(--radius-md);
      overflow: hidden;
      border: 1px solid var(--border-subtle);
      background: rgba(15, 23, 42, 0.5);
      transition: border-color 0.2s, transform 0.2s;
      cursor: move;
    }
    .image-thumb:hover {
      border-color: var(--accent-hover);
      transform: scale(1.02);
    }
    .image-thumb.dragging {
      opacity: 0.5;
    }
    .image-thumb.drag-over {
      border-color: var(--accent);
      border-width: 2px;
    }
    .image-thumb img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      background: var(--bg-elevated, #1a1a2e);
      pointer-events: none;
    }
    .image-thumb .image-order {
      position: absolute;
      top: 4px;
      left: 4px;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 600;
    }
    .dp-content {
      max-width: 1100px;
      margin: 0 auto;
    }
    /* Two-column row for Quantity + Condition */
    .dp-form-row.two-col {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1.25rem;
      margin-bottom: 1.5rem;
    }
    @media (max-width: 700px) {
      .dp-form-row.two-col {
        grid-template-columns: 1fr;
      }
    }
    .dp-form-col label {
      display: block;
      font-weight: 500;
      margin-bottom: 0.5rem;
      font-size: 0.875rem;
      color: #cbd5ff;
    }
    .dp-form-col input,
    .dp-form-col select {
      width: 100%;
      background: var(--bg-card);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-md);
      padding: 0.75rem;
      color: var(--text-primary);
      font-family: inherit;
      font-size: 0.9375rem;
      box-sizing: border-box;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }
    .dp-form-col select {
      cursor: pointer;
    }
    .dp-form-col select:hover {
      border-color: var(--accent);
    }
    .dp-form-col input:focus,
    .dp-form-col select:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-soft);
    }
  </style>
</head>
<body>
  <script src="/auth-client.js"></script>
  <script src="/sidebar-toggle.js"></script>
  
  <div class="dp-shell">
    <!-- Sidebar -->
    <aside class="dp-sidebar">
      <!-- Brand Area -->
      <div class="dp-sidebar__brand">
        <img src="logo/LogoWhiteText_NoBg.png" alt="DraftPilot - AI Listing Studio" class="dp-brand-logo" />
      </div>
      
      <!-- Navigation -->
      <nav class="dp-sidebar__nav">
        <!-- Primary Navigation Group -->
        <div class="dp-nav-group">
          <div class="dp-nav-group__label">APP</div>
          <div class="dp-nav-group__items">
            <a href="/index.html" class="dp-nav-item">
              <svg class="dp-nav-item__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                <polyline points="9 22 9 12 15 12 15 22"></polyline>
              </svg>
              <span class="dp-nav-item__label">Overview</span>
            </a>
            <a href="/quick-list.html" class="dp-nav-item">
              <svg class="dp-nav-item__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon>
              </svg>
              <span class="dp-nav-item__label">Create Listings</span>
            </a>
            <a href="/drafts.html" class="dp-nav-item">
              <svg class="dp-nav-item__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                <polyline points="14 2 14 8 20 8"></polyline>
              </svg>
              <span class="dp-nav-item__label">Drafts</span>
            </a>
            <a href="/active-listings.html" class="dp-nav-item dp-nav-item--active">
              <svg class="dp-nav-item__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect>
                <path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path>
              </svg>
              <span class="dp-nav-item__label">Active Listings</span>
            </a>
          </div>
        </div>
        
        <!-- Account Navigation Group -->
        <div class="dp-nav-group">
          <div class="dp-nav-group__label">ACCOUNT</div>
          <div class="dp-nav-group__items">
            <a href="/policies-manage.html" class="dp-nav-item">
              <svg class="dp-nav-item__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                <polyline points="14 2 14 8 20 8"></polyline>
                <line x1="16" y1="13" x2="8" y2="13"></line>
                <line x1="16" y1="17" x2="8" y2="17"></line>
                <polyline points="10 9 9 9 8 9"></polyline>
              </svg>
              <span class="dp-nav-item__label">eBay Policies</span>
            </a>
            <a href="/location.html" class="dp-nav-item">
              <svg class="dp-nav-item__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                <circle cx="12" cy="10" r="3"></circle>
              </svg>
              <span class="dp-nav-item__label">Inventory Locations</span>
            </a>
            <a href="/settings.html" class="dp-nav-item">
              <svg class="dp-nav-item__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="3"></circle>
                <path d="M12 1v6m0 6v6m5.196-15.196l-4.243 4.243m0 5.656l-4.242 4.243m15.195-5.196l-4.242-4.243m-5.657 0l-4.243-4.243"></path>
              </svg>
              <span class="dp-nav-item__label">Settings</span>
            </a>
            <a href="/faq.html" class="dp-nav-item">
              <svg class="dp-nav-item__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"></circle>
                <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                <line x1="12" y1="17" x2="12.01" y2="17"></line>
              </svg>
              <span class="dp-nav-item__label">FAQ</span>
            </a>
            <a href="/support.html" class="dp-nav-item">
              <svg class="dp-nav-item__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M18 18.72a9.094 9.094 0 0 0 3.741-.479 3 3 0 0 0-4.682-2.72m.94 3.198.001.031c0 .225-.012.447-.037.666A11.944 11.944 0 0 1 12 21c-2.17 0-4.207-.576-5.963-1.584A6.062 6.062 0 0 1 6 18.719m12 0a5.971 5.971 0 0 0-.941-3.197m0 0A5.995 5.995 0 0 0 12 12.75a5.995 5.995 0 0 0-5.058 2.772m0 0a3 3 0 0 0-4.681 2.72 8.986 8.986 0 0 0 3.74.477m.94-3.197a5.971 5.971 0 0 0-.94 3.197M15 6.75a3 3 0 1 1-6 0 3 3 0 0 1 6 0Zm6 3a2.25 2.25 0 1 1-4.5 0 2.25 2.25 0 0 1 4.5 0Zm-13.5 0a2.25 2.25 0 1 1-4.5 0 2.25 2.25 0 0 1 4.5 0Z"></path>
              </svg>
              <span class="dp-nav-item__label">Support</span>
            </a>
          </div>
        </div>
      </nav>
      
      <!-- Spacer -->
      <div class="dp-sidebar__spacer"></div>
      
      <!-- User Footer -->
      <div class="dp-sidebar__footer">
        <div class="dp-user-card" id="userCard">
          <div class="dp-user-card__avatar" id="userAvatar">U</div>
          <div class="dp-user-card__info">
            <div class="dp-user-card__name" id="userName">Loading...</div>
            <div class="dp-user-card__status" id="userEmail">Signed in</div>
          </div>
        </div>
        <div class="dp-user-menu" id="userMenu" style="display: none;">
          <a href="/logout.html" class="dp-user-menu__item">
            <svg class="dp-user-menu__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
              <polyline points="16 17 21 12 16 7"></polyline>
              <line x1="21" y1="12" x2="9" y2="12"></line>
            </svg>
            <span>Sign out</span>
          </a>
        </div>
      </div>
    </aside>
    
    <div class="dp-mobile-backdrop" id="mobileBackdrop"></div>
    
    <!-- Main Content Wrapper -->
    <div class="dp-main-wrapper">
      <!-- Top Bar -->
      <header class="dp-topbar">
        <!-- Left: Mobile menu + Page Title & Subtitle -->
        <div class="dp-topbar-left">
          <!-- Mobile-only hamburger -->
          <button
            class="dp-topbar-icon dp-topbar-icon--menu"
            id="mobileMenuButton"
            aria-label="Open navigation"
            aria-expanded="false"
            type="button"
          >
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="4" y1="6" x2="20" y2="6"></line>
              <line x1="4" y1="12" x2="20" y2="12"></line>
              <line x1="4" y1="18" x2="20" y2="18"></line>
            </svg>
          </button>

          <div class="dp-topbar-heading">
            <h1 class="dp-topbar__title">‚úèÔ∏è Edit Active Listing</h1>
            <p class="dp-topbar__subtitle">
              Update your live eBay listing details
            </p>
          </div>
        </div>
        
        <!-- Right: Actions -->
        <div class="dp-topbar-right" style="display: flex !important; gap: 0.75rem;">
          <a href="/active-listings.html" class="dp-btn dp-btn-secondary" style="padding: 0.5rem 1rem; font-size: 0.875rem;">‚Üê Back to Listings</a>
          <button id="btnSave" class="dp-btn dp-btn-primary" onclick="saveListing()" style="padding: 0.5rem 1rem; font-size: 0.875rem;">Update Listing</button>
        </div>
      </header>
      
      <!-- Main Content Area -->
      <main class="dp-main">
        <div id="flashMessage" class="dp-flash" style="display: none; margin-bottom: 1rem;"></div>
        
        <!-- Basic Information -->
        <div class="dp-card dp-card--full">
          <h3 style="margin-top: 0; margin-bottom: 1rem; color: var(--text-primary);">Basic Information</h3>
          
          <div class="form-row">
            <div class="form-field" style="flex: 2;">
              <label for="title">Title <small class="muted-hint">(max 80 characters)</small></label>
              <input type="text" id="title" maxlength="80" />
              <small class="muted-hint" id="titleCount">0 / 80</small>
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-field" style="flex: 2;">
              <label for="description">Description</label>
              <textarea id="description"></textarea>
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-field">
              <label for="price">Price (USD)</label>
              <input type="number" id="price" step="0.01" min="0" />
            </div>
          </div>
          
          <!-- Quantity & Condition -->
          <div class="dp-form-row two-col">
            <div class="dp-form-col">
              <label for="quantity">Quantity</label>
              <input type="number" id="quantity" placeholder="1" min="1" required />
            </div>
            <div class="dp-form-col">
              <label for="condition">Condition</label>
              <select id="condition">
                <option value="1000">New</option>
                <option value="1500">New other (see details)</option>
                <option value="1750">New with defects</option>
                <option value="2000">Manufacturer refurbished</option>
                <option value="2500">Seller refurbished</option>
                <option value="3000">Used</option>
                <option value="4000">Very Good</option>
                <option value="5000">Good</option>
                <option value="6000">Acceptable</option>
                <option value="7000">For parts or not working</option>
              </select>
            </div>
          </div>
        </div>
        
        <!-- Item Specifics -->
        <div class="dp-card dp-card--full">
          <h3 style="margin-top: 0; margin-bottom: 1rem; color: var(--text-primary);">Item Specifics (Aspects)</h3>
          <div id="aspectsList"></div>
          <button class="dp-btn dp-btn-secondary" style="margin-top: 0.5rem;" onclick="addAspect()">+ Add Aspect</button>
        </div>
        
        <!-- Images -->
        <div class="dp-card dp-card--full">
          <h3 style="margin-top: 0; margin-bottom: 1rem; color: var(--text-primary);">üì∏ Images</h3>
          <p style="color: var(--text-muted); font-size: 0.875rem; margin-bottom: 1rem;">Drag to reorder images. First image is the main listing photo.</p>
          <div class="images-preview" id="imagesPreview"></div>
        </div>
      </main>
    </div>
  </div>
  
  <script>
    const $ = (id) => document.getElementById(id);
    
    let currentItemId = null;
    let originalItem = null;
    
    async function fetchJSON(url, opts = {}) {
      const exec = window.authClient?.authFetch || fetch;
      const r = await exec(url, opts);
      const data = await r.json();
      if (!r.ok) {
        const error = data.error || `HTTP ${r.status}`;
        const detail = data.detail ? ` - ${data.detail}` : '';
        throw new Error(error + detail);
      }
      return data;
    }
    
    function showFlash(message, type = 'success') {
      const flash = $('flashMessage');
      flash.textContent = message;
      flash.className = type === 'error' ? 'dp-flash dp-flash--error' : 'dp-flash dp-flash--success';
      flash.style.display = 'block';
      setTimeout(() => { flash.style.display = 'none'; }, 5000);
    }
    
    function updateTitleCount() {
      const title = $('title');
      $('titleCount').textContent = `${title.value.length} / 80`;
    }
    
    function addAspect(key = '', value = '') {
      const container = $('aspectsList');
      const div = document.createElement('div');
      div.className = 'aspect-item';
      
      const keyReadonly = key ? 'readonly' : '';
      
      div.innerHTML = `
        <input type="text" placeholder="Name (e.g. Brand)" value="${key}" class="aspect-key" ${keyReadonly} />
        <input type="text" placeholder="Value" value="${value}" class="aspect-value" />
        <button class="dp-btn dp-btn-secondary" onclick="this.parentElement.remove()">√ó</button>
      `;
      container.appendChild(div);
    }
    
    async function loadListing() {
      try {
        const params = new URLSearchParams(window.location.search);
        currentItemId = params.get('itemId');
        
        // Get isInventoryListing from URL params as fallback
        const isInventoryListingParam = params.get('isInventoryListing');
        const skuParam = params.get('sku');
        
        if (!currentItemId) {
          throw new Error('Missing itemId in URL');
        }
        
        console.log('Loading listing for itemId:', currentItemId);
        console.log('isInventoryListing from URL:', isInventoryListingParam);
        showFlash('Loading listing...', 'success');
        
        const res = await fetchJSON(`/.netlify/functions/ebay-get-active-item?itemId=${encodeURIComponent(currentItemId)}`);
        
        console.log('Listing loaded:', res);
        
        if (!res.ok || !res.item) {
          throw new Error('Listing not found');
        }
        
        originalItem = res.item;
        
        // Use isInventoryListing from item data, or fall back to URL param
        if (originalItem.isInventoryListing === undefined && isInventoryListingParam) {
          originalItem.isInventoryListing = isInventoryListingParam === '1';
        }
        if (!originalItem.sku && skuParam) {
          originalItem.sku = skuParam;
        }
        
        console.log('Item loaded - isInventoryListing:', originalItem.isInventoryListing, 'SKU:', originalItem.sku);
        
        // Populate form
        $('title').value = originalItem.title || '';
        $('description').value = originalItem.description || '';
        $('price').value = originalItem.price || '';
        $('quantity').value = originalItem.quantity || '';
        $('condition').value = originalItem.condition || '1000';
        
        updateTitleCount();
        
        // Populate aspects
        if (originalItem.aspects && typeof originalItem.aspects === 'object') {
          Object.entries(originalItem.aspects).forEach(([key, values]) => {
            const valueStr = Array.isArray(values) ? values.join(', ') : values;
            addAspect(key, valueStr);
          });
        }
        
        // Show images with drag-and-drop reordering
        if (originalItem.images && Array.isArray(originalItem.images)) {
          const preview = $('imagesPreview');
          originalItem.images.forEach((url, index) => {
            const div = document.createElement('div');
            div.className = 'image-thumb';
            div.draggable = true;
            div.dataset.url = url;
            div.innerHTML = `
              <div class="image-order">${index + 1}</div>
              <img src="${url}" alt="Product image" />
            `;
            
            // Drag and drop event handlers
            div.addEventListener('dragstart', handleDragStart);
            div.addEventListener('dragend', handleDragEnd);
            div.addEventListener('dragover', handleDragOver);
            div.addEventListener('drop', handleDrop);
            div.addEventListener('dragleave', handleDragLeave);
            
            preview.appendChild(div);
          });
        }
        
        showFlash('Listing loaded successfully!', 'success');
        
      } catch (err) {
        console.error('Failed to load listing:', err);
        showFlash(`Error: ${err.message}`, 'error');
      }
    }
    
    // Drag and drop handlers for image reordering
    let draggedElement = null;
    
    function handleDragStart(e) {
      draggedElement = this;
      this.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
    }
    
    function handleDragEnd(e) {
      this.classList.remove('dragging');
      document.querySelectorAll('.image-thumb').forEach(el => {
        el.classList.remove('drag-over');
      });
      updateImageOrderLabels();
    }
    
    function handleDragOver(e) {
      if (e.preventDefault) e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
      return false;
    }
    
    function handleDrop(e) {
      if (e.stopPropagation) e.stopPropagation();
      
      if (draggedElement !== this) {
        const allImages = Array.from($('imagesPreview').children);
        const draggedIndex = allImages.indexOf(draggedElement);
        const targetIndex = allImages.indexOf(this);
        
        if (draggedIndex < targetIndex) {
          this.parentNode.insertBefore(draggedElement, this.nextSibling);
        } else {
          this.parentNode.insertBefore(draggedElement, this);
        }
      }
      
      this.classList.remove('drag-over');
      return false;
    }
    
    function handleDragLeave(e) {
      this.classList.remove('drag-over');
    }
    
    function updateImageOrderLabels() {
      document.querySelectorAll('.image-thumb').forEach((el, index) => {
        const orderLabel = el.querySelector('.image-order');
        if (orderLabel) orderLabel.textContent = index + 1;
      });
    }
    
    async function saveListing() {
      try {
        const btn = $('btnSave');
        btn.disabled = true;
        btn.textContent = 'Saving...';
        
        // Collect aspects
        const aspects = {};
        document.querySelectorAll('.aspect-item').forEach(item => {
          const key = item.querySelector('.aspect-key').value.trim();
          const value = item.querySelector('.aspect-value').value.trim();
          if (key && value) {
            // Split comma-separated values into array
            aspects[key] = value.includes(',') ? value.split(',').map(v => v.trim()) : [value];
          }
        });
        
        // Collect images in their current order
        const images = Array.from(document.querySelectorAll('.image-thumb')).map(el => el.dataset.url);
        
        const updatedListing = {
          itemId: currentItemId,
          sku: originalItem.sku,
          isInventoryListing: originalItem.isInventoryListing || false,
          title: $('title').value.trim(),
          description: $('description').value.trim(),
          price: parseFloat($('price').value) || 0,
          quantity: parseInt($('quantity').value) || 0,
          condition: $('condition').value,
          aspects,
          images, // Include reordered images
        };
        
        console.log('Saving listing:', updatedListing);
        
        // Save to backend
        const res = await fetchJSON('/.netlify/functions/ebay-update-active-item', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(updatedListing),
        });
        
        if (res.ok) {
          showFlash('Listing updated successfully!', 'success');
          setTimeout(() => window.location.href = '/active-listings', 1500);
        } else {
          throw new Error(res.error || 'Failed to update listing');
        }
        
      } catch (err) {
        console.error('Failed to save listing:', err);
        showFlash(`Error: ${err.message}`, 'error');
        $('btnSave').disabled = false;
        $('btnSave').textContent = 'Update Listing';
      }
    }
    
    $('title').addEventListener('input', updateTitleCount);
    
    function initUserMenu() {
      const userCard = document.getElementById('userCard');
      const userMenu = document.getElementById('userMenu');
      
      if (!userCard || !userMenu) return;
      
      userCard.addEventListener('click', (e) => {
        e.stopPropagation();
        const isVisible = userMenu.style.display !== 'none';
        userMenu.style.display = isVisible ? 'none' : 'block';
      });
      
      // Close menu when clicking outside
      document.addEventListener('click', (e) => {
        if (!userCard.contains(e.target) && !userMenu.contains(e.target)) {
          userMenu.style.display = 'none';
        }
      });
    }
    
    async function bootstrap() {
      try {
        // Wait for authClient to be available
        if (!window.authClient) {
          console.log('Waiting for authClient...');
          await new Promise(resolve => {
            const check = setInterval(() => {
              if (window.authClient) {
                clearInterval(check);
                resolve();
              }
            }, 100);
          });
        }
        
        const ok = await window.authClient.requireAuth();
        if (!ok) {
          showFlash('Authentication required. Redirecting to login...', 'error');
          return;
        }
        
        // Populate sidebar user info
        await window.authClient.updateUserDisplay().catch(() => {});
        
        await loadListing();
      } catch (e) {
        console.error('Bootstrap failed', e);
        showFlash(`Failed to load: ${e.message}`, 'error');
      }
    }
    
    initUserMenu();
    bootstrap();
  </script>
  
  <!-- Mobile Menu Script -->
  <script>
    (function() {
      const menuButton = document.getElementById('mobileMenuButton');
      const backdrop = document.getElementById('mobileBackdrop');
      const shell = document.querySelector('.dp-shell');
      
      if (menuButton && backdrop && shell) {
        backdrop.addEventListener('click', () => {
          shell.classList.remove('dp-shell--nav-open');
        });
        
        menuButton.addEventListener('click', () => {
          const willOpen = !shell.classList.contains('dp-shell--nav-open');
          shell.classList.toggle('dp-shell--nav-open', willOpen);
          menuButton.setAttribute('aria-expanded', willOpen);
        });
        
        const navLinks = document.querySelectorAll('.dp-sidebar a');
        navLinks.forEach(link => {
          link.addEventListener('click', () => {
            shell.classList.remove('dp-shell--nav-open');
          });
        });
      }
    })();
  </script>
</body>
</html>
