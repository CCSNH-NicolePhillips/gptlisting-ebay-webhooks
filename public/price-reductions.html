<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Price Reductions â€“ DraftPilot</title>
    <link rel="stylesheet" href="/draftpilot.css">
    <style>
      .dp-stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
      }
      .dp-stat-card {
        background: var(--bg-card);
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-md);
        padding: 1rem;
        text-align: center;
      }
      .dp-stat-value {
        font-size: 1.75rem;
        font-weight: 700;
        color: var(--accent);
      }
      .dp-stat-label {
        font-size: 0.75rem;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-top: 0.25rem;
      }
      .dp-filter-bar {
        display: flex;
        gap: 0.75rem;
        margin-bottom: 1.5rem;
        flex-wrap: wrap;
        align-items: center;
      }
      .dp-filter-btn {
        padding: 0.5rem 1rem;
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-md);
        background: transparent;
        color: var(--text-secondary);
        cursor: pointer;
        font-size: 0.875rem;
        transition: all 0.15s ease;
      }
      .dp-filter-btn:hover {
        border-color: var(--accent);
        color: var(--text-primary);
      }
      .dp-filter-btn.active {
        background: var(--accent);
        border-color: var(--accent);
        color: #fff;
      }
      .dp-table-container {
        background: var(--bg-card);
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-md);
        overflow: hidden;
      }
      .dp-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.875rem;
      }
      .dp-table th,
      .dp-table td {
        padding: 0.875rem 1rem;
        text-align: left;
        border-bottom: 1px solid var(--border-subtle);
      }
      .dp-table th {
        background: rgba(255,255,255,0.02);
        color: var(--text-muted);
        font-weight: 500;
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }
      .dp-table tr:last-child td {
        border-bottom: none;
      }
      .dp-table tr:hover td {
        background: rgba(255,255,255,0.02);
      }
      .dp-status-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.375rem;
        padding: 0.25rem 0.625rem;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 500;
      }
      .dp-status-badge--active {
        background: rgba(34,197,94,0.15);
        color: #22c55e;
      }
      .dp-status-badge--paused {
        background: rgba(234,179,8,0.15);
        color: #eab308;
      }
      .dp-status-badge--at_floor {
        background: rgba(168,85,247,0.15);
        color: #a855f7;
      }
      .dp-status-badge--no_offer {
        background: rgba(239,68,68,0.15);
        color: #ef4444;
      }
      .dp-price-current {
        font-weight: 600;
        color: var(--text-primary);
      }
      .dp-price-original {
        font-size: 0.75rem;
        color: var(--text-muted);
        text-decoration: line-through;
        margin-left: 0.375rem;
      }
      .dp-schedule-text {
        font-size: 0.8125rem;
        color: var(--text-secondary);
      }
      .dp-schedule-next {
        font-size: 0.75rem;
        color: var(--accent);
        margin-top: 0.25rem;
      }
      .dp-schedule-past {
        color: var(--text-muted);
      }
      .dp-btn-icon {
        background: transparent;
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-sm);
        padding: 0.375rem;
        cursor: pointer;
        color: var(--text-muted);
        transition: all 0.15s ease;
      }
      .dp-btn-icon:hover {
        border-color: var(--accent);
        color: var(--accent);
      }
      .dp-empty-state {
        text-align: center;
        padding: 3rem 1.5rem;
        color: var(--text-muted);
      }
      .dp-empty-state h3 {
        color: var(--text-secondary);
        margin-bottom: 0.5rem;
      }
      /* Modal */
      .dp-modal-backdrop {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.6);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.2s ease, visibility 0.2s ease;
      }
      .dp-modal-backdrop.open {
        opacity: 1;
        visibility: visible;
      }
      .dp-modal {
        background: var(--bg-card);
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-lg);
        width: 90%;
        max-width: 440px;
        padding: 1.5rem;
        transform: scale(0.95);
        transition: transform 0.2s ease;
      }
      .dp-modal-backdrop.open .dp-modal {
        transform: scale(1);
      }
      .dp-modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
      }
      .dp-modal-title {
        font-size: 1.125rem;
        font-weight: 600;
      }
      .dp-modal-close {
        background: transparent;
        border: none;
        color: var(--text-muted);
        cursor: pointer;
        padding: 0.25rem;
        font-size: 1.25rem;
      }
      .dp-modal-close:hover {
        color: var(--text-primary);
      }
      .dp-form-group {
        margin-bottom: 1rem;
      }
      .dp-form-label {
        display: block;
        font-size: 0.875rem;
        font-weight: 500;
        color: var(--text-secondary);
        margin-bottom: 0.375rem;
      }
      .dp-input {
        width: 100%;
        padding: 0.625rem 0.75rem;
        font-size: 0.9375rem;
        background: var(--bg-main);
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-md);
        color: var(--text-primary);
        box-sizing: border-box;
      }
      .dp-input:focus {
        outline: none;
        border-color: var(--accent);
      }
      .dp-input-hint {
        font-size: 0.75rem;
        color: var(--text-muted);
        margin-top: 0.25rem;
      }
      .dp-modal-actions {
        display: flex;
        gap: 0.75rem;
        justify-content: flex-end;
        margin-top: 1.5rem;
      }
      .dp-btn {
        padding: 0.625rem 1.25rem;
        border-radius: var(--radius-md);
        font-weight: 500;
        cursor: pointer;
        transition: all 0.15s ease;
        font-size: 0.875rem;
      }
      .dp-btn-primary {
        background: var(--accent);
        color: #fff;
        border: none;
      }
      .dp-btn-primary:hover {
        background: var(--accent-hover);
      }
      .dp-btn-secondary {
        background: transparent;
        border: 1px solid var(--border-subtle);
        color: var(--text-secondary);
      }
      .dp-btn-secondary:hover {
        border-color: var(--text-muted);
        color: var(--text-primary);
      }
      .dp-btn-danger {
        background: rgba(239,68,68,0.15);
        color: #ef4444;
        border: 1px solid transparent;
      }
      .dp-btn-danger:hover {
        background: #ef4444;
        color: #fff;
      }
      /* Toast */
      .dp-toast {
        position: fixed;
        bottom: 2rem;
        left: 50%;
        transform: translateX(-50%) translateY(20px);
        background: var(--bg-card);
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-md);
        padding: 0.75rem 1.25rem;
        font-size: 0.875rem;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        opacity: 0;
        visibility: hidden;
        transition: all 0.25s ease;
        z-index: 1100;
      }
      .dp-toast.show {
        opacity: 1;
        visibility: visible;
        transform: translateX(-50%) translateY(0);
      }
      .dp-toast.success {
        border-color: #22c55e;
        color: #22c55e;
      }
      .dp-toast.error {
        border-color: #ef4444;
        color: #ef4444;
      }
      @media (max-width: 768px) {
        .dp-table-container {
          overflow-x: auto;
        }
        .dp-table {
          min-width: 700px;
        }
      }
    </style>
  </head>
  <body>
    <script src="/auth-client.js"></script>
    <script src="/sidebar-toggle.js"></script>
    
    <div id="pageContent">
      <!-- Stats Grid -->
      <div class="dp-stats-grid" id="statsGrid">
        <div class="dp-stat-card">
          <div class="dp-stat-value" id="statActive">-</div>
          <div class="dp-stat-label">Active</div>
        </div>
        <div class="dp-stat-card">
          <div class="dp-stat-value" id="statAtFloor">-</div>
          <div class="dp-stat-label">At Floor</div>
        </div>
        <div class="dp-stat-card">
          <div class="dp-stat-value" id="statTotalReductions">-</div>
          <div class="dp-stat-label">Total Reductions</div>
        </div>
        <div class="dp-stat-card">
          <div class="dp-stat-value" id="statTotalSaved">-</div>
          <div class="dp-stat-label">Total Reduced</div>
        </div>
      </div>

      <!-- Filter Bar -->
      <div class="dp-filter-bar">
        <button class="dp-filter-btn active" data-filter="all">All</button>
        <button class="dp-filter-btn" data-filter="active">Active</button>
        <button class="dp-filter-btn" data-filter="at_floor">At Floor</button>
        <button class="dp-filter-btn" data-filter="paused">Paused</button>
        <div style="flex:1"></div>
        <button class="dp-filter-btn" id="refreshBtn" title="Refresh">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M1 4v6h6M23 20v-6h-6"/>
            <path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"/>
          </svg>
        </button>
      </div>

      <!-- Table -->
      <div class="dp-table-container">
        <table class="dp-table" id="listingsTable">
          <thead>
            <tr>
              <th>Product</th>
              <th>Price</th>
              <th>Status</th>
              <th>Schedule</th>
              <th>Next Reduction</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="listingsBody">
            <tr>
              <td colspan="6" class="dp-empty-state">
                <h3>Loading...</h3>
                <p>Fetching your price reduction data</p>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Edit Modal -->
    <div class="dp-modal-backdrop" id="editModal">
      <div class="dp-modal">
        <div class="dp-modal-header">
          <h2 class="dp-modal-title">Edit Price Reduction</h2>
          <button class="dp-modal-close" id="closeModal">&times;</button>
        </div>
        
        <div id="modalProductName" style="color:var(--text-muted); font-size:0.875rem; margin-bottom:1rem;"></div>
        
        <div class="dp-form-group">
          <label class="dp-form-label">Reduce By ($)</label>
          <input type="number" class="dp-input" id="editReduceBy" step="0.01" min="0.01" max="100" />
          <div class="dp-input-hint">Amount to reduce each time</div>
        </div>
        
        <div class="dp-form-group">
          <label class="dp-form-label">Every (days)</label>
          <input type="number" class="dp-input" id="editEveryDays" step="1" min="1" max="90" />
          <div class="dp-input-hint">How often to reduce</div>
        </div>
        
        <div class="dp-form-group">
          <label class="dp-form-label">Minimum Price ($)</label>
          <input type="number" class="dp-input" id="editMinPrice" step="0.01" min="0" />
          <div class="dp-input-hint">Stop reducing at this floor price</div>
        </div>
        
        <div class="dp-modal-actions">
          <button class="dp-btn dp-btn-danger" id="disableBtn">Disable</button>
          <div style="flex:1"></div>
          <button class="dp-btn dp-btn-secondary" id="cancelBtn">Cancel</button>
          <button class="dp-btn dp-btn-primary" id="saveBtn">Save Changes</button>
        </div>
      </div>
    </div>

    <!-- Toast -->
    <div class="dp-toast" id="toast"></div>

    <script src="/sidebar-shell.js"></script>
    <script>
      // Global state
      let allItems = [];
      let currentFilter = 'all';
      let editingItem = null;

      // Format helpers
      function formatPrice(val) {
        if (val == null) return '-';
        return '$' + val.toFixed(2);
      }

      function formatDate(ts) {
        if (!ts) return '-';
        const d = new Date(ts);
        const now = new Date();
        const diffMs = ts - now.getTime();
        const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
        
        if (diffDays === 0) {
          return 'Today';
        } else if (diffDays === 1) {
          return 'Tomorrow';
        } else if (diffDays === -1) {
          return 'Yesterday';
        } else if (diffDays > 1 && diffDays <= 7) {
          return `In ${diffDays} days`;
        } else if (diffDays < -1 && diffDays >= -7) {
          return `${Math.abs(diffDays)} days ago`;
        }
        
        return d.toLocaleDateString(undefined, { month: 'short', day: 'numeric' });
      }

      function statusLabel(status) {
        const labels = {
          'active': 'Active',
          'paused': 'Paused',
          'at_floor': 'At Floor',
          'no_offer': 'No Offer'
        };
        return labels[status] || status;
      }

      // Toast
      function showToast(message, type = 'success') {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.className = 'dp-toast show ' + type;
        setTimeout(() => {
          toast.className = 'dp-toast';
        }, 3000);
      }

      // Render table
      function renderTable() {
        const tbody = document.getElementById('listingsBody');
        
        let filtered = allItems;
        if (currentFilter !== 'all') {
          filtered = allItems.filter(item => item.status === currentFilter);
        }

        if (filtered.length === 0) {
          tbody.innerHTML = `
            <tr>
              <td colspan="6" class="dp-empty-state">
                <h3>No items found</h3>
                <p>${currentFilter === 'all' ? 'No price reductions configured yet' : 'No items with this status'}</p>
              </td>
            </tr>
          `;
          return;
        }

        tbody.innerHTML = filtered.map(item => {
          const isPast = item.nextReductionAt && item.nextReductionAt < Date.now();
          const nextClass = isPast ? 'dp-schedule-past' : '';
          
          return `
            <tr data-job-id="${item.jobId}" data-group-id="${item.groupId}">
              <td>
                <div style="font-weight:500; max-width:200px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">
                  ${item.title || item.sku || item.groupId}
                </div>
                <div style="font-size:0.75rem; color:var(--text-muted);">SKU: ${item.sku || '-'}</div>
              </td>
              <td>
                <span class="dp-price-current">${formatPrice(item.currentPrice)}</span>
                ${item.originalPrice && item.originalPrice !== item.currentPrice 
                  ? `<span class="dp-price-original">${formatPrice(item.originalPrice)}</span>` 
                  : ''}
              </td>
              <td>
                <span class="dp-status-badge dp-status-badge--${item.status}">
                  ${statusLabel(item.status)}
                </span>
              </td>
              <td>
                ${item.auto 
                  ? `<div class="dp-schedule-text">-$${item.auto.reduceBy.toFixed(2)} / ${item.auto.everyDays} day${item.auto.everyDays > 1 ? 's' : ''}</div>
                     <div class="dp-schedule-text" style="color:var(--text-muted)">Floor: ${formatPrice(item.auto.minPrice)}</div>`
                  : '<span style="color:var(--text-muted)">Not configured</span>'
                }
              </td>
              <td>
                ${item.status === 'active' && item.nextReductionAt
                  ? `<div class="dp-schedule-next ${nextClass}">${formatDate(item.nextReductionAt)}</div>`
                  : item.status === 'at_floor' 
                    ? '<span style="color:var(--text-muted)">Stopped</span>'
                    : '<span style="color:var(--text-muted)">-</span>'
                }
                ${item.reductionCount > 0 
                  ? `<div style="font-size:0.75rem; color:var(--text-muted)">${item.reductionCount} reduction${item.reductionCount > 1 ? 's' : ''}</div>`
                  : ''}
              </td>
              <td>
                <button class="dp-btn-icon edit-btn" title="Edit settings" data-index="${allItems.indexOf(item)}">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                  </svg>
                </button>
              </td>
            </tr>
          `;
        }).join('');

        // Attach edit handlers
        document.querySelectorAll('.edit-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            const idx = parseInt(btn.dataset.index, 10);
            openEditModal(allItems[idx]);
          });
        });
      }

      // Update stats
      function updateStats(summary) {
        document.getElementById('statActive').textContent = summary.active || 0;
        document.getElementById('statAtFloor').textContent = summary.atFloor || 0;
        document.getElementById('statTotalReductions').textContent = summary.totalReductions || 0;
        document.getElementById('statTotalSaved').textContent = formatPrice(summary.totalSaved || 0);
      }

      // Load data
      async function loadData() {
        try {
          const resp = await authClient.authFetch('/.netlify/functions/price-reduction-list');
          if (!resp.ok) {
            throw new Error('Failed to load data');
          }
          const data = await resp.json();
          allItems = data.items || [];
          updateStats(data.summary || {});
          renderTable();
        } catch (err) {
          console.error('Error loading data:', err);
          document.getElementById('listingsBody').innerHTML = `
            <tr>
              <td colspan="6" class="dp-empty-state">
                <h3>Error loading data</h3>
                <p>${err.message}</p>
              </td>
            </tr>
          `;
        }
      }

      // Modal functions
      function openEditModal(item) {
        editingItem = item;
        const modal = document.getElementById('editModal');
        
        document.getElementById('modalProductName').textContent = item.title || item.sku || item.groupId;
        
        if (item.auto) {
          document.getElementById('editReduceBy').value = item.auto.reduceBy;
          document.getElementById('editEveryDays').value = item.auto.everyDays;
          document.getElementById('editMinPrice').value = item.auto.minPrice;
        } else {
          document.getElementById('editReduceBy').value = '1.00';
          document.getElementById('editEveryDays').value = '7';
          document.getElementById('editMinPrice').value = '5.00';
        }
        
        modal.classList.add('open');
      }

      function closeEditModal() {
        document.getElementById('editModal').classList.remove('open');
        editingItem = null;
      }

      async function saveEdit() {
        if (!editingItem) return;
        
        const reduceBy = parseFloat(document.getElementById('editReduceBy').value);
        const everyDays = parseInt(document.getElementById('editEveryDays').value, 10);
        const minPrice = parseFloat(document.getElementById('editMinPrice').value);

        if (isNaN(reduceBy) || reduceBy <= 0 || reduceBy > 100) {
          showToast('Reduce by must be between $0.01 and $100', 'error');
          return;
        }
        if (isNaN(everyDays) || everyDays < 1 || everyDays > 90) {
          showToast('Days must be between 1 and 90', 'error');
          return;
        }
        if (isNaN(minPrice) || minPrice < 0) {
          showToast('Minimum price must be $0 or more', 'error');
          return;
        }

        try {
          const resp = await authClient.authFetch('/.netlify/functions/price-reduction-update', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              jobId: editingItem.jobId,
              groupId: editingItem.groupId,
              auto: { reduceBy, everyDays, minPrice }
            })
          });

          if (!resp.ok) {
            const err = await resp.json();
            throw new Error(err.error || 'Failed to save');
          }

          showToast('Settings saved successfully');
          closeEditModal();
          await loadData();
        } catch (err) {
          showToast(err.message, 'error');
        }
      }

      async function disableReduction() {
        if (!editingItem) return;
        
        if (!confirm('Disable automatic price reduction for this item?')) return;

        try {
          const resp = await authClient.authFetch('/.netlify/functions/price-reduction-update', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              jobId: editingItem.jobId,
              groupId: editingItem.groupId,
              auto: null
            })
          });

          if (!resp.ok) {
            const err = await resp.json();
            throw new Error(err.error || 'Failed to disable');
          }

          showToast('Price reduction disabled');
          closeEditModal();
          await loadData();
        } catch (err) {
          showToast(err.message, 'error');
        }
      }

      // Init
      document.addEventListener('DOMContentLoaded', async () => {
        // Init sidebar
        DraftPilotShell.init({
          title: 'Price Reductions',
          subtitle: 'Manage automatic price reduction settings',
          activePage: 'price-reductions'
        });

        // Filter buttons
        document.querySelectorAll('.dp-filter-btn[data-filter]').forEach(btn => {
          btn.addEventListener('click', () => {
            document.querySelectorAll('.dp-filter-btn[data-filter]').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            currentFilter = btn.dataset.filter;
            renderTable();
          });
        });

        // Refresh button
        document.getElementById('refreshBtn').addEventListener('click', loadData);

        // Modal handlers
        document.getElementById('closeModal').addEventListener('click', closeEditModal);
        document.getElementById('cancelBtn').addEventListener('click', closeEditModal);
        document.getElementById('saveBtn').addEventListener('click', saveEdit);
        document.getElementById('disableBtn').addEventListener('click', disableReduction);
        
        // Close modal on backdrop click
        document.getElementById('editModal').addEventListener('click', (e) => {
          if (e.target.id === 'editModal') closeEditModal();
        });

        // Load data
        await loadData();
      });
    </script>
  </body>
</html>
