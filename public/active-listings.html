<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Active Listings â€“ DraftPilot</title>
  <link rel="stylesheet" href="/draftpilot.css">
  <style>
    .flash {
      min-height: 1.25rem;
      color: var(--muted);
      margin-bottom: 0.6rem;
    }
    .flash.error {
      color: #ffb4b4;
    }
    .toolbar {
      display: flex;
      gap: 0.5rem;
      align-items: center;
      margin-bottom: 1rem;
    }
    .btn {
      background: var(--primary);
      color: #fff;
      border: none;
      border-radius: 10px;
      padding: 0.55rem 0.85rem;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 1px 0 rgba(0, 0, 0, 0.25);
    }
    .btn:hover {
      background: var(--primary-600);
    }
    .btn.secondary {
      background: transparent;
      color: #cbd5ff;
      border: 1px solid var(--line);
      box-shadow: none;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 1.5rem;
      align-items: flex-start;
      margin-top: 1.5rem;
    }
    @media (min-width: 1280px) {
      .grid {
        grid-template-columns: repeat(4, minmax(0, 1fr));
      }
    }
    .card {
      display: flex;
      flex-direction: column;
      background: var(--dp-surface-elevated, #020617);
      border-radius: 18px;
      padding: 0.9rem;
      border: 1px solid rgba(148, 163, 184, 0.15);
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.45);
      transition: transform 0.15s ease-out, box-shadow 0.15s ease-out, border-color 0.15s ease-out;
      gap: 0.5rem;
      height: 100%;
      min-height: 520px;
    }
    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 22px 55px rgba(15, 23, 42, 0.6);
      border-color: rgba(94, 234, 212, 0.5);
    }
    .card-flash {
      min-height: 1.1rem;
      font-size: 0.85rem;
      color: var(--muted);
    }
    .card-flash.success {
      color: var(--success);
    }
    .card-flash.error {
      color: #ffb4b4;
    }
    .card-title {
      font-weight: 600;
      font-size: 0.98rem;
      line-height: 1.35;
      margin-bottom: 0.3rem;
      min-height: 2.7rem;
      max-height: 2.7rem;
      overflow: hidden;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
    }
    .card-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 0.45rem;
      font-size: 0.85rem;
      color: var(--muted);
      margin-bottom: 0.3rem;
    }
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      padding: 0.18rem 0.55rem;
      border-radius: 999px;
      border: 1px solid var(--line);
      font-size: 0.78rem;
    }
    .pill {
      padding: 0.15rem 0.45rem;
      border-radius: 8px;
      background: rgba(94, 234, 212, 0.08);
      color: #d6e1ff;
      font-size: 0.8rem;
    }
    .promo-control {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      margin-top: 0.4rem;
      padding-top: 0.5rem;
      border-top: 1px solid rgba(148, 163, 184, 0.1);
    }
    .promo-status {
      display: flex;
      gap: 0.4rem;
      align-items: center;
      font-size: 0.85rem;
      color: var(--muted);
    }
    .promo-edit-form {
      display: flex;
      gap: 0.4rem;
      align-items: center;
      flex-wrap: wrap;
    }
    .promo-control input {
      width: 90px;
      padding: 0.35rem 0.45rem;
      border-radius: 8px;
      border: 1px solid var(--line);
      background: #0f1529;
      color: #f4f6fb;
      font-size: 0.9rem;
    }
    .promo-control .btn {
      padding: 0.4rem 0.65rem;
      font-size: 0.82rem;
    }
    .promo-control .btn.danger {
      background: rgba(239, 68, 68, 0.15);
      color: #fca5a5;
      border: 1px solid rgba(239, 68, 68, 0.3);
    }
    .promo-control .btn.danger:hover {
      background: rgba(239, 68, 68, 0.25);
    }
    .loading {
      display: flex;
      align-items: center;
      gap: 0.6rem;
      color: var(--muted);
      margin: 2rem 0;
    }
    .spinner {
      width: 26px;
      height: 26px;
      border: 3px solid rgba(255,255,255,0.15);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .empty-state {
      text-align: center;
      padding: 3rem 1rem;
      color: var(--muted);
    }
    .empty-state h3 {
      margin-bottom: 0.5rem;
      color: var(--text-primary);
    }
  </style>
</head>
<body>
  <script src="/auth-client.js"></script>
  
  <div id="pageContent">
    <div class="dp-card">
      <div class="flash" id="flash"></div>
      
      <div class="toolbar">
        <button class="btn secondary" id="btnRefresh">â†» Refresh</button>
        <select id="sortSelect" style="padding: 0.5rem 0.8rem; border-radius: 6px; background: #0f1529; border: 1px solid #2a335c; color: #f4f6fb; font-size: 0.9rem; cursor: pointer;">
          <option value="newest">Newest First</option>
          <option value="oldest">Oldest First</option>
          <option value="title-asc">Title (A-Z)</option>
          <option value="title-desc">Title (Z-A)</option>
          <option value="price-high">Price (High to Low)</option>
          <option value="price-low">Price (Low to High)</option>
          <option value="sold-high">Most Sold</option>
          <option value="sold-low">Least Sold</option>
          <option value="popular">Most Popular (Views)</option>
          <option value="watched">Most Watched</option>
        </select>
        <div style="flex: 1;"></div>
        <div id="counts" style="color: var(--muted); font-size: 0.9rem;"></div>
      </div>
      
      <div id="loading" class="loading" style="display:none;">
        <div class="spinner"></div>
        <span>Loading active listings...</span>
      </div>
      
      <div id="grid" class="grid"></div>
      
      <div id="emptyState" class="empty-state" style="display:none;">
        <h3>No Active Listings</h3>
        <p>You don't have any published listings on eBay yet.</p>
        <p style="margin-top: 1rem;">
          <a href="/quick-list.html" class="btn">Create Your First Listing</a>
        </p>
      </div>
    </div>
  </div>

  <script src="/sidebar-shell.js"></script>
  <script>
    DraftPilotShell.init({
      title: 'Active Listings',
      subtitle: 'Manage your live eBay listings and promotions',
      activePage: 'active-listings',
      showSearch: false
    });
  </script>
  
  <script type="module">
    const flash = document.getElementById('flash');
    const grid = document.getElementById('grid');
    const loading = document.getElementById('loading');
    const counts = document.getElementById('counts');
    const emptyState = document.getElementById('emptyState');
    const sortSelect = document.getElementById('sortSelect');

    let allOffers = []; // Store all offers for sorting
    
    function getAuthFetch() {
      return (window.authClient && typeof window.authClient.authFetch === 'function') 
        ? window.authClient.authFetch 
        : fetch;
    }

    function sortOffers(offers, sortBy) {
      const sorted = [...offers];
      
      switch(sortBy) {
        case 'newest':
          sorted.sort((a, b) => (b.startTime || '').localeCompare(a.startTime || ''));
          break;
        case 'oldest':
          sorted.sort((a, b) => (a.startTime || '').localeCompare(b.startTime || ''));
          break;
        case 'title-asc':
          sorted.sort((a, b) => (a.title || '').localeCompare(b.title || ''));
          break;
        case 'title-desc':
          sorted.sort((a, b) => (b.title || '').localeCompare(a.title || ''));
          break;
        case 'price-high':
          sorted.sort((a, b) => parseFloat(b.price?.value || '0') - parseFloat(a.price?.value || '0'));
          break;
        case 'price-low':
          sorted.sort((a, b) => parseFloat(a.price?.value || '0') - parseFloat(b.price?.value || '0'));
          break;
        case 'sold-high':
          sorted.sort((a, b) => (b.quantitySold || 0) - (a.quantitySold || 0));
          break;
        case 'sold-low':
          sorted.sort((a, b) => (a.quantitySold || 0) - (b.quantitySold || 0));
          break;
        case 'popular':
          sorted.sort((a, b) => (b.hitCount || 0) - (a.hitCount || 0));
          break;
        case 'watched':
          sorted.sort((a, b) => (b.watchCount || 0) - (a.watchCount || 0));
          break;
      }
      
      return sorted;
    }

    function renderGrid(offers) {
      grid.innerHTML = '';
      const sorted = sortOffers(offers, sortSelect.value);
      sorted.forEach(o => {
        grid.appendChild(renderCard(o));
      });
    }

    sortSelect.addEventListener('change', () => {
      if (allOffers.length > 0) {
        renderGrid(allOffers);
      }
    });

    function fmtPrice(p) {
      if (!p) return '';
      try {
        return new Intl.NumberFormat('en-US', { 
          style: 'currency', 
          currency: p.currency || 'USD' 
        }).format(Number(p.value));
      } catch {
        return `${p.value || ''} ${p.currency || ''}`;
      }
    }

    function renderCard(o) {
      const card = document.createElement('div');
      card.className = 'card';

      // Add image thumbnail if available
      if (o.imageUrl) {
        const imgContainer = document.createElement('div');
        imgContainer.style.width = '100%';
        imgContainer.style.height = '180px';
        imgContainer.style.marginBottom = '0.8rem';
        imgContainer.style.overflow = 'hidden';
        imgContainer.style.borderRadius = '6px';
        imgContainer.style.backgroundColor = '#2a2a2a';
        
        const img = document.createElement('img');
        img.src = o.imageUrl;
        img.alt = o.title || 'Product image';
        img.style.width = '100%';
        img.style.height = '100%';
        img.style.objectFit = 'contain';
        img.style.objectPosition = 'center';
        
        imgContainer.appendChild(img);
        card.appendChild(imgContainer);
      }

      const localFlash = document.createElement('div');
      localFlash.className = 'card-flash';
      card.appendChild(localFlash);

      const title = document.createElement('div');
      title.className = 'card-title';
      title.textContent = o.title || o.sku || '(untitled)';
      card.appendChild(title);

      const meta = document.createElement('div');
      meta.className = 'card-meta';
      const metaParts = [];
      if (o.sku) metaParts.push(`SKU: ${o.sku}`);
      if (o.listingId) metaParts.push(`ID: ${o.listingId}`);
      meta.textContent = metaParts.join(' â€¢ ');
      card.appendChild(meta);

      const priceLine = document.createElement('div');
      priceLine.className = 'card-meta';
      const priceParts = [];
      if (o.price) priceParts.push(fmtPrice(o.price));
      if (o.availableQuantity != null) priceParts.push(`Qty: ${o.availableQuantity}`);
      priceLine.textContent = priceParts.join(' â€¢ ');
      card.appendChild(priceLine);

      const badges = document.createElement('div');
      badges.style.display = 'flex';
      badges.style.gap = '0.4rem';
      badges.style.flexWrap = 'wrap';
      badges.style.marginTop = '0.3rem';

      const statusBadge = document.createElement('span');
      statusBadge.className = 'badge';
      statusBadge.textContent = o.listingStatus || 'ACTIVE';
      badges.appendChild(statusBadge);

      if (o.autoPromote) {
        const promoBadge = document.createElement('span');
        promoBadge.className = 'pill';
        promoBadge.textContent = `Promoted ${o.autoPromoteAdRate ? o.autoPromoteAdRate + '%' : ''}`.trim();
        badges.appendChild(promoBadge);
      }

      card.appendChild(badges);

      // Promotion control
      const promoControl = document.createElement('div');
      promoControl.className = 'promo-control';

      // Check if already promoted
      const isPromoted = o.autoPromote && o.autoPromoteAdRate != null;
      
      if (isPromoted) {
        // Show current promotion status
        const statusDiv = document.createElement('div');
        statusDiv.className = 'promo-status';
        statusDiv.innerHTML = `<strong>ðŸ“¢ Promoted at ${o.autoPromoteAdRate}%</strong>`;
        promoControl.appendChild(statusDiv);
        
        // Edit form (initially hidden)
        const editForm = document.createElement('div');
        editForm.className = 'promo-edit-form';
        editForm.style.display = 'none';
        
        const rateInput = document.createElement('input');
        rateInput.type = 'number';
        rateInput.inputMode = 'decimal';
        rateInput.min = '0.1';
        rateInput.max = '100';
        rateInput.step = '0.1';
        rateInput.value = String(o.autoPromoteAdRate);
        rateInput.placeholder = 'Rate %';
        editForm.appendChild(rateInput);
        
        const saveBtn = document.createElement('button');
        saveBtn.className = 'btn secondary';
        saveBtn.textContent = 'Save';
        editForm.appendChild(saveBtn);
        
        const cancelBtn = document.createElement('button');
        cancelBtn.className = 'btn secondary';
        cancelBtn.textContent = 'Cancel';
        editForm.appendChild(cancelBtn);
        
        promoControl.appendChild(editForm);
        
        // Action buttons (initially visible)
        const actionsDiv = document.createElement('div');
        actionsDiv.className = 'promo-edit-form';
        
        const changeBtn = document.createElement('button');
        changeBtn.className = 'btn secondary';
        changeBtn.textContent = 'Change Rate';
        actionsDiv.appendChild(changeBtn);
        
        const removeBtn = document.createElement('button');
        removeBtn.className = 'btn danger';
        removeBtn.textContent = 'Remove Promotion';
        actionsDiv.appendChild(removeBtn);
        
        promoControl.appendChild(actionsDiv);
        
        // Toggle edit mode
        changeBtn.addEventListener('click', () => {
          actionsDiv.style.display = 'none';
          editForm.style.display = 'flex';
          rateInput.focus();
        });
        
        cancelBtn.addEventListener('click', () => {
          editForm.style.display = 'none';
          actionsDiv.style.display = 'flex';
          rateInput.value = String(o.autoPromoteAdRate);
        });
        
        // Save changes
        saveBtn.addEventListener('click', async () => {
          const val = parseFloat(rateInput.value);
          if (!Number.isFinite(val) || val < 0.1 || val > 100) {
            localFlash.textContent = 'Enter a rate between 0.1 and 100';
            localFlash.className = 'card-flash error';
            return;
          }
          
          saveBtn.disabled = true;
          saveBtn.textContent = 'Saving...';
          localFlash.textContent = '';
          localFlash.className = 'card-flash';
          
          try {
            const exec = getAuthFetch();
            const res = await exec('/.netlify/functions/ebay-update-active-promo', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ 
                listingId: o.listingId, 
                offerId: o.offerId, 
                sku: o.sku, 
                adRate: val 
              }),
            });
            const txt = await res.text();
            const data = txt ? JSON.parse(txt) : {};
            
            if (!res.ok || !data.ok) {
              localFlash.textContent = data?.error || `Save failed (${res.status})`;
              localFlash.className = 'card-flash error';
              return;
            }
            
            // Update UI
            o.autoPromoteAdRate = val;
            statusDiv.innerHTML = `<strong>ðŸ“¢ Promoted at ${val}%</strong>`;
            editForm.style.display = 'none';
            actionsDiv.style.display = 'flex';
            
            localFlash.textContent = `âœ“ Updated to ${val}%`;
            localFlash.className = 'card-flash success';
            setTimeout(() => {
              localFlash.textContent = '';
              localFlash.className = 'card-flash';
            }, 3000);
          } catch (e) {
            localFlash.textContent = e?.message || String(e);
            localFlash.className = 'card-flash error';
          } finally {
            saveBtn.disabled = false;
            saveBtn.textContent = 'Save';
          }
        });
        
        // Remove promotion
        removeBtn.addEventListener('click', async () => {
          if (!confirm('Remove this listing from promotion?')) return;
          
          removeBtn.disabled = true;
          removeBtn.textContent = 'Removing...';
          localFlash.textContent = '';
          localFlash.className = 'card-flash';
          
          try {
            const exec = getAuthFetch();
            const res = await exec('/.netlify/functions/ebay-remove-promo', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ 
                listingId: o.listingId, 
                offerId: o.offerId, 
                sku: o.sku
              }),
            });
            const txt = await res.text();
            const data = txt ? JSON.parse(txt) : {};
            
            if (!res.ok || !data.ok) {
              localFlash.textContent = data?.error || `Remove failed (${res.status})`;
              localFlash.className = 'card-flash error';
              return;
            }
            
            // Reload the page to show updated state
            localFlash.textContent = 'âœ“ Promotion removed - refreshing...';
            localFlash.className = 'card-flash success';
            setTimeout(() => load(), 1500);
          } catch (e) {
            localFlash.textContent = e?.message || String(e);
            localFlash.className = 'card-flash error';
          } finally {
            removeBtn.disabled = false;
            removeBtn.textContent = 'Remove Promotion';
          }
        });
        
      } else {
        // Not promoted - show promotion form
        const statusDiv = document.createElement('div');
        statusDiv.className = 'promo-status';
        statusDiv.textContent = 'Not promoted';
        promoControl.appendChild(statusDiv);
        
        const editForm = document.createElement('div');
        editForm.className = 'promo-edit-form';
        editForm.style.display = 'none';
        
        const label = document.createElement('label');
        label.textContent = 'Ad Rate:';
        label.style.fontSize = '0.85rem';
        label.style.color = 'var(--muted)';
        editForm.appendChild(label);
        
        const rateInput = document.createElement('input');
        rateInput.type = 'number';
        rateInput.inputMode = 'decimal';
        rateInput.min = '0.1';
        rateInput.max = '100';
        rateInput.step = '0.1';
        rateInput.value = '5';
        rateInput.placeholder = '5.0';
        editForm.appendChild(rateInput);
        
        const saveBtn = document.createElement('button');
        saveBtn.className = 'btn primary';
        saveBtn.textContent = 'Create';
        editForm.appendChild(saveBtn);
        
        const cancelBtn = document.createElement('button');
        cancelBtn.className = 'btn secondary';
        cancelBtn.textContent = 'Cancel';
        editForm.appendChild(cancelBtn);
        
        promoControl.appendChild(editForm);
        
        const promoteBtn = document.createElement('button');
        promoteBtn.className = 'btn primary';
        promoteBtn.textContent = 'ðŸ“¢ Promote This Listing';
        promoteBtn.style.width = '100%';
        promoControl.appendChild(promoteBtn);
        
        // Show promotion form
        promoteBtn.addEventListener('click', () => {
          promoteBtn.style.display = 'none';
          editForm.style.display = 'flex';
          rateInput.focus();
        });
        
        cancelBtn.addEventListener('click', () => {
          editForm.style.display = 'none';
          promoteBtn.style.display = 'block';
          rateInput.value = '5';
        });
        
        // Create promotion
        saveBtn.addEventListener('click', async () => {
          const val = parseFloat(rateInput.value);
          if (!Number.isFinite(val) || val < 0.1 || val > 100) {
            localFlash.textContent = 'Enter a rate between 0.1 and 100';
            localFlash.className = 'card-flash error';
            return;
          }
          saveBtn.disabled = true;
          saveBtn.textContent = 'Creating...';
          localFlash.textContent = '';
          localFlash.className = 'card-flash';
          
          try {
            const exec = getAuthFetch();
            const res = await exec('/.netlify/functions/ebay-update-active-promo', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ 
                listingId: o.listingId, 
                offerId: o.offerId, 
                sku: o.sku, 
                adRate: val 
              }),
            });
            const txt = await res.text();
            const data = txt ? JSON.parse(txt) : {};
            
            if (!res.ok || !data.ok) {
              localFlash.textContent = data?.error || `Create failed (${res.status})`;
              localFlash.className = 'card-flash error';
              return;
            }
            
            // Reload to show updated state
            localFlash.textContent = `âœ“ Promotion created at ${val}% - refreshing...`;
            localFlash.className = 'card-flash success';
            setTimeout(() => load(), 1500);
          } catch (e) {
            localFlash.textContent = e?.message || String(e);
            localFlash.className = 'card-flash error';
          } finally {
            saveBtn.disabled = false;
            saveBtn.textContent = 'Create';
          }
        });
      }

      card.appendChild(promoControl);
      
      // Edit button
      const editBtn = document.createElement('button');
      editBtn.className = 'btn primary';
      editBtn.textContent = 'Edit Listing';
      editBtn.style.marginTop = '0.75rem';
      editBtn.style.width = '100%';
      editBtn.addEventListener('click', () => {
        const params = new URLSearchParams({
          itemId: o.itemId,
          isInventoryListing: o.isInventoryListing ? '1' : '0',
          sku: o.sku || ''
        });
        window.location.href = `/edit-active-listing.html?${params.toString()}`;
      });
      card.appendChild(editBtn);
      
      return card;
    }

    async function load() {
      flash.textContent = '';
      flash.className = 'flash';
      loading.style.display = 'flex';
      grid.innerHTML = '';
      counts.textContent = '';
      emptyState.style.display = 'none';

      try {
        // Use Trading API endpoint which gets ALL listings (not just Inventory API ones)
        const exec = getAuthFetch();
        const res = await exec('/.netlify/functions/ebay-list-active-trading');
        const text = await res.text();

        if (res.status === 401) {
          flash.textContent = 'Unauthorized â€“ please sign in and ensure your eBay account is connected.';
          flash.className = 'flash error';
          return;
        }

        let data = {};
        try {
          data = text ? JSON.parse(text) : {};
        } catch {
          flash.textContent = text || `Error ${res.status}`;
          flash.className = 'flash error';
          return;
        }

        if (!res.ok || !data.ok) {
          flash.textContent = data?.error || `Error ${res.status}`;
          flash.className = 'flash error';
          return;
        }

        const offers = Array.isArray(data.offers) ? data.offers : [];
        allOffers = offers; // Store for sorting
        counts.textContent = `${offers.length} active listing${offers.length === 1 ? '' : 's'}`;
        
        if (!offers.length) {
          emptyState.style.display = 'block';
          return;
        }

        renderGrid(offers);
      } catch (e) {
        flash.textContent = e?.message || String(e);
        flash.className = 'flash error';
      } finally {
        loading.style.display = 'none';
      }
    }

    document.getElementById('btnRefresh')?.addEventListener('click', () => load());
    
    // Load on page ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', load);
    } else {
      load();
    }
  </script>
</body>
</html>
