<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Active Listings â€“ DraftPilot</title>
  <link rel="stylesheet" href="/draftpilot.css">
  <style>
    .flash {
      min-height: 1.25rem;
      color: var(--muted);
      margin-bottom: 0.6rem;
    }
    .flash.error {
      color: #ffb4b4;
    }
    .toolbar {
      display: flex;
      gap: 0.5rem;
      align-items: center;
      margin-bottom: 1rem;
    }
    .search-input {
      padding: 0.55rem 0.85rem;
      border-radius: 10px;
      background: #0f1529;
      border: 1px solid #2a335c;
      color: #f4f6fb;
      font-size: 0.9rem;
      min-width: 250px;
      transition: border-color 0.2s ease;
    }
    .search-input:focus {
      outline: none;
      border-color: var(--primary);
    }
    .search-input::placeholder {
      color: var(--muted);
    }
    .btn {
      background: var(--primary);
      color: #fff;
      border: none;
      border-radius: 10px;
      padding: 0.55rem 0.85rem;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 1px 0 rgba(0, 0, 0, 0.25);
    }
    .btn:hover {
      background: var(--primary-600);
    }
    .btn.secondary {
      background: transparent;
      color: #cbd5ff;
      border: 1px solid var(--line);
      box-shadow: none;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 1.5rem;
      align-items: flex-start;
      margin-top: 1.5rem;
    }
    @media (min-width: 1280px) {
      .grid {
        grid-template-columns: repeat(4, minmax(0, 1fr));
      }
    }
    .card {
      display: flex;
      flex-direction: column;
      background: var(--dp-surface-elevated, #020617);
      border-radius: 18px;
      padding: 0.9rem;
      border: 1px solid rgba(148, 163, 184, 0.15);
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.45);
      transition: transform 0.15s ease-out, box-shadow 0.15s ease-out, border-color 0.15s ease-out;
      gap: 0.5rem;
      height: 100%;
      min-height: 520px;
    }
    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 22px 55px rgba(15, 23, 42, 0.6);
      border-color: rgba(94, 234, 212, 0.5);
    }
    .card-flash {
      min-height: 1.1rem;
      font-size: 0.85rem;
      color: var(--muted);
    }
    .card-flash.success {
      color: var(--success);
    }
    .card-flash.error {
      color: #ffb4b4;
    }
    .card-title {
      font-weight: 600;
      font-size: 0.98rem;
      line-height: 1.35;
      margin-bottom: 0.3rem;
      min-height: 2.7rem;
      max-height: 2.7rem;
      overflow: hidden;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
    }
    .card-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 0.45rem;
      font-size: 0.85rem;
      color: var(--muted);
      margin-bottom: 0.3rem;
    }
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      padding: 0.18rem 0.55rem;
      border-radius: 999px;
      border: 1px solid var(--line);
      font-size: 0.78rem;
    }
    .pill {
      padding: 0.15rem 0.45rem;
      border-radius: 8px;
      background: rgba(94, 234, 212, 0.08);
      color: #d6e1ff;
      font-size: 0.8rem;
    }
    .promo-control {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      margin-top: 0.4rem;
      padding-top: 0.5rem;
      border-top: 1px solid rgba(148, 163, 184, 0.1);
    }
    .promo-status {
      display: flex;
      gap: 0.4rem;
      align-items: center;
      font-size: 0.85rem;
      color: var(--muted);
    }
    .promo-edit-form {
      display: flex;
      gap: 0.4rem;
      align-items: center;
      flex-wrap: wrap;
    }
    .promo-control input {
      width: 90px;
      padding: 0.35rem 0.45rem;
      border-radius: 8px;
      border: 1px solid var(--line);
      background: #0f1529;
      color: #f4f6fb;
      font-size: 0.9rem;
    }
    .promo-control .btn {
      padding: 0.4rem 0.65rem;
      font-size: 0.82rem;
    }
    .promo-control .btn.danger {
      background: rgba(239, 68, 68, 0.15);
      color: #fca5a5;
      border: 1px solid rgba(239, 68, 68, 0.3);
    }
    .promo-control .btn.danger:hover {
      background: rgba(239, 68, 68, 0.25);
    }
    .loading {
      display: flex;
      align-items: center;
      gap: 0.6rem;
      color: var(--muted);
      margin: 2rem 0;
    }
    .spinner {
      width: 26px;
      height: 26px;
      border: 3px solid rgba(255,255,255,0.15);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .empty-state {
      text-align: center;
      padding: 3rem 1rem;
      color: var(--muted);
    }
    .empty-state h3 {
      margin-bottom: 0.5rem;
      color: var(--text-primary);
    }
    /* Multi-select styles */
    .card-checkbox {
      position: absolute;
      top: 0.6rem;
      left: 0.6rem;
      width: 20px;
      height: 20px;
      cursor: pointer;
      accent-color: var(--primary);
      z-index: 10;
      opacity: 0;
      transition: opacity 0.15s ease;
    }
    .card:hover .card-checkbox,
    .card.selected .card-checkbox {
      opacity: 1;
    }
    .card.selected {
      background: linear-gradient(135deg, rgba(99, 102, 241, 0.15) 0%, rgba(139, 92, 246, 0.1) 100%);
      border-color: var(--primary);
      box-shadow: 0 0 0 1px rgba(99, 102, 241, 0.4), 0 18px 40px rgba(15, 23, 42, 0.45);
    }
    
    .card.selected {
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.3), 0 18px 40px rgba(15, 23, 42, 0.45);
    }
    .card.selected .card-checkbox {
      opacity: 1;
    }
    .bulk-action-bar {
      display: none;
      position: sticky;
      top: 0;
      z-index: 100;
      background: linear-gradient(135deg, #1e1b4b 0%, #312e81 100%);
      border: 1px solid var(--primary);
      border-radius: 12px;
      padding: 0.75rem 1rem;
      margin-bottom: 1rem;
      align-items: center;
      gap: 1rem;
      box-shadow: 0 4px 20px rgba(99, 102, 241, 0.3);
    }
    .bulk-action-bar.show {
      display: flex;
    }
    .bulk-action-bar .select-all-wrap {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .bulk-action-bar .select-all-wrap input {
      width: 18px;
      height: 18px;
      accent-color: var(--primary);
      cursor: pointer;
    }
    .bulk-action-bar .selected-count {
      font-weight: 600;
      color: #fff;
      min-width: 120px;
    }
    .bulk-action-bar .bulk-actions {
      display: flex;
      gap: 0.5rem;
      margin-left: auto;
    }
    .bulk-action-bar .btn {
      padding: 0.4rem 0.8rem;
      font-size: 0.85rem;
    }
  </style>
</head>
<body>
  <script src="/auth-client.js"></script>
  <script src="/sidebar-toggle.js"></script>
  
  <!-- Main Dashboard Shell -->
  <div class="dp-shell" id="mainCard">
    <!-- Sidebar -->
    <aside class="dp-sidebar">
      <!-- Brand Area -->
      <div class="dp-sidebar__brand">
        <img src="logo/LogoWhiteText_NoBg.png" alt="DraftPilot - AI Listing Studio" class="dp-brand-logo" />
      </div>
      
      <!-- Navigation -->
      <nav class="dp-sidebar__nav">
        <!-- Primary Navigation Group -->
        <div class="dp-nav-group">
          <div class="dp-nav-group__label">APP</div>
          <a href="/index.html" class="dp-nav-item">
            <svg class="dp-nav-item__icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="3" width="7" height="7"></rect>
              <rect x="14" y="3" width="7" height="7"></rect>
              <rect x="14" y="14" width="7" height="7"></rect>
              <rect x="3" y="14" width="7" height="7"></rect>
            </svg>
            <span class="dp-nav-item__label">Overview</span>
          </a>
          <a href="/quick-list.html" class="dp-nav-item">
            <svg class="dp-nav-item__icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="12" y1="5" x2="12" y2="19"></line>
              <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
            <span class="dp-nav-item__label">Create Listings</span>
          </a>
          <a href="/drafts.html" class="dp-nav-item">
            <svg class="dp-nav-item__icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
              <polyline points="14 2 14 8 20 8"></polyline>
              <line x1="16" y1="13" x2="8" y2="13"></line>
              <line x1="16" y1="17" x2="8" y2="17"></line>
              <polyline points="10 9 9 9 8 9"></polyline>
            </svg>
            <span class="dp-nav-item__label">Drafts</span>
          </a>
          <a href="/active-listings.html" class="dp-nav-item dp-nav-item--active">
            <svg class="dp-nav-item__icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
            </svg>
            <span class="dp-nav-item__label">Active Listings</span>
          </a>
        </div>

        <!-- Account Navigation Group -->
        <div class="dp-nav-group">
          <div class="dp-nav-group__label">ACCOUNT</div>
          <a href="/policies-manage.html" class="dp-nav-item">
            <svg class="dp-nav-item__icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
              <polyline points="14 2 14 8 20 8"></polyline>
              <line x1="12" y1="18" x2="12" y2="12"></line>
              <line x1="9" y1="15" x2="15" y2="15"></line>
            </svg>
            <span class="dp-nav-item__label">eBay Policies</span>
          </a>
          <a href="/location.html" class="dp-nav-item">
            <svg class="dp-nav-item__icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
              <circle cx="12" cy="10" r="3"></circle>
            </svg>
            <span class="dp-nav-item__label">Inventory Locations</span>
          </a>
          <a href="/settings.html" class="dp-nav-item">
            <svg class="dp-nav-item__icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="3"></circle>
              <path d="M12 1v6m0 6v6m5.2-15.8l-4.2 4.2m-2 2l-4.2 4.2M23 12h-6m-6 0H1m15.8 5.2l-4.2-4.2m-2-2l-4.2-4.2"></path>
            </svg>
            <span class="dp-nav-item__label">Settings</span>
          </a>
          <a href="/faq.html" class="dp-nav-item">
            <svg class="dp-nav-item__icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"></circle>
              <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
              <line x1="12" y1="17" x2="12.01" y2="17"></line>
            </svg>
            <span class="dp-nav-item__label">FAQ</span>
          </a>
          <a href="/support.html" class="dp-nav-item">
            <svg class="dp-nav-item__icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
            </svg>
            <span class="dp-nav-item__label">Support</span>
          </a>
        </div>
      </nav>
      
      <!-- Sidebar Spacer -->
      <div class="dp-sidebar__spacer"></div>
      
      <!-- User Footer at Bottom -->
      <div class="dp-sidebar__footer">
        <div class="dp-user-card" id="sidebarUserCard">
          <div class="dp-user-card__avatar" id="sidebarAvatar">U</div>
          <div class="dp-user-card__info">
            <div class="dp-user-card__name" id="sidebarUserName">User</div>
            <div class="dp-user-card__email" id="sidebarUserEmail">user@example.com</div>
          </div>
        </div>
        <div class="dp-user-menu" id="sidebarUserMenu" style="display:none;">
          <a href="/logout.html" class="dp-user-menu__item">Sign out</a>
        </div>
      </div>
    </aside>
    
    <!-- Mobile Backdrop -->
    <div class="dp-backdrop" id="mobileBackdrop"></div>
    
    <!-- Main wrapper (topbar + content) -->
    <div class="dp-main-wrapper">
      <!-- Top Bar -->
      <header class="dp-topbar">
        <!-- Left: Mobile menu + Page Title & Subtitle -->
        <div class="dp-topbar-left">
          <!-- Mobile-only hamburger -->
          <button
            class="dp-topbar-icon dp-topbar-icon--menu"
            id="mobileMenuButton"
            aria-label="Open navigation"
            aria-expanded="false"
            type="button"
          >
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="4" y1="6" x2="20" y2="6"></line>
              <line x1="4" y1="12" x2="20" y2="12"></line>
              <line x1="4" y1="18" x2="20" y2="18"></line>
            </svg>
          </button>

          <div class="dp-topbar-heading">
            <h1 class="dp-topbar__title">Active Listings</h1>
            <p class="dp-topbar__subtitle">
              Manage your live eBay listings
            </p>
          </div>
        </div>
        
        <!-- Center: Search -->
        <div class="dp-topbar-center">
          <div class="dp-search">
            <svg class="dp-search__icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="11" cy="11" r="8"></circle>
              <path d="m21 21-4.35-4.35"></path>
            </svg>
            <input type="text" class="dp-search__input" placeholder="Search drafts, SKUs, or notesâ€¦" />
          </div>
        </div>
        
        <!-- Right: Icon Cluster -->
        <div class="dp-topbar-right">
          <button class="dp-topbar-icon" title="Theme Toggle" aria-label="Toggle theme">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="5"></circle>
              <line x1="12" y1="1" x2="12" y2="3"></line>
              <line x1="12" y1="21" x2="12" y2="23"></line>
              <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
              <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
              <line x1="1" y1="12" x2="3" y2="12"></line>
              <line x1="21" y1="12" x2="23" y2="12"></line>
              <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
              <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
            </svg>
          </button>
          <button class="dp-topbar-icon" title="Notifications" aria-label="View notifications">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
              <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
            </svg>
          </button>
          <div class="dp-topbar-avatar" id="topbarAvatar" title="User menu">U</div>
        </div>
      </header>
      
      <!-- Main Content Area -->
      <main class="dp-main">
        <div class="dp-card">
          <div class="dp-card__content">
      <div class="flash" id="flash"></div>
      
      <div class="toolbar">
        <button class="btn secondary" id="btnRefresh">â†» Refresh</button>
        <input 
          type="text" 
          id="searchInput" 
          class="search-input" 
          placeholder="ðŸ” Search by title or SKU..."
        />
        <select id="sortSelect" style="padding: 0.5rem 0.8rem; border-radius: 6px; background: #0f1529; border: 1px solid #2a335c; color: #f4f6fb; font-size: 0.9rem; cursor: pointer;">
          <option value="newest">Newest First</option>
          <option value="oldest">Oldest First</option>
          <option value="title-asc">Title (A-Z)</option>
          <option value="title-desc">Title (Z-A)</option>
          <option value="price-high">Price (High to Low)</option>
          <option value="price-low">Price (Low to High)</option>
          <option value="sold-high">Most Sold</option>
          <option value="sold-low">Least Sold</option>
          <option value="popular">Most Popular (Views)</option>
          <option value="watched">Most Watched</option>
        </select>
        <div style="flex: 1;"></div>
        <div id="counts" style="color: var(--muted); font-size: 0.9rem;"></div>
      </div>
      
      <!-- Bulk Action Bar -->
      <div id="bulkActionBar" class="bulk-action-bar">
        <div class="select-all-wrap">
          <input type="checkbox" id="selectAll" title="Select all">
          <label for="selectAll" style="cursor: pointer; color: #cbd5ff;">Select All</label>
        </div>
        <span class="selected-count" id="selectedCount">0 selected</span>
        <div class="bulk-actions">
          <button class="btn" id="bulkPromote" title="Promote selected listings">ðŸ“¢ Promote</button>
          <button class="btn danger" id="bulkEnd" title="End selected listings">End Listings</button>
        </div>
      </div>
      
      <div id="loading" class="loading" style="display:none;">
        <div class="spinner"></div>
        <span>Loading active listings...</span>
      </div>
      
      <div id="grid" class="grid"></div>
      
      <div id="emptyState" class="empty-state" style="display:none;">
        <h3>No Active Listings</h3>
        <p>You don't have any published listings on eBay yet.</p>
        <p style="margin-top: 1rem;">
          <a href="/quick-list.html" class="btn">Create Your First Listing</a>
        </p>
      </div>
    </div>
  </div>

  <script src="/sidebar-shell.js"></script>
  <script>
    DraftPilotShell.init({
      title: 'Active Listings',
      subtitle: 'Manage your live eBay listings and promotions',
      activePage: 'active-listings',
      showSearch: false
    });
  </script>
  
  <script type="module">
    const flash = document.getElementById('flash');
    const grid = document.getElementById('grid');
    const loading = document.getElementById('loading');
    const counts = document.getElementById('counts');
    const emptyState = document.getElementById('emptyState');
    const sortSelect = document.getElementById('sortSelect');
    const searchInput = document.getElementById('searchInput');

    let allOffers = []; // Store all offers for sorting
    let filteredOffers = []; // Store filtered offers for display
    
    function getAuthFetch() {
      return (window.authClient && typeof window.authClient.authFetch === 'function') 
        ? window.authClient.authFetch 
        : fetch;
    }

    function updateCounts() {
      const totalCount = allOffers.length;
      const filteredCount = filteredOffers.length;
      
      if (searchInput.value.trim() && filteredCount < totalCount) {
        counts.textContent = `Showing ${filteredCount} of ${totalCount} listing${totalCount === 1 ? '' : 's'}`;
      } else {
        counts.textContent = `${totalCount} active listing${totalCount === 1 ? '' : 's'}`;
      }
    }

    function sortOffers(offers, sortBy) {
      const sorted = [...offers];
      
      switch(sortBy) {
        case 'newest':
          sorted.sort((a, b) => (b.startTime || '').localeCompare(a.startTime || ''));
          break;
        case 'oldest':
          sorted.sort((a, b) => (a.startTime || '').localeCompare(b.startTime || ''));
          break;
        case 'title-asc':
          sorted.sort((a, b) => (a.title || '').localeCompare(b.title || ''));
          break;
        case 'title-desc':
          sorted.sort((a, b) => (b.title || '').localeCompare(a.title || ''));
          break;
        case 'price-high':
          sorted.sort((a, b) => parseFloat(b.price?.value || '0') - parseFloat(a.price?.value || '0'));
          break;
        case 'price-low':
          sorted.sort((a, b) => parseFloat(a.price?.value || '0') - parseFloat(b.price?.value || '0'));
          break;
        case 'sold-high':
          sorted.sort((a, b) => (b.quantitySold || 0) - (a.quantitySold || 0));
          break;
        case 'sold-low':
          sorted.sort((a, b) => (a.quantitySold || 0) - (b.quantitySold || 0));
          break;
        case 'popular':
          sorted.sort((a, b) => (b.hitCount || 0) - (a.hitCount || 0));
          break;
        case 'watched':
          sorted.sort((a, b) => (b.watchCount || 0) - (a.watchCount || 0));
          break;
      }
      
      return sorted;
    }

    function filterOffers(offers, searchTerm) {
      if (!searchTerm || searchTerm.trim() === '') {
        return offers;
      }
      
      const term = searchTerm.toLowerCase().trim();
      return offers.filter(o => {
        const title = (o.title || '').toLowerCase();
        const sku = (o.sku || '').toLowerCase();
        return title.includes(term) || sku.includes(term);
      });
    }

    function renderGrid(offers) {
      grid.innerHTML = '';
      const filtered = filterOffers(offers, searchInput.value);
      filteredOffers = filtered;
      const sorted = sortOffers(filtered, sortSelect.value);
      
      // Update counts to show filtered/total
      updateCounts();
      
      if (sorted.length === 0 && offers.length > 0) {
        grid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 3rem; color: var(--muted);">No listings match your search</div>';
        return;
      }
      
      sorted.forEach(o => {
        grid.appendChild(renderCard(o));
      });
    }

    sortSelect.addEventListener('change', () => {
      if (allOffers.length > 0) {
        renderGrid(allOffers);
      }
    });

    searchInput.addEventListener('input', () => {
      if (allOffers.length > 0) {
        renderGrid(allOffers);
      }
    });

    function fmtPrice(p) {
      if (!p) return '';
      try {
        return new Intl.NumberFormat('en-US', { 
          style: 'currency', 
          currency: p.currency || 'USD' 
        }).format(Number(p.value));
      } catch {
        return `${p.value || ''} ${p.currency || ''}`;
      }
    }

    function renderCard(o) {
      const card = document.createElement('div');
      card.className = 'card';
      card.dataset.listingId = o.listingId || '';
      card.dataset.offerId = o.offerId || '';
      card.dataset.sku = o.sku || '';

      // Add image thumbnail if available
      if (o.imageUrl) {
        const imgContainer = document.createElement('div');
        imgContainer.style.width = '100%';
        imgContainer.style.height = '180px';
        imgContainer.style.marginBottom = '0.8rem';
        imgContainer.style.overflow = 'visible'; // Allow checkbox to be visible
        imgContainer.style.borderRadius = '6px';
        imgContainer.style.backgroundColor = '#2a2a2a';
        imgContainer.style.position = 'relative';
        
        // Multi-select checkbox (inside image container)
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.className = 'card-checkbox';
        checkbox.title = 'Select this listing';
        checkbox.addEventListener('change', () => {
          card.classList.toggle('selected', checkbox.checked);
          updateBulkActionBar();
        });
        checkbox.addEventListener('click', (e) => e.stopPropagation());
        imgContainer.appendChild(checkbox);
        
        const img = document.createElement('img');
        img.src = o.imageUrl;
        img.alt = o.title || 'Product image';
        img.style.width = '100%';
        img.style.height = '100%';
        img.style.objectFit = 'contain';
        img.style.objectPosition = 'center';
        img.style.borderRadius = '6px';
        
        imgContainer.appendChild(img);
        card.appendChild(imgContainer);
      } else {
        // No image - add checkbox directly to card with placeholder
        const imgContainer = document.createElement('div');
        imgContainer.style.width = '100%';
        imgContainer.style.height = '180px';
        imgContainer.style.marginBottom = '0.8rem';
        imgContainer.style.borderRadius = '6px';
        imgContainer.style.backgroundColor = '#2a2a2a';
        imgContainer.style.position = 'relative';
        imgContainer.style.display = 'flex';
        imgContainer.style.alignItems = 'center';
        imgContainer.style.justifyContent = 'center';
        imgContainer.style.color = 'var(--muted)';
        imgContainer.textContent = 'No image';
        
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.className = 'card-checkbox';
        checkbox.title = 'Select this listing';
        checkbox.addEventListener('change', () => {
          card.classList.toggle('selected', checkbox.checked);
          updateBulkActionBar();
        });
        checkbox.addEventListener('click', (e) => e.stopPropagation());
        imgContainer.appendChild(checkbox);
        card.appendChild(imgContainer);
      }

      const localFlash = document.createElement('div');
      localFlash.className = 'card-flash';
      card.appendChild(localFlash);

      const title = document.createElement('div');
      title.className = 'card-title';
      title.textContent = o.title || o.sku || '(untitled)';
      card.appendChild(title);

      const meta = document.createElement('div');
      meta.className = 'card-meta';
      const metaParts = [];
      if (o.sku) metaParts.push(`SKU: ${o.sku}`);
      if (o.listingId) metaParts.push(`ID: ${o.listingId}`);
      meta.textContent = metaParts.join(' â€¢ ');
      card.appendChild(meta);

      const priceLine = document.createElement('div');
      priceLine.className = 'card-meta';
      const priceParts = [];
      if (o.price) priceParts.push(fmtPrice(o.price));
      if (o.availableQuantity != null) priceParts.push(`Qty: ${o.availableQuantity}`);
      priceLine.textContent = priceParts.join(' â€¢ ');
      card.appendChild(priceLine);

      const badges = document.createElement('div');
      badges.style.display = 'flex';
      badges.style.gap = '0.4rem';
      badges.style.flexWrap = 'wrap';
      badges.style.marginTop = '0.3rem';

      const statusBadge = document.createElement('span');
      statusBadge.className = 'badge';
      statusBadge.textContent = o.listingStatus || 'ACTIVE';
      badges.appendChild(statusBadge);

      if (o.autoPromote) {
        const promoBadge = document.createElement('span');
        promoBadge.className = 'pill';
        promoBadge.textContent = `Promoted ${o.autoPromoteAdRate ? o.autoPromoteAdRate + '%' : ''}`.trim();
        badges.appendChild(promoBadge);
      }

      if (o.bestOfferEnabled) {
        const bestOfferBadge = document.createElement('span');
        bestOfferBadge.className = 'pill';
        bestOfferBadge.style.background = '#d97706';
        bestOfferBadge.textContent = `Best Offer${o.bestOfferCount ? ' (' + o.bestOfferCount + ')' : ''}`;
        badges.appendChild(bestOfferBadge);
      }

      card.appendChild(badges);

      // Promotion control
      const promoControl = document.createElement('div');
      promoControl.className = 'promo-control';

      // Check if already promoted
      const isPromoted = o.autoPromote && o.autoPromoteAdRate != null;
      
      if (isPromoted) {
        // Show current promotion status
        const statusDiv = document.createElement('div');
        statusDiv.className = 'promo-status';
        statusDiv.innerHTML = `<strong>ðŸ“¢ Promoted at ${o.autoPromoteAdRate}%</strong>`;
        promoControl.appendChild(statusDiv);
        
        // Edit form (initially hidden)
        const editForm = document.createElement('div');
        editForm.className = 'promo-edit-form';
        editForm.style.display = 'none';
        
        const rateInput = document.createElement('input');
        rateInput.type = 'number';
        rateInput.inputMode = 'decimal';
        rateInput.min = '0.1';
        rateInput.max = '100';
        rateInput.step = '0.1';
        rateInput.value = String(o.autoPromoteAdRate);
        rateInput.placeholder = 'Rate %';
        editForm.appendChild(rateInput);
        
        const saveBtn = document.createElement('button');
        saveBtn.className = 'btn secondary';
        saveBtn.textContent = 'Save';
        editForm.appendChild(saveBtn);
        
        const cancelBtn = document.createElement('button');
        cancelBtn.className = 'btn secondary';
        cancelBtn.textContent = 'Cancel';
        editForm.appendChild(cancelBtn);
        
        promoControl.appendChild(editForm);
        
        // Action buttons (initially visible)
        const actionsDiv = document.createElement('div');
        actionsDiv.className = 'promo-edit-form';
        
        const changeBtn = document.createElement('button');
        changeBtn.className = 'btn secondary';
        changeBtn.textContent = 'Change Rate';
        actionsDiv.appendChild(changeBtn);
        
        const removeBtn = document.createElement('button');
        removeBtn.className = 'btn danger';
        removeBtn.textContent = 'Remove Promotion';
        actionsDiv.appendChild(removeBtn);
        
        promoControl.appendChild(actionsDiv);
        
        // Toggle edit mode
        changeBtn.addEventListener('click', () => {
          actionsDiv.style.display = 'none';
          editForm.style.display = 'flex';
          rateInput.focus();
        });
        
        cancelBtn.addEventListener('click', () => {
          editForm.style.display = 'none';
          actionsDiv.style.display = 'flex';
          rateInput.value = String(o.autoPromoteAdRate);
        });
        
        // Save changes
        saveBtn.addEventListener('click', async () => {
          const val = parseFloat(rateInput.value);
          if (!Number.isFinite(val) || val < 0.1 || val > 100) {
            localFlash.textContent = 'Enter a rate between 0.1 and 100';
            localFlash.className = 'card-flash error';
            return;
          }
          
          saveBtn.disabled = true;
          saveBtn.textContent = 'Saving...';
          localFlash.textContent = '';
          localFlash.className = 'card-flash';
          
          try {
            const exec = getAuthFetch();
            const res = await exec('/.netlify/functions/ebay-update-active-promo', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ 
                listingId: o.listingId, 
                offerId: o.offerId, 
                sku: o.sku, 
                adRate: val 
              }),
            });
            const txt = await res.text();
            const data = txt ? JSON.parse(txt) : {};
            
            if (!res.ok || !data.ok) {
              localFlash.textContent = data?.error || `Save failed (${res.status})`;
              localFlash.className = 'card-flash error';
              return;
            }
            
            // Update UI
            o.autoPromoteAdRate = val;
            statusDiv.innerHTML = `<strong>ðŸ“¢ Promoted at ${val}%</strong>`;
            editForm.style.display = 'none';
            actionsDiv.style.display = 'flex';
            
            localFlash.textContent = `âœ“ Updated to ${val}%`;
            localFlash.className = 'card-flash success';
            setTimeout(() => {
              localFlash.textContent = '';
              localFlash.className = 'card-flash';
            }, 3000);
          } catch (e) {
            localFlash.textContent = e?.message || String(e);
            localFlash.className = 'card-flash error';
          } finally {
            saveBtn.disabled = false;
            saveBtn.textContent = 'Save';
          }
        });
        
        // Remove promotion
        removeBtn.addEventListener('click', async () => {
          if (!confirm('Remove this listing from promotion?')) return;
          
          removeBtn.disabled = true;
          removeBtn.textContent = 'Removing...';
          localFlash.textContent = '';
          localFlash.className = 'card-flash';
          
          try {
            const exec = getAuthFetch();
            const res = await exec('/.netlify/functions/ebay-remove-promo', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ 
                listingId: o.listingId, 
                offerId: o.offerId, 
                sku: o.sku
              }),
            });
            const txt = await res.text();
            const data = txt ? JSON.parse(txt) : {};
            
            if (!res.ok || !data.ok) {
              localFlash.textContent = data?.error || `Remove failed (${res.status})`;
              localFlash.className = 'card-flash error';
              return;
            }
            
            // Reload the page to show updated state
            localFlash.textContent = 'âœ“ Promotion removed - refreshing...';
            localFlash.className = 'card-flash success';
            setTimeout(() => load(), 1500);
          } catch (e) {
            localFlash.textContent = e?.message || String(e);
            localFlash.className = 'card-flash error';
          } finally {
            removeBtn.disabled = false;
            removeBtn.textContent = 'Remove Promotion';
          }
        });
        
      } else {
        // Not promoted - show promotion form
        const statusDiv = document.createElement('div');
        statusDiv.className = 'promo-status';
        statusDiv.textContent = 'Not promoted';
        promoControl.appendChild(statusDiv);
        
        const editForm = document.createElement('div');
        editForm.className = 'promo-edit-form';
        editForm.style.display = 'none';
        
        const label = document.createElement('label');
        label.textContent = 'Ad Rate:';
        label.style.fontSize = '0.85rem';
        label.style.color = 'var(--muted)';
        editForm.appendChild(label);
        
        const rateInput = document.createElement('input');
        rateInput.type = 'number';
        rateInput.inputMode = 'decimal';
        rateInput.min = '0.1';
        rateInput.max = '100';
        rateInput.step = '0.1';
        rateInput.value = '5';
        rateInput.placeholder = '5.0';
        editForm.appendChild(rateInput);
        
        const saveBtn = document.createElement('button');
        saveBtn.className = 'btn primary';
        saveBtn.textContent = 'Create';
        editForm.appendChild(saveBtn);
        
        const cancelBtn = document.createElement('button');
        cancelBtn.className = 'btn secondary';
        cancelBtn.textContent = 'Cancel';
        editForm.appendChild(cancelBtn);
        
        promoControl.appendChild(editForm);
        
        const promoteBtn = document.createElement('button');
        promoteBtn.className = 'btn primary';
        promoteBtn.textContent = 'ðŸ“¢ Promote This Listing';
        promoteBtn.style.width = '100%';
        promoControl.appendChild(promoteBtn);
        
        // Show promotion form
        promoteBtn.addEventListener('click', () => {
          promoteBtn.style.display = 'none';
          editForm.style.display = 'flex';
          rateInput.focus();
        });
        
        cancelBtn.addEventListener('click', () => {
          editForm.style.display = 'none';
          promoteBtn.style.display = 'block';
          rateInput.value = '5';
        });
        
        // Create promotion
        saveBtn.addEventListener('click', async () => {
          const val = parseFloat(rateInput.value);
          if (!Number.isFinite(val) || val < 0.1 || val > 100) {
            localFlash.textContent = 'Enter a rate between 0.1 and 100';
            localFlash.className = 'card-flash error';
            return;
          }
          saveBtn.disabled = true;
          saveBtn.textContent = 'Creating...';
          localFlash.textContent = '';
          localFlash.className = 'card-flash';
          
          try {
            const exec = getAuthFetch();
            const res = await exec('/.netlify/functions/ebay-update-active-promo', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ 
                listingId: o.listingId, 
                offerId: o.offerId, 
                sku: o.sku, 
                adRate: val 
              }),
            });
            const txt = await res.text();
            const data = txt ? JSON.parse(txt) : {};
            
            if (!res.ok || !data.ok) {
              localFlash.textContent = data?.error || `Create failed (${res.status})`;
              localFlash.className = 'card-flash error';
              return;
            }
            
            // Reload to show updated state
            localFlash.textContent = `âœ“ Promotion created at ${val}% - refreshing...`;
            localFlash.className = 'card-flash success';
            setTimeout(() => load(), 1500);
          } catch (e) {
            localFlash.textContent = e?.message || String(e);
            localFlash.className = 'card-flash error';
          } finally {
            saveBtn.disabled = false;
            saveBtn.textContent = 'Create';
          }
        });
      }

      card.appendChild(promoControl);
      
      // Button row container
      const btnRow = document.createElement('div');
      btnRow.style.cssText = 'display: flex; gap: 0.5rem; margin-top: 0.75rem;';
      
      // Edit button
      const editBtn = document.createElement('button');
      editBtn.className = 'btn primary';
      editBtn.textContent = 'Edit';
      editBtn.style.flex = '1';
      editBtn.addEventListener('click', () => {
        const params = new URLSearchParams({
          itemId: o.itemId,
          isInventoryListing: o.isInventoryListing ? '1' : '0',
          sku: o.sku || ''
        });
        window.location.href = `/edit-active-listing.html?${params.toString()}`;
      });
      btnRow.appendChild(editBtn);
      
      // Delete button
      const deleteBtn = document.createElement('button');
      deleteBtn.className = 'btn secondary';
      deleteBtn.textContent = 'End';
      deleteBtn.style.flex = '1';
      deleteBtn.style.color = '#ffb4b4';
      deleteBtn.style.borderColor = 'rgba(255, 180, 180, 0.3)';
      deleteBtn.addEventListener('click', async () => {
        if (!confirm(`End this listing?\n\n"${o.title}"\n\nThis will remove it from eBay. This action cannot be undone.`)) {
          return;
        }
        
        deleteBtn.disabled = true;
        deleteBtn.textContent = 'Ending...';
        localFlash.textContent = '';
        
        try {
          const exec = getAuthFetch();
          const res = await exec('/.netlify/functions/ebay-end-listing', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              itemId: o.itemId,
              sku: o.sku || '',
              offerId: o.offerId || '',
              isInventoryListing: !!o.isInventoryListing,
              reason: 'NotAvailable'
            }),
          });
          
          const data = await res.json();
          
          if (!res.ok || !data.ok) {
            localFlash.textContent = data?.error || `Failed to end listing (${res.status})`;
            localFlash.className = 'card-flash error';
            deleteBtn.disabled = false;
            deleteBtn.textContent = 'End';
            return;
          }
          
          localFlash.textContent = 'âœ“ Listing ended - refreshing...';
          localFlash.className = 'card-flash success';
          setTimeout(() => load(), 1500);
        } catch (e) {
          localFlash.textContent = e?.message || String(e);
          localFlash.className = 'card-flash error';
          deleteBtn.disabled = false;
          deleteBtn.textContent = 'End';
        }
      });
      btnRow.appendChild(deleteBtn);
      
      card.appendChild(btnRow);
      
      return card;
    }

    async function load() {
      flash.textContent = '';
      flash.className = 'flash';
      loading.style.display = 'flex';
      grid.innerHTML = '';
      counts.textContent = '';
      emptyState.style.display = 'none';

      try {
        // Use Trading API endpoint which gets ALL listings (not just Inventory API ones)
        const exec = getAuthFetch();
        const res = await exec('/.netlify/functions/ebay-list-active-trading');
        const text = await res.text();

        if (res.status === 401) {
          flash.textContent = 'Unauthorized â€“ please sign in and ensure your eBay account is connected.';
          flash.className = 'flash error';
          return;
        }

        let data = {};
        try {
          data = text ? JSON.parse(text) : {};
        } catch {
          flash.textContent = text || `Error ${res.status}`;
          flash.className = 'flash error';
          return;
        }

        if (!res.ok || !data.ok) {
          flash.textContent = data?.error || `Error ${res.status}`;
          flash.className = 'flash error';
          return;
        }

        const offers = Array.isArray(data.offers) ? data.offers : [];
        allOffers = offers; // Store for sorting
        filteredOffers = offers; // Initially all offers are visible
        updateCounts();
        
        if (!offers.length) {
          emptyState.style.display = 'block';
          return;
        }

        renderGrid(offers);
      } catch (e) {
        flash.textContent = e?.message || String(e);
        flash.className = 'flash error';
      } finally {
        loading.style.display = 'none';
      }
    }

    document.getElementById('btnRefresh')?.addEventListener('click', () => load());
    
    // ========================================================================
    // Multi-select and Bulk Actions
    // ========================================================================
    const bulkActionBar = document.getElementById('bulkActionBar');
    const selectAllCheckbox = document.getElementById('selectAll');
    const selectedCountEl = document.getElementById('selectedCount');
    const bulkPromoteBtn = document.getElementById('bulkPromote');
    const bulkEndBtn = document.getElementById('bulkEnd');
    
    function getSelectedCards() {
      return Array.from(grid.querySelectorAll('.card.selected'));
    }
    
    function getSelectedListings() {
      return getSelectedCards().map(card => ({
        listingId: card.dataset.listingId,
        offerId: card.dataset.offerId,
        sku: card.dataset.sku,
        title: card.querySelector('.card-title')?.textContent || '',
      })).filter(l => l.listingId);
    }
    
    function updateBulkActionBar() {
      const selected = getSelectedCards();
      const count = selected.length;
      
      if (count > 0) {
        bulkActionBar.classList.add('show');
        selectedCountEl.textContent = `${count} selected`;
      } else {
        bulkActionBar.classList.remove('show');
        if (selectAllCheckbox) selectAllCheckbox.checked = false;
      }
      
      // Update bar's select all checkbox state
      const allCheckboxes = grid.querySelectorAll('.card-checkbox');
      const allChecked = allCheckboxes.length > 0 && 
        Array.from(allCheckboxes).every(cb => cb.checked);
      if (selectAllCheckbox) {
        selectAllCheckbox.checked = allChecked;
        selectAllCheckbox.indeterminate = count > 0 && !allChecked;
      }
    }
    
    // Select All in bulk action bar
    selectAllCheckbox?.addEventListener('change', () => {
      const checkboxes = grid.querySelectorAll('.card-checkbox');
      checkboxes.forEach(cb => {
        cb.checked = selectAllCheckbox.checked;
        cb.closest('.card')?.classList.toggle('selected', selectAllCheckbox.checked);
      });
      updateBulkActionBar();
    });
    
    bulkPromoteBtn?.addEventListener('click', async () => {
      const listings = getSelectedListings();
      if (listings.length === 0) return;
      
      const rate = prompt(`Enter ad rate % for ${listings.length} listing(s):`, '5');
      if (rate === null) return;
      
      const adRate = parseFloat(rate);
      if (isNaN(adRate) || adRate < 0.1 || adRate > 100) {
        flash.textContent = 'Invalid ad rate. Must be between 0.1 and 100.';
        flash.className = 'flash error';
        return;
      }
      
      flash.textContent = `Promoting ${listings.length} listing(s) at ${adRate}%...`;
      flash.className = 'flash';
      
      let successCount = 0;
      let errorCount = 0;
      const exec = getAuthFetch();
      
      for (const listing of listings) {
        try {
          const res = await exec('/.netlify/functions/ebay-update-active-promo', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
              listingId: listing.listingId,
              offerId: listing.offerId,
              sku: listing.sku,
              adRate: adRate,
            }),
          });
          
          if (res.ok) {
            successCount++;
          } else {
            errorCount++;
          }
        } catch {
          errorCount++;
        }
      }
      
      // Clear selection
      grid.querySelectorAll('.card.selected').forEach(card => {
        card.classList.remove('selected');
        card.querySelector('.card-checkbox').checked = false;
      });
      updateBulkActionBar();
      
      if (errorCount === 0) {
        flash.textContent = `âœ“ Successfully promoted ${successCount} listing(s)`;
        flash.className = 'flash';
      } else {
        flash.textContent = `Promoted ${successCount}, failed ${errorCount}`;
        flash.className = 'flash error';
      }
      
      // Reload to show updated promo status
      setTimeout(() => load(), 1500);
    });
    
    bulkEndBtn?.addEventListener('click', async () => {
      const listings = getSelectedListings();
      if (listings.length === 0) return;
      
      const confirmed = confirm(`Are you sure you want to END ${listings.length} listing(s)? This will remove them from eBay.`);
      if (!confirmed) return;
      
      flash.textContent = `Ending ${listings.length} listing(s)...`;
      flash.className = 'flash';
      
      let successCount = 0;
      let errorCount = 0;
      const exec = getAuthFetch();
      
      for (const listing of listings) {
        try {
          const res = await exec('/.netlify/functions/ebay-end-listing', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ listingId: listing.listingId }),
          });
          
          if (res.ok) {
            successCount++;
            // Remove card from grid
            const card = grid.querySelector(`.card[data-listing-id="${listing.listingId}"]`);
            card?.remove();
          } else {
            errorCount++;
          }
        } catch {
          errorCount++;
        }
      }
      
      updateBulkActionBar();
      
      if (errorCount === 0) {
        flash.textContent = `âœ“ Successfully ended ${successCount} listing(s)`;
        flash.className = 'flash';
      } else {
        flash.textContent = `Ended ${successCount}, failed ${errorCount}`;
        flash.className = 'flash error';
      }
    });
    
    // Load on page ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', load);
    } else {
      load();
    }
  </script>
          </div>
        </div>
      </main>
    </div>
  </div>
</body>
</html>
