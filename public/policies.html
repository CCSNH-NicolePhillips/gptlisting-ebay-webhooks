<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Policies · GPTListing</title>
    <style>
      body {
        font-family:
          system-ui,
          -apple-system,
          Segoe UI,
          Roboto,
          Arial,
          sans-serif;
        margin: 0;
        padding: 2rem;
        background: #0b1020;
        color: #f4f6fb;
      }
      .card {
        max-width: 760px;
        margin: 0 auto;
        background: #141a33;
        border: 1px solid #2a335c;
        border-radius: 12px;
        padding: 1.5rem;
      }
      .muted {
        color: #a2a9c8;
      }
      button {
        background: #4f7cff;
        color: white;
        border: none;
        border-radius: 8px;
        padding: 0.7rem 1rem;
        cursor: pointer;
        font-weight: 600;
      }
      button.secondary {
        background: transparent;
        color: #cbd5ff;
        border: 1px solid #3d4a86;
      }
      a {
        color: #a8c1ff;
      }
      select,
      input {
        background: #0f1530;
        color: #f4f6fb;
        border: 1px solid #26305a;
        border-radius: 8px;
        padding: 0.5rem;
      }
    </style>
  </head>
  <body>
    <script src="/auth-client.js"></script>
    <div class="card">
      <h2>Business policies</h2>
      <p class="muted">
        Create baseline Payment, Returns, and Shipping policies. You can edit them later in Seller Hub.
      </p>
      <div class="muted" style="background:#0f1530;border:1px solid #26305a;border-radius:10px;padding:.75rem;margin:.75rem 0;">
        <div style="font-weight:600;margin-bottom:.25rem;">What we'll create by default</div>
        <ul style="margin:.25rem 0 .5rem 1.25rem;">
          <li>Payment: Immediate pay disabled (you can change later)</li>
          <li>Returns: 30-day returns, buyer pays return shipping (or <em>No returns</em> if selected)</li>
          <li>Shipping: USPS Ground Advantage, free to buyer; handling time 1 business day</li>
        </ul>
        <div style="font-size:.9rem;">You can refine details after creation from <a href="/policies-manage.html">Manage policies</a>.</div>
      </div>

      <div style="margin: 0.75rem 0">
        <label
          >Returns preference
          <select id="returnsPref">
            <option value="default" selected>30-day returns (buyer pays)</option>
            <option value="no-returns">No returns</option>
          </select>
        </label>
      </div>

      <div style="margin: 0.5rem 0">
        <button id="provisionBtn">Create default policies</button>
        <span id="msg" class="muted"></span>
      </div>

      <div id="current" style="margin-top:1rem;">
        <h3 style="margin:.5rem 0;">Current policies</h3>
        <div class="muted" id="curStatus">Loading…</div>
        <div style="display:grid;grid-template-columns:1fr;gap:.75rem;margin-top:.5rem;">
          <div style="background:#0f1530;border:1px solid #26305a;border-radius:10px;padding:.75rem;">
            <div style="font-weight:600;margin-bottom:.25rem;">Shipping</div>
            <ul id="listFulfillment" style="margin:.25rem 0 .25rem 1.25rem;"></ul>
          </div>
          <div style="background:#0f1530;border:1px solid #26305a;border-radius:10px;padding:.75rem;">
            <div style="font-weight:600;margin-bottom:.25rem;">Payment</div>
            <ul id="listPayment" style="margin:.25rem 0 .25rem 1.25rem;"></ul>
          </div>
          <div style="background:#0f1530;border:1px solid #26305a;border-radius:10px;padding:.75rem;">
            <div style="font-weight:600;margin-bottom:.25rem;">Returns</div>
            <ul id="listReturns" style="margin:.25rem 0 .25rem 1.25rem;"></ul>
          </div>
        </div>
      </div>

      <div id="debug" style="margin-top: 1.25rem; background:#0f1530;border:1px solid #26305a;border-radius:10px;padding:.9rem;">
        <div style="font-weight:700;margin-bottom:.35rem;">Debug tools</div>
        <div class="muted" style="font-size:.9rem;margin-bottom:.5rem;">Run these from this page so your Authorization header is included. Opening the function URL directly won’t include your token and will return Unauthorized.</div>
        <div style="display:flex; gap:.5rem; flex-wrap:wrap;">
          <button id="btnDebugAccount" class="secondary">Run account debug (scopes)</button>
          <button id="btnCreateKnownGood">Create shipping (known-good)</button>
        </div>
        <pre id="debugOut" style="white-space:pre-wrap;color:#e6ebff;background:#0b1020;border:1px solid #26305a;border-radius:8px;padding:.6rem;margin-top:.6rem;max-height:280px;overflow:auto;display:none;"></pre>
      </div>

      <div style="margin-top: 1rem">
        <a class="secondary" href="/">← Back to landing</a>
        <a
          class="secondary"
          href="/.netlify/functions/ebay-list-policies"
          target="_blank"
          style="margin-left: 0.5rem"
          >View policies JSON ↗</a
        >
      </div>
    </div>

    <script>
      // Require auth for this page and ensure Authorization is attached to function calls
      (async () => { try { await authClient.requireAuth(); } catch {} })();

      async function loadPolicies() {
        try {
          const r = await authClient.authFetch('/.netlify/functions/ebay-list-policies');
          const j = await r.json();
          const f = (j?.fulfillment?.json?.fulfillmentPolicies) || [];
          const p = (j?.payment?.json?.paymentPolicies) || [];
          const rr = (j?.returns?.json?.returnPolicies) || [];
          const status = document.getElementById('curStatus');
          if (status) status.textContent = (f.length||p.length||rr.length) ? '' : 'No policies yet';
          function fill(id, arr) {
            const ul = document.getElementById(id);
            if (!ul) return;
            ul.innerHTML='';
            arr.forEach((it)=>{
              const li = document.createElement('li');
              li.textContent = (it.name || '(unnamed)') + ' — ' + (it.id || it.fulfillmentPolicyId || it.paymentPolicyId || it.returnPolicyId || '');
              ul.appendChild(li);
            });
          }
          fill('listFulfillment', f);
          fill('listPayment', p);
          fill('listReturns', rr);
        } catch (e) {
          const status = document.getElementById('curStatus');
          if (status) status.textContent = 'Failed to load: ' + (e?.message || e);
        }
      }

      async function ensureConnected() {
        const r = await authClient.authFetch('/.netlify/functions/status');
        const s = await r.json();
        if (!s.ebay?.connected) {
          document.getElementById('msg').textContent = 'Connect eBay first.';
          throw new Error('Not connected');
        }
      }
      document.getElementById('provisionBtn').onclick = async () => {
        try {
          await ensureConnected();
          const pref = (document.getElementById('returnsPref') || { value: 'default' }).value;
          const qs = pref === 'no-returns' ? '?returns=false' : '';
          const r = await authClient.authFetch('/.netlify/functions/ebay-provision-policies' + qs);
          const data = await r.json();
          document.getElementById('msg').textContent = r.ok
            ? 'Policies ready. Returning to landing…'
            : 'Error: ' + (data.error || JSON.stringify(data));
          if (r.ok) {
            // Refresh list and then return
            try { await loadPolicies(); } catch {}
            setTimeout(() => (location.href = '/'), 1200);
          }
        } catch (e) {
          document.getElementById('msg').textContent = 'Error: ' + e.message;
        }
      };
      // Initial load of current policies
      loadPolicies().catch(()=>{});
      // Debug helpers
      function showDebug(obj) {
        const pre = document.getElementById('debugOut');
        if (!pre) return;
        pre.style.display = 'block';
        try { pre.textContent = JSON.stringify(obj, null, 2); }
        catch { pre.textContent = String(obj); }
      }
      const btnDbg = document.getElementById('btnDebugAccount');
      if (btnDbg) btnDbg.addEventListener('click', async () => {
        try {
          const r = await authClient.authFetch('/.netlify/functions/ebay-debug-account');
          const j = await r.json();
          showDebug(j);
        } catch (e) { showDebug({ error: String(e) }); }
      });
      const btnCreate = document.getElementById('btnCreateKnownGood');
      if (btnCreate) btnCreate.addEventListener('click', async () => {
        if (!confirm('Create a minimal USPS fulfillment policy now?')) return;
        try {
          const name = 'App Default USPS ' + new Date().toISOString().slice(0,19).replace('T',' ');
          // Known-good sample matches eBay docs: free domestic flat-rate USPS Priority Flat Rate Box
          const r = await authClient.authFetch('/.netlify/functions/ebay-policy-create-fulfillment', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name, handlingTime: 3, free: true, costType: 'FLAT_RATE', serviceCode: 'USPSPriorityFlatRateBox' })
          });
          const j = await r.json();
          showDebug(j);
          try { await loadPolicies(); } catch {}
        } catch (e) { showDebug({ error: String(e) }); }
      });
      // Intercept the "View policies JSON" link to ensure we include Authorization
      const viewLink = document.querySelector('a[href="/.netlify/functions/ebay-list-policies"]');
      if (viewLink) viewLink.addEventListener('click', async (e) => {
        e.preventDefault();
        try {
          const r = await authClient.authFetch('/.netlify/functions/ebay-list-policies');
          const text = await r.text();
          const w = window.open('', '_blank');
          if (w) { w.document.write('<pre style="white-space:pre-wrap;color:#fff;background:#0b1020;padding:1rem;">'+
            text.replace(/[&<>]/g, (c)=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[c])) + '</pre>'); w.document.close(); }
        } catch {}
      });
    </script>
  </body>
</html>
