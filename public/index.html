<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>GPTListing – Connect</title>
    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; padding: 2rem; background:#0b1020; color:#f4f6fb; }
      .card { max-width: 760px; margin: 0 auto; background: #141a33; border: 1px solid #2a335c; border-radius: 12px; padding: 1.5rem; box-shadow: 0 10px 30px rgba(0,0,0,.25); }
      h1 { margin-top: 0; font-weight: 700; letter-spacing: .2px; }
      .row { display: flex; gap: 1rem; flex-wrap: wrap; }
      .col { flex: 1 1 280px; background: #0f1530; border: 1px solid #26305a; padding: 1rem; border-radius: 10px; }
      .status { font-size: .9rem; opacity: .9; }
      button { background: #4f7cff; color: white; border: none; border-radius: 8px; padding: .7rem 1rem; cursor: pointer; font-weight: 600; }
      button.secondary { background: transparent; color: #cbd5ff; border: 1px solid #3d4a86; }
      button:disabled { opacity: .5; cursor: not-allowed; }
      a { color: #a8c1ff; }
      .small { font-size: .85rem; opacity: .8; }
      .muted { color: #a2a9c8; }
      .footer { margin-top: 1rem; font-size: .85rem; color: #a2a9c8; }
    </style>
  </head>
  <body>
    <div class="card">
      <h1>Connect your accounts</h1>
      <p class="muted">Link Dropbox to read photos, and eBay to create draft listings in your production account.</p>
      <div class="row">
        <div class="col">
          <h3>Dropbox</h3>
          <p class="status" id="dbxStatus">Loading…</p>
          <div>
            <button id="dbxConnect">Connect Dropbox</button>
            <button id="dbxDisconnect" class="secondary">Disconnect</button>
          </div>
        </div>
        <div class="col">
          <h3>eBay (Production)</h3>
          <p class="status" id="ebayStatus">Loading…</p>
          <div>
            <button id="ebayConnect">Connect eBay</button>
            <button id="ebayDisconnect" class="secondary">Disconnect</button>
          </div>
        </div>
      </div>
      <div style="margin-top:1rem">
        <button id="process" disabled>Process folder → Drafts</button>
        <span id="processMsg" class="small"></span>
      </div>

      <hr style="margin:1.5rem 0; border:none; border-top:1px solid #2a335c"/>
      <h2>Onboarding</h2>
      <p class="muted">Once connected, set your ship-from location and create default business policies. You can customize or select policies per listing.</p>
      <div class="row">
        <div class="col">
          <h3>Ship-from address</h3>
          <div class="row">
            <div class="col"><label>Location Key<br/><input id="locKey" placeholder="home" style="width:100%"/></label></div>
            <div class="col"><label>Name<br/><input id="locName" placeholder="Home" style="width:100%"/></label></div>
          </div>
          <div class="row">
            <div class="col"><label>Address 1<br/><input id="locAddr1" placeholder="123 Main St" style="width:100%"/></label></div>
            <div class="col"><label>City<br/><input id="locCity" placeholder="City" style="width:100%"/></label></div>
          </div>
          <div class="row">
            <div class="col"><label>State/Prov<br/><input id="locState" placeholder="NH" style="width:100%"/></label></div>
            <div class="col"><label>Postal<br/><input id="locPostal" placeholder="03101" style="width:100%"/></label></div>
          </div>
          <div class="row">
            <div class="col"><label>Country<br/><input id="locCountry" placeholder="US" style="width:100%"/></label></div>
          </div>
          <div><button id="initLocationBtn" class="secondary" disabled>Initialize location</button> <span id="initLocationMsg" class="small"></span></div>
        </div>
        <div class="col">
          <h3>Policies</h3>
          <div class="row">
            <div class="col"><label>Returns preference<br/>
              <select id="returnsPref" style="width:100%">
                <option value="default" selected>30-day returns (buyer pays)</option>
                <option value="no-returns">No returns</option>
              </select>
            </label></div>
          </div>
          <div><button id="provisionPoliciesBtn" class="secondary" disabled>Create default policies</button> <span id="provisionMsg" class="small"></span></div>
          <div style="margin-top:.75rem" class="small muted">After provisioning, the dropdowns below will populate for per-listing selection.</div>
          <div class="row" style="margin-top:.5rem">
            <div class="col"><label>Fulfillment policy<br/><select id="selFulfillment" style="width:100%"></select></label></div>
            <div class="col"><label>Payment policy<br/><select id="selPayment" style="width:100%"></select></label></div>
          </div>
          <div class="row">
            <div class="col"><label>Return policy<br/><select id="selReturn" style="width:100%"></select></label></div>
          </div>
        </div>
      </div>

      <hr style="margin:1.5rem 0; border:none; border-top:1px solid #2a335c"/>
      <h2>Create draft listing (manual)</h2>
      <p class="muted">Quick form to create a single draft: provide SKU, title, price, and at least one image URL. Category is optional.</p>
      <form id="draftForm" class="col" style="background:#0f1530">
        <div class="row">
          <div class="col">
            <label>SKU<br/><input id="sku" required style="width:100%" placeholder="SKU-123"/></label>
          </div>
          <div class="col">
            <label>Title<br/><input id="title" required style="width:100%" placeholder="Product title"/></label>
          </div>
        </div>
        <div class="row">
          <div class="col">
            <label>Price (USD)<br/><input id="price" type="number" step="0.01" min="0" required style="width:100%" placeholder="19.99"/></label>
          </div>
          <div class="col">
            <label>Quantity<br/><input id="qty" type="number" min="1" value="1" style="width:100%"/></label>
          </div>
        </div>
        <div class="row">
          <div class="col">
            <label>Category ID (optional)<br/><input id="categoryId" style="width:100%" placeholder="e.g. 31413"/></label>
          </div>
          <div class="col">
            <label>Condition (note-only)<br/><input id="conditionNote" style="width:100%" placeholder="New, Sealed"/></label>
          </div>
        </div>
        <div class="row">
          <div class="col">
            <label>Image URLs (comma-separated)<br/><input id="images" style="width:100%" placeholder="https://...jpg, https://...png"/></label>
          </div>
        </div>
        <div class="row">
          <div class="col">
            <label>Description (optional)<br/>
              <textarea id="description" rows="4" style="width:100%" placeholder="Short description"></textarea>
            </label>
          </div>
        </div>
        <div>
          <button id="createDraftBtn" type="submit" disabled>Create draft</button>
          <span id="createDraftMsg" class="small"></span>
        </div>
      </form>
      <div class="footer">
        Need help? See <a href="/privacy.html" target="_blank">Privacy</a>.
      </div>
    </div>

    <script>
      async function refreshStatus() {
        const res = await fetch('/.netlify/functions/status');
        const s = await res.json();
        const dbxStatus = document.getElementById('dbxStatus');
        const ebayStatus = document.getElementById('ebayStatus');
        dbxStatus.textContent = s.dropbox?.connected ? 'Connected' : 'Not connected';
        ebayStatus.textContent = s.ebay?.connected ? 'Connected' : 'Not connected';
        const connected = s.dropbox?.connected && s.ebay?.connected;
        document.getElementById('process').disabled = !connected;
        document.getElementById('createDraftBtn').disabled = !connected;
        document.getElementById('draftForm').style.display = connected ? '' : 'none';
      }

      document.getElementById('dbxConnect').onclick = () => {
        window.location.href='/.netlify/functions/dropbox-oauth-start';
      };
      document.getElementById('ebayConnect').onclick = () => {
        window.location.href='/.netlify/functions/ebay-oauth-start';
      };
      document.getElementById('dbxDisconnect').onclick = async () => {
        await fetch('/.netlify/functions/status?dropbox=disconnect', { method: 'POST' });
        refreshStatus();
      };
      document.getElementById('ebayDisconnect').onclick = async () => {
        await fetch('/.netlify/functions/status?ebay=disconnect', { method: 'POST' });
        refreshStatus();
      };
      document.getElementById('process').onclick = async () => {
        const btn = document.getElementById('process');
        const msg = document.getElementById('processMsg');
        btn.disabled = true; msg.textContent = 'Starting…';
        try {
          const res = await fetch('/.netlify/functions/process', { method: 'POST' });
          const data = await res.json();
          msg.textContent = data.ok ? `Created ${data.created || 0} drafts` : (data.error || 'Error');
        } catch(e) {
          msg.textContent = 'Error: ' + e.message;
        } finally { btn.disabled = false; }
      };

      document.getElementById('draftForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const msg = document.getElementById('createDraftMsg');
        msg.textContent = '';
        const sku = document.getElementById('sku').value.trim();
        const title = document.getElementById('title').value.trim();
        const price = parseFloat(document.getElementById('price').value);
        const qty = parseInt(document.getElementById('qty').value || '1', 10);
        const categoryId = document.getElementById('categoryId').value.trim();
        const conditionNote = document.getElementById('conditionNote').value.trim();
        const description = document.getElementById('description').value.trim();
        const imagesRaw = document.getElementById('images').value.trim();
        const images = imagesRaw ? imagesRaw.split(',').map(s => s.trim()).filter(Boolean) : [];
        if (!sku || !title || !Number.isFinite(price) || images.length === 0) {
          msg.textContent = 'Please provide SKU, title, price, and at least one image URL.';
          return;
        }
  const selFulfillmentEl = document.getElementById('selFulfillment');
  const selPaymentEl = document.getElementById('selPayment');
  const selReturnEl = document.getElementById('selReturn');
  const locKeyEl = document.getElementById('locKey');
  const selFulfillment = selFulfillmentEl && 'value' in selFulfillmentEl ? selFulfillmentEl.value : '';
  const selPayment = selPaymentEl && 'value' in selPaymentEl ? selPaymentEl.value : '';
  const selReturn = selReturnEl && 'value' in selReturnEl ? selReturnEl.value : '';
  const locKey = locKeyEl && 'value' in locKeyEl ? locKeyEl.value : '';
        const payload = {
          sku, title, price, qty, images,
          categoryId: categoryId || undefined,
          description: description || undefined,
          conditionNote: conditionNote || undefined,
          fulfillmentPolicyId: selFulfillment || undefined,
          paymentPolicyId: selPayment || undefined,
          returnPolicyId: selReturn || undefined,
          merchantLocationKey: locKey || undefined,
        };
        msg.textContent = 'Creating draft…';
        try {
          const r = await fetch('/.netlify/functions/ebay-create-draft', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
          let data;
          try { data = await r.json(); } catch { data = { error: await r.text() }; }
          if (!r.ok || !data.ok) {
            const detail = data.detail ? (typeof data.detail === 'string' ? data.detail : JSON.stringify(data.detail)) : '';
            msg.textContent = 'Error: ' + (data.error || JSON.stringify(data)) + (detail ? ' | ' + detail : '');
          } else {
            msg.textContent = 'Draft created: offerId ' + (data.draftOffer?.offerId || '(unknown)');
          }
        } catch (err) {
          msg.textContent = 'Error: ' + err.message;
        }
      });

      async function loadPoliciesIntoDropdowns() {
        const res = await fetch('/.netlify/functions/ebay-list-policies');
        const data = await res.json();
        function fill(id, list, idKey) {
          const el = document.getElementById(id);
          if (!el) return;
          el.innerHTML = '';
          const opt0 = document.createElement('option'); opt0.value=''; opt0.textContent='(auto-select)'; el.appendChild(opt0);
          (list||[]).forEach(p => {
            const o = document.createElement('option');
            const pid = p[idKey] || p.id; const name = p.name || pid;
            o.value = pid; o.textContent = name; el.appendChild(o);
          });
        }
        fill('selFulfillment', data.fulfillment?.json?.fulfillmentPolicies, 'fulfillmentPolicyId');
        fill('selPayment', data.payment?.json?.paymentPolicies, 'paymentPolicyId');
        fill('selReturn', data.returns?.json?.returnPolicies, 'returnPolicyId');
      }

      async function refreshStatusPlus() {
        await refreshStatus();
        const s = await (await fetch('/.netlify/functions/status')).json();
        const enableOnConnected = s.ebay?.connected;
        document.getElementById('initLocationBtn').disabled = !enableOnConnected;
        document.getElementById('provisionPoliciesBtn').disabled = !enableOnConnected;
        if (enableOnConnected) loadPoliciesIntoDropdowns();
      }

      document.getElementById('initLocationBtn').onclick = async () => {
        const msg = document.getElementById('initLocationMsg');
        msg.textContent = 'Saving…';
  const key = (document.getElementById('locKey') || { value: '' }).value.trim() || 'default-loc';
  const name = (document.getElementById('locName') || { value: '' }).value.trim() || 'Home';
  const a1 = (document.getElementById('locAddr1') || { value: '' }).value.trim();
  const city = (document.getElementById('locCity') || { value: '' }).value.trim();
  const st = (document.getElementById('locState') || { value: '' }).value.trim();
  const pc = (document.getElementById('locPostal') || { value: '' }).value.trim();
  const ctry = (document.getElementById('locCountry') || { value: '' }).value.trim() || 'US';
        const url = `/.netlify/functions/ebay-init-location?key=${encodeURIComponent(key)}&name=${encodeURIComponent(name)}&address1=${encodeURIComponent(a1)}&city=${encodeURIComponent(city)}&state=${encodeURIComponent(st)}&postal=${encodeURIComponent(pc)}&country=${encodeURIComponent(ctry)}`;
        try {
          const r = await fetch(url);
          const data = await r.json();
          msg.textContent = r.ok ? 'Location saved' : ('Error: ' + (data.error || JSON.stringify(data)));
        } catch (e) { msg.textContent = 'Error: ' + e.message; }
      };

      document.getElementById('provisionPoliciesBtn').onclick = async () => {
        const msg = document.getElementById('provisionMsg');
        msg.textContent = 'Provisioning…';
  const returnsPref = (document.getElementById('returnsPref') || { value: 'default' }).value;
        const qs = returnsPref === 'no-returns' ? '?returns=false' : '';
        try {
          const r = await fetch('/.netlify/functions/ebay-provision-policies' + qs);
          const data = await r.json();
          msg.textContent = r.ok ? 'Policies ready' : ('Error: ' + (data.error || JSON.stringify(data)));
          if (r.ok) loadPoliciesIntoDropdowns();
        } catch (e) { msg.textContent = 'Error: ' + e.message; }
      };

      refreshStatusPlus();
    </script>
  </body>
</html>
