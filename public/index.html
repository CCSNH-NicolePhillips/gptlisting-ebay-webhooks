<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>GPTListing – Connect</title>
    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; padding: 2rem; background:#0b1020; color:#f4f6fb; }
      .card { max-width: 760px; margin: 0 auto; background: #141a33; border: 1px solid #2a335c; border-radius: 12px; padding: 1.5rem; box-shadow: 0 10px 30px rgba(0,0,0,.25); }
      h1 { margin-top: 0; font-weight: 700; letter-spacing: .2px; }
      .row { display: flex; gap: 1rem; flex-wrap: wrap; }
      .col { flex: 1 1 280px; background: #0f1530; border: 1px solid #26305a; padding: 1rem; border-radius: 10px; }
      .status { font-size: .9rem; opacity: .9; }
      button { background: #4f7cff; color: white; border: none; border-radius: 8px; padding: .7rem 1rem; cursor: pointer; font-weight: 600; }
      button.secondary { background: transparent; color: #cbd5ff; border: 1px solid #3d4a86; }
      button:disabled { opacity: .5; cursor: not-allowed; }
      a { color: #a8c1ff; }
      .small { font-size: .85rem; opacity: .8; }
      .muted { color: #a2a9c8; }
      .footer { margin-top: 1rem; font-size: .85rem; color: #a2a9c8; }
    </style>
  </head>
  <body>
    <div class="card">
      <h1>Connect your accounts</h1>
      <p class="muted">Link Dropbox to read photos, and eBay to create draft listings in your production account.</p>
      <div class="row">
        <div class="col">
          <h3>Dropbox</h3>
          <p class="status" id="dbxStatus">Loading…</p>
          <div>
            <button id="dbxConnect">Connect Dropbox</button>
            <button id="dbxDisconnect" class="secondary">Disconnect</button>
          </div>
        </div>
        <div class="col">
          <h3>eBay (Production)</h3>
          <p class="status" id="ebayStatus">Loading…</p>
          <div>
            <button id="ebayConnect">Connect eBay</button>
            <button id="ebayDisconnect" class="secondary">Disconnect</button>
          </div>
        </div>
      </div>
      <div style="margin-top:1rem">
        <button id="process" disabled>Process folder → Drafts</button>
        <span id="processMsg" class="small"></span>
      </div>

      <hr style="margin:1.5rem 0; border:none; border-top:1px solid #2a335c"/>
      <h2>Create draft listing (manual)</h2>
      <p class="muted">Quick form to create a single draft: provide SKU, title, price, and at least one image URL. Category is optional.</p>
      <form id="draftForm" class="col" style="background:#0f1530">
        <div class="row">
          <div class="col">
            <label>SKU<br/><input id="sku" required style="width:100%" placeholder="SKU-123"/></label>
          </div>
          <div class="col">
            <label>Title<br/><input id="title" required style="width:100%" placeholder="Product title"/></label>
          </div>
        </div>
        <div class="row">
          <div class="col">
            <label>Price (USD)<br/><input id="price" type="number" step="0.01" min="0" required style="width:100%" placeholder="19.99"/></label>
          </div>
          <div class="col">
            <label>Quantity<br/><input id="qty" type="number" min="1" value="1" style="width:100%"/></label>
          </div>
        </div>
        <div class="row">
          <div class="col">
            <label>Category ID (optional)<br/><input id="categoryId" style="width:100%" placeholder="e.g. 31413"/></label>
          </div>
          <div class="col">
            <label>Condition (note-only)<br/><input id="conditionNote" style="width:100%" placeholder="New, Sealed"/></label>
          </div>
        </div>
        <div class="row">
          <div class="col">
            <label>Image URLs (comma-separated)<br/><input id="images" style="width:100%" placeholder="https://...jpg, https://...png"/></label>
          </div>
        </div>
        <div class="row">
          <div class="col">
            <label>Description (optional)<br/>
              <textarea id="description" rows="4" style="width:100%" placeholder="Short description"></textarea>
            </label>
          </div>
        </div>
        <div>
          <button id="createDraftBtn" type="submit" disabled>Create draft</button>
          <span id="createDraftMsg" class="small"></span>
        </div>
      </form>
      <div class="footer">
        Need help? See <a href="/privacy.html" target="_blank">Privacy</a>.
      </div>
    </div>

    <script>
      async function refreshStatus() {
        const res = await fetch('/.netlify/functions/status');
        const s = await res.json();
        const dbxStatus = document.getElementById('dbxStatus');
        const ebayStatus = document.getElementById('ebayStatus');
        dbxStatus.textContent = s.dropbox?.connected ? 'Connected' : 'Not connected';
        ebayStatus.textContent = s.ebay?.connected ? 'Connected' : 'Not connected';
        const connected = s.dropbox?.connected && s.ebay?.connected;
        document.getElementById('process').disabled = !connected;
        document.getElementById('createDraftBtn').disabled = !connected;
        document.getElementById('draftForm').style.display = connected ? '' : 'none';
      }

      document.getElementById('dbxConnect').onclick = () => {
        window.location.href='/.netlify/functions/dropbox-oauth-start';
      };
      document.getElementById('ebayConnect').onclick = () => {
        window.location.href='/.netlify/functions/ebay-oauth-start';
      };
      document.getElementById('dbxDisconnect').onclick = async () => {
        await fetch('/.netlify/functions/status?dropbox=disconnect', { method: 'POST' });
        refreshStatus();
      };
      document.getElementById('ebayDisconnect').onclick = async () => {
        await fetch('/.netlify/functions/status?ebay=disconnect', { method: 'POST' });
        refreshStatus();
      };
      document.getElementById('process').onclick = async () => {
        const btn = document.getElementById('process');
        const msg = document.getElementById('processMsg');
        btn.disabled = true; msg.textContent = 'Starting…';
        try {
          const res = await fetch('/.netlify/functions/process', { method: 'POST' });
          const data = await res.json();
          msg.textContent = data.ok ? `Created ${data.created || 0} drafts` : (data.error || 'Error');
        } catch(e) {
          msg.textContent = 'Error: ' + e.message;
        } finally { btn.disabled = false; }
      };

      document.getElementById('draftForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const msg = document.getElementById('createDraftMsg');
        msg.textContent = '';
        const sku = document.getElementById('sku').value.trim();
        const title = document.getElementById('title').value.trim();
        const price = parseFloat(document.getElementById('price').value);
        const qty = parseInt(document.getElementById('qty').value || '1', 10);
        const categoryId = document.getElementById('categoryId').value.trim();
        const conditionNote = document.getElementById('conditionNote').value.trim();
        const description = document.getElementById('description').value.trim();
        const imagesRaw = document.getElementById('images').value.trim();
        const images = imagesRaw ? imagesRaw.split(',').map(s => s.trim()).filter(Boolean) : [];
        if (!sku || !title || !Number.isFinite(price) || images.length === 0) {
          msg.textContent = 'Please provide SKU, title, price, and at least one image URL.';
          return;
        }
        const payload = { sku, title, price, qty, images, categoryId: categoryId || undefined, description: description || undefined, conditionNote: conditionNote || undefined };
        msg.textContent = 'Creating draft…';
        try {
          const r = await fetch('/.netlify/functions/ebay-create-draft', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
          let data;
          try { data = await r.json(); } catch { data = { error: await r.text() }; }
          if (!r.ok || !data.ok) {
            msg.textContent = 'Error: ' + (data.error || JSON.stringify(data));
          } else {
            msg.textContent = 'Draft created: offerId ' + (data.draftOffer?.offerId || '(unknown)');
          }
        } catch (err) {
          msg.textContent = 'Error: ' + err.message;
        }
      });

      refreshStatus();
    </script>
  </body>
</html>
